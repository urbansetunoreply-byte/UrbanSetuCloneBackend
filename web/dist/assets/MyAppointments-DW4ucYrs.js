import{u as qo,r as o,k as Yo,J as z,i as Cl,j as e,L as Wr,T as te,aT as Ve,aU as Qs,aB as Kr,a0 as kl,H as u,U as Wo,b7 as fl,aV as Sl,f as Ko,g as Go,R as Zo,aX as Jo,aR as D,b8 as Qo,M as Z,y as Ea,aY as pl,aZ as Ia,b as zt,a_ as Hr,b9 as Ot,a$ as Vr,aN as Ut,ai as He,Q as qr,ap as Ta,ba as Xo,b0 as La,b1 as bl,b2 as ei,b3 as ti,Y as si,S as vs,b4 as yl,b5 as ai,n as ri,b6 as ni,bb as wl}from"./index-WPqAAPOK.js";import{F as vl}from"./linkFormatter-C2S5a9jA.js";import{I as li}from"./ImagePreview-DeHXYQ7P.js";import{E as oi,e as ii,L as jl,a as Js}from"./ExportChatModal-DiWsPTOm.js";import{P as di}from"./PaymentModal-CpxY3LqH.js";const M="https://urbansetu.onrender.com";function Ti(){const{currentUser:n}=qo(x=>x.user),[h,N]=o.useState([]),[Ht,Vt]=o.useState([]),[mt,De]=o.useState(!0),[qe,Be]=o.useState(null),[J,fe]=o.useState(""),[Q,At]=o.useState("all"),[Se,Y]=o.useState("all"),[de,$e]=o.useState(1),[pe,be]=o.useState(1),[ae,F]=o.useState(1),[H,$]=o.useState(1),[A,Xs]=o.useState([]),[js,W]=o.useState(""),[Ye,_e]=o.useState(!1),[q,We]=o.useState(null),[se,Mt]=o.useState(null),[ye,qt]=o.useState(""),[E,Ke]=o.useState(""),[X,I]=o.useState(!1),[_,ge]=o.useState(null),[U,K]=o.useState([]),[Re,ea]=o.useState(!1),ht=Yo(),[Pa,Yt]=o.useState(null),[Dt,xt]=o.useState(!1),[gt,Ns]=o.useState(!1),[ft,Ge]=o.useState(null),[ta,Cs]=o.useState(null),[pt,Wt]=o.useState(!1),[sa,Kt]=o.useState(null),[$t,aa]=o.useState(null),[ze,Gt]=o.useState(!1),[ce,Zt]=o.useState(null),[ks,Jt]=o.useState([]);o.useEffect(()=>(Dt||gt?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[Dt,gt]),o.useEffect(()=>{const x=async()=>{if(!n){Be("Please sign in to view your appointments"),De(!1);return}try{De(!0),Be(null);const{data:b}=await D.get(`${M}/api/bookings/my`,{withCredentials:!0});console.log("All appointments fetched:",b);const C=b.appointments||b;Vt(C)}catch{Be("Failed to load appointments. Please try again.")}finally{De(!1)}},f=async()=>{if(n)try{const{data:b}=await D.get(`${M}/api/bookings/archived`,{withCredentials:!0});K(Array.isArray(b)?b:[])}catch(b){K([]),console.error("Failed to fetch archived appointments:",b)}else K([])};x(),f()},[n]),o.useEffect(()=>{if(Ht.length===0)return;let x=Ht.filter(R=>{var rt,nt,lt,ot,yt,wt,la,Qt,Oe,Xt,es,ts,_s;if(n._id===((nt=(rt=R.buyerId)==null?void 0:rt._id)==null?void 0:nt.toString())&&R.visibleToBuyer===!1||n._id===((ot=(lt=R.sellerId)==null?void 0:lt._id)==null?void 0:ot.toString())&&R.visibleToSeller===!1)return!1;const oe=new Date(R.date)<new Date||new Date(R.date).toDateString()===new Date().toDateString()&&R.time&&R.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(Q==="outdated")return oe;const we=Q==="all"?!0:R.status===Q,at=Se==="all"?!0:R.role===Se,ue=((yt=R.propertyName)==null?void 0:yt.toLowerCase().includes(J.toLowerCase()))||((la=(wt=R.buyerId)==null?void 0:wt.email)==null?void 0:la.toLowerCase().includes(J.toLowerCase()))||((Oe=(Qt=R.sellerId)==null?void 0:Qt.email)==null?void 0:Oe.toLowerCase().includes(J.toLowerCase()))||((es=(Xt=R.buyerId)==null?void 0:Xt.username)==null?void 0:es.toLowerCase().includes(J.toLowerCase()))||((_s=(ts=R.sellerId)==null?void 0:ts.username)==null?void 0:_s.toLowerCase().includes(J.toLowerCase())),Et=(!ye||new Date(R.date)>=new Date(ye))&&(!E||new Date(R.date)<=new Date(E));return we&&at&&ue&&Et});const f=10,b=Math.ceil(x.length/f);be(b);const C=(de-1)*f,k=C+f,P=x.slice(C,k);console.log(`Page ${de} of ${b}, showing ${P.length} appointments`),N(P)},[Ht,de,J,Q,Se,ye,E,n]),o.useEffect(()=>{if(U.length===0)return;let x=U.filter(R=>{var rt,nt,lt,ot,yt,wt;const oe=new Date(R.date)<new Date||new Date(R.date).toDateString()===new Date().toDateString()&&R.time&&R.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),we=Q==="all"?!0:Q==="outdated"?oe:R.status===Q,at=Se==="all"?!0:R.role===Se,ue=((rt=R.propertyName)==null?void 0:rt.toLowerCase().includes(J.toLowerCase()))||((nt=R.message)==null?void 0:nt.toLowerCase().includes(J.toLowerCase()))||((ot=(lt=R.buyerId)==null?void 0:lt.username)==null?void 0:ot.toLowerCase().includes(J.toLowerCase()))||((wt=(yt=R.sellerId)==null?void 0:yt.username)==null?void 0:wt.toLowerCase().includes(J.toLowerCase())),Et=(!ye||new Date(R.date)>=new Date(ye))&&(!E||new Date(R.date)<=new Date(E));return we&&at&&ue&&Et});const f=10,b=Math.ceil(x.length/f);$(b);const C=(ae-1)*f,k=C+f,P=x.slice(C,k);console.log(`Archived Page ${ae} of ${b}, showing ${P.length} archived appointments`),Xs(P)},[U,ae,J,Q,Se,ye,E]),o.useEffect(()=>{const x=f=>{N(b=>b.filter(C=>C._id!==f.detail))};return window.addEventListener("removeAppointmentRow",x),()=>{window.removeEventListener("removeAppointmentRow",x)}},[n]),o.useEffect(()=>{const x=f=>{const{appointmentId:b,preferUnread:C}=f.detail||{};if(b){const k=h.find(P=>P._id===b);k&&(Cs(k),Wt(!0),Kt(b),C&&aa(b))}};return window.addEventListener("openChatFromNotification",x),()=>{window.removeEventListener("openChatFromNotification",x)}},[h]),o.useEffect(()=>(Ye?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[Ye]),o.useEffect(()=>(X?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[X]),o.useEffect(()=>{n&&N(x=>x.map(f=>{const b={...f};return f.buyerId&&(f.buyerId._id===n._id||f.buyerId===n._id)&&(b.buyerId={...b.buyerId,username:n.username,email:n.email,mobileNumber:n.mobileNumber,avatar:n.avatar}),f.sellerId&&(f.sellerId._id===n._id||f.sellerId===n._id)&&(b.sellerId={...b.sellerId,username:n.username,email:n.email,mobileNumber:n.mobileNumber,avatar:n.avatar}),b}))},[n]),o.useEffect(()=>{function x(b){N(C=>C.map(k=>k._id===b.appointmentId?{...k,...b.updatedAppointment}:k))}function f(b){N(C=>C.map(k=>k._id===b.appointmentId?{...k,paymentConfirmed:b.paymentConfirmed}:k))}return z.on("appointmentUpdate",x),z.on("paymentStatusUpdated",f),()=>{z.off("appointmentUpdate",x),z.off("paymentStatusUpdated",f)}},[]),o.useEffect(()=>{function x(b){const C=b.appointment;C.buyerId&&n&&(C.buyerId._id===n._id||C.buyerId===n._id)?C.role="buyer":C.sellerId&&n&&(C.sellerId._id===n._id||C.sellerId===n._id)&&(C.role="seller"),N(k=>[C,...k])}z.on("appointmentCreated",x);const f=b=>{N(C=>C.map(k=>{const P={...k};return k.buyerId&&(k.buyerId._id===b.userId||k.buyerId===b.userId)&&(P.buyerId={...P.buyerId,username:b.username,email:b.email,mobileNumber:b.mobileNumber,avatar:b.avatar}),k.sellerId&&(k.sellerId._id===b.userId||k.sellerId===b.userId)&&(P.sellerId={...P.sellerId,username:b.username,email:b.email,mobileNumber:b.mobileNumber,avatar:b.avatar}),P}))};return z.on("profileUpdated",f),()=>{z.off("appointmentCreated",x),z.off("profileUpdated",f)}},[n]),o.useEffect(()=>{if(!n)return;const x=setInterval(()=>{z.emit("userAppointmentsActive",{userId:n._id})},1e3);return()=>clearInterval(x)},[n]),o.useEffect(()=>{},[pt,ta]);const Ee=Cl();o.useEffect(()=>{var x,f;if((x=Ee.state)!=null&&x.fromNotification&&((f=Ee.state)!=null&&f.openChatForAppointment)){const b=Ee.state.openChatForAppointment;if(h.length>0){const C=h.find(k=>k._id===b);C&&(Cs(C),Wt(!0),Kt(b),ht(Ee.pathname,{replace:!0}))}else{const C=setInterval(()=>{if(h.length>0){const k=h.find(P=>P._id===b);k&&(Cs(k),Wt(!0),Kt(b),ht(Ee.pathname,{replace:!0})),clearInterval(C)}},100);setTimeout(()=>clearInterval(C),5e3)}}},[Ee.state,ht,h,n._id]);const bt=async(x,f)=>{var b,C,k;W(x+f);try{const{data:P}=await D.patch(`${M}/api/bookings/${x}/status`,{status:f},{withCredentials:!0,headers:{"Content-Type":"application/json"}});N(oe=>oe.map(we=>we._id===x?{...we,status:f}:we));const R=f==="accepted"?"accepted":"rejected";u.success(`Appointment ${R} successfully! ${f==="accepted"?"Contact information is now visible to both parties.":""}`,{autoClose:3e3,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),ht("/user/my-appointments")}catch(P){if(((b=P.response)==null?void 0:b.status)===401){u.error("Session expired or unauthorized. Please sign in again."),ht("/sign-in");return}u.error(((k=(C=P.response)==null?void 0:C.data)==null?void 0:k.message)||"Failed to update appointment status.")}W("")},y=async x=>{Ge(x),setDeleteReason(""),setShowDeleteAppointmentModal(!0)},ra=async x=>{Ge(x),xt(!0)},Fa=async()=>{var x,f;try{const{data:b}=await D.patch(`${M}/api/bookings/${ft}/archive`,{},{withCredentials:!0,headers:{"Content-Type":"application/json"}}),C=h.find(k=>k._id===ft);C&&(N(k=>k.filter(P=>P._id!==ft)),K(k=>[{...C,archivedAt:new Date},...k])),u.success("Appointment archived successfully.",{autoClose:3e3,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),xt(!1),Ge(null)}catch(b){u.error(((f=(x=b.response)==null?void 0:x.data)==null?void 0:f.message)||"Failed to archive appointment.")}},Ss=async x=>{Ge(x),Ns(!0)},Ba=async()=>{var x,f;try{const{data:b}=await D.patch(`${M}/api/bookings/${ft}/unarchive`,{},{withCredentials:!0,headers:{"Content-Type":"application/json"}}),C=U.find(k=>k._id===ft);C&&(K(k=>k.filter(P=>P._id!==ft)),N(k=>[{...C,archivedAt:void 0},...k])),u.success("Appointment unarchived successfully.",{autoClose:3e3,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),Ns(!1),Ge(null)}catch(b){u.error(((f=(x=b.response)==null?void 0:x.data)==null?void 0:f.message)||"Failed to unarchive appointment.")}};function na(x){ge({...x,date:x.date?new Date(x.date).toISOString().split("T")[0]:"",time:x.time||"",message:x.message||"",buyerReinitiationCount:x.buyerReinitiationCount||0,sellerReinitiationCount:x.sellerReinitiationCount||0}),I(!0)}async function st(x){var k,P,R,oe;if(x.preventDefault(),!_)return;const f=n&&(((k=_.buyerId)==null?void 0:k._id)===n._id||_.buyerId===n._id);if(n&&(((P=_.sellerId)==null?void 0:P._id)===n._id||(_.sellerId,n._id)),(f?_.buyerReinitiationCount||0:_.sellerReinitiationCount||0)>=2){u.error("You have reached the maximum number of reinitiations for your role.");return}if(!_.buyerId||!_.sellerId){u.error("Cannot reinitiate: one of the parties no longer exists.");return}const C={..._,status:"pending"};try{const{data:we}=await D.post(`${M}/api/bookings/reinitiate`,C,{withCredentials:!0,headers:{"Content-Type":"application/json"}});u.success("Appointment reinitiated successfully!",{autoClose:5e3,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),I(!1),ge(null),ht("/user/my-appointments"),N(at=>at.map(ue=>ue._id===we.appointment._id?{...ue,...we.appointment}:ue))}catch(we){u.error(((oe=(R=we.response)==null?void 0:R.data)==null?void 0:oe.message)||"Failed to reinitiate appointment.")}}const za=(x,f)=>{N(b=>b.map(C=>C._id===x?{...C,status:f}:C))},Gr=async()=>{De(!0),Be(null);try{const{data:x}=await D.get(`${M}/api/bookings/my`,{withCredentials:!0});if(N(x),n){const{data:f}=await D.get(`${M}/api/bookings/archived`,{withCredentials:!0});K(Array.isArray(f)?f:[])}else K([])}catch{Be("Failed to refresh appointments. Please try again.")}finally{De(!1)}},T=x=>{if(!x){u.error("No message to copy");return}navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(x).then(()=>{u.success("Copied",{autoClose:2e3,position:"bottom-center"})}).catch(()=>{Ze(x)}):Ze(x)},Ze=x=>{try{const f=document.createElement("textarea");f.value=x,f.style.position="fixed",f.style.left="-999999px",f.style.top="-999999px",document.body.appendChild(f),f.focus(),f.select();const b=document.execCommand("copy");document.body.removeChild(f),b?u.success("Copied",{autoClose:2e3,position:"bottom-center"}):(console.error("Fallback copy failed"),u.error("Failed to copy message"))}catch(f){console.error("Fallback copy error:",f),u.error("Copy not supported")}};return mt?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading your appointments..."})]})}):qe?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6",children:e.jsx("div",{className:"text-center text-red-600 text-lg",children:qe})})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:[n&&e.jsx("div",{className:"max-w-7xl mx-auto mb-4 flex justify-end",children:e.jsxs(Wr,{to:"/user/my-payments",className:"inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold shadow",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 24 24",fill:"currentColor",children:[e.jsx("path",{d:"M2 7a2 2 0 012-2h16a2 2 0 012 2v3H2V7z"}),e.jsx("path",{d:"M2 12h20v5a2 2 0 01-2 2H4a2 2 0 01-2-2v-5zm4 3a1 1 0 100 2h6a1 1 0 100-2H6z"})]}),"Go to Payments"]})}),showCameraModal&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-4 shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-lg font-medium text-gray-700",children:"Camera"}),e.jsx("button",{onClick:()=>{setShowCameraModal(!1),setCameraError(null),cameraStreamRef.current&&cameraStreamRef.current.getTracks().forEach(x=>x.stop()),capturedPhotoUrl&&URL.revokeObjectURL(capturedPhotoUrl),setCapturedPhotoUrl(null),setCapturedPhotoBlob(null)},className:"text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors",children:e.jsx(te,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-1 grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{className:"col-span-2 bg-black rounded-lg overflow-hidden flex items-center justify-center",children:capturedPhotoUrl?e.jsx("img",{src:capturedPhotoUrl,alt:"Captured",className:"w-full h-full object-contain bg-black"}):e.jsx("video",{ref:cameraVideoRef,className:"w-full h-full object-contain bg-black",autoPlay:!0,playsInline:!0,muted:!0})}),e.jsx("div",{className:"col-span-1 flex flex-col gap-3",children:capturedPhotoUrl?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:confirmCapturedPhoto,className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700",children:"OK"}),e.jsx("button",{onClick:retryCapturedPhoto,className:"px-4 py-2 rounded-lg border hover:bg-gray-50",children:"Retry"}),e.jsx("button",{onClick:()=>{setShowCameraModal(!1),setCameraError(null),cameraStreamRef.current&&cameraStreamRef.current.getTracks().forEach(x=>x.stop()),capturedPhotoUrl&&URL.revokeObjectURL(capturedPhotoUrl),setCapturedPhotoUrl(null),setCapturedPhotoBlob(null)},className:"px-4 py-2 rounded-lg border hover:bg-gray-50",children:"Cancel"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Tap OK to open preview and add caption."})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:capturePhoto,className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700",children:"Capture"}),e.jsx("button",{onClick:switchCamera,className:"px-4 py-2 rounded-lg border hover:bg-gray-50",children:"Switch Camera"}),e.jsx("button",{onClick:()=>{setShowCameraModal(!1),setCameraError(null),cameraStreamRef.current&&cameraStreamRef.current.getTracks().forEach(x=>x.stop())},className:"px-4 py-2 rounded-lg border hover:bg-gray-50",children:"Cancel"}),cameraError&&e.jsx("div",{className:"text-xs text-red-600 bg-red-50 border border-red-200 rounded p-2",children:cameraError}),e.jsx("div",{className:"text-xs text-gray-500",children:"Preview will open after capture where you can add captions and send."})]})})]})]})}),e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-2xl md:text-3xl font-extrabold text-blue-700 drop-shadow",children:Re?`Archived Appointments (${A.length})`:`My Appointments (${h.length})`}),!Re&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"ðŸ’¡ Monitor all appointments across the platform. Use the status filter to view appointments and interactive chatbox to connect with otherparty."})]}),e.jsxs("div",{className:"flex flex-row gap-2 md:gap-4",children:[e.jsx("button",{onClick:Gr,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-2.5 py-1.5 rounded-md hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md text-xs sm:text-base sm:px-3 sm:py-1.5 sm:rounded-md flex-1 sm:flex-none sm:w-auto",title:"Refresh appointments",children:"Refresh"}),e.jsx("button",{onClick:()=>{ea(!Re),$e(1),F(1)},className:`bg-gradient-to-r text-white px-2.5 py-1.5 rounded-md transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-1 sm:gap-2 text-xs sm:text-base flex-1 sm:flex-none sm:w-auto sm:px-4 sm:py-2 sm:rounded-md justify-center ${Re?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:Re?e.jsxs(e.Fragment,{children:[e.jsx(Ve,{})," ",e.jsx("span",{children:"Active Appointments"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Qs,{})," ",e.jsxs("span",{children:["Archived Appointments (",U.length,")"]})]})})]})]}),e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold text-sm",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200 text-sm",value:Q,onChange:x=>At(x.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold text-sm",children:"Role:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200 text-sm",value:Se,onChange:x=>Y(x.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"buyer",children:"As Buyer"}),e.jsx("option",{value:"seller",children:"As Seller"})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold text-sm",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200 text-sm",value:ye,onChange:x=>qt(x.target.value),max:E||void 0}),e.jsx("label",{className:"font-semibold text-sm",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200 text-sm",value:E,onChange:x=>Ke(x.target.value),min:ye||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Kr,{className:"text-gray-500 hover:text-blue-500 transition-colors duration-200"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200 text-sm flex-1",placeholder:"Search by property, message, or user...",value:J,onChange:x=>fe(x.target.value)})]})]})]}),Re&&e.jsx("p",{className:"text-center text-gray-600 mb-6",children:"ðŸ“‹ View and manage archived appointments. You can unarchive them to move them back to active appointments."}),Re?A.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Payment"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:A.map(x=>e.jsx(Nl,{appt:x,currentUser:n,handleStatusUpdate:bt,handleAdminDelete:y,actionLoading:js,onShowOtherParty:(f,b)=>{We(f),Mt(b),_e(!0)},onOpenReinitiate:()=>na(x),handleArchiveAppointment:ra,handleUnarchiveAppointment:Ss,isArchived:!0,onCancelRefresh:za,copyMessageToClipboard:T,onExportChat:(f,b)=>{Zt(f),Jt(b),Gt(!0)}},x._id))})]})}):h.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-gray-500 text-lg mb-6",children:"No appointments found."}),e.jsxs(Wr,{to:"/search",className:"inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 shadow-lg",children:[e.jsx(kl,{className:"mr-2"}),"Book Appointment"]})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Payment"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:h.map(x=>e.jsx(Nl,{appt:x,currentUser:n,handleStatusUpdate:bt,handleAdminDelete:y,actionLoading:js,onShowOtherParty:(f,b)=>{We(f),Mt(b),_e(!0)},onOpenReinitiate:()=>na(x),handleArchiveAppointment:ra,handleUnarchiveAppointment:Ss,isArchived:!1,onCancelRefresh:za,copyMessageToClipboard:T,activeChatAppointmentId:sa,shouldOpenChatFromNotification:pt,onChatOpened:()=>{Wt(!1),Kt(null)},preferUnreadForAppointmentId:$t,onConsumePreferUnread:f=>{$t===f&&aa(null)},onExportChat:(f,b)=>{Zt(f),Jt(b),Gt(!0)}},x._id))})]})}),!Re&&pe>1&&e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between mt-6 gap-2",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:["Page ",de," of ",pe]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsx("button",{onClick:()=>{$e(Math.max(1,de-1)),u.info(`Navigated to page ${Math.max(1,de-1)}`)},disabled:de===1,className:"px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto",children:"Previous"}),e.jsx("button",{onClick:()=>{$e(Math.min(pe,de+1)),u.info(`Navigated to page ${Math.min(pe,de+1)}`)},disabled:de===pe,className:"px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto",children:"Next"})]})]}),Re&&H>1&&e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between mt-6 gap-2",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:["Archived Page ",ae," of ",H]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsx("button",{onClick:()=>{F(Math.max(1,ae-1)),u.info(`Navigated to archived page ${Math.max(1,ae-1)}`)},disabled:ae===1,className:"px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto",children:"Previous"}),e.jsx("button",{onClick:()=>{F(Math.min(H,ae+1)),u.info(`Navigated to archived page ${Math.min(H,ae+1)}`)},disabled:ae===H,className:"px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto",children:"Next"})]})]}),Ye&&q&&se&&(()=>{const x=new Date(se.date)>new Date||new Date(se.date).toDateString()===new Date().toDateString()&&(!se.time||se.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),b=(n&&(n.role==="admin"||n.role==="rootadmin")||se.status==="accepted")&&x&&se.status!=="cancelledByBuyer"&&se.status!=="cancelledBySeller"&&se.status!=="cancelledByAdmin"&&se.status!=="rejected"&&se.status!=="deletedByAdmin";return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",style:{overflow:"hidden"},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>_e(!1),title:"Close","aria-label":"Close",children:e.jsx(te,{className:"w-4 h-4"})}),e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Wo,{user:{username:q.username,avatar:q.avatar},size:"w-16 h-16",textSize:"text-lg",showBorder:!0,className:"border-4 border-white shadow-lg"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 border-2 border-white rounded-full flex items-center justify-center",children:b?q.isTyping?e.jsx("div",{className:"w-full h-full bg-yellow-500 rounded-full flex items-center justify-center",children:e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"})}):q.isOnline?e.jsx("div",{className:"w-full h-full bg-green-500 rounded-full flex items-center justify-center",children:e.jsx(fl,{className:"w-2 h-2 text-white"})}):e.jsx("div",{className:"w-full h-full bg-gray-400 rounded-full flex items-center justify-center",children:e.jsx(fl,{className:"w-2 h-2 text-white"})}):e.jsx("div",{className:"w-full h-full bg-gray-400 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white text-[8px] font-bold",children:"N/A"})})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[q.username||"User",q.role==="admin"&&e.jsx(Sl,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:(()=>{var k;return(((k=se.buyerId)==null?void 0:k._id)===n._id||se.buyerId===n._id?"buyer":"seller")==="buyer"?"seller":"buyer"})()}),b?q.isTyping?e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"text-yellow-600 font-medium text-xs bg-yellow-100 px-3 py-1 rounded-full",children:"Typing..."})}):q.isOnline?e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"text-green-600 font-medium text-xs bg-green-100 px-3 py-1 rounded-full",children:"Online"})}):e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"text-gray-600 font-medium text-xs bg-gray-100 px-3 py-1 rounded-full",children:(()=>{if(!q.lastSeen)return"Offline";const C=new Date(q.lastSeen),P=Math.floor((new Date-C)/(1e3*60)),R=Math.floor(P/60),oe=Math.floor(R/24);return P<1?"Last seen just now":P<60?`Last seen ${P} minute${P>1?"s":""} ago`:R<24?`Last seen ${R} hour${R>1?"s":""} ago`:oe<7?`Last seen ${oe} day${oe>1?"s":""} ago`:`Last seen ${C.toLocaleDateString("en-US",{month:"short",day:"numeric"})}`})()})}):e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"text-gray-600 font-medium text-xs bg-gray-100 px-3 py-1 rounded-full",children:"Not available"})})]})]})}),e.jsx("div",{className:"px-6 py-6 space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[b?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx(Ko,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:q.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(Go,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:q.mobileNumber||"Not provided"})]})]})]}):e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-500",children:[e.jsx(Zo,{className:"text-yellow-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-yellow-700 uppercase tracking-wide font-semibold",children:"Contact Information Restricted"}),e.jsx("p",{className:"text-yellow-800 font-medium",children:"Contact details are only available for accepted appointments"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(Jo,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:q.createdAt?new Date(q.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"Not available"})]})]})]})})]})})})(),X&&_&&e.jsx("div",{className:"modal-backdrop",children:e.jsx("div",{className:"modal-content",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-blue-700",children:"Reinitiate Appointment"}),e.jsxs("form",{onSubmit:st,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Date"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 w-full",value:_.date,onChange:x=>ge(f=>({...f,date:x.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Time"}),e.jsx("input",{type:"time",className:"border rounded px-2 py-1 w-full",value:_.time,onChange:x=>ge(f=>({...f,time:x.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Message (optional)"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",value:_.message,onChange:x=>ge(f=>({...f,message:x.target.value}))})]}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full",children:"Submit"}),e.jsx("button",{type:"button",className:"mt-2 w-full bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400",onClick:()=>I(!1),children:"Cancel"})]})]})})}),Dt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(Qs,{className:"text-blue-500"}),"Archive Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to archive this appointment? It will be moved to the archived section."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{xt(!1),Ge(null)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Fa,className:"px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx(Qs,{size:12}),"Archive"]})]})]})}),gt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(Ve,{className:"text-green-500"}),"Unarchive Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Ns(!1),Ge(null)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Ba,className:"px-4 py-2 rounded bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(Ve,{size:12}),"Unarchive"]})]})]})})]}),e.jsx(oi,{isOpen:ze,onClose:()=>{Gt(!1),Zt(null),Jt([])},onExport:async x=>{var f;try{u.info("Generating PDF...",{autoClose:2e3});const b=((f=ce==null?void 0:ce.buyerId)==null?void 0:f._id)===n._id?ce==null?void 0:ce.sellerId:ce==null?void 0:ce.buyerId,C=await ii(ce,ks,n,b,x);C.success?u.success(`Chat transcript exported as ${C.filename}`):u.error(`Export failed: ${C.error}`)}catch(b){u.error("Failed to export chat transcript"),console.error("Export error:",b)}},appointment:ce,messageCount:ks.filter(x=>{var f;return!x.deleted&&(((f=x.message)==null?void 0:f.trim())||x.imageUrl)}).length,imageCount:ks.filter(x=>x.imageUrl&&!x.deleted).length})]})}function Yr(n){const h=new Date,N=new Date;return N.setDate(h.getDate()-1),n.toDateString()===h.toDateString()?"Today":n.toDateString()===N.toDateString()?"Yesterday":n.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}function Nl({appt:n,currentUser:h,handleStatusUpdate:N,handleAdminDelete:Ht,actionLoading:Vt,onShowOtherParty:mt,onOpenReinitiate:De,handleArchiveAppointment:qe,handleUnarchiveAppointment:Be,isArchived:J,onCancelRefresh:fe,copyMessageToClipboard:Q,activeChatAppointmentId:At,shouldOpenChatFromNotification:Se,onChatOpened:Y,onExportChat:de,preferUnreadForAppointmentId:$e,onConsumePreferUnread:pe}){var el,tl,sl,al,rl,nl,ll,ol,il,dl;const[be,ae]=o.useState(null),[F,H]=o.useState(""),[$,A]=o.useState(n.comments||[]),[Xs,js]=o.useState(!1),[W,Ye]=o.useState(null),[_e,q]=o.useState(""),[We,se]=o.useState(""),[Mt,ye]=o.useState(null),qt=Cl(),[E,Ke]=o.useState(!1),X=o.useRef(null),I=o.useRef(null),[_,ge]=o.useState(!0),[U,K]=o.useState(0),[Re,ea]=o.useState(!1),[ht,Pa]=o.useState(!1),Yt=30,[Dt,xt]=o.useState(Yt),[gt,Ns]=o.useState(""),[ft,Ge]=o.useState(!1),[ta,Cs]=o.useState(!1),[pt,Wt]=o.useState(!1),[sa,Kt]=o.useState(null),[$t,aa]=o.useState(null),[ze,Gt]=o.useState(!1),[ce,Zt]=o.useState(!1),[ks,Jt]=o.useState(!1),Ee=o.useRef(null),bt=o.useRef(null),y=o.useRef(null),[ra,Fa]=o.useState([]),[Ss,Ba]=o.useState(!1);o.useEffect(()=>{if(!E||!(n!=null&&n._id)||!(h!=null&&h._id))return;const t=`appt_draft_${n._id}_${h._id}`,s=localStorage.getItem(t);s!=null&&(H(s),setTimeout(()=>{try{if(y.current){const a=y.current.value.length;y.current.focus(),y.current.setSelectionRange(a,a),Ma(y.current)}}catch{}},0))},[E,n==null?void 0:n._id]),o.useEffect(()=>{!E||!/@[^\s]*$/.test(F||"")||Ss||(async()=>{try{const a=await(await fetch(`${M}/api/listing/get?limit=300`,{credentials:"include"})).json(),r=Array.isArray(a)?a.map(l=>({id:l._id,name:l.name||"Property"})):[];Fa(r),Ba(!0)}catch{}})()},[F,E,Ss]),o.useEffect(()=>{if(!E||!(n!=null&&n._id)||!(h!=null&&h._id))return;const t=`appt_draft_${n._id}_${h._id}`;localStorage.setItem(t,F)},[F,E,n==null?void 0:n._id,h==null?void 0:h._id]);const[na,st]=o.useState(!1),[za,Gr]=o.useState(null),[T,Ze]=o.useState(null),[x,f]=o.useState(!0),[b,C]=o.useState(!1),[k,P]=o.useState(null),[R,oe]=o.useState(null),[we,at]=o.useState(!1),[ue,Et]=o.useState(""),[rt,nt]=o.useState(""),[lt,ot]=o.useState(null),[yt,wt]=o.useState(!1),[la,Qt]=o.useState(!1),[Oe,Xt]=o.useState(""),[es,ts]=o.useState(""),[_s,Zr]=o.useState(!1),[_l,Rl]=o.useState(!1),[Oa,Ua]=o.useState(!1),[Al,Ha]=o.useState(!1),[Va,qa]=o.useState(!1),[ve,oa]=o.useState(!1),[ss,as]=o.useState(!1),[me,Jr]=o.useState(!0),[Ya,Wa]=o.useState(!1),[Ka,rs]=o.useState(!1),[Ga,Za]=o.useState(!1),[Ja,Qa]=o.useState(!1),[Rs,Xa]=o.useState(""),[er,tr]=o.useState(""),[sr,ar]=o.useState(""),[rr,nr]=o.useState(""),[ia,Qr]=o.useState(!1),[lr,Xr]=o.useState(!1),[or,ir]=o.useState(!1),[en,tn]=o.useState(!1),[sn,an]=o.useState(!1),[rn,nn]=o.useState(!1),[ln,on]=o.useState(!1),[dn,ui]=o.useState(!1),[cn,mi]=o.useState(!1);o.useEffect(()=>(Oa||Va?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[Oa,Va]),o.useEffect(()=>(Ya||Ka||Ja||Ga?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[Ya,Ka,Ja,Ga]),o.useEffect(()=>(dn?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[dn]),o.useEffect(()=>(cn?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[cn]),o.useEffect(()=>()=>{R&&clearTimeout(R)},[R]),o.useEffect(()=>{E||(P(null),R&&(clearTimeout(R),oe(null)))},[E,R]),o.useEffect(()=>{var t,s;if(Se&&At===n._id){const a=n.buyerChatLocked||n.sellerChatLocked,r=h._id,l=((t=n.buyerId)==null?void 0:t._id)===r||n.buyerId===r,i=((s=n.sellerId)==null?void 0:s._id)===r||n.sellerId===r;a?(l&&n.buyerChatLocked||i&&n.sellerChatLocked)&&rs(!0):(Ke(!0),window.dispatchEvent(new CustomEvent("chatOpened",{detail:{appointmentId:n._id}})),Y&&Y(),$e===n._id&&(Pa(!0),typeof pe=="function"&&pe(n._id)))}},[Se,At,n._id,n.buyerChatLocked,n.sellerChatLocked,n.buyerId,n.sellerId,h._id,Y,$e,pe]);const[hi,Ml]=o.useState(null),[ns,vt]=o.useState(""),[Dl,un]=o.useState(""),Ue=o.useRef({}),[da,re]=o.useState(null),[xi,gi]=o.useState(!1),[ca,je]=o.useState(!1),[ls,As]=o.useState(!1),[jt,Ms]=o.useState(null),[os,Nt]=o.useState(!1),[fi,$l]=o.useState(window.innerWidth<=768);o.useEffect(()=>{const t=()=>{$l(window.innerWidth<=768)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]);const[El,mn]=o.useState(!1),[Ie,hn]=o.useState(null),[dr,xn]=o.useState(!1),[Il,gn]=o.useState(!1),[cr,ua]=o.useState(!1),[it,It]=o.useState([]),[fn,pn]=o.useState(!1),[ur,bn]=o.useState(!1),[yn,wn]=o.useState(null),[vn,jn]=o.useState(!1),[mr,Ds]=o.useState([]),[pi,Nn]=o.useState(!1),[ma,ha]=o.useState(!1),[Tl,is]=o.useState(!1),[Ae,ds]=o.useState(null),[Ne,cs]=o.useState("24hrs"),[xa,hr]=o.useState(24),[Cn,kn]=o.useState(null),[$s,Me]=o.useState(!1),[xr,Te]=o.useState(!1),[ie,he]=o.useState([]),[us,ga]=o.useState({starring:!1,pinning:!1,copying:!1,deleting:!1}),[gr,fa]=o.useState(!1),[fr,pa]=o.useState(""),[dt,Es]=o.useState([]),[Is,ct]=o.useState(-1),[ba,Ts]=o.useState(!1),[Ll,Pl]=o.useState(""),[bi,Sn]=o.useState(null),[Ct,ut]=o.useState(!1),[_n,Tt]=o.useState(""),[B,kt]=o.useState([]),[Fl,pr]=o.useState(!1),[Bl,Rn]=o.useState([]),[Ce,Je]=o.useState(0),[Ls,Lt]=o.useState({}),[zl,Ps]=o.useState(!1),[St,Qe]=o.useState(0),[An,ya]=o.useState(-1),[Ol,Fs]=o.useState(0),[ms,br]=o.useState([]),[yi,Mn]=o.useState(!1),Bs=o.useRef(null),[Dn,hs]=o.useState(null),[Ul,xs]=o.useState(!1),[Hl,wa]=o.useState(!1),Vl=o.useRef(null),ql=o.useRef(null),$n=o.useRef(null),En=o.useRef(null),yr=o.useRef(null),wr=o.useRef(null),[va,_t]=o.useState(!1),[ja,Yl]=o.useState(!1),[vr,wi]=o.useState("user"),gs=o.useRef(null),jr=o.useRef(null),[vi,Nr]=o.useState(null),[Cr,ji]=o.useState(null),[kr,Ni]=o.useState(null),[Xe,Na]=o.useState(null),[Wl,Ca]=o.useState(!1),[Rt,ka]=o.useState(null),[Kl,Sa]=o.useState(!1),[zs,_a]=o.useState(""),[Os,Ra]=o.useState(""),[Gl,Sr]=o.useState(null),[et,fs]=o.useState(null),[Zl,Us]=o.useState(!1),[Hs,_r]=o.useState(""),[Jl,Rr]=o.useState(null),Ar=o.useRef(null),[Ql,Mr]=o.useState(!1),[ps,Dr]=o.useState(!1),[In,Vs]=o.useState(0),[Pt,$r]=o.useState(null),bs=o.useRef(null),Er=o.useRef([]),Ft=o.useRef(null),ys=o.useRef(0),Ir=o.useRef(!1);o.useEffect(()=>{if(ps){ys.current||(ys.current=Date.now());const t=setInterval(()=>{const s=Date.now()-ys.current;Vs(s)},500);return()=>clearInterval(t)}},[ps]);const Tn=o.useCallback(async()=>{console.log("Starting camera with facing mode:",vr);try{gs.current&&gs.current.getTracks().forEach(a=>a.stop());const t={video:{facingMode:vr}};console.log("Requesting camera access with constraints:",t);const s=await navigator.mediaDevices.getUserMedia(t);console.log("Camera stream obtained:",s),gs.current=s,jr.current&&(jr.current.srcObject=s,await new Promise(a=>setTimeout(a,100)),await jr.current.play().catch(()=>{}),console.log("Camera video element updated")),Nr(null)}catch(t){console.error("Camera error:",t),Nr("Camera not available or permission denied. Try switching camera or attach from gallery."),u.error("Camera not available or permission denied")}},[vr]);o.useEffect(()=>(console.log("Camera modal useEffect triggered:",{showCameraModal:ja,capturedPhotoBlob:Cr}),ja&&(Nr(null),Cr||(console.log("Starting camera from useEffect"),Tn())),()=>{!ja&&gs.current&&(console.log("Cleaning up camera stream"),gs.current.getTracks().forEach(t=>t.stop()),gs.current=null)}),[ja,Tn,Cr]),o.useEffect(()=>()=>{kr&&URL.revokeObjectURL(kr)},[kr]);const{playMessageSent:Xl,playMessageReceived:Ln,playNotification:eo,toggleMute:to,setVolume:so,isMuted:ao}=Qo();o.useEffect(()=>{if(Xe){const t=URL.createObjectURL(Xe);return Sr(t),()=>{URL.revokeObjectURL(t),Sr(null)}}else Sr(null)},[Xe]),o.useEffect(()=>{if(et){const t=URL.createObjectURL(et);return Rr(t),()=>{URL.revokeObjectURL(t),Rr(null)}}else Rr(null)},[et]),o.useEffect(()=>()=>{Ft.current&&clearInterval(Ft.current),Pt&&Pt.getTracks().forEach(t=>t.stop())},[Pt]);const ro=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({audio:!0});$r(t),Er.current=[];const s=new MediaRecorder(t,{mimeType:"audio/webm"});bs.current=s,s.ondataavailable=a=>{a.data&&a.data.size>0&&Er.current.push(a.data)},s.onstop=()=>{try{if(Ir.current)return;const a=new Blob(Er.current,{type:"audio/webm"}),r=`recording-${Date.now()}.webm`,l=new File([a],r,{type:"audio/webm"});fs(l),Mr(!1),Us(!0)}catch{u.error("Failed to prepare audio preview")}finally{Pt&&Pt.getTracks().forEach(a=>a.stop()),$r(null),Dr(!1),Vs(0),Ft.current&&clearInterval(Ft.current),ys.current=0,Ir.current=!1}},s.start(100),Dr(!0),ys.current=Date.now(),Vs(0),Ft.current=setInterval(()=>{const a=Date.now()-ys.current;Vs(a)},500)}catch(t){console.error("Recording error:",t),u.error("Microphone permission denied or unavailable")}},no=()=>{if(bs.current)try{bs.current.stop()}catch{}},Pn=()=>{try{Ir.current=!0,bs.current&&bs.current.state!=="inactive"&&bs.current.stop()}catch{}Pt&&Pt.getTracks().forEach(t=>t.stop()),$r(null),Dr(!1),Vs(0),Ft.current&&clearInterval(Ft.current),Mr(!1),fs(null)};o.useEffect(()=>{if(!va)return;const t=s=>{const a=$n.current,r=En.current;r&&r.contains(s.target)||a&&a.contains(s.target)||_t(!1)};return document.addEventListener("mousedown",t,!0),()=>document.removeEventListener("mousedown",t,!0)},[va]);const lo=async t=>{if(!t||t.length===0)return;const s=[],a=[];if(Array.from(t).forEach((r,l)=>{if(!r.type.startsWith("image/")){a.push(`File ${l+1}: Please select an image file`);return}if(r.size>5*1024*1024){a.push(`File ${l+1}: File size must be less than 5MB`);return}s.push(r)}),a.length>0){Tt(a.join(", ")),setTimeout(()=>Tt(""),5e3);return}if(s.length>10){Tt("Maximum 10 images allowed at once"),setTimeout(()=>Tt(""),3e3);return}kt(s),Je(0),Ps(!0),Tt("")},oo=async(t,s,a="")=>{var i,d;const r=`temp-${Date.now()}`,l={_id:r,sender:h._id,senderEmail:h.email,senderName:h.username,message:a||"",imageUrl:t,status:"sending",timestamp:new Date().toISOString(),readBy:[h._id],type:"image"};A(c=>[...c,l]),X.current&&X.current.scrollIntoView({behavior:"smooth"});try{const{data:c}=await D.post(`${M}/api/bookings/${n._id}/comment`,{message:a||"",imageUrl:t,type:"image"},{withCredentials:!0,headers:{"Content-Type":"application/json"}}),g=c.comments[c.comments.length-1];A(p=>p.map(w=>w._id===r?{...g}:w))}catch(c){console.error("Send image error:",c),A(g=>g.filter(p=>p._id!==r)),u.error(((d=(i=c.response)==null?void 0:i.data)==null?void 0:d.message)||"Failed to send image.")}},Fn=async(t,s)=>{var a;if(!t||typeof t!="string"){u.error("Error: Invalid image URL. Cannot download image.");return}try{const r=t.split("/");let i=r[r.length-1];if(!i.includes(".")||i.length<5){const d=((a=t.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?|$)/i))==null?void 0:a[1])||"jpg";i=`chat-image-${s||Date.now()}.${d}`}try{const d=await fetch(t,{mode:"cors",cache:"no-cache"});if(d.ok)try{const c=await d.blob();if(!c||c.size===0)throw new Error("Downloaded image is empty or corrupted");const g=window.URL.createObjectURL(c),p=document.createElement("a");p.href=g,p.download=i,p.style.display="none",document.body.appendChild(p),p.click(),document.body.removeChild(p),setTimeout(()=>window.URL.revokeObjectURL(g),100),u.success(`Image "${i}" downloaded successfully!`);return}catch(c){throw console.error("Blob processing error:",c),new Error(`Failed to process image data: ${c.message}`)}else{let c=`Server error (${d.status}): `;switch(d.status){case 404:c+="Image not found on server";break;case 403:c+="Access denied to image";break;case 500:c+="Server internal error";break;default:c+="Unable to fetch image"}throw new Error(c)}}catch(d){console.warn("Fetch failed, trying direct download:",d),d.name==="TypeError"&&d.message.includes("Failed to fetch")?u.warn("Network error: Trying alternative download method..."):d.message.includes("CORS")?u.warn("CORS error: Trying alternative download method..."):u.warn(`Fetch error: ${d.message}. Trying alternative download method...`);try{const c=document.createElement("a");c.href=t,c.download=i,c.target="_blank",c.rel="noopener noreferrer",c.style.display="none",document.body.appendChild(c),c.click(),document.body.removeChild(c),u.info(`Alternative download initiated. If it doesn't start automatically, please try right-clicking the image and selecting "Save image as..."`);return}catch(c){throw console.error("Direct download failed:",c),new Error(`Direct download failed: ${c.message}`)}}}catch(r){console.error("Download process failed:",r),u.error(`Download failed: ${r.message}. Attempting to open image in new tab...`);try{if(window.open(t,"_blank","noopener,noreferrer"))u.info("Image opened in new tab. You can right-click to save it manually.");else throw new Error("Pop-up blocked by browser")}catch(l){console.error("Failed to open image in new tab:",l),l.message.includes("Pop-up blocked")?u.error('Error: Pop-up blocked. Please allow pop-ups for this site or right-click the image and select "Save image as..."'):u.error(`All download methods failed: ${l.message}. Please right-click the image and select "Save image as..." or check your internet connection.`)}}},io=async(t,s,a="")=>{var i,d;const r=`temp-${Date.now()}`,l={_id:r,sender:h._id,senderEmail:h.email,message:a||"",videoUrl:t,type:"video",status:"sending",timestamp:new Date().toISOString()};A(c=>[...c,l]);try{const{data:c}=await D.post(`${M}/api/bookings/${n._id}/comment`,{message:a||"",videoUrl:t,type:"video"},{withCredentials:!0});A(c.comments||((i=c.updated)==null?void 0:i.comments)||((d=c==null?void 0:c.appointment)==null?void 0:d.comments)||[])}catch{u.error("Failed to send video"),A(g=>g.filter(p=>p._id!==r))}},co=async()=>{var t,s;if(Xe)try{ut(!0);const a=new FormData;a.append("video",Xe);const{data:r}=await D.post(`${M}/api/upload/video`,a,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"},onUploadProgress:l=>{const i=Math.round(l.loaded*100/Math.max(1,l.total||Xe.size));Qe(i)}});await io(r.videoUrl,Xe.name,zs),Na(null),Ca(!1),_a(""),Qe(0)}catch(a){u.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Video upload failed")}finally{ut(!1)}},uo=async(t,s,a="")=>{var i,d;const r=`temp-${Date.now()}`,l={_id:r,sender:h._id,senderEmail:h.email,message:a||"",audioUrl:t,audioName:s.name,audioMimeType:s.type||null,type:"audio",status:"sending",timestamp:new Date().toISOString()};A(c=>[...c,l]);try{const{data:c}=await D.post(`${M}/api/bookings/${n._id}/comment`,{message:a||"",audioUrl:t,audioName:s.name,audioMimeType:s.type||null,type:"audio"},{withCredentials:!0});A(c.comments||((i=c.updated)==null?void 0:i.comments)||((d=c==null?void 0:c.appointment)==null?void 0:d.comments)||[])}catch{u.error("Failed to send audio"),A(g=>g.filter(p=>p._id!==r))}},mo=async()=>{var t,s;if(et)try{ut(!0);const a=new FormData;a.append("audio",et);const{data:r}=await D.post(`${M}/api/upload/audio`,a,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"},onUploadProgress:l=>{const i=Math.round(l.loaded*100/Math.max(1,l.total||et.size));Qe(i)}});await uo(r.audioUrl,et,Hs),fs(null),Us(!1),_r(""),Qe(0)}catch(a){u.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Audio upload failed")}finally{ut(!1)}},ho=async(t,s,a="")=>{var i,d;const r=`temp-${Date.now()}`,l={_id:r,sender:h._id,senderEmail:h.email,message:a||"",documentUrl:t,documentName:s.name,documentMimeType:s.type||null,type:"document",status:"sending",timestamp:new Date().toISOString()};A(c=>[...c,l]);try{const{data:c}=await D.post(`${M}/api/bookings/${n._id}/comment`,{message:a||"",documentUrl:t,documentName:s.name,documentMimeType:s.type||null,type:"document"},{withCredentials:!0});A(c.comments||((i=c.updated)==null?void 0:i.comments)||((d=c==null?void 0:c.appointment)==null?void 0:d.comments)||[])}catch{u.error("Failed to send document"),A(g=>g.filter(p=>p._id!==r))}},xo=async()=>{var t,s;if(Rt)try{ut(!0);const a=new FormData;a.append("document",Rt);const{data:r}=await D.post(`${M}/api/upload/document`,a,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"},onUploadProgress:l=>{const i=Math.round(l.loaded*100/Math.max(1,l.total||Rt.size));Qe(i)}});await ho(r.documentUrl,Rt,Os),ka(null),Sa(!1),Ra(""),Qe(0)}catch(a){u.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Document upload failed")}finally{ut(!1)}},Bn=t=>{if(m){u.info("Image sending disabled for this appointment status. You can view chat history.");return}if(((B==null?void 0:B.length)||0)+t.length>10){u.error("Maximum 10 images allowed. Please remove some images first.");return}const a=t.filter(l=>l.type.startsWith("image/"));if(a.length===0){u.error("No valid image files found");return}kt(l=>[...l||[],...a]);const r={};a.forEach(l=>{r[l.name]=""}),Lt(l=>({...l,...r})),Ps(!0),u.success(`${a.length} image${a.length>1?"s":""} added successfully!`)},zn=async()=>{var t,s,a,r;if(!(!B||B.length===0)){if(m){u.info("Image sending disabled for this appointment status. You can view chat history.");return}ut(!0),Qe(0),ya(-1),Fs(0),br([]),Mn(!1);try{let l=!1;const i=[];for(let d=0;d<B.length;d++){const c=B[d];ya(d),Fs(0);const g=new FormData;g.append("image",c);const p=new AbortController;Bs.current=p;try{const{data:w}=await D.post(`${M}/api/upload/image`,g,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"},signal:p.signal,onUploadProgress:O=>{if(O.total){const ne=Math.round(O.loaded*100/O.total);Fs(ne);const tt=Math.round((d+ne/100)/B.length*100);Qe(tt)}}});await oo(w.imageUrl,c.name,Ls[c.name]||""),Qe(Math.round((d+1)/B.length*100))}catch(w){if(w.name==="CanceledError"||w.code==="ERR_CANCELED"){l=!0,Mn(!0);break}else i.push(c)}finally{Bs.current===p&&(Bs.current=null)}}i.length&&br(i),!l&&i.length===0&&(kt([]),Lt({}),Je(0),Ps(!1))}catch(l){console.error("File upload error:",l),Tt(((s=(t=l.response)==null?void 0:t.data)==null?void 0:s.message)||"Upload failed. Please try again."),u.error(((r=(a=l.response)==null?void 0:a.data)==null?void 0:r.message)||"Upload failed. Please try again."),setTimeout(()=>Tt(""),3e3)}finally{ut(!1),Qe(0),ya(-1),Fs(0)}}},Tr=()=>{if(Bs.current)try{Bs.current.abort()}catch{}ut(!1),ya(-1),Fs(0)},go=async()=>{ms.length&&(kt(ms),br([]),await zn())},fo=async()=>{var t,s;if(!Rs||!er){u.error("Please fill in both password fields");return}if(Rs!==er){u.error("Passwords do not match");return}if(Rs.length<4){u.error("Password must be at least 4 characters long");return}tn(!0);try{const{data:a}=await D.patch(`${M}/api/bookings/${n._id}/chat/lock`,{password:Rs},{withCredentials:!0,headers:{"Content-Type":"application/json"}});oa(!0),as(!1),Wa(!1),Xa(""),tr(""),u.success("Chat locked successfully.")}catch(a){u.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to lock chat")}finally{tn(!1)}},On=async()=>{var t,s;if(!sr){u.error("Please enter your password");return}an(!0);try{const{data:a}=await D.patch(`${M}/api/bookings/${n._id}/chat/unlock`,{password:sr},{withCredentials:!0,headers:{"Content-Type":"application/json"}});as(!0),rs(!1),ar(""),u.success("Chat access granted."),Ke(!0),window.dispatchEvent(new CustomEvent("chatOpened",{detail:{appointmentId:n._id}})),Y&&Y()}catch(a){u.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Incorrect password")}finally{an(!1)}},Un=async()=>{var t,s;if(!rr){u.error("Please enter your password");return}nn(!0);try{const{data:a}=await D.patch(`${M}/api/bookings/${n._id}/chat/remove-lock`,{password:rr},{withCredentials:!0,headers:{"Content-Type":"application/json"}});oa(!1),as(!1),Za(!1),nr(""),ir(!1),u.success("Chat lock removed.")}catch(a){u.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Incorrect password")}finally{nn(!1)}},po=async()=>{var t,s;on(!0);try{const{data:a}=await D.patch(`${M}/api/bookings/${n._id}/chat/forgot-password`,{},{withCredentials:!0});oa(!1),as(!1),Qa(!1),A([]),u.success("Chat lock removed and cleared successfully.")}catch(a){u.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to reset chat")}finally{on(!1)}},bo=async()=>{if(Ke(!1),window.dispatchEvent(new CustomEvent("chatClosed")),ve&&ss)try{await D.patch(`${M}/api/bookings/${n._id}/chat/reset-access`,{},{withCredentials:!0}),as(!1)}catch(t){console.error("Error resetting chat access:",t)}};o.useEffect(()=>{(async()=>{Jr(!0);try{const{data:s}=await D.get(`${M}/api/bookings/${n._id}/chat/lock-status`,{withCredentials:!0});oa(s.chatLocked),as(s.accessGranted)}catch(s){console.error("Error fetching chat lock status:",s)}finally{Jr(!1)}})()},[n._id]),o.useEffect(()=>{if($.length>0){const t=$.filter(s=>s.starredBy&&s.starredBy.includes(h._id));It(t)}},[$,h._id]),o.useEffect(()=>{if($.length>0){const t=new Date,s=$.filter(a=>!a.pinned||!a.pinExpiresAt?!1:new Date(a.pinExpiresAt)>t);Ds(s)}},[$]),o.useEffect(()=>{n!=null&&n._id&&$.length>0&&jo()},[n._id,$.length]),o.useEffect(()=>{if(ce){const t=setTimeout(()=>Zt(!1),1e4);return()=>clearTimeout(t)}},[ce]);const Hn=async()=>{if(n!=null&&n._id){bn(!0);try{const{data:t}=await D.get(`${M}/api/bookings/${n._id}/starred-messages`,{withCredentials:!0});t.starredMessages&&It(t.starredMessages)}catch(t){console.error("Error fetching starred messages:",t),u.error("Failed to load starred messages")}finally{bn(!1)}}};o.useEffect(()=>{cr&&Hn()},[cr,n._id]);const yo=async()=>{if(it.length!==0){it.length,jn(!0);try{console.log("Starting remove all starred messages operation for",it.length,"messages");let t=0,s=0;const a=[];for(const r of it)try{console.log(`Unstarring message ${r._id}`);const l=await D.patch(`${M}/api/bookings/${n._id}/comment/${r._id}/star`,{starred:!1},{withCredentials:!0,headers:{"Content-Type":"application/json"}});console.log(`Successfully unstarred message ${r._id}`),t++,A(i=>i.map(d=>d._id===r._id?{...d,starredBy:(d.starredBy||[]).filter(c=>c!==h._id)}:d))}catch(l){console.error(`Failed to unstar message ${r._id}:`,l),s++,a.push(r)}console.log(`Remove all operation completed: ${t} successful, ${s} failed`),It(r=>r.filter(l=>!a.some(i=>i._id===l._id))),t>0&&s===0?(u.success(`Successfully removed ${t} starred message${t!==1?"s":""}`),ua(!1)):t>0&&s>0?u.warning(`Partially successful: ${t} messages unstarred, ${s} failed`):u.error("Failed to unstar any messages. Please try again.")}catch(t){console.error("Error removing all starred messages:",t),u.error("Failed to remove all starred messages. Please try again.")}finally{jn(!1)}}};o.useEffect(()=>{const t=l=>{$s&&!l.target.closest(".chat-options-menu")&&Me(!1),ca&&!l.target.closest(".chat-options-menu")&&je(!1),ls&&!l.target.closest(".reactions-bar")&&(As(!1),Ms(null))},s=()=>{$s&&Me(!1),ca&&je(!1),ls&&!os&&(As(!1),Ms(null))},a=l=>{gr&&!l.target.closest(".search-container")&&!l.target.closest(".enhanced-search-header")&&(fa(!1),pa(""),Es([]),ct(-1))},r=l=>{ba&&!l.target.closest(".calendar-container")&&Ts(!1)};return document.addEventListener("mousedown",t),document.addEventListener("mousedown",a),document.addEventListener("mousedown",r),document.addEventListener("scroll",s,!0),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("mousedown",a),document.removeEventListener("mousedown",r),document.removeEventListener("scroll",s,!0)}},[$s,ca,gr,ba,ls,os]),o.useEffect(()=>{if(dr){const t=setTimeout(()=>{xn(!1),gn(!0);const s=setTimeout(()=>gn(!1),1e3);return()=>clearTimeout(s)},800);return()=>clearTimeout(t)}},[dr]),o.useEffect(()=>{Is>=0&&dt[Is]&&Yn(dt[Is]._id)},[Is,dt]),o.useEffect(()=>{const t=I.current;if(!t)return;const s=()=>{if(t.scrollTop<=0&&$.length>Dt){const a=t.scrollHeight;xt(r=>Math.min(r+Yt,$.length)),setTimeout(()=>{const r=t.scrollHeight;t.scrollTop=r-a},0)}};return t.addEventListener("scroll",s),()=>t.removeEventListener("scroll",s)},[$.length,Dt]),o.useEffect(()=>{if(!E)return;const t=$.filter(r=>r.senderEmail!==h.email&&(!r.readBy||!r.readBy.includes(h._id))).length,a=ht||$e===n._id?U||t:U;a>0?(xt(r=>Math.max(Yt,U+5)),setTimeout(()=>{const r=Math.max(0,ee.length-a),l=ee[r];if(l&&Ue.current[l._id])try{Ue.current[l._id].scrollIntoView({behavior:"auto",block:"center"})}catch{}ea(!0),Pa(!1),$e===n._id&&setPreferUnreadForAppointmentId(null)},50)):(xt(Yt),setTimeout(()=>Jn(),0))},[n._id,E]),o.useEffect(()=>{if(!E)return;const t=I.current;if(!t)return;const s=()=>{Re&&ea(!1)};return t.addEventListener("scroll",s,{passive:!0}),()=>t.removeEventListener("scroll",s)},[E,Re]);function qs(t){try{return JSON.parse(localStorage.getItem(`removedDeletedMsgs_${t}`))||[]}catch{return[]}}function Ys(t,s){const a=qs(t);if(!a.includes(s)){const r=[...a,s];localStorage.setItem(`removedDeletedMsgs_${t}`,JSON.stringify(r))}}const wo=()=>{if(k){const s=qs(n._id).filter(a=>a!==k._id);localStorage.setItem(`removedDeletedMsgs_${n._id}`,JSON.stringify(s)),A(a=>{const r=[...a],l=r.findIndex(i=>new Date(i.timestamp)>new Date(k.timestamp));return l===-1?r.push(k):r.splice(l,0,k),r}),P(null),R&&(clearTimeout(R),oe(null)),u.success("Message restored!")}},Vn=t=>{R&&clearTimeout(R),P(t);const s=setTimeout(()=>{P(null),oe(null)},5e3);oe(s)},vo=async()=>{try{Jt(!0);const{data:t}=await D.get(`${M}/api/bookings/${n._id}`,{withCredentials:!0});t.comments&&(A(s=>{const a=new Set(t.comments.map(i=>i._id)),r=s.filter(i=>i._id.startsWith("temp-")),l=[...t.comments];return r.forEach(i=>{a.has(i._id)||l.push(i)}),l}),K(0),u.success("Messages refreshed successfully!",{autoClose:2e3,position:"top-center"}))}catch(t){console.error("Error fetching latest comments:",t),u.error("Failed to refresh messages")}finally{Jt(!1)}},jo=async()=>{if(n!=null&&n._id){Nn(!0);try{const{data:t}=await D.get(`${M}/api/bookings/${n._id}/pinned-messages`,{withCredentials:!0});Ds(t.pinnedMessages||[])}catch{u.error("Failed to fetch pinned messages")}finally{Nn(!1)}}},Aa=async(t,s,a="24hrs",r=24)=>{if(n!=null&&n._id){ha(!0);try{const{data:l}=await D.patch(`${M}/api/bookings/${n._id}/comment/${t._id}/pin`,{pinned:s,pinDuration:a,customHours:a==="custom"?r:void 0},{withCredentials:!0,headers:{"Content-Type":"application/json"}});if(A(i=>i.map(d=>d._id===t._id?{...d,pinned:l.pinned,pinnedBy:l.pinned?h._id:null,pinnedAt:l.pinned?new Date:null,pinExpiresAt:l.pinned?new Date(l.pinExpiresAt):null,pinDuration:l.pinned?a:null}:d)),s){const i={...t,pinned:!0,pinnedBy:h._id,pinnedAt:new Date,pinExpiresAt:new Date(l.pinExpiresAt),pinDuration:a};Ds(d=>[...d,i])}else Ds(i=>i.filter(d=>d._id!==t._id));u.success(l.message),is(!1),ds(null)}catch{u.error("Failed to update pin status")}finally{ha(!1)}}},Ws=(h.role==="admin"||h.role==="rootadmin")&&h.adminApprovalStatus==="approved",No=qt.pathname.includes("/admin"),Le=n.role==="seller",Bt=n.role==="buyer",Ks=new Date(n.date)>new Date||new Date(n.date).toDateString()===new Date().toDateString()&&(!n.time||n.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),m=!Ks||n.status==="rejected"||n.status==="cancelledByAdmin"||n.status==="cancelledByBuyer"||n.status==="cancelledBySeller"||n.status==="deletedByAdmin",Gs=n.status==="pending"||n.status==="rejected"||n.status==="cancelledByAdmin"||n.status==="cancelledByBuyer"||n.status==="cancelledBySeller"||n.status==="deletedByAdmin",Lr=(Ws||n.status==="accepted")&&Ks&&n.status!=="cancelledByBuyer"&&n.status!=="cancelledBySeller"&&n.status!=="cancelledByAdmin"&&n.status!=="rejected"&&n.status!=="deletedByAdmin",v=Le?n.buyerId:n.sellerId,Co=t=>{Ze(t),f(!m),st(!0)},ko=t=>{Ze(t),f(!1),st(!0)},So=async()=>{var t,s,a,r,l,i,d;if(T){try{if(Array.isArray(T)){const c=T.map(g=>g._id);if(x)try{const{data:g}=await D.delete(`${M}/api/bookings/${n._id}/comments/bulk-delete`,{withCredentials:!0,headers:{"Content-Type":"application/json"},data:{commentIds:c}});g!=null&&g.comments&&A(p=>g.comments.map(w=>{const O=p.find(ne=>ne._id===w._id);return O&&O.status==="read"&&w.status!=="read"?{...w,status:"read"}:w})),u.success(`Deleted ${c.length} messages for everyone!`)}catch(g){u.error(((s=(t=g.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to delete selected messages.");return}else try{await D.post(`${M}/api/bookings/${n._id}/comments/removed/sync`,{removedIds:c},{withCredentials:!0,headers:{"Content-Type":"application/json"}}),A(g=>g.filter(p=>!c.includes(p._id))),c.forEach(g=>Ys(n._id,g)),T.length>0&&Vn(T[0]),u.success(`Deleted ${c.length} messages for you!`)}catch(g){u.error(((r=(a=g.response)==null?void 0:a.data)==null?void 0:r.message)||"Failed to delete selected messages for you.");return}}else if(x){const c=!((l=T.readBy)!=null&&l.includes(h._id))&&T.senderEmail!==h.email,{data:g}=await D.delete(`${M}/api/bookings/${n._id}/comment/${T._id}`,{withCredentials:!0});A(p=>g.comments.map(w=>{const O=p.find(ne=>ne._id===w._id);return O&&O.status==="read"&&w.status!=="read"?{...w,status:"read"}:w})),c&&K(p=>Math.max(0,p-1)),u.success("Message deleted for everyone!")}else{try{await D.patch(`${M}/api/bookings/${n._id}/comment/${T._id}/remove-for-me`,{},{withCredentials:!0})}catch{}A(c=>c.filter(g=>g._id!==T._id)),Ys(n._id,T._id),Vn(T),u.success("Message deleted for you!")}}catch(c){u.error(((d=(i=c.response)==null?void 0:i.data)==null?void 0:d.message)||"An error occurred. Please try again.")}st(!1),Ze(null),f(!0)}},_o=async()=>{var t,s;try{const a=Date.now();localStorage.setItem(Qn,a),A([]),await D.patch(`${M}/api/bookings/${n._id}/chat/clear-local`,{},{withCredentials:!0}),u.success("Chat Cleared.")}catch(a){console.error("Failed to persist chat clear:",a),u.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Cleared locally, but failed to sync with server.")}finally{C(!1)}},Ro=t=>{hn(t),mn(!0)},Pr=async()=>{if(!F.trim())return;if(m){u.info("Sending disabled for this appointment status. You can view chat history.");return}window.dispatchEvent(new Event("closeEmojiPicker")),xn(!0);const t=F.trim(),s=be,a=`temp-${Date.now()}`,r={_id:a,sender:h._id,senderEmail:h.email,senderName:h.username,message:t,status:"sending",timestamp:new Date().toISOString(),readBy:[h._id],previewDismissed:Ul,...s?{replyTo:s._id}:{}};A(i=>[...i,r]),H("");try{const i=`appt_draft_${n._id}_${h._id}`;localStorage.removeItem(i)}catch{}hs(null),xs(!1),ae(null),Mo();const l=()=>{y.current&&(y.current.focus(),y.current.setSelectionRange(0,0),document.activeElement!==y.current&&(y.current.click(),y.current.focus()))};l(),requestAnimationFrame(l),setTimeout(l,10),X.current&&X.current.scrollIntoView({behavior:"smooth"}),(async()=>{var i,d;try{const{data:c}=await D.post(`${M}/api/bookings/${n._id}/comment`,{message:t,...s?{replyTo:s._id}:{}},{withCredentials:!0,headers:{"Content-Type":"application/json"}}),g=c.comments[c.comments.length-1];A(p=>p.map(w=>w._id===a?{...w,_id:g._id,status:g.status,readBy:g.readBy||w.readBy,timestamp:g.timestamp||w.timestamp}:w)),Xl()}catch(c){A(p=>p.filter(w=>w._id!==a)),u.error(((d=(i=c.response)==null?void 0:i.data)==null?void 0:d.message)||"An error occurred. Please try again.");const g=()=>{y.current&&(y.current.focus(),y.current.setSelectionRange(0,0),document.activeElement!==y.current&&(y.current.click(),y.current.focus()))};g(),requestAnimationFrame(g)}})()},Fr=async t=>{var a,r;if(!_e.trim())return;ye(t),A(l=>l.map(i=>i._id===t?{...i,message:_e,edited:!0,editedAt:new Date}:i));try{const{data:l}=await D.patch(`${M}/api/bookings/${n._id}/comment/${t}`,{message:_e},{withCredentials:!0,headers:{"Content-Type":"application/json"}});A(c=>c.map(g=>{const p=l.comments.find(w=>w._id===g._id);return p?p._id===t?p:g.status==="read"&&p.status!=="read"?{...p,status:"read"}:p:g})),Ye(null),q(""),H(We),setTimeout(()=>{se("")},100),hs(null),xs(!1),setTimeout(()=>{if(y.current){const c=new Event("input",{bubbles:!0});y.current.dispatchEvent(c),Ma(y.current)}},50);const d=()=>{if(y.current){y.current.focus();const c=y.current.value.length;y.current.setSelectionRange(c,c),y.current.style.height="48px";const g=y.current.scrollHeight,p=144;y.current.style.height=Math.min(g,p)+"px"}};d(),requestAnimationFrame(d),setTimeout(d,10),u.success("Message edited successfully!")}catch(l){A(i=>i.map(d=>d._id===t?{...d,message:d.originalMessage||d.message,edited:d.wasEdited||!1}:d)),Ye(t),q(_e),H(_e),u.error(((r=(a=l.response)==null?void 0:a.data)==null?void 0:r.message)||"An error occurred. Please try again.")}finally{ye(null)}},Ao=t=>{se(F),Ye(t._id),q(t.message),H(t.message),A(s=>s.map(a=>a._id===t._id?{...a,originalMessage:a.message,wasEdited:a.edited}:a)),setTimeout(()=>{if(y.current){y.current.focus();const s=y.current.value.length;y.current.setSelectionRange(s,s),Ma(y.current)}},100)},Ma=t=>{if(t){t.style.height="48px";const s=t.scrollHeight,a=144;s<=a?(t.style.height=s+"px",t.style.overflowY="hidden"):(t.style.height=a+"px",t.style.overflowY="auto")}},Mo=()=>{y.current&&(y.current.style.height="48px",y.current.style.overflowY="hidden")},qn=t=>{ae(t);const s=()=>{if(y.current){y.current.focus();const a=y.current.value.length;y.current.setSelectionRange(a,a),document.activeElement!==y.current&&(y.current.click(),y.current.focus()),Ma(y.current)}};setTimeout(s,50),setTimeout(s,100),setTimeout(s,200)},Do=t=>{switch(t){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-orange-100 text-orange-700";case"cancelledBySeller":return"bg-pink-100 text-pink-700";case"cancelledByAdmin":return"bg-purple-100 text-purple-700";default:return"bg-gray-100 text-gray-700"}},$o=t=>{if(!t.trim()){Es([]),ct(-1),document.querySelectorAll(".search-highlight").forEach(r=>{r.classList.remove("search-highlight","search-pulse","search-glow")}),document.querySelectorAll(".search-text-highlight").forEach(r=>{r.outerHTML=r.innerHTML});return}const a=$.filter(r=>{var d,c;const l=r.clearTime||0,i=Math.max(l,0);return new Date(r.timestamp).getTime()>i&&!Da.includes(r._id)&&!((c=(d=r.removedFor)==null?void 0:d.includes)!=null&&c.call(d,h._id))}).filter(r=>!r.deleted).filter(r=>{var l,i;return r.message.toLowerCase().includes(t.toLowerCase())||((l=r.senderName)==null?void 0:l.toLowerCase().includes(t.toLowerCase()))||((i=r.senderEmail)==null?void 0:i.toLowerCase().includes(t.toLowerCase()))}).map(r=>({...r,matchIndex:r.message.toLowerCase().indexOf(t.toLowerCase())}));Es(a),a.length>0?(ct(0),setTimeout(()=>{Yn(a[0]._id)},100)):ct(-1)},Eo=t=>{const s=t.target.value;pa(s),$o(s)},Io=t=>{t.key==="Enter"?(t.preventDefault(),dt.length>0&&ct(s=>s<dt.length-1?s+1:0)):t.key==="Escape"&&(fa(!1),pa(""),Es([]),ct(-1),document.querySelectorAll(".search-text-highlight").forEach(s=>{s.outerHTML=s.innerHTML}))},Yn=t=>{const s=Ue.current[t];s&&(s.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{document.querySelectorAll(".search-highlight").forEach(r=>{r.classList.remove("search-highlight","search-pulse","search-glow")}),s.classList.add("search-highlight","search-pulse","search-glow");const a=document.createElement("div");a.className="search-ripple",s.style.position="relative",s.appendChild(a),setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},1e3),setTimeout(()=>{s.classList.remove("search-highlight","search-pulse","search-glow")},3e3)},300))},To=t=>{Pl(t),Ts(!1);const s=$.filter(i=>{var g,p;const d=i.clearTime||0,c=Math.max(d,0);return new Date(i.timestamp).getTime()>c&&!Da.includes(i._id)&&!((p=(g=i.removedFor)==null?void 0:g.includes)!=null&&p.call(g,h._id))}),r=new Date(t).toDateString(),l=s.find(i=>new Date(i.timestamp).toDateString()===r);if(l){const i=Ue.current[l._id];i&&(i.classList.add("date-jump-preparing"),i.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{i.classList.remove("date-jump-preparing"),Sn(l._id),i.classList.add("date-highlight","date-jump-pulse");const d=document.createElement("div");d.className="date-jump-ripple",i.style.position="relative",i.appendChild(d),setTimeout(()=>{d.parentNode&&d.parentNode.removeChild(d)},1e3),setTimeout(()=>{i.classList.remove("date-highlight","date-jump-pulse"),Sn(null)},4e3)},500))}else u.info("No messages found for the selected date in visible chat",{position:"top-center",autoClose:3e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0})},Lo=t=>{const s=new Date(t),a=s.getFullYear(),r=String(s.getMonth()+1).padStart(2,"0"),l=String(s.getDate()).padStart(2,"0");return`${a}-${r}-${l}`},Wn=async()=>{vt(""),Ua(!0)},Po=async()=>{var t,s,a;if(!ns.trim()){u.error("Reason is required for cancellation.");return}try{const{data:r}=await D.patch(`${M}/api/bookings/${n._id}/cancel`,{reason:ns},{withCredentials:!0,headers:{"Content-Type":"application/json"}});u.success("Appointment cancelled successfully."),typeof fe=="function"&&fe(n._id,Le?"cancelledBySeller":"cancelledByBuyer"),Ua(!1),vt("")}catch(r){if(((t=r.response)==null?void 0:t.status)===401){u.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}u.error(((a=(s=r.response)==null?void 0:s.data)==null?void 0:a.message)||"An error occurred. Please try again.")}},Fo=async()=>{vt(""),Ha(!0)},Bo=async()=>{var t,s,a;if(!ns.trim()){u.error("Reason is required for admin cancellation.");return}try{const{data:r}=await D.patch(`${M}/api/bookings/${n._id}/cancel`,{reason:ns},{withCredentials:!0,headers:{"Content-Type":"application/json"}});u.success("Appointment cancelled by admin."),navigate("/user/my-appointments"),Ha(!1),vt("")}catch(r){if(((t=r.response)==null?void 0:t.status)===401){u.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}u.error(((a=(s=r.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to cancel appointment.")}},Br=async()=>{qa(!0)},zo=async()=>{var t,s;try{const a=Bt?"buyer":Le?"seller":null;if(!a)return;const{data:r}=await D.patch(`${M}/api/bookings/${n._id}/soft-delete`,{who:a},{withCredentials:!0,headers:{"Content-Type":"application/json"}});if(typeof window<"u"){const l=new CustomEvent("removeAppointmentRow",{detail:n._id});window.dispatchEvent(l),u.success("Appointment removed from your table successfully.")}qa(!1)}catch(a){u.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to remove appointment from table.")}};o.useEffect(()=>{E&&X.current&&X.current.scrollIntoView({behavior:"smooth"})},[E]);const ke=async(t,s)=>{var a,r;if(m){u.info("Reactions disabled for this appointment status. You can view chat history.");return}try{if(!$.find(d=>d._id===t)){u.error("Message not found");return}const{data:i}=await D.patch(`${M}/api/bookings/${n._id}/comment/${t}/react`,{emoji:s},{withCredentials:!0,headers:{"Content-Type":"application/json"}});A(d=>d.map(c=>c._id===t?{...c,reactions:i.reactions||c.reactions||[]}:c)),Nt(!1),As(!1),Ms(null),u.success("Reaction added!")}catch(l){u.error(((r=(a=l.response)==null?void 0:a.data)==null?void 0:r.message)||"Failed to add reaction")}},Oo=t=>{if(m){u.info("Reactions disabled for this appointment status. You can view chat history.");return}jt===t&&ls?(As(!1),Ms(null),Nt(!1)):(Ms(t),As(!0),Nt(!1))},[Ci,ki]=o.useState("react"),[Si,_i]=o.useState(""),Kn=()=>{Nt(!os)};o.useCallback(t=>{if(os)return t.stopPropagation(),t.preventDefault(),!1},[os]);const zr=o.useRef(!1),ws=o.useCallback(async()=>{var i,d;if(!I.current||zr.current||!(n!=null&&n._id))return;const{scrollTop:t,scrollHeight:s,clientHeight:a}=I.current;if(!(s-t-a<10))return;const l=$.filter(c=>{var g;return!((g=c.readBy)!=null&&g.includes(h._id))&&c.senderEmail!==h.email});if(l.length>0){zr.current=!0;try{const{data:c}=await D.patch(`${M}/api/bookings/${n._id}/comments/read`,{},{withCredentials:!0,headers:{"Content-Type":"application/json"}});A(g=>g.map(p=>l.some(w=>w._id===p._id)?{...p,readBy:[...p.readBy||[],h._id],status:"read"}:p)),l.forEach(g=>{z.emit("messageRead",{appointmentId:n._id,messageId:g._id,userId:h._id,readBy:h._id})}),K(g=>Math.max(0,g-l.length))}catch(c){((i=c.response)==null?void 0:i.status)!==500?console.error("Error marking messages as read:",c):console.warn("Server error marking messages as read (will retry later):",(d=c.response)==null?void 0:d.status)}finally{zr.current=!1}}},[$,h._id,n._id,z]),Gn=o.useRef($.length),Uo=o.useRef($);o.useEffect(()=>{const t=$.slice(Gn.current),s=t.length;if(Gn.current=$.length,Uo.current=$,s>0&&E){const a=t.some(l=>l.senderEmail===h.email),r=t.filter(l=>l.senderEmail!==h.email);a||_?setTimeout(()=>{X.current&&(X.current.scrollIntoView({behavior:"smooth"}),_&&r.length>0&&setTimeout(()=>{ws()},300))},100):r.length>0&&K(l=>l+r.length)}},[$.length,_,E,h.email,ws]);const Zn=o.useCallback(()=>{if(I.current){const{scrollTop:t,scrollHeight:s,clientHeight:a}=I.current,r=s-t-a<10;ge(r),r&&($.filter(i=>{var d;return!((d=i.readBy)!=null&&d.includes(h._id))&&i.senderEmail!==h.email}).length>0&&ws(),U>0&&K(0))}},[U,ws,$,h._id]),Or=o.useCallback(()=>{if(!I.current||$.length===0)return;const t=`chatClearTime_${n._id}`,s=Number(localStorage.getItem(t))||0,a=(()=>{const w=n.role==="buyer"?n.buyerChatClearedAt:n.sellerChatClearedAt;return w?new Date(w).getTime():0})(),r=Math.max(s,a),l=qs(n._id),i=$.filter(w=>new Date(w.timestamp).getTime()>r&&!l.includes(w._id));if(i.length===0)return;const c=I.current.getBoundingClientRect(),g=c.top+60;let p="";for(let w=0;w<i.length;w++){const O=Ue.current[i[w]._id];if(O){const ne=O.getBoundingClientRect();if(ne.top>=g&&ne.bottom<=c.bottom){const tt=new Date(i[w].timestamp);p=Yr(tt);break}}}if(!p)for(let w=0;w<i.length;w++){const O=Ue.current[i[w]._id];if(O&&O.getBoundingClientRect().bottom>g){const tt=new Date(i[w].timestamp);p=Yr(tt);break}}p&&p!==gt&&Ns(p)},[$,gt,n._id]);o.useEffect(()=>{const t=I.current;if(t&&E){const s=()=>{Zn(),Or(),Ge(!0),bt.current&&clearTimeout(bt.current),bt.current=setTimeout(()=>{Ge(!1)},1e3)};if(t.addEventListener("scroll",s),t){const{scrollTop:a,scrollHeight:r,clientHeight:l}=t,i=r-a-l<10;ge(i)}return setTimeout(Or,100),()=>{t.removeEventListener("scroll",s),bt.current&&clearTimeout(bt.current)}}},[E,Zn,Or]),o.useEffect(()=>{E&&X.current&&X.current.scrollIntoView({behavior:"smooth"})},[E]);const Jn=o.useCallback(()=>{X.current&&(X.current.scrollIntoView({behavior:"smooth"}),K(0),setTimeout(()=>{ws()},500))},[ws]);o.useEffect(()=>{function t(r){r.appointmentId===n._id&&A(l=>{var d;const i=l.findIndex(c=>c._id===r.comment._id);if(i!==-1){const c=[...l],g=l[i],p=r.comment;let w=p.status;return g.status==="read"&&p.status!=="read"&&(w="read"),c[i]={...p,status:w},c}else return!l.some(g=>g._id.toString().startsWith("temp-"))||r.comment.senderEmail!==h.email?(r.comment.senderEmail!==h.email&&!E&&!((d=r.comment.readBy)!=null&&d.includes(h._id))?K(g=>g+1):Ln(),[...l,r.comment]):l})}function s({appointmentId:r,clearedAt:l}){if(r===n._id){try{const i=`chatClearTime_${n._id}`,d=Number(localStorage.getItem(i))||0,c=l?new Date(l).getTime():0,g=Math.max(d,c);localStorage.setItem(i,String(g))}catch{}A([]),K(0)}}function a({appointmentId:r,commentId:l}){r===n._id&&(A(i=>i.filter(d=>d._id!==l)),Ys(n._id,l))}return z.on("commentUpdate",t),z.on("chatClearedForUser",s),z.on("commentRemovedForUser",a),()=>{z.off("commentUpdate",t),z.off("chatClearedForUser",s),z.off("commentRemovedForUser",a)}},[n._id,h.email,h._id,E,eo,Ln]),o.useEffect(()=>(E?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[E]),o.useEffect(()=>{E&&(n!=null&&n._id)&&D.patch(`${M}/api/bookings/${n._id}/comments/read`,{},{withCredentials:!0}).catch(t=>{var s,a;((s=t.response)==null?void 0:s.status)!==500?console.warn("Error marking comments as read on modal open:",t):console.warn("Server error marking comments as read on modal open (will retry later):",(a=t.response)==null?void 0:a.status)})},[E,n._id]),o.useEffect(()=>{function t(a){a.appointmentId===n._id&&A(r=>r.map(l=>l._id===a.commentId?{...l,status:l.status==="read"?"read":"delivered",deliveredAt:new Date}:l))}function s(a){a.appointmentId===n._id&&A(r=>r.map(l=>{var i;return(i=l.readBy)!=null&&i.includes(a.userId)?l:{...l,status:"read",readBy:[...l.readBy||[],a.userId],readAt:new Date}}))}return z.on("commentDelivered",t),z.on("commentRead",s),()=>{z.off("commentDelivered",t),z.off("commentRead",s)}},[n._id,A]);const Qn=`chatClearTime_${n._id}`,Ho=Number(localStorage.getItem(Qn))||0,Vo=(()=>{const t=n.role==="buyer"?n.buyerChatClearedAt:n.sellerChatClearedAt;return t?new Date(t).getTime():0})(),Ur=Math.max(Ho,Vo),Da=qs(n._id),Pe=$.filter(t=>{var s,a,r;return!((s=t.readBy)!=null&&s.includes(h._id))&&t.senderEmail!==h.email&&!t.deleted&&new Date(t.timestamp).getTime()>Ur&&!((r=(a=t.removedFor)==null?void 0:a.includes)!=null&&r.call(a,h._id))&&!Da.includes(t._id)}).length;o.useEffect(()=>{E&&U===0&&Pe>0&&K(Pe)},[E,Pe,U]),o.useEffect(()=>{!E&&Pe>0&&K(Pe)},[Pe,E]),o.useEffect(()=>{$.length>0&&Pe>0&&U===0&&K(Pe)},[$,Pe,U]),o.useEffect(()=>{(async()=>{if($.length>0&&U===0){const s=$.filter(a=>{var r,l,i;return!((r=a.readBy)!=null&&r.includes(h._id))&&a.senderEmail!==h.email&&!a.deleted&&new Date(a.timestamp).getTime()>Ur&&!((i=(l=a.removedFor)==null?void 0:l.includes)!=null&&i.call(l,h._id))&&!qs(n._id).includes(a._id)}).length;s>0&&K(s)}})()},[$,h._id,n._id,U]),o.useEffect(()=>(E?document.body.style.overflow="hidden":(document.body.style.overflow="",Pe>0?K(Pe):K(0)),()=>{document.body.style.overflow=""}),[E,Pe]);const ee=$.filter(t=>{var s,a;return new Date(t.timestamp).getTime()>Ur&&!Da.includes(t._id)&&!((a=(s=t.removedFor)==null?void 0:s.includes)!=null&&a.call(s,h._id))});o.useEffect(()=>{if(!E||!(v!=null&&v._id))return;z.emit("checkUserOnline",{userId:v._id});function t(s){s.userId===v._id&&(Cs(!!s.online),Kt(s.lastSeen||null))}return z.on("userOnlineStatus",t),z.on("userOnlineUpdate",t),()=>{z.off("userOnlineStatus",t),z.off("userOnlineUpdate",t)}},[E,v==null?void 0:v._id]),o.useEffect(()=>{if(!(v!=null&&v._id))return;z.emit("checkUserOnline",{userId:v._id});function t(s){s.userId===v._id&&(Wt(!!s.online),aa(s.lastSeen||null))}return z.on("userOnlineStatus",t),z.on("userOnlineUpdate",t),()=>{z.off("userOnlineStatus",t),z.off("userOnlineUpdate",t)}},[v==null?void 0:v._id]),o.useEffect(()=>{function t(s){s.fromUserId===(v==null?void 0:v._id)&&s.appointmentId===n._id&&(Gt(!0),Ee.current&&clearTimeout(Ee.current),Ee.current=setTimeout(()=>Gt(!1),1e3))}return z.on("typing",t),()=>{z.off("typing",t),Ee.current&&clearTimeout(Ee.current)}},[v==null?void 0:v._id,n._id]),o.useEffect(()=>{if(!E)return;setTimeout(()=>{y.current&&ri(y.current,y.current.value.length)},100);const s=a=>{a.ctrlKey&&a.key==="f"?(a.preventDefault(),y.current&&ni(y.current,y.current.value.length)):a.key==="Escape"&&(a.preventDefault(),Ke(!1))};return document.addEventListener("keydown",s),()=>{document.removeEventListener("keydown",s)}},[E]);function Xn(t){if(!t)return null;const s=new Date(t),a=new Date,r=Math.floor((a-s)/(1e3*60)),l=Math.floor(r/60),i=Math.floor(l/24);return r<1?"last seen just now":r<60?`last seen ${r} minute${r>1?"s":""} ago`:l<24?`last seen ${l} hour${l>1?"s":""} ago`:i<7?`last seen ${i} day${i>1?"s":""} ago`:`last seen ${s.toLocaleDateString("en-US",{month:"short",day:"numeric",year:s.getFullYear()!==a.getFullYear()?"numeric":void 0})}`}const S=da?$.find(t=>t._id===da):null;return e.jsxs(e.Fragment,{children:[e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${Ks?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(n.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:n.time}),!Ks&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"}),J&&n.archivedAt&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Archived: ",new Date(n.archivedAt).toLocaleDateString("en-GB")]})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:n.listingId?e.jsx(Wr,{to:No?`/admin/listing/${n.listingId._id}`:`/user/listing/${n.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:n.propertyName}):e.jsx("div",{className:"font-semibold",children:n.propertyName})})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${Le?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:Le?"Seller":"Buyer"})}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[Lr?e.jsx("button",{className:"font-semibold text-blue-700 hover:underline text-left",style:{cursor:"pointer"},onClick:()=>mt({...v,isOnline:pt,isTyping:ze,lastSeen:$t},n),title:"Click to view details",children:(v==null?void 0:v.username)||"Unknown"}):e.jsx("span",{className:"font-semibold",children:(v==null?void 0:v.username)||"Unknown"}),Lr?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-gray-600",children:v==null?void 0:v.email}),e.jsx("div",{className:"text-sm text-gray-600",children:v!=null&&v.mobileNumber&&(v==null?void 0:v.mobileNumber)!==""?v.mobileNumber:"No phone"})]}):e.jsx("div",{className:"text-sm text-gray-500 italic",children:Ws?"Contact info available":"Contact info hidden until accepted"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:n.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:n.message||"No message provided"}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${Do(n.status)}`,children:n.status==="cancelledByBuyer"?"Cancelled by Buyer":n.status==="cancelledBySeller"?"Cancelled by Seller":n.status==="cancelledByAdmin"?"Cancelled by Admin":n.status.charAt(0).toUpperCase()+n.status.slice(1)})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx(ci,{appointment:n,isBuyer:Bt})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:J?e.jsx("button",{className:"text-green-600 hover:text-green-800 text-xl",onClick:()=>Be(n._id),title:"Unarchive Appointment",children:e.jsx(Ve,{size:16})}):e.jsx(e.Fragment,{children:Ks?e.jsxs(e.Fragment,{children:[Le&&n.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-green-500 hover:text-green-700 text-xl disabled:opacity-50",onClick:()=>N(n._id,"accepted"),disabled:Vt===n._id+"accepted"||!n.paymentConfirmed,title:n.paymentConfirmed?"Accept Appointment":"Accept enabled after buyer payment",children:e.jsx(Ea,{})}),!n.paymentConfirmed&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl disabled:opacity-50",onClick:()=>N(n._id,"rejected"),disabled:Vt===n._id+"rejected",title:"Reject Appointment",children:e.jsx(te,{})})]}),Le&&n.status==="accepted"&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:Wn,title:"Cancel Appointment (Seller)",children:e.jsx(Z,{})}),Le&&(n.status==="cancelledBySeller"||n.status==="cancelledByBuyer"||n.status==="cancelledByAdmin"||n.status==="rejected"||n.status==="deletedByAdmin")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:Br,title:"Remove from table",style:{opacity:.5},children:e.jsx(Z,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),Bt&&(n.status==="pending"||n.status==="accepted")&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:Wn,title:"Cancel Appointment (Buyer)",children:e.jsx(Z,{})}),Bt&&(n.status==="cancelledByBuyer"||n.status==="cancelledBySeller"||n.status==="cancelledByAdmin"||n.status==="deletedByAdmin"||n.status==="rejected")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:Br,title:"Remove from table",style:{opacity:.5},children:e.jsx(Z,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),Ws&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:Fo,title:"Cancel Appointment (Admin)",children:e.jsx(Sl,{})}),!Ws&&e.jsx("button",{className:"text-gray-600 hover:text-gray-800 text-xl",onClick:()=>qe(n._id),title:"Archive Appointment",children:e.jsx(Qs,{size:16})}),(n.status==="cancelledByBuyer"&&Bt||n.status==="cancelledBySeller"&&Le)&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{className:"text-blue-500 hover:text-blue-700 text-xs border border-blue-500 rounded px-2 py-1 mt-1",onClick:()=>De(n),disabled:n.status==="cancelledByBuyer"&&Bt&&(n.buyerReinitiationCount||0)>=2||n.status==="cancelledBySeller"&&Le&&(n.sellerReinitiationCount||0)>=2||!n.buyerId||!n.sellerId,title:"Reinitiate or Reschedule Appointment",children:"Reinitiate"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:Bt&&n.status==="cancelledByBuyer"?`${2-(n.buyerReinitiationCount||0)} left`:Le&&n.status==="cancelledBySeller"?`${2-(n.sellerReinitiationCount||0)} left`:""})]})]}):e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:Br,title:"Delete outdated appointment from table",style:{opacity:.7},children:e.jsx(Z,{size:18})}),!Ws&&e.jsx("button",{className:"text-gray-600 hover:text-gray-800 text-xl",onClick:()=>qe(n._id),title:"Archive outdated appointment",children:e.jsx(Qs,{size:16})})]})})})}),e.jsx("td",{className:"border p-2 text-center relative",children:e.jsxs("button",{className:"flex items-center justify-center rounded-full p-3 shadow-lg mx-auto relative transform transition-all duration-200 group bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white hover:shadow-xl hover:scale-105",title:"Open Chat",onClick:()=>{(ve||me)&&!ss?rs(!0):(Ke(!0),window.dispatchEvent(new CustomEvent("chatOpened",{detail:{appointmentId:n._id}})))},children:[e.jsx(pl,{size:22,className:"group-hover:animate-pulse"}),e.jsx("div",{className:"absolute inset-0 bg-white rounded-full opacity-0 group-hover:opacity-20 transition-opacity duration-200"}),(ve||me)&&!ss&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-orange-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:me?"â³":"ðŸ”’"}),ze&&!((ve||me)&&!ss)&&!Gs&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white animate-pulse",children:"..."}),!ze&&U>0&&!((ve||me)&&!ss)&&!Gs&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:U}),!ze&&U===0&&pt&&!((ve||me)&&!ss)&&!Gs&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 border-2 border-white rounded-full w-3 h-3"})]})})]}),E&&e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md flex items-center justify-center z-50 p-4",children:[os&&jt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center z-[999999] animate-fadeIn",onMouseDown:t=>{t.target===t.currentTarget&&Nt(!1)},onClick:t=>{t.target===t.currentTarget&&Nt(!1)},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl border border-gray-200 p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-hidden quick-reactions-modal",onMouseDown:t=>{t.stopPropagation()},onClick:t=>{t.stopPropagation()},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-800",children:"Quick Reactions"}),e.jsx("button",{onMouseDown:t=>{t.stopPropagation(),t.preventDefault()},onClick:t=>{t.stopPropagation(),Nt(!1)},className:"text-gray-500 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors",title:"Close",children:e.jsx(te,{size:16})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[60vh] scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",onMouseDown:t=>{t.stopPropagation()},onClick:t=>{t.stopPropagation()},children:e.jsx("div",{className:"grid grid-cols-10 gap-2",onMouseDown:t=>{t.stopPropagation()},onClick:t=>{t.stopPropagation()},children:["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜‡","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜Œ","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ˜—","ðŸ˜™","ðŸ˜š","ðŸ˜‹","ðŸ˜›","ðŸ˜","ðŸ˜œ","ðŸ¤ª","ðŸ¤¨","ðŸ§","ðŸ¤“","ðŸ˜Ž","ðŸ¤©","ðŸ¥³","ðŸ˜","ðŸ˜’","ðŸ˜ž","ðŸ˜”","ðŸ˜Ÿ","ðŸ˜•","ðŸ™","â˜¹ï¸","ðŸ˜£","ðŸ˜–","ðŸ˜«","ðŸ˜©","ðŸ¥º","ðŸ˜¢","ðŸ˜­","ðŸ˜¤","ðŸ˜ ","ðŸ˜¡","ðŸ¤¬","ðŸ¤¯","ðŸ˜³","ðŸ¥µ","ðŸ¥¶","ðŸ˜±","ðŸ˜¨","ðŸ˜°","ðŸ˜¥","ðŸ˜“","ðŸ¤—","ðŸ¤”","ðŸ¤­","ðŸ¤«","ðŸ¤¥","ðŸ˜¶","ðŸ˜","ðŸ˜‘","ðŸ˜¯","ðŸ˜¦","ðŸ˜§","ðŸ˜®","ðŸ˜²","ðŸ¥±","ðŸ˜´","ðŸ¤¤","ðŸ˜ª","ðŸ˜µ","ðŸ¤","ðŸ¥´","ðŸ¤¢","ðŸ¤®","ðŸ¤§","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤‘","ðŸ¤ ","ðŸ’€","ðŸ‘»","ðŸ‘½","ðŸ‘¾","ðŸ¤–","ðŸ˜ˆ","ðŸ‘¿","ðŸ‘¹","ðŸ‘º","ðŸ’ª","ðŸ¦¾","ðŸ¦¿","ðŸ¦µ","ðŸ¦¶","ðŸ‘‚","ðŸ¦»","ðŸ‘ƒ","ðŸ§ ","ðŸ«€","ðŸ«","ðŸ¦·","ðŸ¦´","ðŸ‘€","ðŸ‘ï¸","ðŸ‘…","ðŸ‘„","ðŸ’‹","ðŸ©¸","ðŸ«‚","ðŸ‘¶","ðŸ‘§","ðŸ§’","ðŸ‘¦","ðŸ‘©","ðŸ§‘","ðŸ‘¨","ðŸ‘µ","ðŸ§“","ðŸ‘´","ðŸ‘®â€â™€ï¸","ðŸ‘®","ðŸ‘®â€â™‚ï¸","ðŸ•µï¸â€â™€ï¸","ðŸ•µï¸","ðŸ•µï¸â€â™‚ï¸","ðŸ‘·â€â™€ï¸","ðŸ‘·","ðŸ‘·â€â™‚ï¸","ðŸ«…","ðŸ¤´","ðŸ‘¸","ðŸ‘³â€â™€ï¸","ðŸ‘³","ðŸ‘³â€â™‚ï¸","ðŸ‘²","ðŸ§•","ðŸ¤µâ€â™€ï¸","ðŸ¤µ","ðŸ¤µâ€â™‚ï¸","ðŸ‘°â€â™€ï¸","ðŸ‘°","ðŸ‘°â€â™‚ï¸","ðŸ¤°","ðŸ¤±","ðŸ‘¼","ðŸŽ…","ðŸ¤¶","ðŸ¦¸â€â™€ï¸","ðŸ¦¸","ðŸ¦¸â€â™‚ï¸","ðŸ¦¹â€â™€ï¸","ðŸ¦¹","ðŸ¦¹â€â™‚ï¸","ðŸ§™â€â™€ï¸","ðŸ§™","ðŸ§™â€â™‚ï¸","ðŸ§šâ€â™€ï¸","ðŸ§š","ðŸ§šâ€â™‚ï¸","ðŸ§›â€â™€ï¸","ðŸ§›","ðŸ§›â€â™‚ï¸","ðŸ§œâ€â™€ï¸","ðŸ§œ","ðŸ§œâ€â™‚ï¸","ðŸ§â€â™€ï¸","ðŸ§","ðŸ§â€â™‚ï¸","ðŸ§žâ€â™€ï¸","ðŸ§ž","ðŸ§žâ€â™‚ï¸","ðŸ§Ÿâ€â™€ï¸","ðŸ§Ÿ","ðŸ§Ÿâ€â™‚ï¸","ðŸ§Œ","ðŸ¶","ðŸ±","ðŸ­","ðŸ¹","ðŸ°","ðŸ¦Š","ðŸ»","ðŸ¼","ðŸ»â€â„ï¸","ðŸ¨","ðŸ¯","ðŸ¦","ðŸ®","ðŸ·","ðŸ¸","ðŸµ","ðŸ™ˆ","ðŸ™‰","ðŸ™Š","ðŸ’","ðŸ”","ðŸ§","ðŸ¦","ðŸ¤","ðŸ£","ðŸ¦†","ðŸ¦…","ðŸ¦‰","ðŸ¦‡","ðŸº","ðŸ—","ðŸ´","ðŸ¦„","ðŸ","ðŸ›","ðŸ¦‹","ðŸŒ","ðŸž","ðŸœ","ðŸ¦Ÿ","ðŸ¦—","ðŸ•·ï¸","ðŸ•¸ï¸","ðŸ¦‚","ðŸ¢","ðŸ","ðŸ¦Ž","ðŸ¦–","ðŸ¦•","ðŸ™","ðŸ¦‘","ðŸ¦","ðŸ¦ž","ðŸ¦€","ðŸ¡","ðŸ ","ðŸŸ","ðŸ¬","ðŸ³","ðŸ‹","ðŸ¦ˆ","ðŸŠ","ðŸ…","ðŸ†","ðŸ¦“","ðŸ¦","ðŸ¦§","ðŸ˜","ðŸ¦›","ðŸ¦","ðŸª","ðŸ«","ðŸ¦™","ðŸ¦’","ðŸƒ","ðŸ‚","ðŸ„","ðŸŽ","ðŸ–","ðŸ","ðŸ‘","ðŸ","ðŸ¦Œ","ðŸ•","ðŸ©","ðŸ¦®","ðŸ•â€ðŸ¦º","ðŸˆ","ðŸˆâ€â¬›","ðŸ“","ðŸ¦ƒ","ðŸ¦š","ðŸ¦œ","ðŸ¦¢","ðŸ¦©","ðŸ•Šï¸","ðŸŽ","ðŸ","ðŸŠ","ðŸ‹","ðŸŒ","ðŸ‰","ðŸ‡","ðŸ“","ðŸ«","ðŸˆ","ðŸ’","ðŸ‘","ðŸ¥­","ðŸ","ðŸ¥¥","ðŸ¥","ðŸ…","ðŸ†","ðŸ¥‘","ðŸ¥¦","ðŸ¥¬","ðŸ¥’","ðŸŒ¶ï¸","ðŸ«‘","ðŸŒ½","ðŸ¥•","ðŸ«’","ðŸ§„","ðŸ§…","ðŸ¥”","ðŸ ","ðŸ¥","ðŸ¥¯","ðŸž","ðŸ¥–","ðŸ¥¨","ðŸ§€","ðŸ¥š","ðŸ³","ðŸ§ˆ","ðŸ¥ž","ðŸ§‡","ðŸ¥“","ðŸ¥©","ðŸ—","ðŸ–","ðŸ¦´","ðŸŒ­","ðŸ”","ðŸŸ","ðŸ•","ðŸ¥ª","ðŸ¥™","ðŸ§†","ðŸŒ®","ðŸŒ¯","ðŸ«”","ðŸ¥—","ðŸ¥˜","ðŸ«•","ðŸ¥«","ðŸ","ðŸœ","ðŸ²","ðŸ›","ðŸ£","ðŸ±","ðŸ¥Ÿ","ðŸ¦ª","ðŸ¤","ðŸ™","ðŸš","ðŸ˜","ðŸ¥","ðŸ¥ ","ðŸ¥®","ðŸ¢","ðŸ¡","ðŸ§","ðŸ¨","ðŸ¦","ðŸ°","ðŸ§","ðŸ¥§","ðŸ®","ðŸ­","ðŸ¬","ðŸ«","ðŸ¿","ðŸª","ðŸŒ°","ðŸ¥œ","ðŸ¯","ðŸ¥›","ðŸ¼","ðŸ«–","âš½","ðŸ€","ðŸˆ","âš¾","ðŸ¥Ž","ðŸŽ¾","ðŸ","ðŸ‰","ðŸ¥","ðŸŽ±","ðŸª€","ðŸ“","ðŸ¸","ðŸ’","ðŸ‘","ðŸ¥","ðŸ","ðŸ¥…","â›³","ðŸª","ðŸ¹","ðŸŽ£","ðŸ¤¿","ðŸ¥Š","ðŸ¥‹","ðŸŽ½","ðŸ›¹","ðŸ›·ï¸","â›¸ï¸","ðŸ¥Œ","ðŸŽ¿","â›·ï¸","ðŸ‚","ðŸª‚","ðŸ‹ï¸â€â™€ï¸","ðŸ‹ï¸","ðŸ‹ï¸â€â™‚ï¸","ðŸ¤¼â€â™€ï¸","ðŸ¤¼","ðŸ¤¼â€â™‚ï¸","ðŸ¤¸â€â™€ï¸","ðŸ¤¸","ðŸ¤¸â€â™‚ï¸","â›¹ï¸â€â™€ï¸","â›¹ï¸","â›¹ï¸â€â™‚ï¸","ðŸ¤º","ðŸ¤¾â€â™€ï¸","ðŸ¤¾","ðŸ¤¾â€â™‚ï¸","ðŸŠâ€â™€ï¸","ðŸŠ","ðŸŠâ€â™‚ï¸","ðŸš£â€â™€ï¸","ðŸš£","ðŸš£â€â™‚ï¸","ðŸ„â€â™€ï¸","ðŸ„","ðŸ„â€â™‚ï¸","ðŸš´â€â™€ï¸","ðŸš´","ðŸš´â€â™‚ï¸","ðŸšµâ€â™€ï¸","ðŸšµ","ðŸšµâ€â™‚ï¸","ðŸ¤¹â€â™€ï¸","ðŸ¤¹","ðŸ¤¹â€â™‚ï¸","ðŸŽ­","ðŸ©°","ðŸŽ¨","ðŸŽ¬","ðŸŽ¤","ðŸŽ§","ðŸŽ¼","ðŸŽ¹","ðŸ¥","ðŸª˜","ðŸŽ·","ðŸŽº","ðŸŽ¸","ðŸª•","ðŸŽ»","ðŸŽ²","â™Ÿï¸","ðŸŽ¯","ðŸŽ³","ðŸŽ®","ðŸŽ°","ðŸ§©","ðŸŽ¨","ðŸ“±","ðŸš—","ðŸš•","ðŸš™","ðŸšŒ","ðŸšŽ","ðŸŽï¸","ðŸš“","ðŸš‘","ðŸš’","ðŸš","ðŸšš","ðŸš›","ðŸšœ","ðŸ›´","ðŸ›µ","ðŸï¸","ðŸš¨","ðŸš”","ðŸš","ðŸš˜","ðŸš–","ðŸš¡","ðŸš ","ðŸšŸ","ðŸšƒ","ðŸš‹","ðŸšž","ðŸš","ðŸš„","ðŸš…","ðŸšˆ","ðŸš‚","ðŸš†","ðŸš‡","ðŸšŠ","ðŸš‰","âœˆï¸","ðŸ›«","ðŸ›¬","ðŸ›©ï¸","ðŸ’º","ðŸ›°ï¸","ðŸš€","ðŸ›¸","ðŸš","ðŸ›¶","â›µ","ðŸš¤","ðŸ›¥ï¸","ðŸ›³ï¸","â›´ï¸","ðŸš¢","âš“","ðŸš§","â›½","ðŸš","ðŸš¦","ðŸš¥","ðŸ—ºï¸","ðŸ—¿","ðŸ—½","ðŸ—¼","ðŸ°","ðŸ¯","ðŸŸï¸","ðŸŽ¡","ðŸŽ¢","ðŸŽ ","â›²","â›±ï¸","ðŸ–ï¸","ðŸï¸","ðŸ”ï¸","ðŸ—»","ðŸŒ‹","ðŸ—¾","ðŸ•ï¸","â›º","ðŸ ","ðŸ¡","ðŸ˜ï¸","ðŸšï¸","ðŸ—ï¸","ðŸ­","ðŸ¢","ðŸ¬","ðŸ£","ðŸ¤","ðŸ¥","ðŸ¦","ðŸ¨","ðŸª","ðŸ«","ðŸ©","ðŸ’’","â›ª","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ–¤","ðŸ¤","ðŸ¤Ž","ðŸ’”","â£ï¸","ðŸ’•","ðŸ’ž","ðŸ’“","ðŸ’—","ðŸ’–","ðŸ’˜","ðŸ’","ðŸ’Ÿ","â˜®ï¸","âœï¸","â˜ªï¸","ðŸ•‰ï¸","â˜¸ï¸","âœ¡ï¸","ðŸ”¯","ðŸ•Ž","â˜¯ï¸","â˜¦ï¸","ðŸ›","â›Ž","â™ˆ","â™‰","â™Š","â™‹","â™Œ","â™","â™Ž","â™","â™","â™‘","â™’","â™“","ðŸ†”","âš›ï¸","ðŸ‰‘","â˜¢ï¸","â˜£ï¸","ðŸ“´","ðŸ“³","ðŸˆ¶","ðŸˆš","ðŸˆ¸","ðŸˆº","ðŸˆ·ï¸","âœ´ï¸","ðŸ†š","ðŸ’®","ðŸ‰","ãŠ™ï¸","ãŠ—ï¸","ðŸˆ´","ðŸˆµ","ðŸˆ¹","ðŸˆ²","ðŸ…°ï¸","ðŸ…±ï¸","ðŸ†Ž","ðŸ†‘","ðŸ…¾ï¸","ðŸ†˜","âŒ","â­•","ðŸ›‘","â›”","ðŸ“›","ðŸš«","ðŸ’¯","ðŸ’¢","â™¨ï¸","ðŸš·","ðŸš¯","ðŸš³","ðŸš±","ðŸ”ž","ðŸ“µ","ðŸš­","â—","â•","â“","â”","â€¼ï¸","â‰ï¸","ðŸ”…","ðŸ”†","ã€½ï¸","ðŸ","ðŸš©","ðŸŽŒ","ðŸ´","ðŸ³ï¸","ðŸ³ï¸â€ðŸŒˆ","ðŸ´â€â˜ ï¸","ðŸ‡¦ðŸ‡«","ðŸ‡¦ðŸ‡±","ðŸ‡©ðŸ‡¿","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‘","ðŸ‘Ž","ðŸ‘Œ","âœŒï¸","ðŸ¤ž","ðŸ¤Ÿ","ðŸ¤˜","ðŸ¤™","ðŸ‘ˆ","ðŸ‘‰","ðŸ‘†","ðŸ–•","ðŸ‘‡","â˜ï¸","ðŸ‘‹","ðŸ¤š","ðŸ–ï¸","âœ‹","ðŸ––","ðŸ‘Œ","ðŸ¤Œ","ðŸ¤","âœŒï¸","ðŸ¤ž","ðŸ¤Ÿ","ðŸ¤˜","ðŸ¤™","ðŸ‘ˆ","ðŸ‘‰","ðŸ‘†","ðŸ–•","ðŸ‘‡","ðŸŽ‰","ðŸŽŠ","ðŸŽˆ","ðŸŽ‚","ðŸŽ","ðŸŽ„","ðŸŽƒ","ðŸŽ—ï¸","ðŸŽŸï¸","ðŸŽ«","ðŸŽ–ï¸","ðŸ†","ðŸ…","ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰","ðŸ”¥","ðŸ’¯","âœ¨","ðŸŒŸ","ðŸ’«","â­","ðŸ’¥","âš¡","ðŸ’¦","ðŸ’¨","â˜ï¸","ðŸŒ¤ï¸","â›…","ðŸŒ¥ï¸","â˜ï¸","ðŸŒ¦ï¸","ðŸŒ§ï¸","â›ˆï¸","ðŸŒ©ï¸","ðŸŒ¨ï¸","â˜ƒï¸","â›„","ðŸŒ¬ï¸","ðŸ’¨","ðŸŒªï¸","ðŸŒ«ï¸","ðŸŒŠ","ðŸ’§","ðŸ’¦","â˜”","â˜‚ï¸","ðŸŒ‚"].map(t=>e.jsx("button",{onMouseDown:s=>{s.stopPropagation(),s.preventDefault()},onClick:s=>{s.stopPropagation(),s.preventDefault(),jt&&n._id?(ke(jt,t),Nt(!1)):u.error("Unable to add reaction - missing message information")},className:"w-10 h-10 flex items-center justify-center text-xl hover:scale-110 transition-all duration-200 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 hover:border-gray-300 hover:shadow-md",title:`React with ${t}`,children:t},t))})})]})}),e.jsxs("div",{className:"bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-3xl shadow-2xl w-full h-full max-w-6xl max-h-full p-0 relative animate-fadeIn flex flex-col border border-gray-200 transform transition-all duration-500 hover:shadow-3xl overflow-hidden",children:[e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2 sm:gap-3 px-4 sm:px-6 py-3 sm:py-4 border-b-2 border-blue-700 bg-gradient-to-r from-blue-700 via-purple-700 to-blue-900 rounded-t-3xl relative shadow-2xl flex-shrink-0 md:sticky md:top-0 sticky top-[env(safe-area-inset-top,0px)] z-30",children:xr?e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-white text-sm cursor-pointer hover:text-blue-200 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:ie.length===ee.length&&ee.length>0,onChange:()=>{ie.length===ee.length?he([]):he([...ee])},className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"}),e.jsx("span",{className:"font-medium",children:"Select All Messages"})]}),e.jsxs("span",{className:"text-white text-sm font-medium",children:["(",ie.length," message",ie.length!==1?"s":""," selected)"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[ie.length===1?e.jsx("div",{className:"flex items-center gap-2",children:(()=>{var a,r,l;const t=ie[0],s=t.senderEmail===h.email;return e.jsxs(e.Fragment,{children:[!t.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{qn(t),Te(!1),he([])},title:"Reply","aria-label":"Reply",children:e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Q(t.message),Te(!1),he([])},title:"Copy message","aria-label":"Copy message",children:e.jsx(Ia,{size:18})}),e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:async()=>{var d,c,g;const i=(d=t.starredBy)==null?void 0:d.includes(h._id);ga(p=>({...p,starring:!0}));try{const{data:p}=await D.patch(`${M}/api/bookings/${n._id}/comment/${t._id}/star`,{starred:!i},{withCredentials:!0,headers:{"Content-Type":"application/json"}});A(w=>w.map(O=>O._id===t._id?{...O,starredBy:i?(O.starredBy||[]).filter(ne=>ne!==h._id):[...O.starredBy||[],h._id]}:O)),u.success(i?"Message unstarred.":"Message starred.")}catch(p){u.error(((g=(c=p.response)==null?void 0:c.data)==null?void 0:g.message)||"Failed to update star status")}finally{ga(p=>({...p,starring:!1}))}Te(!1),he([])},title:(a=t.starredBy)!=null&&a.includes(h._id)?"Unstar message":"Star message","aria-label":(r=t.starredBy)!=null&&r.includes(h._id)?"Unstar message":"Star message",disabled:us.starring,children:us.starring?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):(l=t.starredBy)!=null&&l.includes(h._id)?e.jsx(zt,{size:18}):e.jsx(Hr,{size:18})}),s&&null,e.jsx("button",{className:`rounded-full p-2 transition-colors ${m?"text-gray-400 bg-white/5 cursor-not-allowed":"text-white hover:text-red-200 bg-white/10 hover:bg-white/20"}`,onClick:()=>{if(m){u.info("Delete disabled for this appointment status. You can view chat history.");return}Ze(t),f(m?!1:s),st(!0),Te(!1),he([])},disabled:m,title:m?"Delete disabled for this appointment status":"Delete","aria-label":m?"Delete disabled for this appointment status":"Delete",children:e.jsx(Z,{size:18})})]}),t.deleted&&e.jsx("button",{className:`rounded-full p-2 transition-colors ${m?"text-gray-400 bg-white/5 cursor-not-allowed":"text-white hover:text-red-200 bg-white/10 hover:bg-white/20"}`,onClick:async()=>{if(m){u.info("Delete disabled for this appointment status. You can view chat history.");return}try{await D.patch(`${M}/api/bookings/${n._id}/comment/${t._id}/remove-for-me`,{},{withCredentials:!0})}catch{}A(i=>i.filter(d=>d._id!==t._id)),Ys(n._id,t._id),u.success("Message deleted for you!"),Te(!1),he([])},disabled:m,title:m?"Delete disabled for this appointment status":"Delete for me","aria-label":m?"Delete disabled for this appointment status":"Delete for me",children:e.jsx(Z,{size:18})})]})})()}):ie.length>1?e.jsx("div",{className:"flex items-center gap-2",children:ie.some(t=>t.deleted)?e.jsx("button",{className:`rounded-full p-2 transition-colors ${m?"text-gray-400 bg-white/5 cursor-not-allowed":"text-white hover:text-red-200 bg-white/10 hover:bg-white/20"}`,onClick:async()=>{var s,a;if(m){u.info("Delete disabled for this appointment status. You can view chat history.");return}const t=ie.map(r=>r._id);try{await D.post(`${M}/api/bookings/${n._id}/comments/removed/sync`,{removedIds:t},{withCredentials:!0,headers:{"Content-Type":"application/json"}}),A(r=>r.filter(l=>!t.includes(l._id))),t.forEach(r=>Ys(n._id,r)),u.success(`Deleted ${t.length} messages for you!`),Te(!1),he([])}catch(r){u.error(((a=(s=r.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to delete selected messages for you.")}},disabled:m,title:m?"Delete disabled for this appointment status":"Delete selected (for me)","aria-label":m?"Delete disabled for this appointment status":"Delete selected (for me)",children:e.jsx(Z,{size:18})}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:async()=>{var t,s,a;ga(r=>({...r,starring:!0}));try{let r=0,l=0;const i=[];for(const d of ie)try{const c=(t=d.starredBy)==null?void 0:t.includes(h._id);console.log(`Processing message ${d._id}: currently starred = ${c}, will set starred = ${!c}`);const g=await D.patch(`${M}/api/bookings/${n._id}/comment/${d._id}/star`,{starred:!c},{withCredentials:!0,headers:{"Content-Type":"application/json"}});console.log(`Successfully processed message ${d._id}`),r++,A(p=>p.map(w=>w._id===d._id?{...w,starredBy:c?(w.starredBy||[]).filter(O=>O!==h._id):[...w.starredBy||[],h._id]}:w)),It(p=>c?p.filter(w=>w._id!==d._id):p.some(w=>w._id===d._id)?p:[...p,{...d,starredBy:[...d.starredBy||[],h._id]}])}catch(c){console.error(`Failed to process message ${d._id}:`,c),l++,i.push(d)}console.log(`Bulk operation completed: ${r} successful, ${l} failed`),r>0&&l===0?u.success(`Successfully updated star status for ${r} messages`):r>0&&l>0?u.warning(`Partially successful: ${r} messages updated, ${l} failed`):u.error("Failed to update any messages. Please try again."),l===0&&(Te(!1),he([]))}catch(r){console.error("Error in bulk starring operation:",r),r.response&&(console.error("Response data:",r.response.data),console.error("Response status:",r.response.status)),u.error(((a=(s=r.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to star messages. Please try again.")}finally{ga(r=>({...r,starring:!1}))}},title:"Star all selected messages","aria-label":"Star all selected messages",disabled:us.starring,children:us.starring?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(zt,{size:18})}),e.jsx("button",{className:`rounded-full p-2 transition-colors ${m?"text-gray-400 bg-white/5 cursor-not-allowed":"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20"}`,onClick:()=>{if(m){u.info("Pinning disabled for this appointment status. You can view chat history.");return}ds(ie),is(!0)},title:m?"Pinning disabled for this appointment status":"Pin all selected messages","aria-label":m?"Pinning disabled for this appointment status":"Pin all selected messages",disabled:us.pinning||m,children:us.pinning?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(Ot,{size:18})}),e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{const t=ie.map(s=>s.message).join(`

`);Q(t),u.success("Copied all selected messages"),Te(!1),he([])},title:"Copy all selected messages","aria-label":"Copy all selected messages",children:e.jsx(Ia,{size:18})}),e.jsx("button",{className:`rounded-full p-2 transition-colors ${m?"text-gray-400 bg-white/5 cursor-not-allowed":"text-white hover:text-red-200 bg-white/10 hover:bg-white/20"}`,onClick:()=>{if(m){u.info("Delete disabled for this appointment status. You can view chat history.");return}const t=ie.every(a=>a.senderEmail===h.email),s=ie.some(a=>a.senderEmail!==h.email);Ze(ie),f(m?!1:t&&!s),st(!0),Te(!1),he([])},disabled:m,title:m?"Delete disabled for this appointment status":"Delete all selected messages","aria-label":m?"Delete disabled for this appointment status":"Delete all selected messages",children:e.jsx(Z,{size:18})})]})}):null,e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Te(!1),he([])},title:"Exit selection mode","aria-label":"Exit selection mode",children:e.jsx(te,{className:"w-4 h-4"})})]})]}):da&&S?e.jsxs("div",{className:"flex items-center justify-end w-full gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[!S.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{qn(S),re(null)},title:"Reply","aria-label":"Reply",children:e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),!S.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Q(S.message),re(null)},title:"Copy message","aria-label":"Copy message",children:e.jsx(Ia,{size:18})}),!S.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:async()=>{var s,a,r;const t=(s=S.starredBy)==null?void 0:s.includes(h._id);pn(!0);try{const{data:l}=await D.patch(`${M}/api/bookings/${n._id}/comment/${S._id}/star`,{starred:!t},{withCredentials:!0,headers:{"Content-Type":"application/json"}});A(i=>i.map(d=>d._id===S._id?{...d,starredBy:t?(d.starredBy||[]).filter(c=>c!==h._id):[...d.starredBy||[],h._id]}:d)),It(t?i=>i.filter(d=>d._id!==S._id):i=>[...i,S]),u.success(t?"Message unstarred.":"Message starred.")}catch(l){u.error(((r=(a=l.response)==null?void 0:a.data)==null?void 0:r.message)||"Failed to update star status")}finally{pn(!1)}re(null)},title:(el=S.starredBy)!=null&&el.includes(h._id)?"Unstar message":"Star message","aria-label":(tl=S.starredBy)!=null&&tl.includes(h._id)?"Unstar message":"Star message",disabled:fn,children:fn?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):(sl=S.starredBy)!=null&&sl.includes(h._id)?e.jsx(zt,{size:18}):e.jsx(Hr,{size:18})}),!S.deleted&&e.jsx("button",{className:`rounded-full p-2 transition-colors ${m?"text-gray-400 bg-white/5 cursor-not-allowed":"text-white hover:text-red-200 bg-white/10 hover:bg-white/20"}`,onClick:()=>{if(m){u.info("Delete disabled for this appointment status. You can view chat history.");return}S.senderEmail===h.email?Co(S):ko(S),re(null)},disabled:m,title:m?"Delete disabled for this appointment status":"Delete","aria-label":m?"Delete disabled for this appointment status":"Delete",children:e.jsx(Z,{size:18})}),!S.deleted&&e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>je(t=>!t),title:"More options","aria-label":"More options",children:e.jsx(Vr,{size:14})}),ca&&e.jsx("div",{className:"absolute top-full right-0 mt-2 bg-white rounded-lg shadow-lg border border-gray-200 z-20 min-w-[180px] chat-options-menu",children:S.senderEmail===h.email?e.jsxs(e.Fragment,{children:[S.imageUrl&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:()=>{Fn(S.imageUrl,S._id),je(!1),re(null)},children:[e.jsx(Ut,{className:"text-sm"}),"Download Image"]}),S.videoUrl&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:async()=>{try{const t=await fetch(S.videoUrl,{mode:"cors"});if(!t.ok)throw new Error(`HTTP ${t.status}`);const s=await t.blob(),a=window.URL.createObjectURL(s),r=document.createElement("a");r.href=a,r.download=`video-${S._id||Date.now()}.mp4`,document.body.appendChild(r),r.click(),r.remove(),setTimeout(()=>window.URL.revokeObjectURL(a),200),u.success("Video downloaded successfully")}catch(t){console.error("Video download failed:",t);const s=document.createElement("a");s.href=S.videoUrl,s.download=`video-${S._id||Date.now()}.mp4`,s.target="_blank",document.body.appendChild(s),s.click(),s.remove(),u.success("Video download started")}je(!1),re(null)},children:[e.jsx(Ut,{className:"text-sm"}),"Download Video"]}),S.audioUrl&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:async()=>{try{const t=await fetch(S.audioUrl,{mode:"cors"});if(!t.ok)throw new Error(`HTTP ${t.status}`);const s=await t.blob(),a=window.URL.createObjectURL(s),r=document.createElement("a");r.href=a,r.download=S.audioName||`audio-${S._id||Date.now()}`,document.body.appendChild(r),r.click(),r.remove(),setTimeout(()=>window.URL.revokeObjectURL(a),200),u.success("Audio downloaded successfully")}catch{const s=document.createElement("a");s.href=S.audioUrl,s.download=S.audioName||`audio-${S._id||Date.now()}`,s.target="_blank",document.body.appendChild(s),s.click(),s.remove(),u.success("Audio download started")}je(!1),re(null)},children:[e.jsx(Ut,{className:"text-sm"}),"Download Audio"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",onClick:()=>{Ro(S),je(!1),re(null)},children:[e.jsx(He,{className:"text-sm"}),"Info"]}),e.jsxs("button",{className:`w-full px-4 py-2 text-left text-sm flex items-center gap-2 ${m?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-100"}`,onClick:()=>{if(m){u.info("Pinning disabled for this appointment status. You can view chat history.");return}S.pinned?Aa(S,!1):(ds(S),is(!0)),je(!1),re(null)},disabled:ma||m,children:[e.jsx(Ot,{className:"text-sm"}),S.pinned?"Unpin":"Pin"]}),e.jsxs("button",{className:`w-full px-4 py-2 text-left text-sm flex items-center gap-2 ${m||W!==null?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-100"}`,onClick:()=>{if(m){u.info("Edit disabled for this appointment status. You can view chat history.");return}Ao(S),je(!1),re(null)},disabled:m||W!==null,title:m?"Edit disabled for this appointment status":"Edit message",children:[e.jsx(qr,{className:"text-sm"}),"Edit"]})]}):e.jsxs(e.Fragment,{children:[S.imageUrl&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:()=>{Fn(S.imageUrl,S._id),je(!1),re(null)},children:[e.jsx(Ut,{className:"text-sm"}),"Download Image"]}),S.videoUrl&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:async()=>{try{const t=await fetch(S.videoUrl,{mode:"cors"});if(!t.ok)throw new Error(`HTTP ${t.status}`);const s=await t.blob(),a=window.URL.createObjectURL(s),r=document.createElement("a");r.href=a,r.download=`video-${S._id||Date.now()}.mp4`,document.body.appendChild(r),r.click(),r.remove(),setTimeout(()=>window.URL.revokeObjectURL(a),200)}catch(t){console.error("Video download failed:",t);const s=document.createElement("a");s.href=S.videoUrl,s.download=`video-${S._id||Date.now()}.mp4`,s.target="_blank",document.body.appendChild(s),s.click(),s.remove()}je(!1),re(null)},children:[e.jsx(Ut,{className:"text-sm"}),"Download Video"]}),e.jsxs("button",{className:`w-full px-4 py-2 text-left text-sm flex items-center gap-2 ${m?"text-gray-400 cursor-not-allowed":"text-gray-700 hover:bg-gray-100"}`,onClick:()=>{if(m){u.info("Pinning disabled for this appointment status. You can view chat history.");return}S.pinned?Aa(S,!1):(ds(S),is(!0)),je(!1),re(null)},disabled:ma||m,children:[e.jsx(Ot,{className:"text-sm"}),S.pinned?"Unpin":"Pin"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",onClick:()=>{ot(S),at(!0),je(!1),re(null)},children:[e.jsx(Ta,{className:"text-sm"}),"Report"]})]})})]}),S.deleted&&e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Ze(S),f(!1),st(!0),re(null)},title:"Delete from chat locally","aria-label":"Delete from chat locally",children:e.jsx(Z,{size:18})})]}),e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>{re(null),je(!1)},title:"Close options","aria-label":"Close options",children:e.jsx(te,{className:"w-4 h-4"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-full p-1 sm:p-1.5 shadow-lg flex-shrink-0 cursor-pointer hover:scale-105 transition-transform duration-200",onClick:()=>mt({...v,isOnline:pt,isTyping:ze,lastSeen:$t},n),title:"Click to view user details",children:v!=null&&v.avatar?e.jsx("img",{src:v.avatar,alt:v.username||"User",className:"w-8 h-8 rounded-full object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold text-sm",children:((v==null?void 0:v.username)||"U").charAt(0).toUpperCase()})}),e.jsx("div",{className:`flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 min-w-0 flex-1 ${ve||me?"pr-2 sm:pr-0":""}`,children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2",children:[e.jsx("h3",{className:"text-sm sm:text-lg font-bold text-white truncate cursor-pointer hover:underline",onClick:()=>mt({...v,isOnline:pt,isTyping:ze,lastSeen:$t},n),title:"Click to view user details",children:(v==null?void 0:v.username)||"Unknown User"}),e.jsx("div",{className:`flex items-center gap-1 sm:hidden ${ve||me?"max-w-[120px]":""}`,children:Gs?e.jsx("span",{className:`text-gray-100 font-semibold text-[10px] bg-gray-500 bg-opacity-80 px-1.5 py-0.5 rounded-full whitespace-nowrap ${ve||me?"truncate":""}`,children:"Not available"}):ze?e.jsx("span",{className:`text-yellow-100 font-semibold text-[10px] bg-yellow-500 bg-opacity-80 px-1.5 py-0.5 rounded-full whitespace-nowrap ${ve||me?"truncate":""}`,children:"Typing..."}):ta?e.jsx("span",{className:`text-green-100 font-semibold text-[10px] bg-green-500 bg-opacity-80 px-1.5 py-0.5 rounded-full whitespace-nowrap ${ve||me?"truncate":""}`,children:"Online"}):e.jsx("span",{className:`text-gray-100 font-semibold text-[10px] bg-gray-500 bg-opacity-80 px-1.5 py-0.5 rounded-full whitespace-nowrap ${ve||me?"truncate":""}`,children:Xn(sa)||"Offline"})}),e.jsx("div",{className:"hidden sm:flex items-center gap-1",children:Gs?e.jsx("span",{className:"text-gray-100 font-semibold text-xs bg-gray-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Not available"}):ze?e.jsx("span",{className:"text-yellow-100 font-semibold text-xs bg-yellow-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Typing..."}):ta?e.jsx("span",{className:"text-green-100 font-semibold text-xs bg-green-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Online"}):e.jsx("span",{className:"text-gray-100 font-semibold text-xs bg-gray-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:Xn(sa)||"Offline"})})]})}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 ml-auto flex-shrink-0",children:[e.jsx("div",{className:"hidden sm:block",children:e.jsx(Xo,{onToggleMute:()=>{const t=to();u.info(t?"Sounds muted":"Sounds unmuted")},isMuted:ao(),onVolumeChange:t=>{so(t),u.info(`Volume: ${Math.round(t*100)}%`)}})}),(ve||me)&&e.jsxs("div",{className:"flex items-center gap-1 bg-orange-500 text-white text-xs px-2 py-1 rounded-full font-bold flex-shrink-0",children:[me?e.jsx("div",{className:"w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx("svg",{width:"12",height:"12",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M18 10v-4c0-3.313-2.687-6-6-6s-6 2.687-6 6v4H4v10h16V10h-2zM8 6c0-2.206 1.794-4 4-4s4 1.794 4 4v4H8V6z"})}),me?"Loading...":"Locked"]}),e.jsx("div",{className:"relative search-container",children:e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-all duration-300 transform hover:scale-110 shadow",onClick:()=>fa(!0),title:"Search messages","aria-label":"Search messages",children:e.jsx(Kr,{className:"text-sm"})})}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[ks&&e.jsx("div",{className:"text-white bg-white/10 rounded-full p-2 shadow",children:e.jsx(La,{className:"text-sm animate-spin"})}),e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors shadow",onClick:()=>Me(!$s),title:"Chat options","aria-label":"Chat options",children:e.jsx(Vr,{className:"text-sm"})}),$s&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-white rounded-lg shadow-lg border border-gray-200 z-20 min-w-[180px] chat-options-menu",children:[Lr&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:()=>{mt({...v,isOnline:pt,isTyping:ze,lastSeen:$t},n),Me(!1)},children:[e.jsx(He,{className:"text-sm"}),"Contact Information"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",onClick:()=>{vo(),Me(!1)},children:[e.jsx(bl,{className:"text-sm"}),"Refresh Messages"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-yellow-600 hover:bg-yellow-50 flex items-center gap-2",onClick:()=>{ua(!0),Me(!1)},children:[e.jsx(zt,{className:"text-sm"}),"Starred Messages"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:()=>{Te(!0),he([]),Me(!1)},children:[e.jsx(ei,{className:"text-sm"}),"Select Messages"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",onClick:()=>{Zt(!ce),Me(!1)},children:[e.jsx(ti,{className:"text-sm"}),"Tips & Guidelines"]}),ee.length>0&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-green-600 hover:bg-green-50 flex items-center gap-2",onClick:()=>{Me(!1),de(n,ee)},children:[e.jsx(Ut,{className:"text-sm"}),"Export Chat Transcript (PDF)"]}),e.jsx("div",{className:"border-t border-gray-200 my-1"}),ve||me?e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",onClick:()=>{Za(!0),Me(!1)},children:[e.jsx("svg",{width:"16",height:"16",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M18 10v-4c0-3.313-2.687-6-6-6s-6 2.687-6 6v4H4v10h16V10h-2zM8 6c0-2.206 1.794-4 4-4s4 1.794 4 4v4H8V6z"})}),"Remove Chat Lock"]}):e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:()=>{Wa(!0),Me(!1)},children:[e.jsx("svg",{width:"16",height:"16",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M18 10v-4c0-3.313-2.687-6-6-6s-6 2.687-6 6v4H4v10h16V10h-2zM8 6c0-2.206 1.794-4 4-4s4 1.794 4 4v4H8V6z"})}),"Lock Chat"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",onClick:()=>{Qt(!0),Me(!1)},children:[e.jsx(Ta,{className:"text-sm"}),"Report Chat"]}),ee.length>0&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",onClick:()=>{C(!0),Me(!1)},children:[e.jsx(Z,{className:"text-sm"}),"Clear Chat"]})]})]}),ce&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 shadow-lg z-20 max-w-xs animate-fadeIn",children:[e.jsx("div",{className:"font-semibold mb-2",children:"âŒ¨ï¸ Keyboard Shortcuts:"}),e.jsx("div",{className:"mb-2",children:"â€¢ Press Ctrl + F to quickly focus and type your message"}),e.jsxs("div",{className:"border-t border-gray-600 pt-2 mt-2",children:[e.jsx("div",{className:"font-semibold mb-2",children:"ðŸ“Ž File Upload Guidelines:"}),e.jsx("div",{children:"â€¢ Photos: JPG, PNG, GIF, WebP (â‰¤ 5MB)"}),e.jsx("div",{children:"â€¢ Videos: MP4, WebM, MOV, MKV, OGG (â‰¤ 5MB)"}),e.jsx("div",{children:"â€¢ Documents: PDF, DOCX, XLSX, TXT and more (â‰¤ 5MB)"}),e.jsx("div",{children:"â€¢ Add captions to images"}),e.jsx("div",{children:"â€¢ Other file types coming soon"})]}),e.jsxs("div",{className:"border-t border-gray-600 pt-2 mt-2",children:[e.jsx("div",{className:"font-semibold mb-2",children:"ðŸ’¬ Chat Features:"}),e.jsx("div",{children:"â€¢ Real-time messaging with socket.io"}),e.jsx("div",{children:"â€¢ Message reactions and emoji support"}),e.jsx("div",{children:"â€¢ File sharing and image previews"}),e.jsx("div",{children:"â€¢ Chat locking for dispute resolution"})]}),e.jsxs("div",{className:"border-t border-gray-600 pt-2 mt-2",children:[e.jsx("div",{className:"font-semibold mb-2",children:"ðŸ”’ Security & Moderation:"}),e.jsx("div",{children:"â€¢ Report inappropriate content"}),e.jsx("div",{children:"â€¢ Report chat"}),e.jsx("div",{children:"â€¢ Content filtering and moderation"}),e.jsx("div",{children:"â€¢ User blocking capabilities"})]}),e.jsx("div",{className:"absolute -top-1 right-4 w-2 h-2 bg-gray-800 transform rotate-45"})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:bo,title:"Close","aria-label":"Close",children:e.jsx(te,{className:"w-4 h-4"})})]})]})}),gr&&e.jsx("div",{className:"enhanced-search-header bg-gradient-to-r from-blue-600 via-purple-600 to-blue-800 px-3 sm:px-4 py-3 border-b-2 border-blue-700 flex-shrink-0 animate-slideDown",children:e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 flex-nowrap",children:[e.jsxs("div",{className:"relative calendar-container",children:[e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-all duration-300 transform hover:scale-110 shadow",onClick:t=>{t.stopPropagation(),Ts(!ba)},title:"Jump to date","aria-label":"Jump to date",children:e.jsx(kl,{className:"text-sm"})}),ba&&e.jsxs("div",{className:"absolute top-full left-0 mt-2 bg-white rounded-lg shadow-xl border border-gray-200 p-3 min-w-[250px] animate-fadeIn",style:{zIndex:9999},children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Jump to Date"}),e.jsx("button",{onClick:t=>{t.stopPropagation(),Ts(!1)},className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(te,{size:14})})]}),e.jsx("input",{type:"date",value:Ll,onChange:t=>{t.stopPropagation(),To(t.target.value)},className:"w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all",max:Lo(new Date)}),e.jsx("div",{className:"text-xs text-gray-500 mt-2",children:"Select a date to jump to the first message from that day"})]})]}),e.jsxs("div",{className:"flex-1 flex items-center gap-2 bg-white/20 rounded-full px-3 sm:px-4 py-2 backdrop-blur-sm min-w-0 overflow-hidden",children:[e.jsx(Kr,{className:"text-white/70 text-sm"}),e.jsx("input",{type:"text",placeholder:"Search messages...",value:fr,onChange:Eo,onKeyDown:Io,className:"bg-transparent text-white placeholder-white/70 text-sm outline-none flex-1 min-w-0 w-full",autoFocus:!0}),dt.length>0&&e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 flex-shrink-0",children:[e.jsxs("span",{className:"text-white/80 text-xs bg-white/10 px-2 py-1 rounded-full",children:[Is+1,"/",dt.length]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>ct(t=>t>0?t-1:dt.length-1),className:"text-white/80 hover:text-white p-1 rounded transition-colors text-xs",title:"Previous result",children:"â†‘"}),e.jsx("button",{onClick:()=>ct(t=>t<dt.length-1?t+1:0),className:"text-white/80 hover:text-white p-1 rounded transition-colors text-xs",title:"Next result",children:"â†“"})]})]})]}),e.jsx("button",{onClick:()=>{fa(!1),pa(""),Es([]),ct(-1),Ts(!1),document.querySelectorAll(".search-text-highlight").forEach(t=>{t.outerHTML=t.innerHTML})},className:"flex-shrink-0 text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-all duration-300 transform hover:scale-110 shadow",title:"Close search","aria-label":"Close search",children:e.jsx(te,{className:"text-sm"})})]})}),e.jsxs("div",{className:"flex-1 flex flex-col min-h-0",children:[mr.length>0&&e.jsxs("div",{className:"bg-gradient-to-r from-purple-50 to-blue-50 border-b border-purple-200 px-4 py-3 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ot,{className:"text-purple-600 text-sm"}),e.jsx("span",{className:"text-purple-700 font-semibold text-sm",children:"Pinned Messages"}),e.jsxs("span",{className:"text-purple-600 text-xs",children:["(",mr.length,")"]})]}),e.jsx("div",{className:"space-y-2 max-h-24 overflow-y-auto",children:mr.map(t=>e.jsx("div",{className:`bg-white rounded-lg p-2 border-l-4 border-purple-500 cursor-pointer transition-all duration-200 hover:shadow-md ${Cn===t._id?"ring-2 ring-purple-400 shadow-lg":""}`,onClick:()=>{kn(t._id);const s=document.getElementById(`message-${t._id}`);s&&(s.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>kn(null),3e3))},children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-xs text-purple-600 font-medium",children:t.senderEmail===h.email?"You":(v==null?void 0:v.username)||"Other"}),e.jsx("span",{className:"text-xs text-gray-500",children:t.pinDuration==="custom"?`${Math.round((new Date(t.pinExpiresAt)-new Date)/(1e3*60*60))}h left`:t.pinDuration==="24hrs"?"24h left":t.pinDuration==="7days"?"7d left":"30d left"})]}),e.jsx("div",{className:"text-sm text-gray-800 line-clamp-2",children:t.message})]}),e.jsx("button",{className:"text-purple-600 hover:text-purple-800 p-1 rounded-full hover:bg-purple-100 transition-colors",onClick:s=>{s.stopPropagation(),Aa(t,!1)},title:"Unpin message",children:e.jsx(Ot,{size:14})})]})},t._id))})]}),e.jsxs("div",{ref:I,className:`flex-1 overflow-y-auto space-y-2 px-4 pt-4 animate-fadeInChat relative bg-gradient-to-b from-transparent to-blue-50/30 ${Hl?"bg-blue-50/50 border-2 border-dashed border-blue-300":""}`,onDragOver:t=>{t.preventDefault(),t.stopPropagation(),m||wa(!0)},onDragEnter:t=>{t.preventDefault(),t.stopPropagation(),m||wa(!0)},onDragLeave:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.contains(t.relatedTarget)||wa(!1)},onDrop:t=>{if(t.preventDefault(),t.stopPropagation(),wa(!1),m){u.info("Image sending disabled for this appointment status. You can view chat history.");return}const s=Array.from(t.dataTransfer.files),a=s.filter(r=>r.type.startsWith("image/"));a.length>0?Bn(a):s.length>0&&u.error("Only image files are supported")},children:[e.jsx("div",{className:"px-4 py-3 bg-gradient-to-r from-blue-50 to-purple-50 border-l-4 border-blue-400 rounded-r-lg mb-4 backdrop-blur-sm",children:e.jsxs("p",{className:"text-sm text-blue-700 font-medium text-center flex items-center justify-center gap-2",children:[e.jsx("span",{className:"animate-gentlePulse",children:"ðŸ”’"}),"Your privacy is our top priority â€” all your chats and data are fully encrypted for your safety"]})}),gt&&ee.length>0&&e.jsx("div",{className:`sticky top-0 left-0 right-0 z-30 pointer-events-none transition-all duration-300 ease-in-out ${ft?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"w-full flex justify-center py-2",children:e.jsx("div",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:gt})})}),ee.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx(pl,{className:"text-gray-300 text-4xl mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"No messages yet"}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"Start the conversation and connect with the other party"})]}):ee.slice(Math.max(0,ee.length-Math.min(Dt,ee.length))).map((t,s,a)=>{var p,w,O,ne,tt,le,Zs,G,cl,ul,ml,hl,xl,gl;const r=ee.length-a.length+s,l=t.senderEmail===h.email,i=W===t._id,d=new Date(t.timestamp),c=r>0?new Date(ee[r-1].timestamp):null,g=c?d.toDateString()!==c.toDateString():!0;return d.toLocaleDateString("en-US",{month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"}),e.jsxs(si.Fragment,{children:[g&&e.jsx("div",{className:"w-full flex justify-center my-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:Yr(d)})}),Re&&U>0&&r===ee.length-U&&e.jsxs("div",{className:"w-full flex items-center my-2",children:[e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsxs("span",{className:"mx-2 text-xs font-semibold text-red-600 bg-red-50 px-2 py-1 rounded-full border border-red-200",children:[U," unread message",U>1?"s":""]}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"})]}),e.jsxs("div",{className:`flex w-full ${l?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*r}s`},children:[xr&&e.jsx("div",{className:`flex items-start ${l?"order-2 ml-2":"order-1 mr-2"}`,children:e.jsx("input",{type:"checkbox",checked:ie.some(j=>j._id===t._id),onChange:j=>{j.target.checked?he(L=>[...L,t]):he(L=>L.filter(V=>V._id!==t._id))},className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"})}),e.jsxs("div",{ref:j=>Ue.current[t._id]=j,id:`message-${t._id}`,"data-message-id":t._id,className:`relative rounded-2xl px-4 sm:px-5 py-3 text-sm shadow-xl max-w-[90%] sm:max-w-[80%] md:max-w-[70%] lg:max-w-[60%] xl:max-w-[50%] break-words overflow-visible transition-all duration-300 min-h-[60px] ${l?"bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-500 hover:to-purple-600 text-white shadow-blue-200 hover:shadow-blue-300 hover:shadow-2xl":"bg-white hover:bg-gray-50 text-gray-800 border border-gray-200 shadow-gray-200 hover:shadow-lg hover:border-gray-300 hover:shadow-xl"} ${Cn===t._id?"ring-4 ring-purple-400 shadow-2xl scale-105":""} ${xr&&ie.some(j=>j._id===t._id)?"ring-2 ring-blue-400":""}`,style:{animationDelay:`${.03*r}s`},children:[t.replyTo&&e.jsx("div",{className:"border-l-4 border-purple-400 pl-3 mb-2 text-xs bg-gradient-to-r from-purple-50 to-blue-50 hover:from-purple-100 hover:to-blue-100 rounded-lg w-full max-w-full break-words cursor-pointer transition-all duration-200 hover:shadow-sm",onClick:()=>{Ue.current[t.replyTo]&&(Ue.current[t.replyTo].scrollIntoView({behavior:"smooth",block:"center"}),Ue.current[t.replyTo].classList.add("reply-highlight"),setTimeout(()=>{var j;(j=Ue.current[t.replyTo])==null||j.classList.remove("reply-highlight")},1600))},role:"button",tabIndex:0,"aria-label":"Go to replied message",children:e.jsxs("span",{className:"text-xs text-gray-700 font-medium truncate max-w-[150px] flex items-center gap-1",children:[e.jsx("span",{className:"text-purple-500",children:"â†©"}),((w=(p=$.find(j=>j._id===t.replyTo))==null?void 0:p.message)==null?void 0:w.substring(0,30))||"Original message",((ne=(O=$.find(j=>j._id===t.replyTo))==null?void 0:O.message)==null?void 0:ne.length)>30?"...":""]})}),!l&&t.senderEmail!==((tt=n.buyerId)==null?void 0:tt.email)&&t.senderEmail!==((le=n.sellerId)==null?void 0:le.email)&&e.jsx("div",{className:"font-semibold mb-1 text-xs text-purple-600",children:"UrbanSetu"}),e.jsx("div",{className:`text-left ${l?"text-base font-medium":"text-sm"}`,children:t.deleted?e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(vs,{className:"inline-block text-lg"})," ",t.senderEmail===h.email?"You deleted this message":"This message was deleted."]}):e.jsx("div",{children:i?e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-400 px-2 py-1 rounded",children:e.jsx("span",{className:"text-yellow-800 text-xs font-medium",children:"âœï¸ Editing this message below..."})}):e.jsxs(e.Fragment,{children:[t.imageUrl&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:t.imageUrl,alt:"Shared image",className:"max-w-full max-h-64 rounded-lg cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>{const j=($||[]).filter(V=>!!V.imageUrl).map(V=>V.imageUrl),L=Math.max(0,j.indexOf(t.imageUrl));Rn(j),Je(L),pr(!0)},onError:j=>{j.target.src="https://via.placeholder.com/300x200?text=Image+Not+Found",j.target.className="max-w-full max-h-64 rounded-lg opacity-50"}})}),t.videoUrl&&e.jsxs("div",{className:"mb-2",children:[e.jsx("div",{className:"relative",children:e.jsx("video",{src:t.videoUrl,className:"max-w-full max-h-64 rounded-lg border cursor-pointer hover:opacity-90 transition-opacity",controls:!0,onClick:j=>{j.preventDefault(),j.stopPropagation(),j.target.requestFullscreen?j.target.requestFullscreen():j.target.webkitRequestFullscreen?j.target.webkitRequestFullscreen():j.target.msRequestFullscreen&&j.target.msRequestFullscreen()}})}),e.jsx("div",{className:`mt-1 text-xs flex gap-3 ${l?"text-blue-100":"text-gray-500"}`,children:e.jsx("button",{className:`${l?"text-white hover:text-blue-100":"text-blue-600 hover:underline"}`,onClick:j=>{j.stopPropagation();const L=document.createElement("a");L.href=t.videoUrl,L.download=`video-${t._id||Date.now()}`,L.target="_blank",document.body.appendChild(L),L.click(),L.remove(),u.success("Video download started")},children:"Download"})})]}),t.audioUrl&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"w-full",children:e.jsx("audio",{src:t.audioUrl,className:"w-full",controls:!0,preload:"metadata",onClick:j=>j.stopPropagation()})}),e.jsx("div",{className:"mt-2 flex justify-end",children:e.jsx("button",{className:`px-3 py-1.5 text-xs rounded-full shadow-sm border transition-colors ${l?"bg-white text-blue-600 hover:bg-blue-50 border-blue-200":"bg-blue-600 text-white hover:bg-blue-700 border-transparent"}`,onClick:async j=>{j.stopPropagation();try{const L=await fetch(t.audioUrl,{mode:"cors"});if(!L.ok)throw new Error(`HTTP ${L.status}`);const V=await L.blob(),Fe=window.URL.createObjectURL(V),xe=document.createElement("a");xe.href=Fe,xe.download=t.audioName||`audio-${t._id||Date.now()}`,document.body.appendChild(xe),xe.click(),xe.remove(),setTimeout(()=>window.URL.revokeObjectURL(Fe),200),u.success("Audio downloaded successfully")}catch{const V=document.createElement("a");V.href=t.audioUrl,V.download=t.audioName||`audio-${t._id||Date.now()}`,V.target="_blank",document.body.appendChild(V),V.click(),V.remove(),u.success("Audio download started")}},title:"Download audio",children:e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"})}),"Download"]})})})]}),t.message&&e.jsx("div",{className:"mt-2 text-sm text-gray-700 whitespace-pre-wrap break-words",children:t.message})]}),t.documentUrl&&e.jsx("div",{className:"mb-2",children:e.jsxs("button",{className:"flex items-center gap-2 px-3 py-2 rounded-lg border hover:bg-gray-50",onClick:async j=>{j.stopPropagation();try{const L=await fetch(t.documentUrl,{mode:"cors"});if(!L.ok)throw new Error(`HTTP ${L.status}`);const V=await L.blob(),Fe=window.URL.createObjectURL(V),xe=document.createElement("a");xe.href=Fe,xe.download=t.documentName||`document-${t._id||Date.now()}`,document.body.appendChild(xe),xe.click(),xe.remove(),setTimeout(()=>window.URL.revokeObjectURL(Fe),200),u.success("Document downloaded successfully")}catch(L){console.error("Download failed:",L);const V=document.createElement("a");V.href=t.documentUrl,V.download=t.documentName||`document-${t._id||Date.now()}`,V.target="_blank",document.body.appendChild(V),V.click(),V.remove(),u.success("Document download started")}},children:[e.jsx("span",{className:"text-2xl",children:"ðŸ“„"}),e.jsx("span",{className:`text-sm truncate max-w-[200px] ${l?"text-white":"text-blue-700"}`,children:t.documentName||"Document"})]})}),(()=>{if(t.previewDismissed)return null;const j=/(https?:\/\/[^\s]+|www\.[^\s]+\.[^\s]{2,}(?:\/[^\s]*)?|[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/gi,L=(t.message||"").match(j);return L&&L.length>0?e.jsx("div",{className:"mb-2 max-h-40 overflow-hidden",children:e.jsx(jl,{url:L[0],className:"max-w-xs",showRemoveButton:!1,clickable:!0})}):null})(),e.jsx(vl,{text:(t.message||"").replace(/\n+$/,""),isSentMessage:l,className:"whitespace-pre-wrap break-words",searchQuery:fr}),t.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300 whitespace-nowrap",children:"(Edited)"})]})})}),e.jsxs("div",{className:"flex items-center gap-1 justify-end mt-2","data-message-actions":!0,children:[t.pinned&&e.jsx(Ot,{className:`${l?"text-purple-300":"text-purple-500"} text-[10px]`,title:"Pinned message"}),((Zs=t.starredBy)==null?void 0:Zs.includes(h._id))&&e.jsx(zt,{className:`${l?"text-yellow-300":"text-yellow-500"} text-[10px]`,title:"Starred message"}),e.jsx("span",{className:`${l?"text-blue-200":"text-gray-500"} text-[10px]`,children:new Date(t.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})}),e.jsx("button",{className:`${t.senderEmail===h.email?"text-blue-200 hover:text-white":"text-gray-500 hover:text-gray-700"} transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-white hover:bg-opacity-20 ml-1`,onClick:j=>{j.stopPropagation(),re(t._id),m||Oo(t._id)},title:"Message options","aria-label":"Message options",children:e.jsx(Vr,{size:12})}),!t.deleted&&t.reactions&&t.reactions.length>0&&e.jsx("div",{className:"flex items-center gap-1 ml-1",children:(()=>{const j={};return t.reactions.forEach(L=>{j[L.emoji]||(j[L.emoji]=[]),j[L.emoji].push(L)}),Object.entries(j).map(([L,V])=>{const Fe=V.some($a=>$a.userId===h._id),xe=V.map($a=>$a.userName).join(", ");return e.jsxs("button",{onClick:()=>ke(t._id,L),className:`text-xs rounded-full px-2 py-1 flex items-center gap-1 transition-all duration-200 hover:scale-105 ${Fe?"bg-blue-100 border border-blue-300 hover:bg-blue-200":"bg-gray-100 hover:bg-gray-200"}`,title:`${xe} reacted with ${L}${Fe?" (Click to remove)":" (Click to add)"}`,children:[e.jsx("span",{children:L}),e.jsx("span",{className:`${Fe?"text-blue-600":"text-gray-600"}`,children:V.length})]},L)})})()}),t.senderEmail===h.email&&!t.deleted&&e.jsx("span",{className:"flex items-center gap-1 ml-1",children:(G=t.readBy)!=null&&G.includes(v==null?void 0:v._id)?e.jsx(yl,{className:"text-green-400 text-xs transition-all duration-300 animate-fadeIn",title:"Read"}):t.status==="delivered"?e.jsx(yl,{className:"text-blue-200 text-xs transition-all duration-300 animate-fadeIn",title:"Delivered"}):t.status==="sending"?e.jsx(Ea,{className:"text-blue-200 text-xs animate-pulse transition-all duration-300",title:"Sending..."}):e.jsx(Ea,{className:"text-blue-200 text-xs transition-all duration-300 animate-fadeIn",title:"Sent"})})]})]}),(()=>{if(!(!t.deleted&&ls&&jt===t._id))return!1;const L=document.querySelector(`[data-message-id="${t._id}"]`);if(L){const V=L.getBoundingClientRect(),Fe=I.current;if(Fe){const xe=Fe.getBoundingClientRect();if(V.top-xe.top<120&&xe.bottom-V.bottom>=60+20)return!1}}return!0})()&&e.jsxs("div",{className:`absolute -top-8 ${l?"right-0":"left-0"} bg-red-500 rounded-full shadow-lg border-2 border-red-600 p-1 flex items-center gap-1 animate-reactions-bar z-[999999] reactions-bar transition-all duration-300`,style:{minWidth:"max-content"},children:[e.jsx("button",{onClick:()=>ke(t._id,"ðŸ‘"),className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":(cl=t.reactions)!=null&&cl.some(j=>j.emoji==="ðŸ‘"&&j.userId===h._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"Like",children:"ðŸ‘"}),e.jsx("button",{onClick:()=>ke(t._id,"â¤ï¸"),className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":(ul=t.reactions)!=null&&ul.some(j=>j.emoji==="â¤ï¸"&&j.userId===h._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"Love",children:"â¤ï¸"}),e.jsx("button",{onClick:()=>ke(t._id,"ðŸ˜‚"),className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":(ml=t.reactions)!=null&&ml.some(j=>j.emoji==="ðŸ˜‚"&&j.userId===h._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"Laugh",children:"ðŸ˜‚"}),e.jsx("button",{onClick:()=>ke(t._id,"ðŸ˜®"),className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":(hl=t.reactions)!=null&&hl.some(j=>j.emoji==="ðŸ˜®"&&j.userId===h._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"Wow",children:"ðŸ˜®"}),e.jsx("button",{onClick:()=>ke(t._id,"ðŸ˜¢"),className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":(xl=t.reactions)!=null&&xl.some(j=>j.emoji==="ðŸ˜¢"&&j.userId===h._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"Sad",children:"ðŸ˜¢"}),e.jsx("button",{onClick:()=>ke(t._id,"ðŸ˜¡"),className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":(gl=t.reactions)!=null&&gl.some(j=>j.emoji==="ðŸ˜¡"&&j.userId===h._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"Angry",children:"ðŸ˜¡"}),e.jsx("div",{className:"w-px h-6 bg-gray-300 mx-1"}),e.jsx("button",{onClick:Kn,className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"More emojis",children:"âž•"})]})]})]},t._id||r)}),e.jsx("div",{ref:X})]})]}),(()=>{var d,c,g,p,w,O;if(!(ls&&jt))return null;const s=document.querySelector(`[data-message-id="${jt}"]`);if(!s)return null;const a=s.getBoundingClientRect(),r=I.current;if(!r)return null;const l=r.getBoundingClientRect();if(a.top-l.top<120&&l.bottom-a.bottom>=60+20){const le=$.find(G=>G._id===jt);if(!le||le.deleted)return null;const Zs=le.senderEmail===h.email;return e.jsxs("div",{className:"fixed bg-red-500 rounded-full shadow-lg border-2 border-red-600 p-1 flex items-center gap-1 animate-reactions-bar z-[999999] reactions-bar transition-all duration-300",style:{minWidth:"max-content",top:`${a.bottom+2}px`,left:Zs?"auto":`${a.left}px`,right:Zs?`${window.innerWidth-a.right}px`:"auto"},children:[e.jsx("button",{onClick:()=>ke(le._id,"ðŸ‘"),className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":(d=le.reactions)!=null&&d.some(G=>G.emoji==="ðŸ‘"&&G.userId===h._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"Like",children:"ðŸ‘"}),e.jsx("button",{onClick:()=>ke(le._id,"â¤ï¸"),className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":(c=le.reactions)!=null&&c.some(G=>G.emoji==="â¤ï¸"&&G.userId===h._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"Love",children:"â¤ï¸"}),e.jsx("button",{onClick:()=>ke(le._id,"ðŸ˜‚"),className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":(g=le.reactions)!=null&&g.some(G=>G.emoji==="ðŸ˜‚"&&G.userId===h._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"Laugh",children:"ðŸ˜‚"}),e.jsx("button",{onClick:()=>ke(le._id,"ðŸ˜®"),className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":(p=le.reactions)!=null&&p.some(G=>G.emoji==="ðŸ˜®"&&G.userId===h._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"Wow",children:"ðŸ˜®"}),e.jsx("button",{onClick:()=>ke(le._id,"ðŸ˜¢"),className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":(w=le.reactions)!=null&&w.some(G=>G.emoji==="ðŸ˜¢"&&G.userId===h._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"Sad",children:"ðŸ˜¢"}),e.jsx("button",{onClick:()=>ke(le._id,"ðŸ˜¡"),className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":(O=le.reactions)!=null&&O.some(G=>G.emoji==="ðŸ˜¡"&&G.userId===h._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"Angry",children:"ðŸ˜¡"}),e.jsx("div",{className:"w-px h-6 bg-gray-300 mx-1"}),e.jsx("button",{onClick:Kn,className:`w-8 h-8 flex items-center justify-center text-lg transition-transform rounded-full ${m?"bg-gray-200 cursor-not-allowed opacity-50":"bg-gray-50 hover:bg-gray-100 hover:scale-110"}`,disabled:m,title:m?"Reactions disabled":"More emojis",children:"âž•"})]})}return null})(),be&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsxs("span",{className:"text-xs text-gray-600 truncate max-w-[200px]",children:[(al=be.message)==null?void 0:al.substring(0,40),((rl=be.message)==null?void 0:rl.length)>40?"...":""]}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-1 transition-colors",onClick:()=>ae(null),title:"Cancel reply",children:e.jsx(te,{className:"w-3 h-3"})})]})}),W&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-yellow-50 border-l-4 border-yellow-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-yellow-700 font-semibold mr-2",children:"âœï¸ Editing message:"}),e.jsx("span",{className:"text-xs text-yellow-600 truncate",children:_e}),e.jsx("button",{className:"ml-auto text-yellow-400 hover:text-yellow-700 bg-yellow-100 hover:bg-yellow-200 rounded-full p-1 transition-colors",onClick:()=>{Ye(null),q(""),H(We),setTimeout(()=>{se("")},100),hs(null),xs(!1),setTimeout(()=>{if(y.current){const s=new Event("input",{bubbles:!0});y.current.dispatchEvent(s),y.current.style.height="48px";const a=y.current.scrollHeight,r=144;a<=r?(y.current.style.height=a+"px",y.current.style.overflowY="hidden"):(y.current.style.height=r+"px",y.current.style.overflowY="auto")}},100)},title:"Cancel edit",children:e.jsx(te,{className:"w-3 h-3"})})]})}),e.jsxs("div",{className:"flex gap-2 mt-1 px-3 pb-2 flex-shrink-0 bg-gradient-to-b from-transparent to-white pt-2 items-end",children:[e.jsxs("div",{className:"flex-1 relative",children:[Dn&&e.jsx("div",{className:"max-h-32 max-w-full overflow-y-auto mb-2 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:e.jsx(jl,{url:Dn,onRemove:()=>{hs(null),xs(!0)},className:"w-full",showRemoveButton:!0,clickable:!1})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-2",children:[e.jsx("button",{type:"button",className:`px-2 py-1 text-xs rounded border ${m?"opacity-50 cursor-not-allowed bg-gray-50":"hover:bg-gray-100"}`,onClick:()=>{if(m){u.info("Formatting disabled for this appointment status. You can view chat history.");return}const t=y.current;if(!t)return;const s=t.selectionStart||0,a=t.selectionEnd||0,r=F||"",l=r.slice(s,a),i=`**${l||"bold"}**`,d=r.slice(0,s)+i+r.slice(a);H(d),setTimeout(()=>{try{t.focus(),t.setSelectionRange(s+2,s+2+(l||"bold").length)}catch{}},0)},disabled:m,children:"B"}),e.jsx("button",{type:"button",className:`px-2 py-1 text-xs rounded border italic ${m?"opacity-50 cursor-not-allowed bg-gray-50":"hover:bg-gray-100"}`,onClick:()=>{if(m){u.info("Formatting disabled for this appointment status. You can view chat history.");return}const t=y.current;if(!t)return;const s=t.selectionStart||0,a=t.selectionEnd||0,r=F||"",l=r.slice(s,a),i=`*${l||"italic"}*`,d=r.slice(0,s)+i+r.slice(a);H(d),setTimeout(()=>{try{t.focus(),t.setSelectionRange(s+1,s+1+(l||"italic").length)}catch{}},0)},disabled:m,children:"I"}),e.jsx("button",{type:"button",className:`px-2 py-1 text-xs rounded border underline ${m?"opacity-50 cursor-not-allowed bg-gray-50":"hover:bg-gray-100"}`,onClick:()=>{if(m){u.info("Formatting disabled for this appointment status. You can view chat history.");return}const t=y.current;if(!t)return;const s=t.selectionStart||0,a=t.selectionEnd||0,r=F||"",l=r.slice(s,a),i=`__${l||"underline"}__`,d=r.slice(0,s)+i+r.slice(a);H(d),setTimeout(()=>{try{t.focus(),t.setSelectionRange(s+2,s+2+(l||"underline").length)}catch{}},0)},disabled:m,children:"U"}),e.jsx("button",{type:"button",className:`px-2 py-1 text-xs rounded border ${m?"opacity-50 cursor-not-allowed bg-gray-50":"hover:bg-gray-100"}`,onClick:()=>{if(m){u.info("Formatting disabled for this appointment status. You can view chat history.");return}const t=y.current;if(!t)return;const s=t.selectionStart||0,a=t.selectionEnd||0,r=F||"",l=r.slice(s,a),i=`~~${l||"strike"}~~`,d=r.slice(0,s)+i+r.slice(a);H(d),setTimeout(()=>{try{t.focus(),t.setSelectionRange(s+2,s+2+(l||"strike").length)}catch{}},0)},disabled:m,children:"S"}),e.jsx("button",{type:"button",className:`px-2 py-1 text-xs rounded border ${m?"opacity-50 cursor-not-allowed bg-gray-50":"hover:bg-gray-100"}`,onClick:()=>{if(m){u.info("Formatting disabled for this appointment status. You can view chat history.");return}const t=y.current;if(!t)return;const s=F||"",a=t.selectionStart||0,r=s.slice(0,a),l=s.slice(a),i=`${r}- ${l}`;H(i),setTimeout(()=>{try{t.focus(),t.setSelectionRange(a+2,a+2)}catch{}},0)},disabled:m,children:"â€¢ List"}),e.jsx("button",{type:"button",className:`px-2 py-1 text-xs rounded border ${m?"opacity-50 cursor-not-allowed bg-gray-50":"hover:bg-gray-100"}`,onClick:()=>{if(m){u.info("Formatting disabled for this appointment status. You can view chat history.");return}const t=y.current;if(!t)return;const s=F||"",a=t.selectionStart||0,r=s.slice(0,a),l=s.slice(a),i=r.split(`
`);i[i.length-1];let d=1;for(let g=i.length-1;g>=0;g--){const p=i[g].trim(),w=p.match(/^(\d+)\.\s/);if(w){d=parseInt(w[1])+1;break}else if(p&&!p.match(/^\s*$/))break}const c=`${r}${d}. ${l}`;H(c),setTimeout(()=>{try{t.focus(),t.setSelectionRange(a+d.toString().length+2,a+d.toString().length+2)}catch{}},0)},disabled:m,children:"1. List"}),e.jsx("button",{type:"button",className:`px-2 py-1 text-xs rounded border ${m?"opacity-50 cursor-not-allowed bg-gray-50":"hover:bg-gray-100"}`,onClick:()=>{if(m){u.info("Formatting disabled for this appointment status. You can view chat history.");return}const t=y.current;if(!t)return;const s=F||"",a=t.selectionStart||0,r=s.slice(0,a),l=s.slice(a),i=`${r}> ${l}`;H(i),setTimeout(()=>{try{t.focus(),t.setSelectionRange(a+2,a+2)}catch{}},0)},disabled:m,children:"> Quote"}),e.jsx("button",{type:"button",className:`px-2 py-1 text-xs rounded border ${m?"opacity-50 cursor-not-allowed bg-gray-50":"hover:bg-gray-100"}`,title:"Tag Property",onClick:()=>{if(m){u.info("Formatting disabled for this appointment status. You can view chat history.");return}const t=y.current;if(!t)return;const s=t.selectionStart||0,a=F||"",l=a.slice(0,s)+"@"+a.slice(s);H(l),setTimeout(()=>{try{t.focus(),t.setSelectionRange(s+1,s+1)}catch{}},0)},disabled:m,children:"@Prop"}),e.jsx("button",{type:"button",className:`px-2 py-1 text-xs rounded border ${m?"opacity-50 cursor-not-allowed bg-gray-50":"hover:bg-gray-100"}`,title:"Insert appointment card",onClick:()=>{if(m){u.info("Formatting disabled for this appointment status. You can view chat history.");return}const t=y.current;if(!t)return;const s=t.selectionStart||0,a=F||"",l=a.slice(0,s)+"[Appointment: date â€¢ time â€¢ with]"+a.slice(s);H(l),setTimeout(()=>{try{t.focus(),t.setSelectionRange(s+13,s+13)}catch{}},0)},disabled:m,children:"Appt"}),e.jsx("button",{type:"button",className:`px-2 py-1 text-xs rounded border ${m?"opacity-50 cursor-not-allowed bg-gray-50":"hover:bg-gray-100"}`,title:"Insert service link",onClick:()=>{if(m){u.info("Formatting disabled for this appointment status. You can view chat history.");return}const t=y.current;if(!t)return;const s=t.selectionStart||0,a=F||"",l=a.slice(0,s)+"Book Movers: /user/movers"+a.slice(s);H(l),setTimeout(()=>{try{t.focus(),t.setSelectionRange(s,s)}catch{}},0)},disabled:m,children:"Service"})]}),F&&/@[^\s]*$/.test(F)&&e.jsx("div",{className:"absolute bottom-16 left-2 right-2 bg-white border rounded shadow-lg max-h-48 overflow-auto z-30",children:(()=>{var i;const t=(((i=F.match(/@([^\s]*)$/))==null?void 0:i[1])||"").toLowerCase(),r=[...(typeof appointments<"u"&&Array.isArray(appointments)&&appointments.length>0?appointments:[n].filter(Boolean)).map(d=>{var c,g;return{id:((c=d==null?void 0:d.listingId)==null?void 0:c._id)||(d==null?void 0:d.listingId),name:(d==null?void 0:d.propertyName)||((g=d==null?void 0:d.listingId)==null?void 0:g.name)||"Property"}}),...ra],l=Array.from(new Set(r.filter(d=>d.id&&d.name).map(d=>JSON.stringify(d)))).map(d=>JSON.parse(d)).filter(d=>d.name&&d.name.toLowerCase().includes(t));return l.length===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:"No matches"}):l.slice(0,8).map(d=>e.jsx("button",{type:"button",className:"w-full text-left px-3 py-2 text-sm hover:bg-gray-100",onClick:()=>{const c=y.current,g=F||"",p=g.match(/@([^\s]*)$/);if(!p)return;const w=g.lastIndexOf("@"),O=`@[${d.name}](${d.id})`,ne=g.slice(0,w)+O+" "+g.slice(w+p[0].length);H(ne),setTimeout(()=>{try{c==null||c.focus(),c==null||c.setSelectionRange(w+O.length+1,w+O.length+1)}catch{}},0)},children:d.name},d.id))})()}),e.jsx("textarea",{rows:1,className:"w-full pl-4 pr-20 py-3 border-2 border-gray-200 rounded-2xl text-sm focus:ring-2 focus:ring-blue-300 focus:border-blue-400 shadow-lg transition-all duration-300 bg-white resize-none whitespace-pre-wrap break-all hover:border-blue-300 hover:shadow-xl focus:shadow-2xl transform hover:scale-[1.01] overflow-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",style:{minHeight:"48px",maxHeight:"144px",lineHeight:"24px",wordBreak:"break-all",overflowWrap:"break-word"},placeholder:m?"Sending disabled for this appointment status. Chat history is available.":W?"Edit your message...":"Type a message...",value:F,onChange:t=>{if(m)return;const s=t.target.value;H(s);const a=/(https?:\/\/[^\s]+|www\.[^\s]+\.[^\s]{2,}(?:\/[^\s]*)?|[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/gi,r=s.match(a);if(r&&r.length>0?(hs(r[0]),xs(!1)):(hs(null),xs(!1)),W&&q(s),W||z.emit("typing",{toUserId:v._id,fromUserId:h._id,appointmentId:n._id}),(s||"").trim()===""){const c=t.target;c.style.height="48px",c.style.overflowY="hidden";return}const l=t.target;l.style.height="48px";const i=l.scrollHeight,d=144;i<=d?(l.style.height=i+"px",l.style.overflowY="hidden"):(l.style.height=d+"px",l.style.overflowY="auto")},onClick:()=>{da&&(re(null),u.info("You can hit reply icon in header to reply"))},onScroll:t=>{t.stopPropagation()},onPaste:t=>{const a=Array.from(t.clipboardData.items).filter(r=>r.type.startsWith("image/"));if(a.length>0){t.preventDefault();const l=a[0].getAsFile();l&&Bn([l])}},onKeyDown:t=>{if(m){(t.key==="Enter"||t.key.length===1)&&(t.preventDefault(),u.info("Sending disabled for this appointment status."));return}const s=window.matchMedia("(min-width: 768px)").matches;if(t.ctrlKey&&(t.key==="b"||t.key==="B")&&(t.preventDefault(),document.querySelector('button:contains("B")')),t.ctrlKey&&(t.key==="i"||t.key==="I")){t.preventDefault();const a=y.current;if(!a)return;const r=a.selectionStart||0,l=a.selectionEnd||0,i=F||"",c=`*${i.slice(r,l)||"italic"}*`;H(i.slice(0,r)+c+i.slice(l));return}if(t.ctrlKey&&(t.key==="u"||t.key==="U")){t.preventDefault();const a=y.current;if(!a)return;const r=a.selectionStart||0,l=a.selectionEnd||0,i=F||"",c=`__${i.slice(r,l)||"underline"}__`;H(i.slice(0,r)+c+i.slice(l));return}if(t.shiftKey&&t.altKey&&t.key==="7"){t.preventDefault();const a=y.current;if(!a)return;const r=F||"",l=a.selectionStart||0;H(r.slice(0,l)+"> "+r.slice(l));return}if(t.key==="Enter"){if(t.isComposing||t.keyCode===229)return;(s&&!t.shiftKey||t.ctrlKey||t.metaKey)&&(t.preventDefault(),W?Fr(W):Pr())}},ref:y}),e.jsx("div",{className:"absolute right-12 bottom-3",children:e.jsx(Js,{onEmojiClick:t=>{if(m){u.info("Emoji sending disabled for this appointment status. You can view chat history.");return}const s=y==null?void 0:y.current,a=s?s.value:F;let r=a.length,l=a.length;try{s&&typeof s.selectionStart=="number"&&typeof s.selectionEnd=="number"&&(r=s.selectionStart,l=s.selectionEnd)}catch{}const i=a.slice(0,r)+t+a.slice(l);H(i),W&&q(i),setTimeout(()=>{try{if(s){const d=r+t.length;s.focus(),s.setSelectionRange(d,d)}}catch{}},0)},className:"w-8 h-8",inputRef:y,disabled:m})}),e.jsxs("div",{className:"absolute right-3 bottom-3",children:[e.jsx("button",{ref:$n,type:"button",onClick:()=>_t(t=>!t),disabled:Ct||m,className:`flex items-center justify-center w-8 h-8 rounded-full transition-all duration-300 ${Ct||m?"bg-gray-400 cursor-not-allowed":"bg-gray-100 hover:bg-gray-200 hover:shadow-md active:scale-95"}`,"aria-haspopup":"true","aria-expanded":va,"aria-label":"Attachments",children:Ct?e.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-gray-600 border-t-transparent rounded-full"}):e.jsx("svg",{className:"w-4 h-4 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"})})}),va&&!m&&e.jsxs("div",{ref:En,className:"absolute bottom-10 right-0 bg-white border border-gray-200 shadow-xl rounded-lg w-48 py-2 z-20",children:[e.jsxs("label",{className:"flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})}),"Photos",e.jsx("input",{type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:t=>{const s=t.target.files;s&&s.length>0&&lo(s),t.target.value="",_t(!1)}})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",onClick:()=>{console.log("Camera button clicked"),Yl(!0),_t(!1)},children:[e.jsx("svg",{className:"w-4 h-4 text-purple-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 7a2 2 0 012-2h2l1-2h6l1 2h2a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"})}),"Camera"]}),e.jsxs("label",{className:"flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer",children:[e.jsx("svg",{className:"w-4 h-4 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})}),"Videos",e.jsx("input",{ref:Vl,type:"file",accept:"video/*",className:"hidden",onChange:t=>{const s=t.target.files&&t.target.files[0];s&&(s.size>5*1024*1024?u.error("Maximum video size is 5MB"):(Na(s),Ca(!0))),t.target.value="",_t(!1)}})]}),e.jsxs("label",{className:"flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer",children:[e.jsx("svg",{className:"w-4 h-4 text-green-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Documents",e.jsx("input",{ref:ql,type:"file",className:"hidden",onChange:t=>{const s=t.target.files&&t.target.files[0];s&&(s.size>5*1024*1024?u.error("Maximum document size is 5MB"):(ka(s),Sa(!0))),t.target.value="",_t(!1)}})]}),e.jsxs("label",{className:"flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer",children:[e.jsxs("svg",{className:"w-4 h-4 text-indigo-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 1a3 3 0 00-3 3v8a3 3 0 106 0V4a3 3 0 00-3-3z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 10v2a7 7 0 11-14 0v-2"})]}),"Audio",e.jsx("input",{type:"file",accept:"audio/*",className:"hidden",onChange:t=>{const s=t.target.files&&t.target.files[0];s&&(s.size>5*1024*1024?u.error("Maximum audio size is 5MB"):(fs(s),Us(!0))),t.target.value="",_t(!1)}})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",onClick:()=>{Mr(!0),_t(!1)},children:[e.jsxs("svg",{className:"w-4 h-4 text-rose-500",viewBox:"0 0 24 24",fill:"currentColor",children:[e.jsx("path",{d:"M12 14a3 3 0 003-3V7a3 3 0 10-6 0v4a3 3 0 003 3z"}),e.jsx("path",{d:"M19 11a7 7 0 11-14 0h2a5 5 0 0010 0h2z"}),e.jsx("path",{d:"M13 19h-2v2h2v-2z"})]}),"Record Audio"]})]})]})]}),e.jsx("button",{onClick:t=>{t.preventDefault(),W?Fr(W):Pr()},disabled:W?Mt===W:!F.trim(),className:"bg-gradient-to-r from-blue-600 to-purple-700 text-white w-12 h-12 rounded-full shadow-lg hover:from-blue-700 hover:to-purple-800 hover:shadow-xl transform hover:scale-110 transition-all duration-300 disabled:opacity-50 disabled:transform-none flex items-center justify-center hover:shadow-2xl active:scale-95 group",children:W?Mt===W?e.jsx(qr,{className:"text-lg text-white animate-editSaving"}):e.jsx(qr,{className:"text-lg text-white group-hover:scale-110 transition-transform duration-200"}):e.jsx("div",{className:"relative",children:Il?e.jsx(Ea,{className:"text-lg text-white group-hover:scale-110 transition-all duration-300 send-icon animate-sent"}):e.jsx(ai,{className:`text-lg text-white group-hover:scale-110 transition-all duration-300 send-icon ${dr?"animate-fly":""}`})})})]}),_n&&e.jsx("div",{className:"px-3 pb-2",children:e.jsx("div",{className:"text-red-500 text-sm bg-red-50 p-2 rounded-lg border border-red-200",children:_n})}),zl&&B.length>0&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-4 shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("span",{className:"text-lg font-medium text-gray-700",children:["Image Preview (",B.length," image",B.length!==1?"s":"",")"]}),e.jsx("button",{onClick:()=>{kt([]),Lt({}),Je(0),Ps(!1)},className:"text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors",children:e.jsx(te,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"relative mb-4",children:[B.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>Je(t=>t>0?t-1:B.length-1),className:"absolute left-2 top-1/2 transform -translate-y-1/2 z-10 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-70 transition-all duration-200",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("button",{onClick:()=>Je(t=>t<B.length-1?t+1:0),className:"absolute right-2 top-1/2 transform -translate-y-1/2 z-10 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-70 transition-all duration-200",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]}),e.jsx("div",{className:"mb-3",children:e.jsx("img",{src:URL.createObjectURL(B[Ce]),alt:`Preview ${Ce+1}`,className:"w-full h-64 object-contain rounded-lg border"})}),e.jsxs("div",{className:"text-center text-sm text-gray-600 mb-3",children:[Ce+1," of ",B.length]}),e.jsxs("div",{className:"flex gap-2 mb-3 overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 pb-2 min-w-0 max-w-full",style:{scrollbarWidth:"thin",scrollbarColor:"#d1d5db #f3f4f6"},children:[B.map((t,s)=>e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>Je(s),className:`flex-shrink-0 w-12 h-12 rounded-lg border-2 transition-all duration-200 ${s===Ce?"border-blue-500 shadow-lg":"border-gray-300 hover:border-gray-400"}`,children:e.jsx("img",{src:URL.createObjectURL(t),alt:`Thumbnail ${s+1}`,className:"w-full h-full object-cover rounded-lg"})}),B.length>1&&e.jsx("button",{onClick:a=>{a.stopPropagation();const r=B.filter((i,d)=>d!==s),l={...Ls};delete l[t.name],r.length===0?(kt([]),Lt({}),Ps(!1)):(kt(r),Lt(l),Ce>=r.length?Je(r.length-1):Ce>s&&Je(Ce-1))},className:"absolute -top-1 -right-1 bg-red-500 hover:bg-red-600 text-white rounded-full p-1 shadow-lg transition-all duration-200 hover:scale-110 z-10",title:"Remove this image","aria-label":"Remove this image",children:e.jsx(te,{className:"w-2 h-2"})})]},s)),B.length<10&&e.jsx("div",{className:"relative",children:e.jsxs("label",{className:"flex-shrink-0 w-12 h-12 rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-400 hover:bg-blue-50 transition-all duration-200 cursor-pointer flex items-center justify-center group",children:[e.jsx("input",{type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:t=>{const s=t.target.files;if(s&&s.length>0){const a=10-B.length,r=Array.from(s).slice(0,a);if(r.length>0){const l=[...B,...r];kt(l),r.length<s.length&&u.info(`Added ${r.length} images. Maximum limit of 10 images reached.`)}t.target.value=""}}}),e.jsx("svg",{className:"w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})]})})]})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx("textarea",{placeholder:`Add a caption for ${(nl=B[Ce])==null?void 0:nl.name}...`,value:Ls[(ll=B[Ce])==null?void 0:ll.name]||"",onChange:t=>Lt(s=>{var a;return{...s,[(a=B[Ce])==null?void 0:a.name]:t.target.value}}),className:"w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:3,maxLength:500}),e.jsx("div",{className:"absolute right-2 top-2",children:e.jsx(Js,{onEmojiClick:t=>{var a;if(m){u.info("Emoji sending disabled for this appointment status. You can view chat history.");return}const s=Ls[(a=B[Ce])==null?void 0:a.name]||"";Lt(r=>{var l;return{...r,[(l=B[Ce])==null?void 0:l.name]:s+t}})},className:"w-6 h-6",disabled:m})}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-right",children:[(Ls[(ol=B[Ce])==null?void 0:ol.name]||"").length,"/500"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"text-sm text-gray-600",children:Ct&&An>=0?e.jsxs("span",{children:["Uploading ",An+1," / ",B.length,` â€¢ ${Ol}%`]}):e.jsxs(e.Fragment,{children:[B.length," image",B.length!==1?"s":""," ready to send",ms.length>0&&e.jsxs("span",{className:"ml-2 text-red-600",children:["â€¢ ",ms.length," failed"]})]})}),e.jsx("div",{className:"flex items-center gap-2",children:Ct?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Tr,className:"bg-red-600 text-white py-2 px-3 rounded-lg hover:bg-red-700 text-sm font-medium transition-colors",children:"Cancel Upload"}),e.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-2 bg-blue-600 rounded-full transition-all",style:{width:`${St}%`}})}),e.jsxs("span",{className:"text-sm text-gray-700 w-10 text-right",children:[St,"%"]})]}):e.jsxs(e.Fragment,{children:[ms.length>0&&e.jsxs("button",{onClick:go,className:"bg-yellow-500 text-white py-2 px-3 rounded-lg hover:bg-yellow-600 text-sm font-medium transition-colors",children:["Retry Failed (",ms.length,")"]}),e.jsx("button",{onClick:zn,disabled:m,className:`py-2 px-4 rounded-lg text-sm font-medium transition-colors ${m?"bg-gray-400 text-gray-200 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:`Send ${B.length} Image${B.length!==1?"s":""}`})]})})]})]})}),Wl&&Xe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-4 shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-lg font-medium text-gray-700",children:"Video Preview"}),e.jsx("button",{onClick:()=>{Na(null),Ca(!1)},className:"text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors",children:e.jsx(te,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-1 mb-4 min-h-0",children:e.jsx("video",{controls:!0,className:"w-full h-full max-h-[60vh] rounded-lg border",src:Gl})}),e.jsxs("div",{className:"relative mb-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:yr,placeholder:`Add a caption for ${Xe.name}...`,value:zs,onChange:t=>_a(t.target.value),className:"w-full p-3 pr-12 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:2,maxLength:500}),e.jsx("div",{className:"absolute right-2 top-2",children:e.jsx(Js,{onEmojiClick:t=>{const s=yr.current;if(s){const a=s.selectionStart,r=s.selectionEnd,l=zs.slice(0,a)+t+zs.slice(r);_a(l),setTimeout(()=>{s.focus(),s.setSelectionRange(a+t.length,a+t.length)},0)}},inputRef:yr})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-right",children:[zs.length,"/500"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600 truncate flex-1 mr-4",children:Xe.name}),e.jsx("div",{className:"flex gap-2 flex-shrink-0",children:Ct?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Tr,className:"px-4 py-2 rounded-lg border border-red-300 text-red-600 hover:bg-red-50",children:"Cancel"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-2 bg-blue-600 rounded-full transition-all",style:{width:`${St}%`}})}),e.jsxs("span",{className:"text-sm text-gray-700 w-10 text-right",children:[St,"%"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{Na(null),Ca(!1),_a("")},className:"px-4 py-2 rounded-lg border",children:"Cancel"}),e.jsx("button",{onClick:co,className:"px-4 py-2 rounded-lg bg-blue-600 text-white",children:"Send"})]})})]})]})}),Zl&&et&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-4 shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-lg font-medium text-gray-700",children:"Audio Preview"}),e.jsx("button",{onClick:()=>{fs(null),Us(!1)},className:"text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors",children:e.jsx(te,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"mb-4",children:e.jsx("audio",{controls:!0,className:"w-full",src:Jl})}),e.jsxs("div",{className:"relative mb-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:Ar,placeholder:`Add a caption for ${et.name}...`,value:Hs,onChange:t=>_r(t.target.value),className:"w-full p-3 pr-12 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:2,maxLength:500}),e.jsx("div",{className:"absolute right-2 top-2",children:e.jsx(Js,{onEmojiClick:t=>{const s=Ar.current;if(s){const a=s.selectionStart,r=s.selectionEnd,l=Hs.slice(0,a)+t+Hs.slice(r);_r(l),setTimeout(()=>{s.focus(),s.setSelectionRange(a+t.length,a+t.length)},0)}},inputRef:Ar})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-right",children:[Hs.length,"/500"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600 truncate flex-1 mr-4",children:et.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{fs(null),Us(!1)},className:"py-2 px-4 rounded-lg text-sm font-medium border hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:mo,disabled:m,className:`py-2 px-4 rounded-lg text-sm font-medium transition-colors ${m?"bg-gray-400 text-gray-200 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:"Send Audio"})]})]}),Ct&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full",style:{width:`${St}%`}})}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-right",children:[St,"%"]})]})]})}),Ql&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-4 shadow-2xl max-w-md w-full",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-lg font-medium text-gray-700",children:"Record Audio"}),e.jsx("button",{onClick:Pn,className:"text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors",children:e.jsx(te,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center gap-4 py-4",children:[e.jsx("div",{className:`w-24 h-24 rounded-full flex items-center justify-center ${ps?"bg-red-100":"bg-gray-100"}`,children:e.jsxs("svg",{className:`w-10 h-10 ${ps?"text-red-600 animate-pulse":"text-gray-600"}`,viewBox:"0 0 24 24",fill:"currentColor",children:[e.jsx("path",{d:"M12 14a3 3 0 003-3V7a3 3 0 10-6 0v4a3 3 0 003 3z"}),e.jsx("path",{d:"M19 11a7 7 0 11-14 0h2a5 5 0 0010 0h2z"})]})}),e.jsx("div",{className:"text-sm text-gray-600",children:ps?`${Math.floor(In/6e4).toString().padStart(2,"0")}:${Math.floor(In%6e4/1e3).toString().padStart(2,"0")}`:"Ready"}),e.jsxs("div",{className:"flex items-center gap-3",children:[ps?e.jsx("button",{onClick:no,className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700",children:"Stop & Preview"}):e.jsx("button",{onClick:ro,className:"px-4 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700",children:"Start"}),e.jsx("button",{onClick:Pn,className:"px-4 py-2 rounded-lg border",children:"Cancel"})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Your mic input stays on device until you choose to send."})]})]})}),Kl&&Rt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-4 shadow-2xl max-w-md w-full",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-lg font-medium text-gray-700",children:"Document Preview"}),e.jsx("button",{onClick:()=>{ka(null),Sa(!1)},className:"text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors",children:e.jsx(te,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"mb-4 flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded flex items-center justify-center text-gray-600",children:"ðŸ“„"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-medium truncate",children:Rt.name}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:Rt.type||"Document"})]})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:wr,placeholder:`Add a caption for ${Rt.name}...`,value:Os,onChange:t=>Ra(t.target.value),className:"w-full p-3 pr-12 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:2,maxLength:500}),e.jsx("div",{className:"absolute right-2 top-2",children:e.jsx(Js,{onEmojiClick:t=>{const s=wr.current;if(s){const a=s.selectionStart,r=s.selectionEnd,l=Os.slice(0,a)+t+Os.slice(r);Ra(l),setTimeout(()=>{s.focus(),s.setSelectionRange(a+t.length,a+t.length)},0)}},inputRef:wr})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-right",children:[Os.length,"/500"]})]}),e.jsx("div",{className:"flex items-center justify-between",children:Ct?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Tr,className:"px-4 py-2 rounded-lg border border-red-300 text-red-600 hover:bg-red-50",children:"Cancel"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-2 bg-blue-600 rounded-full transition-all",style:{width:`${St}%`}})}),e.jsxs("span",{className:"text-sm text-gray-700 w-10 text-right",children:[St,"%"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{ka(null),Sa(!1),Ra("")},className:"px-4 py-2 rounded-lg border",children:"Cancel"}),e.jsx("button",{onClick:xo,className:"px-4 py-2 rounded-lg bg-blue-600 text-white",children:"Send"})]})})]})}),e.jsx("style",{jsx:!0,children:`
                  @keyframes fadeInChatBubble {
                    from { opacity: 0; transform: translateY(20px) scale(0.95); }
                    to { opacity: 1; transform: translateY(0) scale(1); }
                  }
                  .animate-fadeInChatBubble {
                    animation: fadeInChatBubble 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
                  }
                  @keyframes fadeInChat {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                  }
                  .animate-fadeInChat {
                    animation: fadeInChat 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
                  }
                  @keyframes gentlePulse {
                    0%, 100% { opacity: 1; transform: scale(1); }
                    50% { opacity: 0.9; transform: scale(1.01); }
                  }
                  .animate-gentlePulse {
                    animation: gentlePulse 3s ease-in-out infinite;
                  }
                  @keyframes attentionGlow {
                    0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
                    50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
                  }
                  .animate-attentionGlow {
                    animation: attentionGlow 2s ease-in-out infinite;
                  }
                  @keyframes slideInFromTop {
                    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
                    to { opacity: 1; transform: translateY(0) scale(1); }
                  }
                  .animate-slideInFromTop {
                    animation: slideInFromTop 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
                  }
                  @keyframes sendIconFly {
                    0% { 
                      transform: translate(0, 0) scale(1); 
                      opacity: 1;
                    }
                    20% { 
                      transform: translate(0, 0) scale(1.2); 
                      opacity: 1;
                    }
                    40% { 
                      transform: translate(15px, -20px) scale(1.3); 
                      opacity: 0.8;
                    }
                    60% { 
                      transform: translate(25px, -35px) scale(1.4); 
                      opacity: 0.6;
                    }
                    80% { 
                      transform: translate(15px, -20px) scale(1.2); 
                      opacity: 0.8;
                    }
                    100% { 
                      transform: translate(0, 0) scale(1); 
                      opacity: 1;
                    }
                  }
                  .send-icon.animate-fly {
                    animation: sendIconFly 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                  }
                  @keyframes sentSuccess {
                    0% { 
                      transform: scale(0.8); 
                      opacity: 0;
                    }
                    50% { 
                      transform: scale(1.2); 
                      opacity: 1;
                    }
                    100% { 
                      transform: scale(1); 
                      opacity: 1;
                    }
                  }
                  .send-icon.animate-sent {
                    animation: sentSuccess 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                  }
                  @keyframes editSaving {
                    0% { 
                      transform: scale(1) rotate(0deg) translate(0, 0); 
                      opacity: 1;
                    }
                    20% { 
                      transform: scale(1.15) rotate(-8deg) translate(-1px, -1px); 
                      opacity: 0.9;
                    }
                    40% { 
                      transform: scale(1.25) rotate(0deg) translate(0, -2px); 
                      opacity: 1;
                    }
                    60% { 
                      transform: scale(1.15) rotate(8deg) translate(1px, -1px); 
                      opacity: 0.9;
                    }
                    80% { 
                      transform: scale(1.1) rotate(-4deg) translate(-1px, 0); 
                      opacity: 0.95;
                    }
                    100% { 
                      transform: scale(1) rotate(0deg) translate(0, 0); 
                      opacity: 1;
                    }
                  }
                  .animate-editSaving {
                    animation: editSaving 1.2s ease-in-out infinite;
                  }
                  .search-highlight {
                    animation: searchHighlight 2s ease-in-out;
                  }
                  @keyframes searchHighlight {
                    0%, 100% { box-shadow: 0 0 0 rgba(59, 130, 246, 0); }
                    50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
                  }
                  .date-highlight {
                    animation: dateHighlight 3s ease-in-out;
                  }
                  @keyframes dateHighlight {
                    0%, 100% { box-shadow: 0 0 0 rgba(168, 85, 247, 0); }
                    50% { box-shadow: 0 0 25px rgba(168, 85, 247, 0.9); }
                  }
                `}),(typeof isChatDisabled<"u"?isChatDisabled:m)&&e.jsxs("div",{className:"px-4 sm:px-6 py-2 bg-blue-50 text-blue-800 text-sm border-b border-blue-200 flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})}),e.jsx("span",{children:"Chat is read-only for this appointment status"})]})]}),!_&&!(typeof isChatDisabled<"u"?isChatDisabled:m)&&!W&&!be&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsxs("button",{onClick:()=>{xt(Math.max(Yt,ee.length)),Jn()},className:"bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-full p-3 shadow-xl transition-all duration-200 hover:scale-110 relative transform hover:shadow-2xl",title:U>0?`${U} new message${U>1?"s":""}`:"Jump to latest","aria-label":U>0?`${U} new messages, jump to latest`:"Jump to latest",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})}),U>0&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 border-2 border-white shadow-lg",children:U>99?"99+":U})]})}),k&&e.jsx("div",{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 z-30",children:e.jsxs("div",{className:"bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-fadeIn",children:[e.jsx(Ve,{className:"text-white"}),e.jsx("span",{className:"text-sm font-medium",children:"Message deleted for you"}),e.jsx("button",{onClick:wo,className:"bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors",children:"Undo"})]})})]})]}),Ya&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",className:"text-blue-600",children:e.jsx("path",{d:"M18 10v-4c0-3.313-2.687-6-6-6s-6 2.687-6 6v4H4v10h16V10h-2zM8 6c0-2.206 1.794-4 4-4s4 1.794 4 4v4H8V6z"})}),"Lock Chat"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Create a password to lock your chat. You'll need this password to access the chat later."}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Password (minimum 4 characters)"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:ia?"text":"password",value:Rs,onChange:t=>Xa(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10",placeholder:"Enter password"}),e.jsx("button",{type:"button",onClick:()=>Qr(!ia),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600",children:ia?"ðŸ‘ï¸":"ðŸ‘ï¸â€ðŸ—¨ï¸"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Confirm Password"}),e.jsx("input",{type:ia?"text":"password",value:er,onChange:t=>tr(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Confirm password"})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end mt-6",children:[e.jsx("button",{type:"button",onClick:()=>{Wa(!1),Xa(""),tr(""),Qr(!1)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsx("button",{type:"button",onClick:fo,disabled:en,className:"px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2 disabled:opacity-50",children:en?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Locking..."]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M18 10v-4c0-3.313-2.687-6-6-6s-6 2.687-6 6v4H4v10h16V10h-2zM8 6c0-2.206 1.794-4 4-4s4 1.794 4 4v4H8V6z"})}),"Lock Chat"]})})]})]})}),Ka&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",className:"text-orange-600",children:e.jsx("path",{d:"M18 10v-4c0-3.313-2.687-6-6-6s-6 2.687-6 6v4H4v10h16V10h-2zM8 6c0-2.206 1.794-4 4-4s4 1.794 4 4v4H8V6z"})}),"Chat is Locked"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"This chat is protected with a password. Enter your password to access the chat."}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Password"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:lr?"text":"password",value:sr,onChange:t=>ar(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 pr-10",placeholder:"Enter password",onKeyPress:t=>t.key==="Enter"&&On()}),e.jsx("button",{type:"button",onClick:()=>Xr(!lr),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600",children:lr?"ðŸ‘ï¸":"ðŸ‘ï¸â€ðŸ—¨ï¸"})]})]}),e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsx("button",{type:"button",onClick:()=>{rs(!1),Qa(!0)},className:"text-sm text-blue-600 hover:text-blue-800 underline",children:"Forgot password?"})}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{rs(!1),ar(""),Xr(!1)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsx("button",{type:"button",onClick:On,disabled:sn,className:"px-4 py-2 rounded bg-orange-600 text-white font-semibold hover:bg-orange-700 transition-colors flex items-center gap-2 disabled:opacity-50",children:sn?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Unlocking..."]}):"Unlock Chat"})]})]})}),Ja&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",className:"text-red-600",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"})}),"Forgot Password"]}),e.jsx("div",{className:"bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-yellow-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-yellow-800",children:"Warning"}),e.jsxs("div",{className:"mt-2 text-sm text-yellow-700",children:[e.jsx("p",{children:"This action will permanently:"}),e.jsxs("ul",{className:"list-disc list-inside mt-1",children:[e.jsx("li",{children:"Clear all chat messages"}),e.jsx("li",{children:"Remove the chat lock"}),e.jsx("li",{children:"Clear the passcode if set"})]})]})]})]})}),e.jsx("p",{className:"text-gray-600 mb-6",children:"This action cannot be undone. Are you sure you want to proceed?"}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>Qa(!1),className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsx("button",{type:"button",onClick:po,disabled:ln,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2 disabled:opacity-50",children:ln?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Processing..."]}):"Continue"})]})]})}),Ga&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",className:"text-red-600",children:e.jsx("path",{d:"M18 10v-4c0-3.313-2.687-6-6-6s-6 2.687-6 6v4H4v10h16V10h-2zM8 6c0-2.206 1.794-4 4-4s4 1.794 4 4v4H8V6z"})}),"Remove Chat Lock"]}),e.jsx("div",{className:"bg-red-50 border-l-4 border-red-400 p-4 mb-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-red-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-red-800",children:"Permanent Action"}),e.jsx("div",{className:"mt-2 text-sm text-red-700",children:e.jsx("p",{children:"This will remove the chat lock and disable password protection for this conversation. You can lock this chat again at any time from the options."})})]})]})}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Enter your chat lock password to confirm this action."}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Password"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:or?"text":"password",value:rr,onChange:t=>nr(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 pr-10",placeholder:"Enter your chat lock password",onKeyPress:t=>t.key==="Enter"&&Un()}),e.jsx("button",{type:"button",onClick:()=>ir(!or),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600",children:or?"ðŸ‘ï¸":"ðŸ‘ï¸â€ðŸ—¨ï¸"})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Za(!1),nr(""),ir(!1)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsx("button",{type:"button",onClick:Un,disabled:rn,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2 disabled:opacity-50",children:rn?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Removing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M18 10v-4c0-3.313-2.687-6-6-6s-6 2.687-6 6v4H4v10h16V10h-2zM8 6c0-2.206 1.794-4 4-4s4 1.794 4 4v4H8V6z"})}),"Remove Lock"]})})]})]})}),na&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(Z,{className:"text-red-500"}),Array.isArray(T)?"Delete Selected Messages":"Delete Message"]}),!Array.isArray(T)&&(T!=null&&T.deleted)?e.jsx("p",{className:"text-gray-600 mb-6",children:"Delete this message for me?"}):Array.isArray(T)&&T.every(t=>t.senderEmail===h.email)||!Array.isArray(T)&&(T==null?void 0:T.senderEmail)===h.email?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-600 mb-4",children:Array.isArray(T)?`Are you sure you want to delete ${T.length} messages?`:"Are you sure you want to delete this message?"}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("label",{className:`flex items-center gap-3 ${m?"cursor-not-allowed":"cursor-pointer"}`,children:[e.jsx("input",{type:"checkbox",checked:x,onChange:t=>{if(m){u.info("Delete for everyone is disabled for this appointment status. Only delete for me is allowed.");return}f(t.target.checked)},disabled:m,className:`form-checkbox h-4 w-4 text-red-600 rounded border-gray-300 focus:ring-red-500 ${m?"opacity-50 cursor-not-allowed":""}`}),e.jsxs("span",{className:`text-sm ${m?"text-gray-400":"text-gray-700"}`,children:["Also delete for"," ",e.jsx("span",{className:`font-medium ${m?"text-gray-400":"text-gray-900"}`,children:(v==null?void 0:v.username)||"other user"}),m&&" (Disabled for this appointment status)"]})]}),e.jsx("p",{className:`text-xs mt-1 ml-7 ${m?"text-gray-400":"text-gray-500"}`,children:m?Array.isArray(T)?"The selected messages will only be deleted for you":"The message will only be deleted for you":x?Array.isArray(T)?"The selected messages will be permanently deleted for everyone":"The message will be permanently deleted for everyone":Array.isArray(T)?"The selected messages will only be deleted for you":"The message will only be deleted for you"})]})]}):e.jsx("p",{className:"text-gray-600 mb-6",children:Array.isArray(T)?e.jsxs(e.Fragment,{children:["Delete selected messages from ",e.jsx("span",{className:"font-medium text-gray-900",children:(v==null?void 0:v.username)||"other user"}),"?"]}):e.jsxs(e.Fragment,{children:["Delete message from ",e.jsx("span",{className:"font-medium text-gray-900",children:(v==null?void 0:v.username)||"other user"}),"?"]})}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{st(!1),Ze(null),f(!0)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:So,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(Z,{size:12}),Array.isArray(T)?T.every(t=>t.senderEmail===h.email)&&x?"Delete for everyone":"Delete for me":T!=null&&T.deleted?"Delete for me":(T==null?void 0:T.senderEmail)===h.email&&x?"Delete for everyone":"Delete for me"]})]})]})}),b&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(Z,{className:"text-red-500"}),"Clear Chat"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to clear chat? This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>C(!1),className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:_o,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(Z,{size:12}),"Clear Chat"]})]})]})}),_l&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(Z,{className:"text-red-500"}),"Delete Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to delete this appointment?"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for deletion (required):"}),e.jsx("textarea",{value:Dl,onChange:t=>un(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for deleting this appointment..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Rl(!1),Ml(null),un("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmAdminDelete,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(Z,{size:12}),"Delete Appointment"]})]})]})}),Oa&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(vs,{className:"text-orange-500"}),"Cancel Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to cancel this appointment?"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for cancellation (required):"}),e.jsx("textarea",{value:ns,onChange:t=>vt(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500",rows:"3",placeholder:Le?"Please provide a reason for cancelling...":"Optional reason for cancelling..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Ua(!1),vt("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Po,className:"px-4 py-2 rounded bg-orange-600 text-white font-semibold hover:bg-orange-700 transition-colors flex items-center gap-2",children:[e.jsx(vs,{size:12}),"Cancel Appointment"]})]})]})}),Al&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(vs,{className:"text-red-500"}),"Admin Cancel Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to cancel this appointment as admin?"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for admin cancellation (required):"}),e.jsx("textarea",{value:ns,onChange:t=>vt(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for admin cancellation..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Ha(!1),vt("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Bo,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(vs,{size:12}),"Cancel as Admin"]})]})]})}),Va&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(Z,{className:"text-red-500"}),"Remove Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to permanently remove this appointment from your table? This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>qa(!1),className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:zo,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(Z,{size:12}),"Remove Permanently"]})]})]})}),we&&lt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(Ta,{className:"text-red-500"})," Report message"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason"}),e.jsxs("select",{value:ue,onChange:t=>Et(t.target.value),className:"w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 text-gray-900",children:[e.jsx("option",{value:"",children:"-- Select a reason --"}),e.jsx("option",{value:"Spam or scam",children:"Spam or scam"}),e.jsx("option",{value:"Harassment or hate speech",children:"Harassment or hate speech"}),e.jsx("option",{value:"Inappropriate content",children:"Inappropriate content"}),e.jsx("option",{value:"Sensitive or personal data",children:"Sensitive or personal data"}),e.jsx("option",{value:"Fraud or illegal activity",children:"Fraud or illegal activity"}),e.jsx("option",{value:"Other",children:"Other"})]})]}),ue&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:ue==="Other"?"Additional details *":"Additional details (optional)"}),e.jsx("textarea",{value:rt,onChange:t=>nt(t.target.value),rows:4,placeholder:ue==="Other"?"Please provide details about the issue...":"Add any context to help admins review...",className:"w-full p-2 border border-gray-300 rounded resize-y focus:outline-none focus:ring-2 focus:ring-red-500 text-gray-900"})]}),e.jsxs("div",{className:"bg-gray-50 rounded p-3 text-sm text-gray-700",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Message excerpt:"}),e.jsx("div",{className:"line-clamp-4 whitespace-pre-wrap",children:(lt.message||"").slice(0,300)})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>{at(!1),ot(null),Et(""),nt("")},className:"px-4 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:async()=>{var t,s;if(!ue){u.error("Please select a reason");return}wt(!0);try{const{data:a}=await D.post(`${M}/api/notifications/report-chat`,{appointmentId:n._id,commentId:lt._id,reason:ue,details:rt},{withCredentials:!0,headers:{"Content-Type":"application/json"}});u.info("Thank you for reporting."),at(!1),ot(null),Et(""),nt("")}catch(a){u.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Network error while reporting")}finally{wt(!1)}},disabled:yt||!ue||ue==="Other"&&!rt.trim(),className:"px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 disabled:opacity-50",children:yt?"Reportingâ€¦":"Report"})]})]})}),la&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-2xl w-full mx-4 shadow-xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(Ta,{className:"text-red-500"})," Report Chat"]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(He,{className:"text-blue-500 text-sm"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"The last 5 messages in this chat will be sent to UrbanSetu. This person won't know you reported them:"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200 max-h-48 overflow-y-auto",children:[ee.slice(-5).map((t,s)=>e.jsx("div",{className:"mb-3 last:mb-0",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-xs font-semibold text-blue-600 flex-shrink-0",children:t.senderName?t.senderName.charAt(0).toUpperCase():"U"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-600",children:t.senderName||"Unknown User"}),e.jsx("span",{className:"text-xs text-gray-400",children:new Date(t.timestamp).toLocaleString()})]}),e.jsx("div",{className:"text-sm text-gray-700 bg-white rounded p-2 border border-gray-200",children:t.type==="image"?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{children:["ðŸ“· Image: ",t.message]}),t.imageUrl&&e.jsx("img",{src:t.imageUrl,alt:"Reported image",className:"w-8 h-8 object-cover rounded",onError:a=>a.target.style.display="none"})]}):e.jsx("span",{className:"whitespace-pre-wrap break-words",children:t.message})})]})]})},t._id||s)),ee.length===0&&e.jsx("div",{className:"text-center text-gray-500 text-sm py-4",children:"No messages to report"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason"}),e.jsxs("select",{value:Oe,onChange:t=>Xt(t.target.value),className:"w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 text-gray-900",children:[e.jsx("option",{value:"",children:"Select a reason"}),e.jsx("option",{value:"harassment",children:"Harassment or bullying"}),e.jsx("option",{value:"spam",children:"Spam or unwanted messages"}),e.jsx("option",{value:"inappropriate",children:"Inappropriate content"}),e.jsx("option",{value:"scam",children:"Scam or fraud"}),e.jsx("option",{value:"threats",children:"Threats or violence"}),e.jsx("option",{value:"privacy",children:"Privacy violation"}),e.jsx("option",{value:"other",children:"Other"})]})]}),Oe&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:Oe==="other"?"Additional details *":"Additional details (optional)"}),e.jsx("textarea",{value:es,onChange:t=>ts(t.target.value),rows:4,placeholder:Oe==="other"?"Please provide details about the issue...":"Provide more context to help admins review this chat...",className:"w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 text-gray-900"})]})]}),e.jsxs("div",{className:"flex gap-2 justify-end mt-6",children:[e.jsx("button",{onClick:()=>{Qt(!1),Xt(""),ts("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300",children:"Cancel"}),e.jsx("button",{onClick:async()=>{var t,s;if(!Oe){u.error("Please select a reason");return}Zr(!0);try{const{data:a}=await D.post(`${M}/api/notifications/report-chat-conversation`,{appointmentId:n._id,reason:Oe,details:es},{withCredentials:!0,headers:{"Content-Type":"application/json"}});u.info("Thank you for reporting."),Qt(!1),Xt(""),ts("")}catch(a){u.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Network error while reporting")}finally{Zr(!1)}},disabled:_s||!Oe||Oe==="other"&&!es.trim(),className:"px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 disabled:opacity-50",children:_s?"Reportingâ€¦":"Report"})]})]})}),El&&Ie&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(He,{className:"text-blue-500"})," Message Info"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded p-3 text-sm text-gray-700",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Message:"}),e.jsxs("div",{className:"whitespace-pre-wrap break-words",children:[(Ie.message||"").slice(0,200),(Ie.message||"").length>200?"...":""]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Sent:"}),e.jsx("span",{className:"text-sm text-gray-800",children:new Date(Ie.timestamp).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})})]}),Ie.deliveredAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Delivered:"}),e.jsx("span",{className:"text-sm text-gray-800",children:new Date(Ie.deliveredAt).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})})]}),Ie.readAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Read:"}),e.jsx("span",{className:"text-sm text-gray-800",children:new Date(Ie.readAt).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})})]}),!Ie.deliveredAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Status:"}),e.jsx("span",{className:"text-sm text-gray-500",children:"Not delivered yet"})]}),Ie.deliveredAt&&!Ie.readAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Status:"}),e.jsx("span",{className:"text-sm text-blue-600",children:"Delivered"})]}),Ie.readAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Status:"}),e.jsx("span",{className:"text-sm text-green-600",children:"Read"})]})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{onClick:()=>{mn(!1),hn(null)},className:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Close"})})]})}),cr&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-yellow-50 to-amber-50",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(zt,{className:"text-yellow-500"}),"Starred Messages"]}),e.jsx("button",{onClick:Hn,disabled:ur,className:"p-2 text-yellow-600 hover:text-yellow-700 bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:"Refresh starred messages",children:ur?e.jsx("div",{className:"w-4 h-4 border-2 border-yellow-600 border-t-transparent rounded-full animate-spin"}):e.jsx(bl,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:ur?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-500"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading starred messages..."})]}):it.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Hr,{className:"mx-auto text-6xl text-gray-300 mb-4"}),e.jsx("h4",{className:"text-xl font-semibold text-gray-600 mb-2",children:"No Starred Messages"}),e.jsx("p",{className:"text-gray-500",children:"Star important messages to find them easily later."})]}):e.jsx("div",{className:"space-y-4",children:it.map((t,s)=>{const a=t.senderEmail===h.email,r=new Date(t.timestamp);return e.jsx("div",{className:`flex w-full ${a?"justify-end":"justify-start"} mb-4`,children:e.jsxs("div",{className:`relative max-w-[80%] ${a?"ml-12":"mr-12"}`,children:[e.jsxs("div",{className:`flex items-center gap-2 mb-1 ${a?"justify-end":"justify-start"}`,children:[e.jsx(zt,{className:"text-yellow-500 text-xs"}),e.jsx("span",{className:`text-xs font-medium ${a?"text-blue-600":"text-green-600"}`,children:a?"You":t.senderName||"Other Party"}),e.jsx("span",{className:"text-xs text-gray-500",children:r.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})}),e.jsx("button",{onClick:async()=>{var l,i;wn(t._id);try{const{data:d}=await D.patch(`${M}/api/bookings/${n._id}/comment/${t._id}/star`,{starred:!1},{withCredentials:!0,headers:{"Content-Type":"application/json"}});A(c=>c.map(g=>g._id===t._id?{...g,starredBy:(g.starredBy||[]).filter(p=>p!==h._id)}:g)),It(c=>c.filter(g=>g._id!==t._id)),u.success("Message unstarred.")}catch(d){u.error(((i=(l=d.response)==null?void 0:l.data)==null?void 0:i.message)||"Failed to unstar message")}finally{wn(null)}},className:"text-red-500 hover:text-red-700 text-xs p-1 rounded-full hover:bg-red-50 transition-colors",title:"Remove from starred messages",disabled:yn===t._id,children:yn===t._id?e.jsx("div",{className:"w-3 h-3 border border-red-500 border-t-transparent rounded-full animate-spin"}):e.jsx(te,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:`rounded-2xl px-4 py-3 text-sm shadow-lg break-words relative group cursor-pointer hover:shadow-xl transition-all duration-200 ${a?"bg-gradient-to-r from-blue-600 to-purple-700 text-white hover:from-blue-500 hover:to-purple-600":"bg-white text-gray-800 border border-gray-200 hover:bg-gray-50 hover:border-gray-300"}`,onClick:()=>{ua(!1);const l=document.querySelector(`[data-message-id="${t._id}"]`);l&&(l.scrollIntoView({behavior:"smooth",block:"center"}),l.classList.add("starred-highlight"),setTimeout(()=>{l.classList.remove("starred-highlight")},1600))},children:[e.jsx("div",{className:"whitespace-pre-wrap break-words",children:t.deleted?e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(vs,{className:"inline-block text-lg"})," ",t.senderEmail===h.email?"You deleted this message":"This message was deleted."]}):e.jsxs(e.Fragment,{children:[t.imageUrl&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:t.imageUrl,alt:"Shared image",className:"max-w-full max-h-64 rounded-lg cursor-pointer hover:opacity-90 transition-opacity",onClick:l=>{l.stopPropagation();const i=($||[]).filter(c=>!!c.imageUrl).map(c=>c.imageUrl),d=Math.max(0,i.indexOf(t.imageUrl));Rn(i),Je(d),pr(!0)},onError:l=>{l.target.src="https://via.placeholder.com/300x200?text=Image+Not+Found",l.target.className="max-w-full max-h-64 rounded-lg opacity-50"}})}),e.jsx(vl,{text:(t.message||"").replace(/\n+$/,""),isSentMessage:a,className:"whitespace-pre-wrap break-words",searchQuery:fr})]})}),!t.deleted&&e.jsx("button",{onClick:l=>{l.stopPropagation(),Q(t.message)},className:`absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 p-1.5 rounded-full ${a?"bg-white/20 hover:bg-white/30 text-white":"bg-gray-100 hover:bg-gray-200 text-gray-600"}`,title:"Copy message",children:e.jsx(Ia,{className:"w-3 h-3"})}),t.edited&&e.jsx("div",{className:`flex justify-end mt-2 text-xs ${a?"text-blue-200":"text-gray-500"}`,children:e.jsx("span",{className:"italic",children:"(Edited)"})})]})]})},t._id)})})}),e.jsx("div",{className:"p-6 border-t border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:[it.length," starred message",it.length!==1?"s":""]}),e.jsxs("div",{className:"flex gap-2",children:[it.length>0&&e.jsx("button",{onClick:yo,disabled:vn,className:"px-2 sm:px-4 py-1.5 sm:py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:bg-red-400 disabled:cursor-not-allowed transition-colors font-medium flex items-center gap-1 sm:gap-2 text-xs sm:text-sm",children:vn?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Removing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"w-4 h-4"}),"Remove All"]})}),e.jsx("button",{onClick:()=>ua(!1),className:"px-2 sm:px-4 py-1.5 sm:py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors font-medium text-xs sm:text-sm",children:"Close"})]})]})})]})}),Tl&&Ae&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden",children:[e.jsx("div",{className:"flex items-center p-6 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-blue-50",children:e.jsxs("h3",{className:"text-xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Ot,{className:"text-purple-500"}),"Pin Message"]})}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-gray-600 mb-4",children:Array.isArray(Ae)?`Choose how long to pin these ${Ae.length} messages:`:"Choose how long to pin this message:"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:[e.jsx("input",{type:"radio",name:"pinDuration",value:"24hrs",checked:Ne==="24hrs",onChange:t=>cs(t.target.value),className:"text-purple-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-800",children:"24 Hours"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Pin for 24 hours"})]})]}),e.jsxs("label",{className:"flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:[e.jsx("input",{type:"radio",name:"pinDuration",value:"7days",checked:Ne==="7days",onChange:t=>cs(t.target.value),className:"text-purple-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-800",children:"7 Days"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Pin for 7 days"})]})]}),e.jsxs("label",{className:"flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:[e.jsx("input",{type:"radio",name:"pinDuration",value:"30days",checked:Ne==="30days",onChange:t=>cs(t.target.value),className:"text-purple-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-800",children:"30 Days"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Pin for 30 days"})]})]}),e.jsxs("label",{className:"flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:[e.jsx("input",{type:"radio",name:"pinDuration",value:"custom",checked:Ne==="custom",onChange:t=>cs(t.target.value),className:"text-purple-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-800",children:"Custom"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Pin for custom hours"})]})]})]}),Ne==="custom"&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Custom Hours"}),e.jsx("input",{type:"number",min:"1",max:"8760",value:xa,onChange:t=>hr(Math.max(1,parseInt(t.target.value)||1)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500",placeholder:"Enter hours (1-8760)"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Maximum: 8760 hours (1 year)"})]}),e.jsxs("div",{className:"mt-4 p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-2",children:Array.isArray(Ae)?"Messages to pin:":"Message to pin:"}),Array.isArray(Ae)?e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto",children:Ae.map((t,s)=>{var a,r;return e.jsxs("div",{className:"text-sm text-gray-800 bg-white p-2 rounded border",children:[e.jsxs("span",{className:"font-medium text-xs text-gray-500",children:["#",s+1,": "]}),(a=t.message)==null?void 0:a.substring(0,80),((r=t.message)==null?void 0:r.length)>80?"...":""]},t._id)})}):e.jsxs("div",{className:"text-sm text-gray-800 bg-white p-2 rounded border",children:[(il=Ae.message)==null?void 0:il.substring(0,100),((dl=Ae.message)==null?void 0:dl.length)>100?"...":""]})]})]})}),e.jsxs("div",{className:"p-6 border-t border-gray-200 bg-gray-50 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>{is(!1),ds(null),cs("24hrs"),hr(24)},className:"px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors font-medium",children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(Array.isArray(Ae)){ha(!0);try{let t=0,s=0;const a=[],r=[];for(const l of Ae)try{const i=await D.patch(`${M}/api/bookings/${n._id}/comment/${l._id}/pin`,{pinned:!0,pinDuration:Ne,customHours:Ne==="custom"?xa:void 0},{withCredentials:!0,headers:{"Content-Type":"application/json"}});t++,r.push(l)}catch(i){console.error(`Failed to pin message ${l._id}:`,i),s++,a.push(l)}if(t>0){const l=new Date;let i;Ne==="24hrs"?i=new Date(l.getTime()+24*60*60*1e3):Ne==="7days"?i=new Date(l.getTime()+7*24*60*60*1e3):Ne==="30days"?i=new Date(l.getTime()+30*24*60*60*1e3):Ne==="custom"&&(i=new Date(l.getTime()+xa*60*60*1e3)),A(c=>c.map(g=>r.find(w=>w._id===g._id)?{...g,pinned:!0,pinnedBy:h._id,pinnedAt:l,pinExpiresAt:i,pinDuration:Ne}:g));const d=r.map(c=>({...c,pinned:!0,pinnedBy:h._id,pinnedAt:l,pinExpiresAt:i,pinDuration:Ne}));Ds(c=>[...c.filter(p=>!r.some(w=>w._id===p._id)),...d]),t>0&&s===0?(u.success(`Successfully pinned ${t} messages`),Te(!1),he([])):t>0&&s>0?u.warning(`Partially successful: ${t} messages pinned, ${s} failed`):u.error("Failed to pin any messages. Please try again.")}else u.error("Failed to pin any messages. Please try again.")}catch(t){console.error("Error in bulk pinning operation:",t),t.response&&(console.error("Response data:",t.response.data),console.error("Response status:",t.response.status)),u.error("Failed to pin messages. Please try again.")}finally{ha(!1)}}else Aa(Ae,!0,Ne,xa);is(!1),ds(null),cs("24hrs"),hr(24)},disabled:ma,className:"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:ma?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Pinning..."]}):Array.isArray(Ae)?`Pin ${Ae.length} Messages`:"Pin Message"})]})]})}),e.jsx(li,{isOpen:Fl,onClose:()=>pr(!1),images:Bl,initialIndex:Ce,listingId:null,metadata:{addedFrom:"chat",chatType:"appointment"}})]})}function ci({appointment:n,isBuyer:h}){var X;const[N,Ht]=o.useState(null),[Vt,mt]=o.useState(!0),[De,qe]=o.useState(!1),[Be,J]=o.useState(!1),[fe,Q]=o.useState({reason:"",amount:0,type:"full"}),[At,Se]=o.useState(!1),[Y,de]=o.useState(null),[$e,pe]=o.useState(!1),[be,ae]=o.useState({reason:"",text:""}),[F,H]=o.useState(!1);o.useEffect(()=>{$()},[n._id,n.paymentConfirmed]),o.useEffect(()=>(Be?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[Be]),o.useEffect(()=>($e?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[$e]),o.useEffect(()=>(De?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[De]);const $=async()=>{try{const I=await fetch(`https://urbansetu.onrender.com/api/payments/history?appointmentId=${n._id}`,{credentials:"include"}),_=await I.json();I.ok&&_.payments.length>0&&(Ht(_.payments[0]),await A(_.payments[0].paymentId))}catch(I){console.error("Error fetching payment status:",I)}finally{mt(!1)}},A=async I=>{try{const _=await fetch(`https://urbansetu.onrender.com/api/payments/refund-request-status/${I}`,{credentials:"include"}),ge=await _.json();_.ok&&ge.refundRequest?de(ge.refundRequest):de(null)}catch(_){console.error("Error fetching refund request status:",_),de(null)}};if(Vt)return e.jsx(La,{className:"animate-spin text-blue-600"});const Xs=()=>{var _;return N?(_=N==null?void 0:N.metadata)!=null&&_.adminMarked?{status:"admin_confirmed",text:"Paid (Admin)",color:"bg-green-100 text-green-800"}:!h&&["refunded","partially_refunded","failed"].includes(N.status)?{status:"completed",text:"Paid",color:"bg-green-100 text-green-800"}:js(N.status):{status:"pending",text:"Pending",color:"bg-yellow-100 text-yellow-800"}},js=I=>{switch(I){case"completed":return{status:"completed",text:"Paid",color:"bg-green-100 text-green-800"};case"pending":return{status:"pending",text:"Pending",color:"bg-yellow-100 text-yellow-800"};case"failed":return{status:"failed",text:"Failed",color:"bg-red-100 text-red-800"};case"refunded":return{status:"refunded",text:"Refunded",color:"bg-blue-100 text-blue-800"};case"partially_refunded":return{status:"partially_refunded",text:"Partial Refund",color:"bg-orange-100 text-orange-800"};default:return{status:"unknown",text:I,color:"bg-gray-100 text-gray-800"}}},W=async I=>{if(I.preventDefault(),!!N)try{Se(!0);const _=await fetch("https://urbansetu.onrender.com/api/payments/refund-request",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({paymentId:N.paymentId,appointmentId:n._id,reason:fe.reason,requestedAmount:fe.type==="full"?N.amount:fe.amount,type:fe.type})}),ge=await _.json();_.ok?(u.success("Refund request submitted successfully"),J(!1),Q({reason:"",amount:0,type:"full"}),$()):u.error(ge.message||"Failed to submit refund request")}catch(_){console.error("Error submitting refund request:",_),u.error("An error occurred while submitting refund request")}finally{Se(!1)}},Ye=async I=>{if(I.preventDefault(),!(!Y||!be.reason||!be.text))try{H(!0);const _=await fetch("https://urbansetu.onrender.com/api/payments/refund-appeal",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({refundRequestId:Y._id,appealReason:be.reason,appealText:be.text})}),ge=await _.json();_.ok?(u.success("Appeal submitted successfully. Please wait for response."),pe(!1),ae({reason:"",text:""}),$()):u.error(ge.message||"Failed to submit appeal")}catch(_){console.error("Error submitting appeal:",_),u.error("An error occurred while submitting appeal")}finally{H(!1)}},_e=Xs(),q=["rejected","cancelledByBuyer","cancelledBySeller","cancelledByAdmin","outdated"].includes(n.status),We=!!((X=N==null?void 0:N.metadata)!=null&&X.adminMarked),se=!We&&(!N||N.status!=="completed")&&!q,Mt=Y&&["pending","rejected","approved","processed"].includes(Y.status),ye=Y&&Y.status==="rejected",qt=Y&&Y.status==="pending",E=Y&&["approved","processed"].includes(Y.status),Ke=Y&&Y.caseReopened;return e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${_e.color}`,children:_e.text}),h&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500",children:[(!N||N.status!=="completed"&&!We)&&(n.status==="pending"||n.status==="accepted")&&e.jsxs("div",{className:"relative group",children:[e.jsx(He,{className:"text-blue-500 hover:text-blue-700 cursor-pointer",title:"Pay the advance amount to confirm your booking and unlock full chat features."}),e.jsxs("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10",children:["Pay the advance amount to confirm your booking and unlock full chat features.",e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"})]})]}),(N&&N.status==="completed"||We)&&!q?e.jsxs("div",{className:"relative group",children:[e.jsx(He,{className:"text-green-500 hover:text-green-700 cursor-pointer",title:"You have unlocked full features of chat. Enjoy seamlessly!"}),e.jsxs("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-green-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10",children:["You have unlocked full features of chat. Enjoy seamlessly!",e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-green-800"})]})]}):null]}),Mt&&qt&&e.jsxs("div",{className:"relative group mb-1",children:[e.jsx(He,{className:"text-orange-500 hover:text-orange-700 cursor-pointer text-xs",title:"Processing Refund Request..."}),e.jsxs("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-orange-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10",children:["Processing Refund Request...",e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-orange-800"})]})]}),se?e.jsxs("button",{className:"mt-1 inline-flex items-center gap-1 text-white bg-blue-600 hover:bg-blue-700 text-xs font-semibold px-3 py-1 rounded",onClick:()=>qe(!0),children:[e.jsx(wl,{})," Pay Now"]}):N&&N.status==="failed"&&!q?e.jsxs("button",{onClick:()=>qe(!0),className:"mt-1 inline-flex items-center gap-1 text-white bg-red-600 hover:bg-red-700 text-xs font-semibold px-3 py-1 rounded",children:[e.jsx(wl,{})," Retry Payment"]}):N&&N.status==="completed"&&["rejected","cancelledBySeller","cancelledByAdmin"].includes(n.status)&&(!N.refundAmount||N.refundAmount===0)?e.jsx(e.Fragment,{children:!E&&!qt&&e.jsx(e.Fragment,{children:ye&&Y.isAppealed?e.jsxs("div",{className:"relative group mb-1",children:[e.jsx(He,{className:"text-blue-500 hover:text-blue-700 cursor-pointer text-xs",title:"Appeal submitted please wait for response..."}),e.jsxs("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-blue-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10",children:["Appeal submitted please wait for response...",e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-blue-800"})]})]}):ye&&!Ke?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative group mb-1",children:[e.jsx(He,{className:"text-purple-500 hover:text-purple-700 cursor-pointer text-xs",title:"Refund Request Rejected - You can appeal your refund with valid proofs and reason"}),e.jsxs("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-purple-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10",children:[e.jsx("div",{className:"font-semibold text-red-300",children:"Refund Request Rejected"}),e.jsx("div",{className:"text-purple-200",children:"You can appeal your refund with valid proofs and reason"}),e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-purple-800"})]})]}),e.jsxs("button",{onClick:()=>pe(!0),className:"mt-1 inline-flex items-center gap-1 text-white bg-purple-600 hover:bg-purple-700 text-xs font-semibold px-3 py-1 rounded",children:[e.jsx(Ve,{})," Appeal"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative group mb-1",children:[e.jsx(He,{className:"text-orange-500 hover:text-orange-700 cursor-pointer text-xs",title:"You can raise a refund request now"}),e.jsxs("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-orange-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10",children:["You can raise a refund request now",e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-orange-800"})]})]}),e.jsxs("button",{onClick:()=>J(!0),className:"mt-1 inline-flex items-center gap-1 text-white bg-orange-600 hover:bg-orange-700 text-xs font-semibold px-3 py-1 rounded",children:[e.jsx(Ve,{})," ","Request Refund"]})]})})}):N&&N.receiptUrl?e.jsxs(e.Fragment,{children:[(N.status==="refunded"||N.status==="partially_refunded")&&e.jsxs("div",{className:"relative group mb-1",children:[e.jsx(He,{className:"text-red-500 hover:text-red-700 cursor-pointer text-xs",title:"Refund processed successfully"}),e.jsxs("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-red-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10",children:[e.jsxs("div",{children:["Refunded: ",N.currency==="INR"?"â‚¹":"$",N.refundAmount.toLocaleString()]}),N.refundedAt&&e.jsxs("div",{className:"text-red-200",children:[new Date(N.refundedAt).toLocaleDateString("en-GB")," ",new Date(N.refundedAt).toLocaleTimeString("en-GB")]}),e.jsx("div",{className:"text-green-300",children:"Refund Request Approved"}),e.jsx("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-red-800"})]})]}),e.jsxs("a",{href:N.receiptUrl,target:"_blank",rel:"noreferrer",className:"mt-1 inline-flex items-center gap-1 text-white bg-green-600 hover:bg-green-700 text-xs font-semibold px-3 py-1 rounded",children:[e.jsx(Ut,{})," Receipt"]})]}):null]}),We&&e.jsx("div",{className:"text-[10px] text-green-700 font-semibold",children:"âœ“ Admin Confirmed"}),De&&h&&e.jsx(di,{isOpen:De,onClose:()=>qe(!1),appointment:{...n,region:"india"},onPaymentSuccess:I=>{qe(!1),$()}}),Be&&N&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Ve,{className:"text-orange-600"}),"Request Refund"]}),e.jsx("button",{onClick:()=>J(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(te,{className:"text-xl"})})]})}),e.jsxs("form",{onSubmit:W,className:"p-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Payment Details"}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Property:"}),e.jsx("span",{className:"font-medium",children:n.propertyName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Amount:"}),e.jsxs("span",{className:"font-medium",children:[N.currency==="INR"?"â‚¹":"$",N.amount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Payment ID:"}),e.jsx("span",{className:"font-mono text-sm",children:N.paymentId})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Appointment Status:"}),e.jsx("span",{className:"font-medium capitalize",children:n.status.replace(/([A-Z])/g," $1").trim()})]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Refund Type"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"type",value:"full",checked:fe.type==="full",onChange:I=>{Q(_=>({..._,type:I.target.value,amount:I.target.value==="full"?N.amount:_.amount}))},className:"mr-2"}),"Full Refund (",N.currency==="INR"?"â‚¹":"$",N.amount.toLocaleString(),")"]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"type",value:"partial",checked:fe.type==="partial",onChange:I=>Q(_=>({..._,type:I.target.value})),className:"mr-2"}),"Partial Refund"]})]})]}),fe.type==="partial"&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Refund Amount"}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 font-semibold",children:N.currency==="INR"?"â‚¹":"$"}),e.jsx("input",{type:"number",value:fe.amount,onChange:I=>Q(_=>({..._,amount:parseFloat(I.target.value)||0})),max:N.amount,min:"1",step:"0.01",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Refund Reason"}),e.jsx("textarea",{value:fe.reason,onChange:I=>Q(_=>({..._,reason:I.target.value})),placeholder:"Please explain why you need a refund...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",rows:"3",required:!0})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>J(!1),className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:At,className:"flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:At?e.jsxs(e.Fragment,{children:[e.jsx(La,{className:"animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ve,{}),"Submit Request"]})})]})]})]})}),$e&&Y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(Ve,{className:"text-purple-600"}),"Submit Appeal"]}),e.jsx("button",{onClick:()=>pe(!1),className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(te,{className:"text-xl"})})]})}),e.jsxs("form",{onSubmit:Ye,className:"p-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Refund Request Details"}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Property:"}),e.jsx("span",{className:"font-medium",children:n.propertyName})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Original Reason:"}),e.jsx("span",{className:"font-medium text-sm",children:Y.reason})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Requested Amount:"}),e.jsxs("span",{className:"font-medium",children:[N.currency==="INR"?"â‚¹":"$",Y.requestedAmount.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Status:"}),e.jsx("span",{className:"font-medium text-red-600 capitalize",children:Y.status})]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Appeal Reason"}),e.jsxs("select",{value:be.reason,onChange:I=>ae(_=>({..._,reason:I.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500",required:!0,children:[e.jsx("option",{value:"",children:"Select a reason for your appeal"}),e.jsx("option",{value:"Additional evidence",children:"Additional evidence provided"}),e.jsx("option",{value:"Misunderstanding",children:"Misunderstanding of the situation"}),e.jsx("option",{value:"New information",children:"New information has come to light"}),e.jsx("option",{value:"Service quality",children:"Service quality issues"}),e.jsx("option",{value:"Technical problems",children:"Technical problems encountered"}),e.jsx("option",{value:"Other",children:"Other (please explain in detail)"})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Appeal Details"}),e.jsx("textarea",{value:be.text,onChange:I=>ae(_=>({..._,text:I.target.value})),placeholder:"Please provide detailed information about why you believe your refund request should be reconsidered...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500",rows:"4",required:!0})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"button",onClick:()=>pe(!1),className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:F,className:"flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:F?e.jsxs(e.Fragment,{children:[e.jsx(La,{className:"animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ve,{}),"Submit Appeal"]})})]})]})]})})]})}export{Ti as default};
