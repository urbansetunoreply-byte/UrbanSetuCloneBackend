import{i as $,o as H,p as J,r as a,j as e,C as W,y as o}from"./index-DFkuEFH9.js";import{P as G}from"./PaymentModal-IFfi4F1j.js";const A="https://urbansetu.onrender.com";function X(){const{currentUser:n}=$(r=>r.user),C=H(),l=J(),m=new URLSearchParams(C.search),c=m.get("listingId"),I=m.get("propertyName"),T=m.get("propertyDescription"),x=m.get("listingType"),[s,R]=a.useState({date:"",time:"",message:"",purpose:"",propertyName:I||"",propertyDescription:T||""}),[q,B]=a.useState(!1),[v,j]=a.useState(!1),[h,M]=a.useState(!1),[u,p]=a.useState(!1),[N,f]=a.useState(!0),[w,y]=a.useState(!1),[b,k]=a.useState("international"),[S,O]=a.useState(null),[L,P]=a.useState(null),[_,D]=a.useState(!1),d=r=>{R(i=>({...i,[r.target.name]:r.target.value}))};a.useEffect(()=>{async function r(){if(!n||!c){p(!1),f(!1);return}f(!0);try{const i=await fetch(`${A}/api/bookings/my`,{credentials:"include"});if(i.ok){const g=await i.json(),z=["pending","accepted"],Y=g.find(t=>!t.buyerId||t.buyerId._id!==n._id&&t.buyerId!==n._id||!t.listingId||t.listingId._id!==c&&t.listingId!==c||new Date(t.date)<new Date||new Date(t.date).toDateString()===new Date().toDateString()&&t.time&&t.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})?!1:!!(z.includes(t.status)||t.status==="cancelledByBuyer"&&(t.buyerReinitiationCount||0)<2));p(!!Y)}else p(!1)}catch{p(!1)}finally{f(!1)}}r()},[n,c]);const E=async r=>{if(r.preventDefault(),u){o.info("You already have an active appointment for this property. Please complete, cancel, or wait for the other party to respond before booking again.");return}if(!h){o.warning("You must agree to share your contact information with the seller to book an appointment.");return}if(!n){o.info("Please sign in to book an appointment."),l("/sign-in");return}if(!s.date||!s.time||!s.purpose||!s.propertyName||!s.propertyDescription){o.warning("Please fill out all required fields before booking the appointment.");return}if(!c){o.warning("Listing information is missing. Please try again.");return}j(!0);try{const i=await fetch(`${A}/api/bookings`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({...s,listingId:c})}),g=await i.json();i.ok?(O({...g.appointment,region:b}),y(!0)):o.error(g.message||"Failed to book appointment.")}catch(i){console.error("Error booking appointment:",i),o.error("An error occurred. Please try again.")}finally{j(!1)}},F=r=>{B(!0),y(!1),P("success"),D(!0),o.success("Appointment booked and payment confirmed!"),setTimeout(()=>{n&&(n.role==="admin"||n.role==="rootadmin")?l("/admin/appointments"):l("/user/my-appointments")},2e3)},U=()=>{y(!1),P("failed"),D(!0),o.info("Payment not completed. Appointment remains pending until payment is confirmed."),setTimeout(()=>{n&&(n.role==="admin"||n.role==="rootadmin")?l("/admin/appointments"):l("/user/my-appointments")},2e3)};return n?e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen py-10 px-2 md:px-8",children:[e.jsxs("div",{className:"max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 relative",children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 mb-6 text-center drop-shadow",children:"Book Appointment"}),_?e.jsx("div",{className:"text-center py-10",children:L==="success"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-green-600 text-xl font-semibold mb-2",children:"Payment Successful!"}),e.jsx("div",{className:"text-gray-700 mb-2",children:"Appointment booked successfully!"}),e.jsx("div",{className:"text-gray-600 text-sm mb-2",children:"The property owner will review your request."}),e.jsx("div",{className:"text-sm text-gray-500",children:"Redirecting to Myappointments..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-red-600 text-xl font-semibold mb-2",children:"Payment Unsuccessful"}),e.jsx("div",{className:"text-gray-700 mb-2",children:"Please complete your payment from Myppointments to confirm booking"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Redirecting to Myappointments..."})]})}):q?e.jsxs("div",{className:"text-center py-10",children:[e.jsx("div",{className:"text-green-600 text-xl font-semibold",children:"Appointment booked successfully!"}),e.jsx("div",{className:"text-gray-700 mt-1",children:"The property owner will review your request."}),e.jsx("div",{className:"text-sm text-gray-500 mt-1",children:"Redirecting to your appointments..."}),e.jsxs("div",{className:"mt-6 flex items-center justify-center gap-3",children:[e.jsx("button",{onClick:()=>l("/user/movers"),className:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm",children:"Book Packers & Movers"}),e.jsx("button",{onClick:()=>l("/user/services"),className:"px-4 py-2 rounded bg-purple-600 text-white hover:bg-purple-700 text-sm",children:"On-Demand Services"})]})]}):e.jsxs("form",{onSubmit:E,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select Date"}),e.jsx("input",{type:"date",name:"date",value:s.date,onChange:d,className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:new Date().toISOString().split("T")[0],required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select Time"}),e.jsx("input",{type:"time",name:"time",value:s.time,onChange:d,className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsxs("select",{name:"purpose",value:s.purpose,onChange:d,className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"Select Purpose"}),x==="rent"&&e.jsx("option",{value:"rent",children:"Rent"}),(x==="sale"||x==="buy")&&e.jsx("option",{value:"buy",children:"Buy"})]})}),e.jsx("input",{type:"text",name:"propertyName",value:s.propertyName,onChange:d,placeholder:"Property Name",className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0}),e.jsx("textarea",{name:"propertyDescription",value:s.propertyDescription,onChange:d,placeholder:"Property Description",className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",rows:"2",required:!0}),e.jsx("textarea",{name:"message",value:s.message,onChange:d,placeholder:"Tell us about your requirements... (Optional)",className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",rows:"4"}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("input",{type:"checkbox",id:"agreement",checked:h,onChange:r=>M(r.target.checked),required:!0}),e.jsxs("label",{htmlFor:"agreement",className:"text-sm text-gray-700 select-none",children:["I understand that ",e.jsx("span",{className:"font-semibold text-blue-700",children:"my contact information and details will be shared with the seller"})," for this appointment."]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Select Region"}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"region",value:"india",checked:b==="india",onChange:()=>k("india")}),e.jsx("span",{children:"India (â‚¹100 via Razorpay)"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"region",value:"international",checked:b==="international",onChange:()=>k("international")}),e.jsx("span",{children:"International ($5 via PayPal)"})]})]})]}),e.jsx("div",{className:"flex justify-center mt-6",children:e.jsx("button",{type:"submit",className:"w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed",disabled:v||!h||u||N,children:N?"Checking...":v?"Booking...":u?"Already Booked":"Book Appointment"})}),u&&e.jsx("div",{className:"text-red-600 text-sm mt-2 text-center font-semibold",children:"You already have an active appointment for this property. Please complete, cancel, or wait for the other party to respond before booking again."})]})]}),w&&S&&e.jsx(G,{isOpen:w,onClose:U,appointment:S,onPaymentSuccess:F}),e.jsx(W,{})]}):e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 relative",children:e.jsx("div",{className:"text-center text-red-600 text-xl font-semibold py-10",children:"Please sign in to book an appointment."})})})}export{X as default};
