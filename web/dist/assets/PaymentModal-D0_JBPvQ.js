import{r as x,y as n,j as e,bf as Q,Z as V,ak as M,d as W,R as Z,l as X}from"./index-AwWxf1fH.js";const ae=({isOpen:g,onClose:j,appointment:t,onPaymentSuccess:z})=>{var F,T,C,A,E,$,O,L,U,J;const[I,c]=x.useState(!1),[r,w]=x.useState(null),[S,_]=x.useState(!1),[k,R]=x.useState(""),[Y,h]=x.useState(!1),[l,v]=x.useState(()=>(t==null?void 0:t.region)==="india"?"razorpay":"paypal");x.useEffect(()=>{if(g&&t){const s=(t==null?void 0:t.region)==="india"?"razorpay":"paypal";v(s),w(null),c(!0),setTimeout(()=>N(s),0)}return g?(document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%"):(document.body.style.overflow="",document.body.style.position="",document.body.style.width=""),()=>{document.body.style.overflow="",document.body.style.position="",document.body.style.width=""}},[g,t]);const N=async s=>{try{if(c(!0),t.status==="rejected"){n.error("This appointment has been rejected by the seller. Payment cannot be processed. Please book a new appointment or explore other alternatives."),j();return}if(t.status!=="pending"){n.error("This appointment is not in pending status. Payment cannot be processed at this time."),j();return}const a=await fetch("https://urbansetu.onrender.com/api/payments/create-intent",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({appointmentId:t._id,paymentType:"advance",gateway:(s||l)==="razorpay"?"razorpay":"paypal"})}),i=await a.json();a.ok?w(i):n.error(i.message||"Failed to create payment intent")}catch(a){console.error("Error creating payment intent:",a),n.error("An error occurred while creating payment")}finally{c(!1)}},q=async()=>{var s,a,i,K;if(r)try{if(c(!0),l==="razorpay"){await new Promise((o,m)=>{if(window&&window.Razorpay)return o();const b=document.querySelector('script[src*="checkout.razorpay.com/v1/checkout.js"]');if(b){b.addEventListener("load",()=>o()),b.addEventListener("error",()=>m(new Error("Failed to load Razorpay SDK")));return}const p=document.createElement("script");p.src="https://checkout.razorpay.com/v1/checkout.js",p.async=!0,p.onload=()=>o(),p.onerror=()=>m(new Error("Failed to load Razorpay SDK")),document.body.appendChild(p)});const d=r.razorpay;if(!d){n.error("Razorpay not initialized");return}const u={key:d.keyId||"rzp_test_RFphKnf5uivCkc",amount:d.amount,currency:d.currency||"INR",name:"UrbanSetu",description:"Advance Booking Payment",order_id:d.orderId,prefill:{name:((s=t==null?void 0:t.buyerId)==null?void 0:s.username)||"",email:((a=t==null?void 0:t.buyerId)==null?void 0:a.email)||""},handler:async o=>{try{h(!0),await G(o)}catch{n.error("Verification failed")}finally{h(!1)}},modal:{ondismiss:()=>n.info("Payment cancelled. You can try again later.")}};new window.Razorpay(u).open();return}if(await new Promise((f,d)=>{if(window&&window.paypal)return f();const u=document.querySelector('script[src*="paypal.com/sdk/js"]');if(u){u.addEventListener("load",()=>f()),u.addEventListener("error",m=>d(new Error("Failed to load PayPal SDK")));return}const y="ATGAm-Q7s0hQAidh-pzq0TvGf1vJIYXseJxQyl1y0l-gMhvHegopwE_KPHo2k9CdlWQ5jkRH0lvZ37WY",o=document.createElement("script");o.src=`https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(y)}&currency=USD&intent=capture`,o.async=!0,o.onload=()=>f(),o.onerror=()=>d(new Error("Failed to load PayPal SDK")),document.body.appendChild(o)}),window&&window.paypal){const f=((i=r==null?void 0:r.paypal)==null?void 0:i.amount)||((K=r==null?void 0:r.payment)==null?void 0:K.amount),d=`paypal-button-container-${t._id}`,u=document.getElementById(d);u&&(u.innerHTML=""),window.paypal.Buttons({createOrder:async(y,o)=>{try{const m=await fetch("https://urbansetu.onrender.com/api/payments/paypal/create-order",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({amount:Number(f).toFixed(2),currency:"USD"})}),b=await m.text();let p;try{p=JSON.parse(b)}catch{throw new Error(b||"Invalid JSON from create-order")}if(!m.ok)throw new Error(p.message||"Failed to create PayPal order");return p.id}catch(m){throw n.error("Failed to initialize PayPal"),m}},onApprove:async(y,o)=>{try{h(!0);try{await o.order.capture()}catch{await fetch("https://urbansetu.onrender.com/api/payments/paypal/capture-order",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({orderId:y.orderID})})}await D({paypal_order_id:y.orderID})}catch{n.error("Payment capture failed")}finally{h(!1)}},onCancel:()=>{n.info("Payment cancelled. You can try again later.")},onError:y=>{var o;console.error("PayPal error",y),n.error("Payment failed or cancelled."),(o=r==null?void 0:r.payment)!=null&&o.paymentId&&P("PayPal payment failed")}}).render(`#${d}`)}else n.error("PayPal SDK not loaded.")}catch(B){console.error("Payment error:",B),n.error("Payment failed. Please try again.")}finally{c(!1)}},P=async s=>{try{const a=await fetch("https://urbansetu.onrender.com/api/payments/verify",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({paymentId:r.payment.paymentId,paymentStatus:"failed",clientIp:window&&window.__CLIENT_IP__||void 0,userAgent:navigator.userAgent})}),i=await a.json();(a.ok||a.status===400)&&(n.error(`Payment failed: ${s}`),c(!1),h(!1))}catch(a){console.error("Error marking payment as failed:",a),n.error("Payment failed"),c(!1),h(!1)}},D=async s=>{try{const a=await fetch("https://urbansetu.onrender.com/api/payments/verify",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({paymentId:r.payment.paymentId,paypalOrderId:s.paypal_order_id||s.paypalOrderId||s.orderID,clientIp:window&&window.__CLIENT_IP__||void 0,userAgent:navigator.userAgent})}),i=await a.json();a.ok?(_(!0),R(i.receiptUrl),n.success("Payment successful!"),z(i.payment)):(n.error(i.message||"Payment verification failed"),i.message&&i.message.toLowerCase().includes("signature")&&n.info("Dev mode: signature bypass is enabled. Please try again."))}catch(a){console.error("Verification error:",a),n.error("Payment verification failed")}finally{c(!1)}},G=async s=>{try{const a=await fetch("https://urbansetu.onrender.com/api/payments/razorpay/verify",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({paymentId:r.payment.paymentId,razorpay_payment_id:s.razorpay_payment_id,razorpay_order_id:s.razorpay_order_id,razorpay_signature:s.razorpay_signature,clientIp:window&&window.__CLIENT_IP__||void 0,userAgent:navigator.userAgent})}),i=await a.json();a.ok?(_(!0),R(i.receiptUrl),n.success("Payment successful!"),z(i.payment)):(n.error(i.message||"Payment verification failed"),a.status===400&&await P("Razorpay verification failed"))}catch(a){console.error("Verification error:",a),n.error("Payment verification failed"),await P("Razorpay verification error")}finally{c(!1)}},H=()=>{k&&window.open(k,"_blank")};return g?e.jsx("div",{className:"fixed inset-0 bg-gradient-to-br from-blue-900/40 to-purple-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4",style:{overscrollBehavior:"contain"},children:e.jsx("div",{className:"rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto bg-gradient-to-br from-white to-blue-50",children:S?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"p-6 text-center",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx(Z,{className:"text-6xl text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Payment Successful!"}),e.jsx("p",{className:"text-gray-600",children:"Your advance payment has been processed successfully."})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-2",children:"Payment Details"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Amount Paid:"}),e.jsxs("span",{className:"font-medium",children:["$ ",Number(r.payment.amount).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Payment ID:"}),e.jsx("span",{className:"font-mono text-xs",children:r.payment.paymentId})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Receipt No:"}),e.jsx("span",{className:"font-mono text-xs",children:r.payment.receiptNumber})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:H,className:"w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center justify-center gap-2",children:[e.jsx(X,{}),"Download Receipt"]}),e.jsx("button",{onClick:()=>{j(),window.location.href="/user/my-appointments"},className:"w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors",children:"View My Appointments"})]})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-6 border-b border-blue-100 bg-gradient-to-r from-blue-50 to-purple-50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-700 to-purple-700 flex items-center gap-2",children:[e.jsx(Q,{className:"text-blue-600"}),"Payment Required"]}),e.jsx("button",{onClick:()=>{S||n.info("Payment not completed. You can pay later from My Appointments."),j()},className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(V,{className:"text-xl"})})]}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Complete your advance payment to confirm the booking"})]}),e.jsx("div",{className:"p-6",children:Y?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(M,{className:"animate-spin text-4xl text-blue-600 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Processing Payment..."}),e.jsx("p",{className:"text-gray-600 text-center",children:"Please wait while we verify your payment. Do not close this window."})]}):I&&!r?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(M,{className:"animate-spin text-2xl text-blue-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Preparing payment..."})]}):r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:[e.jsx("h5",{className:"font-semibold text-gray-800 mb-2",children:"Select Region"}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"region",value:"india",checked:l==="razorpay",onChange:()=>{const s="razorpay";v(s),c(!0),w(null),setTimeout(()=>N(s),0)}}),e.jsx("span",{children:"India (₹100 via Razorpay)"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"region",value:"international",checked:l==="paypal",onChange:()=>{const s="paypal";v(s),c(!0),w(null),setTimeout(()=>N(s),0)}}),e.jsx("span",{children:"International ($5 via PayPal)"})]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-6 border border-blue-100",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-2",children:t.propertyName}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:t.propertyDescription}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Appointment Date:"}),e.jsx("span",{className:"text-sm font-medium",children:new Date(t.date).toLocaleDateString("en-GB")})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Time:"}),e.jsx("span",{className:"text-sm font-medium",children:t.time})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Payment Initiated:"}),e.jsx("span",{className:"text-sm font-medium",children:new Date().toLocaleString("en-GB")})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-6 border border-blue-100",children:[e.jsx("h4",{className:"font-semibold text-blue-800 mb-3",children:"Payment Summary"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Advance Payment (Flat)"}),e.jsx("span",{className:"font-medium",children:l==="razorpay"?`₹ ${Number(((F=r==null?void 0:r.payment)==null?void 0:F.currency)==="INR"?(T=r==null?void 0:r.payment)==null?void 0:T.amount:100).toFixed(2)}`:`$ ${Number(((C=r==null?void 0:r.payment)==null?void 0:C.currency)==="USD"?(A=r==null?void 0:r.payment)==null?void 0:A.amount:5).toFixed(2)}`})]}),e.jsxs("div",{className:"flex justify-between text-sm text-gray-500",children:[e.jsx("span",{children:"Note"}),e.jsx("span",{children:l==="razorpay"?"₹100 advance to confirm booking":"$5 advance to confirm booking"})]})]}),e.jsx("div",{className:"border-t border-blue-200 mt-3 pt-3",children:e.jsxs("div",{className:"flex justify-between font-semibold text-blue-800",children:[e.jsx("span",{children:"Total Amount"}),e.jsx("span",{children:l==="razorpay"?`₹ ${Number(((E=r==null?void 0:r.payment)==null?void 0:E.currency)==="INR"?($=r==null?void 0:r.payment)==null?void 0:$.amount:100).toFixed(2)}`:`$ ${Number(((O=r==null?void 0:r.payment)==null?void 0:O.currency)==="USD"?(L=r==null?void 0:r.payment)==null?void 0:L.amount:5).toFixed(2)}`})]})})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-6 border border-blue-100",children:[e.jsx("h5",{className:"font-semibold text-gray-800 mb-2",children:"Payment Platform"}),e.jsx("div",{className:"text-sm text-gray-700",children:l==="razorpay"?"Razorpay":"PayPal"}),e.jsxs("ul",{className:"list-disc pl-5 mt-3 text-sm text-gray-600 space-y-1",children:[l==="razorpay"?e.jsxs(e.Fragment,{children:[e.jsx("li",{children:'Click "Pay via Razorpay" and complete payment in the Razorpay popup.'}),e.jsx("li",{children:"On approval, we verify and confirm your booking automatically."})]}):e.jsxs(e.Fragment,{children:[e.jsx("li",{children:'Click "Load PayPal Button" and complete payment in the PayPal popup.'}),e.jsx("li",{children:"On approval, we verify and confirm your booking automatically."})]}),e.jsx("li",{children:"If you cancel or close PayPal, you can retry from My Appointments."})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-6 border border-blue-100",children:[e.jsx("h5",{className:"font-semibold text-gray-800 mb-2",children:"Payment Technical Details"}),e.jsxs("div",{className:"text-xs text-gray-600 space-y-1",children:[l==="razorpay"&&(r==null?void 0:r.razorpay)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:["Order ID: ",e.jsx("span",{className:"font-mono",children:r.razorpay.orderId})]}),e.jsxs("div",{children:["Amount (paise): ",e.jsx("span",{className:"font-mono",children:r.razorpay.amount})]})]}),l==="paypal"&&e.jsxs("div",{children:["Amount: ",e.jsx("span",{className:"font-mono",children:((U=r==null?void 0:r.paypal)==null?void 0:U.amount)||((J=r==null?void 0:r.payment)==null?void 0:J.amount)})," USD"]})]})]}),e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(W,{className:"text-green-600 mt-1"}),e.jsxs("div",{children:[e.jsxs("h5",{className:"font-semibold text-green-800 mb-1",children:["Secure Payment via ",l==="razorpay"?"Razorpay":"PayPal"]}),e.jsx("p",{className:"text-sm text-green-700",children:"Your payment is processed securely. You can request a full refund if the appointment is cancelled."})]})]})}),e.jsxs("div",{className:"space-y-2",children:[l==="paypal"&&e.jsx("div",{id:`paypal-button-container-${t._id}`}),e.jsx("button",{onClick:q,className:"w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 shadow",children:I?"Loading…":l==="razorpay"?"Pay via Razorpay":"Load PayPal Button"})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray-600",children:"Failed to initialize payment. Please try again."}),e.jsx("button",{onClick:N,className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors",children:"Retry"})]})})]})})}):null};export{ae as P};
