import{u as pn,r as c,aR as D,J as T,j as e,L as kr,aS as yn,aT as Rt,aU as Us,aB as Na,H as h,T as ne,U as wn,aV as ms,aW as Ca,f as vn,g as jn,aX as Nn,Y as y,aY as Bs,aZ as Mt,b as it,a_ as zs,M as Ve,a$ as pa,aN as Lt,ai as ya,Q as wa,b0 as Sr,b1 as wr,b2 as Cn,b3 as kn,a0 as Sn,S as Ft,b4 as va,y as vr,b5 as _n,n as In,b6 as An}from"./index-WPqAAPOK.js";import{F as jr}from"./linkFormatter-C2S5a9jA.js";import{I as $n}from"./ImagePreview-DeHXYQ7P.js";import{E as Dn,e as En,L as Nr,a as cs}from"./ExportChatModal-DiWsPTOm.js";const I="https://urbansetu.onrender.com";function On(){const{currentUser:l}=pn(u=>u.user),[m,_]=c.useState([]),[Ce,Tt]=c.useState([]),[He,le]=c.useState([]),[We,oe]=c.useState(!0),[Z,jt]=c.useState("all"),[te,Nt]=c.useState(""),[xe,dt]=c.useState(1),[Fe,ke]=c.useState(1),[Q,se]=c.useState(1),[ce,Os]=c.useState(1),[us,Vs]=c.useState([]),[ae,Hs]=c.useState(null),[Pt,qe]=c.useState(!1),[ie,Je]=c.useState(!1),[W,ct]=c.useState(!1),[me,Ws]=c.useState(""),[Se,qs]=c.useState(""),[b,C]=c.useState(null),[B,V]=c.useState(""),[mt,_e]=c.useState(!1),[Ct,Ie]=c.useState(!1),[kt,Ye]=c.useState(!1),[Bt,zt]=c.useState(!1),[J,ge]=c.useState(!1),[Ae,ue]=c.useState(null),[Ut,ut]=c.useState(!1),[hs,St]=c.useState(!1),[de,ht]=c.useState(null),[E,xt]=c.useState([]);c.useEffect(()=>(mt||Ct||kt||Bt?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[mt,Ct,kt,Bt]);const[_t,It]=c.useState({}),st=c.useRef(!1),Ot=c.useCallback((u,x)=>{st.current||It(j=>{const z=j[u];if(z&&x){if(x.some((X,F)=>{const $e=z[F];return!$e||JSON.stringify($e)!==JSON.stringify(X)}))return st.current=!0,setTimeout(()=>{st.current=!1},100),{...j,[u]:x}}else if(JSON.stringify(z)!==JSON.stringify(x))return st.current=!0,setTimeout(()=>{st.current=!1},100),{...j,[u]:x};return j})},[]),Vt=c.useCallback(async()=>{try{const{data:u}=await D.get(`${I}/api/bookings`,{withCredentials:!0});console.log("All admin appointments fetched:",u);const x=u.appointments||u;Tt(x),oe(!1)}catch(u){console.error("Failed to fetch appointments",u),oe(!1)}},[]),Ge=c.useCallback(async()=>{try{const{data:u}=await D.get(`${I}/api/bookings/archived`,{withCredentials:!0});le(u)}catch(u){console.error("Failed to fetch archived appointments",u)}},[]);c.useEffect(()=>{window.scrollTo(0,0)},[]),c.useEffect(()=>{T.connected&&l&&T.emit("adminAppointmentsActive",{adminId:l._id,role:l.role});const u=setInterval(()=>{l&&T.emit("adminAppointmentsActive",{adminId:l._id,role:l.role})},1e3);Vt(),Ge();const x=setInterval(()=>{Vt(),Ge()},5e3),j=w=>{_(U=>U.map(p=>{const R={...p};return p.buyerId&&(p.buyerId._id===w.userId||p.buyerId===w.userId)&&(R.buyerId={...R.buyerId,username:w.username,email:w.email,mobileNumber:w.mobileNumber,avatar:w.avatar}),p.sellerId&&(p.sellerId._id===w.userId||p.sellerId===w.userId)&&(R.sellerId={...R.sellerId,username:w.username,email:w.email,mobileNumber:w.mobileNumber,avatar:w.avatar}),R})),le(U=>U.map(p=>{const R={...p};return p.buyerId&&(p.buyerId._id===w.userId||p.buyerId===w.userId)&&(R.buyerId={...R.buyerId,username:w.username,email:w.email,mobileNumber:w.mobileNumber,avatar:w.avatar}),p.sellerId&&(p.sellerId._id===w.userId||p.sellerId===w.userId)&&(R.sellerId={...R.sellerId,username:w.username,email:w.email,mobileNumber:w.mobileNumber,avatar:w.avatar}),R}))};T.on("profileUpdated",j);const z=w=>{w.comment.senderEmail!==(l==null?void 0:l.email)&&(_(U=>U.map(p=>{var R;if(p._id===w.appointmentId){const Y=(R=p.comments)==null?void 0:R.findIndex(A=>A._id===w.comment._id);if(Y!==-1){const A=p.comments[Y],K={...w.comment,starredBy:A.starredBy||[]};if(JSON.stringify(A)!==JSON.stringify(K)){const O=[...p.comments||[]];O[Y]=K;try{playMessageReceived()}catch{}return{...p,comments:O}}return p}else{const A=[...p.comments||[],w.comment];try{playMessageReceived()}catch{}return{...p,comments:A}}}return p})),le(U=>U.map(p=>{var R;if(p._id===w.appointmentId){const Y=(R=p.comments)==null?void 0:R.findIndex(A=>A._id===w.comment._id);if(Y!==-1){const A=p.comments[Y],K={...w.comment,starredBy:A.starredBy||[]};if(JSON.stringify(A)!==JSON.stringify(K)){const O=[...p.comments||[]];O[Y]=K;try{playMessageReceived()}catch{}return{...p,comments:O}}return p}else{const A=[...p.comments||[],w.comment];try{playMessageReceived()}catch{}return{...p,comments:A}}}return p})),It(U=>{const R=[...U[w.appointmentId]||[]],Y=R.findIndex(A=>A._id===w.comment._id);if(Y!==-1){const A=R[Y],K={...w.comment,starredBy:A.starredBy||[]};R[Y]=K}else R.push(w.comment);return{...U,[w.appointmentId]:R}}))};T.on("commentUpdate",z);const P=w=>{_(U=>U.map(p=>p._id===w.appointmentId?{...p,...w.updatedAppointment}:p)),le(U=>U.map(p=>p._id===w.appointmentId?{...p,...w.updatedAppointment}:p))},X=w=>{_(U=>U.map(p=>p._id===w.appointmentId?{...p,paymentConfirmed:w.paymentConfirmed}:p)),le(U=>U.map(p=>p._id===w.appointmentId?{...p,paymentConfirmed:w.paymentConfirmed}:p))};T.on("appointmentUpdate",P),T.on("paymentStatusUpdated",X);const F=w=>{const U=w.appointment;_(p=>[U,...p])};T.on("appointmentCreated",F);const $e=()=>{l&&T.emit("adminAppointmentsActive",{adminId:l._id,role:l.role})},Ze=()=>{};return T.on("connect",$e),T.on("disconnect",Ze),()=>{clearInterval(x),clearInterval(u),T.off("profileUpdated",j),T.off("commentUpdate",z),T.off("appointmentUpdate",P),T.off("paymentStatusUpdated",X),T.off("appointmentCreated",F),T.off("connect",$e),T.off("disconnect",Ze)}},[Vt,Ge,l]),c.useEffect(()=>{if(Ce.length===0)return;let u=Ce.filter(F=>{var p,R,Y,A,K,O,pe,ft,De;const $e=new Date(F.date)<new Date||new Date(F.date).toDateString()===new Date().toDateString()&&F.time&&F.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),Ze=Z==="all"?!0:Z==="outdated"?$e:F.status===Z,w=((R=(p=F.buyerId)==null?void 0:p.email)==null?void 0:R.toLowerCase().includes(te.toLowerCase()))||((A=(Y=F.sellerId)==null?void 0:Y.email)==null?void 0:A.toLowerCase().includes(te.toLowerCase()))||((O=(K=F.buyerId)==null?void 0:K.username)==null?void 0:O.toLowerCase().includes(te.toLowerCase()))||((ft=(pe=F.sellerId)==null?void 0:pe.username)==null?void 0:ft.toLowerCase().includes(te.toLowerCase()))||((De=F.propertyName)==null?void 0:De.toLowerCase().includes(te.toLowerCase())),U=(!me||new Date(F.date)>=new Date(me))&&(!Se||new Date(F.date)<=new Date(Se));return Ze&&w&&U});const x=10,j=Math.ceil(u.length/x);ke(j);const z=(xe-1)*x,P=z+x,X=u.slice(z,P);console.log(`Admin Page ${xe} of ${j}, showing ${X.length} appointments`),_(X)},[Ce,xe,te,Z,me,Se]),c.useEffect(()=>{if(He.length===0)return;let u=He.filter(F=>{var p,R,Y,A,K,O,pe,ft,De;const $e=new Date(F.date)<new Date||new Date(F.date).toDateString()===new Date().toDateString()&&F.time&&F.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),Ze=Z==="all"?!0:Z==="outdated"?$e:F.status===Z,w=((R=(p=F.buyerId)==null?void 0:p.email)==null?void 0:R.toLowerCase().includes(te.toLowerCase()))||((A=(Y=F.sellerId)==null?void 0:Y.email)==null?void 0:A.toLowerCase().includes(te.toLowerCase()))||((O=(K=F.buyerId)==null?void 0:K.username)==null?void 0:O.toLowerCase().includes(te.toLowerCase()))||((ft=(pe=F.sellerId)==null?void 0:pe.username)==null?void 0:ft.toLowerCase().includes(te.toLowerCase()))||((De=F.propertyName)==null?void 0:De.toLowerCase().includes(te.toLowerCase())),U=(!me||new Date(F.date)>=new Date(me))&&(!Se||new Date(F.date)<=new Date(Se));return Ze&&w&&U});const x=10,j=Math.ceil(u.length/x);Os(j);const z=(Q-1)*x,P=z+x,X=u.slice(z,P);console.log(`Admin Archived Page ${Q} of ${j}, showing ${X.length} archived appointments`),Vs(X)},[He,Q,te,Z,me,Se]),c.useEffect(()=>(Pt?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[Pt]),c.useEffect(()=>{l&&(_(u=>u.map(x=>{const j={...x};return x.buyerId&&(x.buyerId._id===l._id||x.buyerId===l._id)&&(j.buyerId={...j.buyerId,username:l.username,email:l.email,mobileNumber:l.mobileNumber,avatar:l.avatar}),x.sellerId&&(x.sellerId._id===l._id||x.sellerId===l._id)&&(j.sellerId={...j.sellerId,username:l.username,email:l.email,mobileNumber:l.mobileNumber,avatar:l.avatar}),j})),le(u=>u.map(x=>{const j={...x};return x.buyerId&&(x.buyerId._id===l._id||x.buyerId===l._id)&&(j.buyerId={...j.buyerId,username:l.username,email:l.email,mobileNumber:l.mobileNumber,avatar:l.avatar}),x.sellerId&&(x.sellerId._id===l._id||x.sellerId===l._id)&&(j.sellerId={...j.sellerId,username:l.username,email:l.email,mobileNumber:l.mobileNumber,avatar:l.avatar}),j})))},[l]);const Ke=async u=>{C(u),V(""),_e(!0),ge(!1),ue(null)},at=async()=>{var u,x;if(!B.trim()){h.error("Please provide a reason for cancelling this appointment.");return}try{const{data:j}=await D.patch(`${I}/api/bookings/${b}/cancel`,{reason:B},{withCredentials:!0,headers:{"Content-Type":"application/json"}});_(z=>z.map(P=>P._id===b?{...P,status:"cancelledByAdmin",cancelReason:B}:P)),h.success("Appointment cancelled successfully. Both buyer and seller have been notified of the cancellation."),_e(!1),C(null),V("")}catch(j){console.error("Error in confirmAdminCancel:",j),h.error(((x=(u=j.response)==null?void 0:u.data)==null?void 0:x.message)||"Failed to cancel appointment.")}},Ht=async u=>{C(u),Ie(!0),ge(!1),ue(null)},Wt=async()=>{var u,x;try{const{data:j}=await D.patch(`${I}/api/bookings/${b}/reinitiate`,{},{withCredentials:!0,headers:{"Content-Type":"application/json"}});_(z=>z.map(P=>P._id===b?{...P,status:"pending",cancelReason:""}:P)),h.success("Appointment reinitiated successfully. Both buyer and seller have been notified."),Ie(!1),C(null)}catch(j){console.error("Error in confirmReinitiate:",j),h.error(((x=(u=j.response)==null?void 0:u.data)==null?void 0:x.message)||"Failed to reinitiate appointment.")}},xs=async u=>{C(u),Ye(!0),ge(!1),ue(null)},gt=async()=>{var u,x;try{const{data:j}=await D.patch(`${I}/api/bookings/${b}/archive`,{},{withCredentials:!0,headers:{"Content-Type":"application/json"}}),z=m.find(P=>P._id===b);z&&(_(P=>P.filter(X=>X._id!==b)),le(P=>[{...z,archivedByAdmin:!0,archivedAt:new Date},...P])),h.success("Appointment archived successfully."),Ye(!1),C(null)}catch(j){console.error("Error in confirmArchive:",j),h.error(((x=(u=j.response)==null?void 0:u.data)==null?void 0:x.message)||"Failed to archive appointment.")}},he=async u=>{C(u),zt(!0),ge(!1),ue(null)},we=async()=>{var u,x;try{const{data:j}=await D.patch(`${I}/api/bookings/${b}/unarchive`,{},{withCredentials:!0,headers:{"Content-Type":"application/json"}}),z=He.find(P=>P._id===b);z&&(le(P=>P.filter(X=>X._id!==b)),_(P=>[{...z,archivedByAdmin:!1,archivedAt:void 0},...P])),h.success("Appointment unarchived successfully."),zt(!1),C(null)}catch(j){console.error("Error in confirmUnarchive:",j),h.error(((x=(u=j.response)==null?void 0:u.data)==null?void 0:x.message)||"Failed to unarchive appointment.")}},g=async u=>{if(!u){h.error("User ID not available");return}Je(!0),qe(!0),ge(!1),ue(null);try{const{data:x}=await D.get(`${I}/api/user/id/${u}`);Hs(x)}catch{h.error("Failed to fetch user details."),qe(!1)}Je(!1)},qt=m.map(u=>({...u,comments:_t[u._id]||u.comments||[]})),Jt=us.map(u=>({...u,comments:_t[u._id]||u.comments||[]})),gs=async()=>{oe(!0);try{const{data:u}=await D.get(`${I}/api/bookings`,{withCredentials:!0});_(u);const{data:x}=await D.get(`${I}/api/bookings/archived`,{withCredentials:!0});le(Array.isArray(x)?x:[])}catch{}finally{oe(!1)}},fs=u=>{if(!u){h.error("No message to copy");return}navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(u).then(()=>{h.success("Copied",{autoClose:2e3,position:"bottom-center"})}).catch(()=>{ve(u)}):ve(u)},ve=u=>{try{const x=document.createElement("textarea");x.value=u,x.style.position="fixed",x.style.left="-999999px",x.style.top="-999999px",document.body.appendChild(x),x.focus(),x.select();const j=document.execCommand("copy");document.body.removeChild(x),j?h.success("Copied",{autoClose:2e3,position:"bottom-center"}):(console.error("Fallback copy failed"),h.error("Failed to copy message"))}catch(x){console.error("Fallback copy error:",x),h.error("Copy not supported")}},Re=c.useCallback(u=>{Ae===u&&J?(ge(!1),ue(null)):(ge(!0),ue(u))},[Ae,J]),bs=c.useCallback(()=>{ut(u=>!u)},[]);return We?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading appointments..."})]})}):Array.isArray(m)?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:[e.jsx("div",{className:"max-w-7xl mx-auto mb-4 flex justify-end",children:e.jsxs("a",{href:"/admin/payments",className:"inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold shadow",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 24 24",fill:"currentColor",children:[e.jsx("path",{d:"M2 7a2 2 0 012-2h16a2 2 0 012 2v3H2V7z"}),e.jsx("path",{d:"M2 12h20v5a2 2 0 01-2 2H4a2 2 0 01-2-2v-5zm4 3a1 1 0 100 2h6a1 1 0 100-2H6z"})]}),"Go to Payments"]})}),e.jsx(yn,{position:"top-center",autoClose:2e3,closeOnClick:!0,containerClassName:"!z-[100]",toastOptions:{style:{fontSize:"0.9rem",borderRadius:"8px",boxShadow:"0 2px 8px #0001"}}}),e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-6",children:[e.jsx("h3",{className:"text-2xl sm:text-3xl font-extrabold text-blue-700 drop-shadow",children:W?`Archived Appointments (${Jt.length})`:`All Appointments (${qt.length})`}),e.jsxs("div",{className:"flex flex-row w-full sm:w-auto gap-2 sm:gap-4 justify-center sm:justify-end mt-2 sm:mt-0",children:[e.jsx("button",{onClick:gs,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-2.5 py-1.5 rounded-md hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md text-xs sm:text-base sm:px-4 sm:py-2 sm:rounded-lg w-1/2 sm:w-auto",title:"Refresh appointments",children:"Refresh"}),e.jsx("button",{onClick:()=>{ct(!W),dt(1),se(1)},className:`bg-gradient-to-r text-white px-2.5 py-1.5 rounded-md transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-1 sm:gap-2 text-xs sm:text-base w-1/2 sm:w-auto sm:px-6 sm:py-3 sm:rounded-lg justify-center ${W?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:W?e.jsxs(e.Fragment,{children:[e.jsx(Rt,{})," ",e.jsx("span",{children:"Active Appointments"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Us,{})," ",e.jsxs("span",{children:["Archived Appointments (",He.length,")"]})]})})]})]}),e.jsx("p",{className:"text-center text-gray-600 mb-6",children:W?"View and manage archived appointments. You can unarchive them to move them back to active appointments.":"ðŸ’¡ High data traffic may cause this page to slow down or stop working. Please refresh to continue using it normally.âš ï¸ Chats are encrypted and secure. View only for valid purposes like disputes or fraud checks. Unauthorized access or sharing is prohibited and will be logged."}),e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6",children:[e.jsx("div",{className:"flex flex-col sm:flex-row gap-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold text-sm",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200 text-sm",value:Z,onChange:u=>jt(u.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending Appointments"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold text-sm",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200 text-sm",value:me,onChange:u=>Ws(u.target.value),max:Se||void 0}),e.jsx("label",{className:"font-semibold text-sm",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200 text-sm",value:Se,onChange:u=>qs(u.target.value),min:me||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Na,{className:"text-gray-500 hover:text-blue-500 transition-colors duration-200"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200 text-sm flex-1",placeholder:"Search by email, property, or username...",value:te,onChange:u=>Nt(u.target.value)})]})]})]}),W?Jt.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Payment"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:Jt.map(u=>e.jsx(Cr,{appt:u,currentUser:l,handleAdminCancel:Ke,handleReinitiateAppointment:Ht,handleArchiveAppointment:xs,handleUnarchiveAppointment:he,onUserClick:g,isArchived:!0,copyMessageToClipboard:fs,updateAppointmentComments:Ot,showCancelModal:mt,setShowCancelModal:_e,showReinitiateModal:Ct,setShowReinitiateModal:Ie,showArchiveModal:kt,setShowArchiveModal:Ye,showUnarchiveModal:Bt,setShowUnarchiveModal:zt,appointmentToHandle:b,setAppointmentToHandle:C,cancelReason:B,setCancelReason:V,confirmAdminCancel:at,confirmReinitiate:Wt,confirmArchive:gt,confirmUnarchive:we,showReactionsBar:J,setShowReactionsBar:ge,reactionsMessageId:Ae,setReactionsMessageId:ue,showReactionsEmojiPicker:Ut,setShowReactionsEmojiPicker:ut,toggleReactionsBar:Re,toggleReactionsEmojiPicker:bs,onExportChat:(x,j)=>{ht(x),xt(j),St(!0)}},u._id))})]})}):qt.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Payment"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:qt.map(u=>e.jsx(Cr,{appt:u,currentUser:l,handleAdminCancel:Ke,handleReinitiateAppointment:Ht,handleArchiveAppointment:xs,handleUnarchiveAppointment:he,onUserClick:g,isArchived:!1,copyMessageToClipboard:fs,updateAppointmentComments:Ot,showCancelModal:mt,setShowCancelModal:_e,showReinitiateModal:Ct,setShowReinitiateModal:Ie,showArchiveModal:kt,setShowArchiveModal:Ye,showUnarchiveModal:Bt,setShowUnarchiveModal:zt,appointmentToHandle:b,setAppointmentToHandle:C,cancelReason:B,setCancelReason:V,confirmAdminCancel:at,confirmReinitiate:Wt,confirmArchive:gt,confirmUnarchive:we,showReactionsBar:J,setShowReactionsBar:ge,reactionsMessageId:Ae,setReactionsMessageId:ue,showReactionsEmojiPicker:Ut,setShowReactionsEmojiPicker:ut,toggleReactionsBar:Re,toggleReactionsEmojiPicker:bs,onExportChat:(x,j)=>{ht(x),xt(j),St(!0)}},u._id))})]})}),!W&&Fe>1&&e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between mt-6 gap-2",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:["Page ",xe," of ",Fe]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsx("button",{onClick:()=>{dt(Math.max(1,xe-1)),h.info(`Navigated to page ${Math.max(1,xe-1)}`)},disabled:xe===1,className:"px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto",children:"Previous"}),e.jsx("button",{onClick:()=>{dt(Math.min(Fe,xe+1)),h.info(`Navigated to page ${Math.min(Fe,xe+1)}`)},disabled:xe===Fe,className:"px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto",children:"Next"})]})]}),W&&ce>1&&e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between mt-6 gap-2",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:["Archived Page ",Q," of ",ce]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 w-full sm:w-auto",children:[e.jsx("button",{onClick:()=>{se(Math.max(1,Q-1)),h.info(`Navigated to archived page ${Math.max(1,Q-1)}`)},disabled:Q===1,className:"px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto",children:"Previous"}),e.jsx("button",{onClick:()=>{se(Math.min(ce,Q+1)),h.info(`Navigated to archived page ${Math.min(ce,Q+1)}`)},disabled:Q===ce,className:"px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto",children:"Next"})]})]})]}),Pt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",style:{overflow:"hidden"},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-40 shadow",onClick:()=>qe(!1),title:"Close","aria-label":"Close",children:e.jsx(ne,{className:"w-4 h-4"})}),ie?e.jsxs("div",{className:"flex items-center justify-center p-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"}),e.jsx("p",{className:"ml-4 text-gray-600",children:"Loading user details..."})]}):ae?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200 sticky top-[env(safe-area-inset-top,0px)] z-20",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(wn,{user:{username:ae.username,avatar:ae.avatar},size:"w-16 h-16",textSize:"text-lg",showBorder:!0,className:"border-4 border-white shadow-lg"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-2 border-white rounded-full flex items-center justify-center",children:ae.role==="admin"||ae.role==="rootadmin"?e.jsx(ms,{className:"w-3 h-3 text-white"}):e.jsx(Ca,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[ae.username,(ae.role==="admin"||ae.role==="rootadmin")&&e.jsx(ms,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:ae.role||"User"}),ae.adminApprovalStatus&&e.jsx("p",{className:`text-xs font-medium px-2 py-1 rounded-full ${ae.adminApprovalStatus==="approved"?"bg-green-100 text-green-700":ae.adminApprovalStatus==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:ae.adminApprovalStatus})]})]})]})}),e.jsx("div",{className:"px-6 py-6 space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx(vn,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:ae.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(jn,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:ae.mobileNumber||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(Nn,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:new Date(ae.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})})]})]})]})})]}):e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("p",{className:"text-gray-600",children:"User not found"})})]})}),e.jsx(Dn,{isOpen:hs,onClose:()=>{St(!1),ht(null),xt([])},onExport:async u=>{var x;try{h.info("Generating PDF...",{autoClose:2e3});const j=((x=de==null?void 0:de.buyerId)==null?void 0:x._id)===l._id?de==null?void 0:de.sellerId:de==null?void 0:de.buyerId,z=await En(de,E,l,j,u);z.success?h.success(`Chat transcript exported as ${z.filename}`):h.error(`Export failed: ${z.error}`)}catch(j){h.error("Failed to export chat transcript"),console.error("Export error:",j)}},appointment:de,messageCount:E.filter(u=>{var x;return!u.deleted&&(((x=u.message)==null?void 0:x.trim())||u.imageUrl)}).length,imageCount:E.filter(u=>u.imageUrl&&!u.deleted).length})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-50 to-blue-100",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-8 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Session expired or unauthorized"}),e.jsx("p",{className:"text-gray-700 mb-4",children:"Please sign in again to access admin appointments."}),e.jsx(kr,{to:"/sign-in",className:"bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors",children:"Go to Sign In"})]})})}function ja(l){const m=new Date,_=new Date;return _.setDate(m.getDate()-1),l.toDateString()===m.toDateString()?"Today":l.toDateString()===_.toDateString()?"Yesterday":l.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}function Mn({appointmentId:l,appointment:m}){var Fe;const[_,Ce]=y.useState(null),[Tt,He]=y.useState(!0),[le,We]=y.useState(!1),[oe,Z]=y.useState(!1);y.useEffect(()=>{async function ke(){try{const Q=await fetch(`${I}/api/payments/history?appointmentId=${l}`,{credentials:"include"}),se=await Q.json();Q.ok&&Array.isArray(se.payments)&&se.payments.length>0?Ce(se.payments[0]):Ce(null)}catch{Ce(null)}finally{He(!1)}}ke()},[l]),y.useEffect(()=>{const ke=Q=>{oe&&!Q.target.closest(".status-options-container")&&Z(!1)};if(oe)return document.addEventListener("mousedown",ke),()=>document.removeEventListener("mousedown",ke)},[oe]);const jt=async ke=>{if(m&&(m==null?void 0:m.paymentConfirmed)!==ke){We(!0),Z(!1);try{if(ke){if((await fetch(`${I}/api/payments/admin/mark-paid`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({appointmentId:l})})).ok){const se=await fetch(`${I}/api/payments/history?appointmentId=${l}`,{credentials:"include"}),ce=await se.json();se.ok&&Array.isArray(ce.payments)&&Ce(ce.payments[0]||null)}}else if((await fetch(`${I}/api/payments/admin/mark-unpaid`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({appointmentId:l})})).ok){const se=await fetch(`${I}/api/payments/history?appointmentId=${l}`,{credentials:"include"}),ce=await se.json();se.ok&&Array.isArray(ce.payments)&&Ce(ce.payments[0]||null)}}finally{We(!1)}}},te=e.jsxs("div",{className:"mt-1 relative status-options-container",children:[e.jsx("button",{onClick:()=>Z(!oe),disabled:le,className:"text-[10px] px-2 py-1 rounded border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",title:"Change payment status",children:le?"Updating...":"Change Status"}),oe&&e.jsx("div",{className:"absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded shadow-lg z-50 min-w-[120px]",children:m!=null&&m.paymentConfirmed?e.jsx("button",{onClick:()=>jt(!1),className:"w-full text-left px-3 py-2 text-[10px] text-red-700 hover:bg-red-50 border-b border-gray-100",children:"Mark Unpaid"}):e.jsx("button",{onClick:()=>jt(!0),className:"w-full text-left px-3 py-2 text-[10px] text-green-700 hover:bg-green-50 border-b border-gray-100",children:"Mark Paid"})})]});if(Tt)return e.jsx(Sr,{className:"animate-spin text-blue-600 mx-auto"});if(!_)return e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${m!=null&&m.paymentConfirmed?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"}`,children:m!=null&&m.paymentConfirmed?"Paid (Admin)":"Pending"}),(m==null?void 0:m.paymentConfirmed)&&e.jsx("div",{className:"text-[10px] text-green-700 font-semibold",children:"âœ“ Admin Confirmed"}),te]});const Nt=!!((Fe=_==null?void 0:_.metadata)!=null&&Fe.adminMarked),xe=_.status==="completed"||Nt?"bg-green-100 text-green-800":_.status==="pending"?"bg-yellow-100 text-yellow-800":_.status==="failed"?"bg-red-100 text-red-800":_.status==="refunded"?"bg-blue-100 text-blue-800":_.status==="partially_refunded"?"bg-orange-100 text-orange-800":"bg-gray-100 text-gray-800",dt=_.status==="completed"?"Paid":Nt?"Paid (Admin)":_.status==="pending"?"Pending":_.status==="failed"?"Failed":_.status==="refunded"?"Refunded":_.status==="partially_refunded"?"Partial Refund":_.status;return e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${xe}`,children:dt}),typeof _.amount=="number"&&e.jsx("div",{className:"text-[10px] text-gray-500 inline-flex items-center gap-1",children:(_.currency||"USD")==="INR"?e.jsxs("span",{children:["â‚¹ ",Number(_.amount).toFixed(2)]}):e.jsxs("span",{children:["$ ",Number(_.amount).toFixed(2)]})}),_.refundAmount>0&&e.jsxs("div",{className:"text-[10px] text-red-500",children:[e.jsxs("div",{children:["Refunded: ",(_.currency||"USD")==="INR"?"â‚¹":"$",Number(_.refundAmount).toFixed(2)]}),_.refundedAt&&e.jsxs("div",{className:"text-red-400",children:[new Date(_.refundedAt).toLocaleDateString("en-GB")," ",new Date(_.refundedAt).toLocaleTimeString("en-GB")]})]}),(m==null?void 0:m.paymentConfirmed)&&e.jsx("div",{className:"text-[10px] text-green-700 font-semibold",children:"âœ“ Admin Confirmed"}),te]})}function Cr({appt:l,currentUser:m,handleAdminCancel:_,handleReinitiateAppointment:Ce,handleArchiveAppointment:Tt,handleUnarchiveAppointment:He,onUserClick:le,isArchived:We,copyMessageToClipboard:oe,updateAppointmentComments:Z,showCancelModal:jt,setShowCancelModal:te,showReinitiateModal:Nt,setShowReinitiateModal:xe,showArchiveModal:dt,setShowArchiveModal:Fe,showUnarchiveModal:ke,setShowUnarchiveModal:Q,appointmentToHandle:se,setAppointmentToHandle:ce,cancelReason:Os,setCancelReason:us,confirmAdminCancel:Vs,confirmReinitiate:ae,confirmArchive:Hs,confirmUnarchive:Pt,showReactionsBar:qe,setShowReactionsBar:ie,reactionsMessageId:Je,setReactionsMessageId:W,showReactionsEmojiPicker:ct,setShowReactionsEmojiPicker:me,toggleReactionsBar:Ws,toggleReactionsEmojiPicker:Se,onExportChat:qs}){var er,tr,sr,ar,rr,nr,lr,or,ir,dr,cr,mr,ur,hr,xr,gr,fr;const[b,C]=y.useState(l.comments||[]);y.useEffect(()=>{if(b.length>0){const t=b.filter(s=>s.starredBy&&s.starredBy.includes(m._id));Te(t)}},[b,m._id]);const[B,V]=c.useState(""),[mt,_e]=c.useState(null),[Ct,Ie]=c.useState(!1),[kt,Ye]=c.useState(!1),[Bt,zt]=c.useState(!1),[J,ge]=c.useState(null),[Ae,ue]=c.useState(""),[Ut,ut]=c.useState(""),[hs,St]=c.useState(null),[de,ht]=c.useState(null),[E,xt]=c.useState(!1),[_t,It]=c.useState(!1),[st,Ot]=c.useState(""),[Vt,Ge]=c.useState(!1),[Ke,at]=c.useState(null),[Ht,Wt]=c.useState(!1),[xs,gt]=c.useState(!1),he=y.useRef(null),we=y.useRef(null),g=y.useRef(null),[qt,Jt]=c.useState([]),[gs,fs]=c.useState(!1),ve=y.useRef({}),[Re,bs]=c.useState(!0),[u,x]=c.useState(0),j=30,[z,P]=c.useState(j),[X,F]=c.useState(""),[$e,Ze]=c.useState(!1),[w,U]=c.useState(!1),[p,R]=c.useState(()=>gn(l._id)),[Y,A]=c.useState(null),[K,O]=c.useState(!1),pe=y.useRef(null),[ft,De]=c.useState(!1),[Yt,Gt]=c.useState(""),[Js,ps]=c.useState(!1),[_r,ka]=c.useState(!1),[je,Sa]=c.useState(null);y.useEffect(()=>{if(!E||!(l!=null&&l._id)||!(m!=null&&m._id))return;const t=`admin_appt_draft_${l._id}_${m._id}`,s=localStorage.getItem(t);s!=null&&(V(s),setTimeout(()=>{try{if(g.current){const a=g.current.value.length;g.current.focus(),g.current.setSelectionRange(a,a),Ps(g.current)}}catch{}},0))},[E,l==null?void 0:l._id,m==null?void 0:m._id]),y.useEffect(()=>{if(!E||!(l!=null&&l._id)||!(m!=null&&m._id))return;const t=`admin_appt_draft_${l._id}_${m._id}`;localStorage.setItem(t,B)},[B,E,l==null?void 0:l._id,m==null?void 0:m._id]);const[Ys,ys]=c.useState(!1),[Ee,Te]=c.useState([]),[ws,vs]=c.useState(!1),[Gs,_a]=c.useState(!1),[Ia,Aa]=c.useState(null),[$a,Da]=c.useState(!1),[Ks,Ea]=c.useState(!1),[Ir,Ma]=c.useState(!1),[At,Me]=c.useState(!1),[Zs,Qe]=c.useState(!1),[Ne,ye]=c.useState([]),[js,Ns]=c.useState({starring:!1,copying:!1,deleting:!1}),[Qs,Cs]=c.useState(!1),[Xs,ks]=c.useState(""),[Xe,Kt]=c.useState([]),[Zt,et]=c.useState(-1),[Ss,Qt]=c.useState(!1),[Ar,$r]=c.useState(""),[Ln,La]=c.useState(null),[Pe,tt]=c.useState(!1),[Fa,bt]=c.useState(""),[M,rt]=c.useState([]),[Dr,_s]=c.useState(!1),[Er,ea]=c.useState([]),[fe,Le]=c.useState(0),[Xt,pt]=c.useState({}),[Mr,es]=c.useState(!1),[nt,Be]=c.useState(0),[Ra,Is]=c.useState(-1),[Lr,ts]=c.useState(0),[$t,ta]=c.useState([]),[Fn,Ta]=c.useState(!1),ss=y.useRef(null),sa=y.useRef(null),aa=y.useRef(null),Fr=y.useRef(null),Rr=y.useRef(null),Pa=y.useRef(null),Ba=y.useRef(null),[ra,lt]=c.useState(!1),[ze,As]=c.useState(null),[Tr,$s]=c.useState(!1),[ot,Ds]=c.useState(null),[Pr,Es]=c.useState(!1),[as,Ms]=c.useState(""),[rs,Ls]=c.useState(""),[Br,na]=c.useState(null),[Ue,ns]=c.useState(null),[zr,ls]=c.useState(!1),[os,la]=c.useState(""),[Ur,oa]=c.useState(null),ia=y.useRef(null),[Or,Fs]=c.useState(!1),[is,da]=c.useState(!1),[Vr,Rs]=c.useState(0),[yt,ca]=c.useState(null),Dt=y.useRef(null),ma=y.useRef([]),wt=y.useRef(null);y.useEffect(()=>{if(ze){const t=URL.createObjectURL(ze);return na(t),()=>{URL.revokeObjectURL(t),na(null)}}else na(null)},[ze]),y.useEffect(()=>{if(Ue){const t=URL.createObjectURL(Ue);return oa(t),()=>{URL.revokeObjectURL(t),oa(null)}}else oa(null)},[Ue]),y.useEffect(()=>()=>{wt.current&&clearInterval(wt.current),yt&&yt.getTracks().forEach(t=>t.stop())},[yt]);const Hr=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({audio:!0});ca(t),ma.current=[];const s=new MediaRecorder(t,{mimeType:"audio/webm"});Dt.current=s,s.ondataavailable=a=>{a.data&&a.data.size>0&&ma.current.push(a.data)},s.onstop=()=>{try{const a=new Blob(ma.current,{type:"audio/webm"}),n=`recording-${Date.now()}.webm`,r=new File([a],n,{type:"audio/webm"});ns(r),Fs(!1),ls(!0)}catch{h.error("Failed to prepare audio preview")}finally{yt&&yt.getTracks().forEach(a=>a.stop()),ca(null),da(!1),Rs(0),wt.current&&clearInterval(wt.current)}},s.start(100),da(!0),Rs(0),wt.current=setInterval(()=>{Rs(a=>a+1e3)},1e3)}catch(t){console.error("Recording error:",t),h.error("Microphone permission denied or unavailable")}},Wr=()=>{if(Dt.current)try{Dt.current.stop()}catch{}},za=()=>{try{Dt.current&&Dt.current.state!=="inactive"&&Dt.current.stop()}catch{}yt&&yt.getTracks().forEach(t=>t.stop()),ca(null),da(!1),Rs(0),wt.current&&clearInterval(wt.current),Fs(!1)};y.useEffect(()=>{if(!ra)return;const t=s=>{const a=Pa.current,n=Ba.current;n&&n.contains(s.target)||a&&a.contains(s.target)||lt(!1)};return document.addEventListener("mousedown",t,!0),()=>document.removeEventListener("mousedown",t,!0)},[ra]);const k=Y?b.find(t=>t._id===Y):null,be=async(t,s)=>{var a,n;try{if(!b.find(i=>i._id===t)){h.error("Message not found");return}const{data:o}=await D.patch(`${I}/api/bookings/${l._id}/comment/${t}/react`,{emoji:s},{withCredentials:!0,headers:{"Content-Type":"application/json"}});C(i=>i.map(d=>d._id===t?{...d,reactions:o.reactions||d.reactions||[]}:d)),Z(l._id,b.map(i=>i._id===t?{...i,reactions:o.reactions||i.reactions||[]}:i)),me(!1),ie(!1),W(null),h.success("Reaction added!")}catch(r){h.error(((n=(a=r.response)==null?void 0:a.data)==null?void 0:n.message)||"Failed to add reaction")}};y.useEffect(()=>(E?(document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%"):(document.body.style.overflow="",document.body.style.position="",document.body.style.width=""),()=>{document.body.style.overflow="",document.body.style.position="",document.body.style.width=""}),[E]),y.useEffect(()=>{if(E&&(x(0),D.patch(`${I}/api/bookings/${l._id}/comments/read`,{},{withCredentials:!0}).catch(t=>{console.error("Error marking messages as read:",t)}),Ee.length>0)){const t=Ee.map(s=>{const a=b.find(n=>n._id===s._id);return a?{...s,starredBy:a.starredBy||[]}:s}).filter(s=>s.starredBy&&s.starredBy.includes(m._id));Te(t)}},[E,l._id,Ee.length,b,m._id]),y.useEffect(()=>{if(w){const t=setTimeout(()=>{U(!1)},1e4);return()=>clearTimeout(t)}},[w]),y.useEffect(()=>(_t?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[_t]);const Ua=async()=>{if(l!=null&&l._id){_a(!0);try{await Qa();const{data:t}=await D.get(`${I}/api/bookings/${l._id}/starred-messages`,{withCredentials:!0});t.starredMessages&&Te(t.starredMessages)}catch(t){console.error("Error fetching starred messages:",t),h.error("Failed to load starred messages")}finally{_a(!1)}}};y.useEffect(()=>{Ys&&Ua()},[Ys,l._id]);const qr=async()=>{if(Ee.length!==0){Ee.length,Da(!0);try{let t=0,s=0;const a=[];for(const n of Ee)try{const r=await D.patch(`${I}/api/bookings/${l._id}/comment/${n._id}/star`,{starred:!1},{withCredentials:!0,headers:{"Content-Type":"application/json"}});t++,C(o=>o.map(i=>i._id===n._id?{...i,starredBy:(i.starredBy||[]).filter(d=>d!==m._id)}:i))}catch(r){console.error(`Failed to unstar message ${n._id}:`,r),s++,a.push(n)}Te(n=>n.filter(r=>!a.some(o=>o._id===r._id))),t>0&&s===0?(h.success(`Successfully removed ${t} starred message${t!==1?"s":""}`),ys(!1)):t>0&&s>0?h.warning(`Partially successful: ${t} messages unstarred, ${s} failed`):h.error("Failed to unstar any messages. Please try again.")}catch(t){console.error("Error removing all starred messages:",t),h.error("Failed to remove all starred messages. Please try again.")}finally{Da(!1)}}};y.useEffect(()=>{const t=o=>{At&&!o.target.closest(".chat-options-menu")&&Me(!1),K&&!o.target.closest(".chat-options-menu")&&O(!1)},s=o=>{Qs&&!o.target.closest(".search-container")&&!o.target.closest(".enhanced-search-header")&&(Cs(!1),ks(""),Kt([]),et(-1))},a=o=>{Ss&&!o.target.closest(".calendar-container")&&Qt(!1)},n=o=>{ct&&!o.target.closest(".quick-reactions-modal")&&me(!1),qe&&!o.target.closest(".reactions-bar")&&(ie(!1),W(null))},r=()=>{At&&Me(!1),K&&O(!1),ct&&me(!1),qe&&!ct&&(ie(!1),W(null))};return document.addEventListener("mousedown",t),document.addEventListener("mousedown",s),document.addEventListener("mousedown",a),document.addEventListener("mousedown",n),document.addEventListener("scroll",r,!0),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("mousedown",s),document.removeEventListener("mousedown",a),document.removeEventListener("mousedown",n),document.removeEventListener("scroll",r,!0)}},[At,K,Qs,Ss,qe,ct]),y.useEffect(()=>{if(Ks){const t=setTimeout(()=>{Ea(!1),Ma(!0);const s=setTimeout(()=>Ma(!1),1e3);return()=>clearTimeout(s)},800);return()=>clearTimeout(t)}},[Ks]),y.useEffect(()=>{Zt>=0&&Xe[Zt]&&Za(Xe[Zt]._id)},[Zt,Xe]),y.useEffect(()=>{const t=l.comments||[];if(JSON.stringify(b)!==JSON.stringify(t)){const s=b.length;if(C(t),t.length>s){const n=t.slice(s).filter(r=>r.senderEmail!==m.email);n.length>0&&(E||x(r=>r+n.length),E&&Re&&setTimeout(()=>{he.current&&he.current.scrollIntoView({behavior:"smooth"})},100),E&&setTimeout(()=>{D.patch(`${I}/api/bookings/${l._id}/comments/read`,{},{withCredentials:!0}).catch(r=>{console.error("Error marking messages as read:",r)})},100))}}},[l.comments,l._id,E,Re,m.email]),y.useEffect(()=>{E&&he.current&&he.current.scrollIntoView({behavior:"smooth"})},[E]),y.useEffect(()=>{const t=we.current;if(!t)return;const s=()=>{if(t.scrollTop<=0&&b.length>z){const a=t.scrollHeight;P(n=>Math.min(n+j,b.length)),setTimeout(()=>{const n=t.scrollHeight;t.scrollTop=n-a},0)}};return t.addEventListener("scroll",s),()=>t.removeEventListener("scroll",s)},[b.length,z]),y.useEffect(()=>{P(j)},[l._id,E]);const Oa=y.useRef(b.length),Jr=y.useRef(b);y.useEffect(()=>{const t=b.slice(Oa.current),s=t.length;if(Oa.current=b.length,Jr.current=b,s>0&&E){const a=t.some(r=>r.senderEmail===m.email),n=t.filter(r=>r.senderEmail!==m.email);a||Re?setTimeout(()=>{he.current&&he.current.scrollIntoView({behavior:"smooth"})},100):n.length>0&&x(r=>r+n.length)}},[b.length,Re,E,m.email]),y.useEffect(()=>{x(0)},[E]);const ua=y.useCallback(()=>{if(!we.current||b.length===0)return;const s=we.current.getBoundingClientRect(),a=s.top+60;let n="";for(let r=0;r<b.length;r++){const o=ve.current[b[r]._id];if(o){const i=o.getBoundingClientRect();if(i.top>=a&&i.bottom<=s.bottom){const d=new Date(b[r].timestamp);n=ja(d);break}}}if(!n)for(let r=0;r<b.length;r++){const o=ve.current[b[r]._id];if(o&&o.getBoundingClientRect().bottom>a){const d=new Date(b[r].timestamp);n=ja(d);break}}n&&n!==X&&F(n)},[b,X]),ha=y.useRef(!1),Ts=y.useCallback(async()=>{if(ha.current)return;const t=b.filter(s=>{var a;return!((a=s.readBy)!=null&&a.includes(m._id))&&s.senderEmail!==m.email});if(t.length>0){ha.current=!0;try{const{data:s}=await D.patch(`${I}/api/bookings/${l._id}/comments/read`,{},{withCredentials:!0,headers:{"Content-Type":"application/json"}});C(a=>a.map(n=>t.some(r=>r._id===n._id)?{...n,readBy:[...n.readBy||[],m._id],status:"read"}:n)),t.forEach(a=>{T.emit("messageRead",{appointmentId:l._id,messageId:a._id,userId:m._id})})}catch(s){console.error("Error marking messages as read:",s)}finally{ha.current=!1}}},[b,m._id,l._id,T]),xa=y.useCallback(()=>{if(we.current){const{scrollTop:t,scrollHeight:s,clientHeight:a}=we.current,n=s-t-a<5;bs(n),n&&u>0&&(x(0),Ts())}},[u,Ts]);y.useEffect(()=>{const t=we.current;if(t&&E){const s=()=>{xa(),ua(),Ze(!0),pe.current&&clearTimeout(pe.current),pe.current=setTimeout(()=>{Ze(!1)},1e3)};return t.addEventListener("scroll",s),xa(),setTimeout(ua,100),()=>{t.removeEventListener("scroll",s),pe.current&&clearTimeout(pe.current)}}},[E,xa,ua]);const Va=y.useCallback(()=>{he.current&&(he.current.scrollIntoView({behavior:"smooth"}),x(0),setTimeout(()=>{Ts()},500))},[Ts]);y.useEffect(()=>(E?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[E]),y.useEffect(()=>{function t(s){var a,n;if(s.appointmentId===l._id&&!E){if(s.comment.deleted)return;const r=s.comment.senderEmail===((a=l.buyerId)==null?void 0:a.email),o=s.comment.senderEmail===((n=l.sellerId)==null?void 0:n.email),d=!r&&!o?"UrbanSetu":s.comment.senderEmail||"User";h.info(`New message from ${d}`)}}return T.on("commentUpdate",t),()=>{T.off("commentUpdate",t)}},[l._id,E]),y.useEffect(()=>{function t({appointmentId:a,clearedAt:n}){a===l._id&&(C([]),x(0),ie(!1),W(null))}function s({appointmentId:a,commentId:n}){a===l._id&&(C(r=>r.filter(o=>o._id!==n)),ie(!1),W(null))}return T.on("chatClearedForUser",t),T.on("commentRemovedForUser",s),()=>{T.off("chatClearedForUser",t),T.off("commentRemovedForUser",s)}},[l._id]),y.useEffect(()=>{const t=n=>{n.appointmentId===l._id&&C(r=>r.map(o=>o._id===n.commentId?{...o,status:o.status==="read"?"read":"delivered",deliveredAt:new Date}:o))},s=n=>{n.appointmentId===l._id&&C(r=>r.map(o=>{var i;return(i=o.readBy)!=null&&i.includes(n.userId)?o:{...o,status:"read",readBy:[...o.readBy||[],n.userId],readAt:new Date}}))},a=n=>{n.appointmentId===l._id&&(C([]),h.success("Chat deleted by admin"),ie(!1),W(null))};return T.on("chatCleared",a),T.on("commentDelivered",t),T.on("commentRead",s),()=>{T.off("chatCleared",a),T.off("commentDelivered",t),T.off("commentRead",s)}},[l._id,E,m.email,Re]),y.useEffect(()=>{if(!E)return;setTimeout(()=>{g.current&&In(g.current,g.current.value.length)},100);const s=a=>{a.ctrlKey&&a.key==="f"?(a.preventDefault(),g.current&&An(g.current,g.current.value.length)):a.key==="Escape"&&(a.preventDefault(),xt(!1))};return document.addEventListener("keydown",s),()=>{document.removeEventListener("keydown",s)}},[E]),y.useEffect(()=>{!E||!/@[^\s]*$/.test(B||"")||gs||(async()=>{try{const a=await(await fetch(`${I}/api/listing/get?limit=300`,{credentials:"include"})).json(),n=Array.isArray(a)?a.map(r=>({id:r._id,name:r.name||"Property"})):[];Jt(n),fs(!0)}catch{}})()},[B,E,gs]);const Ha=async t=>{if(!t||t.length===0)return;const s=[],a=[];if(Array.from(t).forEach((n,r)=>{if(!n.type.startsWith("image/")){a.push(`File ${r+1}: Please select an image file`);return}if(n.size>5*1024*1024){a.push(`File ${r+1}: File size must be less than 5MB`);return}s.push(n)}),a.length>0){bt(a.join(", ")),setTimeout(()=>bt(""),5e3);return}if(s.length>10){bt("Maximum 10 images allowed at once"),setTimeout(()=>bt(""),3e3);return}rt(s),Le(0),es(!0),bt("")},Yr=async(t,s,a="")=>{var o,i;const n=`temp-${Date.now()}`,r={_id:n,sender:m._id,senderEmail:m.email,senderName:m.username,message:a||"",imageUrl:t,status:"sending",timestamp:new Date().toISOString(),readBy:[m._id],type:"image"};C(d=>[...d,r]),he.current&&he.current.scrollIntoView({behavior:"smooth"});try{const{data:d}=await D.post(`${I}/api/bookings/${l._id}/comment`,{message:a||"",imageUrl:t,type:"image"},{withCredentials:!0,headers:{"Content-Type":"application/json"}}),N=d.comments[d.comments.length-1];C(S=>S.map($=>$._id===n?{...$,_id:N._id,status:N.status,readBy:N.readBy||$.readBy,timestamp:N.timestamp||$.timestamp}:$))}catch(d){console.error("Send image error:",d),C(N=>N.filter(S=>S._id!==n)),h.error(((i=(o=d.response)==null?void 0:o.data)==null?void 0:i.message)||"Failed to send image.")}},Wa=async(t,s)=>{var a;if(!t||typeof t!="string"){h.error("Error: Invalid image URL. Cannot download image.");return}try{const n=t.split("/");let o=n[n.length-1];if(!o.includes(".")||o.length<5){const i=((a=t.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?|$)/i))==null?void 0:a[1])||"jpg";o=`chat-image-${s||Date.now()}.${i}`}try{const i=await fetch(t,{mode:"cors",cache:"no-cache"});if(i.ok)try{const d=await i.blob();if(!d||d.size===0)throw new Error("Downloaded image is empty or corrupted");const N=window.URL.createObjectURL(d),S=document.createElement("a");S.href=N,S.download=o,S.style.display="none",document.body.appendChild(S),S.click(),document.body.removeChild(S),setTimeout(()=>window.URL.revokeObjectURL(N),100),h.success(`Image "${o}" downloaded successfully!`);return}catch(d){throw console.error("Blob processing error:",d),new Error(`Failed to process image data: ${d.message}`)}else{let d=`Server error (${i.status}): `;switch(i.status){case 404:d+="Image not found on server";break;case 403:d+="Access denied to image";break;case 500:d+="Server internal error";break;default:d+="Unable to fetch image"}throw new Error(d)}}catch(i){console.warn("Fetch failed, trying direct download:",i),i.name==="TypeError"&&i.message.includes("Failed to fetch")?h.warn("Network error: Trying alternative download method..."):i.message.includes("CORS")?h.warn("CORS error: Trying alternative download method..."):h.warn(`Fetch error: ${i.message}. Trying alternative download method...`);try{const d=document.createElement("a");d.href=t,d.download=o,d.target="_blank",d.rel="noopener noreferrer",d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d),h.info(`Alternative download initiated. If it doesn't start automatically, please try right-clicking the image and selecting "Save image as..."`);return}catch(d){throw console.error("Direct download failed:",d),new Error(`Direct download failed: ${d.message}`)}}}catch(n){console.error("Download process failed:",n),h.error(`Download failed: ${n.message}. Attempting to open image in new tab...`);try{if(window.open(t,"_blank","noopener,noreferrer"))h.info("Image opened in new tab. You can right-click to save it manually.");else throw new Error("Pop-up blocked by browser")}catch(r){console.error("Failed to open image in new tab:",r),r.message.includes("Pop-up blocked")?h.error('Error: Pop-up blocked. Please allow pop-ups for this site or right-click the image and select "Save image as..."'):h.error(`All download methods failed: ${r.message}. Please right-click the image and select "Save image as..." or check your internet connection.`)}}},qa=t=>{if(((M==null?void 0:M.length)||0)+t.length>10){h.error("Maximum 10 images allowed. Please remove some images first.");return}const a=t.filter(r=>r.type.startsWith("image/"));if(a.length===0){h.error("No valid image files found");return}rt(r=>[...r||[],...a]);const n={};a.forEach(r=>{n[r.name]=""}),pt(r=>({...r,...n})),es(!0),h.success(`${a.length} image${a.length>1?"s":""} added successfully!`)},Ja=async()=>{var t,s,a,n;if(!(!M||M.length===0)){tt(!0),Be(0),Is(-1),ts(0),ta([]),Ta(!1);try{let r=!1;const o=[];for(let i=0;i<M.length;i++){const d=M[i];Is(i),ts(0);const N=new FormData;N.append("image",d);const S=new AbortController;ss.current=S;try{const{data:$}=await D.post(`${I}/api/upload/image`,N,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"},signal:S.signal,onUploadProgress:ee=>{if(ee.total){const Oe=Math.round(ee.loaded*100/ee.total);ts(Oe);const Et=Math.round((i+Oe/100)/M.length*100);Be(Et)}}});await Yr($.imageUrl,d.name,Xt[d.name]||""),Be(Math.round((i+1)/M.length*100))}catch($){if($.name==="CanceledError"||$.code==="ERR_CANCELED"){r=!0,Ta(!0);break}else o.push(d)}finally{ss.current===S&&(ss.current=null)}}o.length&&ta(o),!r&&o.length===0&&(rt([]),pt({}),Le(0),es(!1))}catch(r){console.error("File upload error:",r),bt(((s=(t=r.response)==null?void 0:t.data)==null?void 0:s.message)||"Upload failed. Please try again."),h.error(((n=(a=r.response)==null?void 0:a.data)==null?void 0:n.message)||"Upload failed. Please try again."),setTimeout(()=>bt(""),3e3)}finally{tt(!1),Be(0),Is(-1),ts(0)}}},ga=()=>{if(ss.current)try{ss.current.abort()}catch{}tt(!1),Is(-1),ts(0)},Gr=async()=>{$t.length&&(rt($t),ta([]),await Ja())},Kr=async(t,s,a="")=>{var o,i;const n=`temp-${Date.now()}`,r={_id:n,sender:m._id,senderEmail:m.email,message:a||"",videoUrl:t,type:"video",status:"sending",timestamp:new Date().toISOString()};C(d=>[...d,r]);try{const{data:d}=await D.post(`${I}/api/bookings/${l._id}/comment`,{message:a||"",videoUrl:t,type:"video"},{withCredentials:!0});C(d.comments||((o=d.updated)==null?void 0:o.comments)||((i=d==null?void 0:d.appointment)==null?void 0:i.comments)||[])}catch{h.error("Failed to send video"),C(N=>N.filter(S=>S._id!==n))}},Zr=async()=>{var t,s;if(ze)try{tt(!0);const a=new FormData;a.append("video",ze);const{data:n}=await D.post(`${I}/api/upload/video`,a,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"},onUploadProgress:r=>{const o=Math.round(r.loaded*100/Math.max(1,r.total||ze.size));Be(o)}});await Kr(n.videoUrl,ze.name,as),As(null),$s(!1),Ms(""),Be(0)}catch(a){h.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Video upload failed")}finally{tt(!1)}},Qr=async(t,s,a="")=>{var o,i;const n=`temp-${Date.now()}`,r={_id:n,sender:m._id,senderEmail:m.email,message:a||"",documentUrl:t,documentName:s.name,documentType:s.type,type:"document",status:"sending",timestamp:new Date().toISOString()};C(d=>[...d,r]);try{const{data:d}=await D.post(`${I}/api/bookings/${l._id}/comment`,{message:a||"",documentUrl:t,documentName:s.name,documentType:s.type,type:"document"},{withCredentials:!0});C(d.comments||((o=d.updated)==null?void 0:o.comments)||((i=d==null?void 0:d.appointment)==null?void 0:i.comments)||[])}catch{h.error("Failed to send document"),C(N=>N.filter(S=>S._id!==n))}},Xr=async(t,s,a="")=>{var o,i;const n=`temp-${Date.now()}`,r={_id:n,sender:m._id,senderEmail:m.email,message:a||"",audioUrl:t,audioName:s.name,audioMimeType:s.type||null,type:"audio",status:"sending",timestamp:new Date().toISOString()};C(d=>[...d,r]);try{const{data:d}=await D.post(`${I}/api/bookings/${l._id}/comment`,{message:a||"",audioUrl:t,audioName:s.name,audioMimeType:s.type||null,type:"audio"},{withCredentials:!0});C(d.comments||((o=d.updated)==null?void 0:o.comments)||((i=d==null?void 0:d.appointment)==null?void 0:i.comments)||[])}catch{h.error("Failed to send audio"),C(N=>N.filter(S=>S._id!==n))}},en=async()=>{var t,s;if(Ue)try{tt(!0);const a=new FormData;a.append("audio",Ue);const{data:n}=await D.post(`${I}/api/upload/audio`,a,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"},onUploadProgress:r=>{const o=Math.round(r.loaded*100/Math.max(1,r.total||Ue.size));Be(o)}});await Xr(n.audioUrl,Ue,os),ns(null),ls(!1),la(""),Be(0)}catch(a){h.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Audio upload failed")}finally{tt(!1)}},tn=async()=>{var t,s;if(ot)try{tt(!0);const a=new FormData;a.append("document",ot);const{data:n}=await D.post(`${I}/api/upload/document`,a,{withCredentials:!0,headers:{"Content-Type":"multipart/form-data"},onUploadProgress:r=>{const o=Math.round(r.loaded*100/Math.max(1,r.total||ot.size));Be(o)}});await Qr(n.documentUrl,ot,rs),Ds(null),Es(!1),Ls(""),Be(0)}catch(a){h.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Document upload failed")}finally{tt(!1)}},fa=async()=>{if(!B.trim())return;window.dispatchEvent(new Event("closeEmojiPicker")),Ea(!0);const t=B.trim(),s=de,a=`temp-${Date.now()}`,n={_id:a,sender:m._id,senderEmail:m.email,senderName:m.username,message:t,status:"sending",timestamp:new Date().toISOString(),readBy:[m._id],previewDismissed:Ct,...s?{replyTo:s._id}:{}};C(o=>[...o,n]);try{playMessageSent()}catch{}V("");try{const o=`admin_appt_draft_${l._id}_${m._id}`;localStorage.removeItem(o)}catch{}_e(null),Ie(!1),ht(null),sn();const r=()=>{g.current&&(g.current.focus(),g.current.setSelectionRange(0,0),document.activeElement!==g.current&&(g.current.click(),g.current.focus()))};r(),requestAnimationFrame(r),setTimeout(r,10),he.current&&he.current.scrollIntoView({behavior:"smooth"}),(async()=>{var o,i;try{const{data:d}=await D.post(`${I}/api/bookings/${l._id}/comment`,{message:t,...s?{replyTo:s._id}:{}},{withCredentials:!0,headers:{"Content-Type":"application/json"}}),N=d.comments[d.comments.length-1];C(S=>S.map($=>$._id===a?{...$,_id:N._id,status:N.status,readBy:N.readBy||$.readBy,timestamp:N.timestamp||$.timestamp}:$))}catch(d){C(S=>S.filter($=>$._id!==a)),V(t),h.error(((i=(o=d.response)==null?void 0:o.data)==null?void 0:i.message)||"Failed to send message.");const N=()=>{g.current&&(g.current.focus(),g.current.setSelectionRange(0,0),document.activeElement!==g.current&&(g.current.click(),g.current.focus()))};N(),requestAnimationFrame(N)}})()},ba=async t=>{if(!Ae.trim())return;St(t),C(a=>a.map(n=>n._id===t?{...n,message:Ae,edited:!0,editedAt:new Date}:n));try{const{data:a}=await D.patch(`${I}/api/bookings/${l._id}/comment/${t}`,{message:Ae},{withCredentials:!0,headers:{"Content-Type":"application/json"}});C(o=>o.map(i=>{const d=a.comments.find(N=>N._id===i._id);return d?d._id===t?d:i.status==="read"&&d.status!=="read"?{...d,status:"read"}:d:i})),ge(null),ue(""),V(Ut),setTimeout(()=>{ut("")},100),_e(null),Ie(!1),setTimeout(()=>{if(g.current){const o=new Event("input",{bubbles:!0});g.current.dispatchEvent(o),Ps(g.current)}},50);const r=()=>{g.current&&(g.current.focus(),g.current.setSelectionRange(0,0),document.activeElement!==g.current&&(g.current.click(),g.current.focus()))};r(),requestAnimationFrame(r),setTimeout(r,10),h.success("Message edited successfully!")}catch(a){console.error("Error editing comment:",a),C(n=>n.map(r=>r._id===t?{...r,message:r.originalMessage||r.message,edited:r.wasEdited||!1}:r)),ge(t),ue(Ae),V(Ae),h.error("An error occurred. Please try again.")}finally{St(null)}},Ps=t=>{if(t){t.style.height="48px";const s=t.scrollHeight,a=144;s<=a?(t.style.height=s+"px",t.style.overflowY="hidden"):(t.style.height=a+"px",t.style.overflowY="auto")}},sn=()=>{g.current&&(g.current.style.height="48px",g.current.style.overflowY="hidden")},an=t=>{ut(B),ge(t._id),ue(t.message),V(t.message),C(s=>s.map(a=>a._id===t._id?{...a,originalMessage:a.message,wasEdited:a.edited}:a)),setTimeout(()=>{if(g.current){g.current.focus();const s=g.current.value.length;g.current.setSelectionRange(s,s),Ps(g.current)}},100)},Ya=t=>{ht(t);const s=()=>{if(g.current){g.current.focus();const a=g.current.value.length;g.current.setSelectionRange(a,a),document.activeElement!==g.current&&(g.current.click(),g.current.focus()),Ps(g.current)}};setTimeout(s,50),setTimeout(s,100),setTimeout(s,200)},Ga=t=>{Sa(t),ka(!0)},Ka=new Date(l.date)>new Date||new Date(l.date).toDateString()===new Date().toDateString()&&(!l.time||l.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),rn=t=>{if(!t.trim()){Kt([]),et(-1),document.querySelectorAll(".search-highlight").forEach(a=>{a.classList.remove("search-highlight","search-pulse","search-glow")}),document.querySelectorAll(".search-text-highlight").forEach(a=>{a.outerHTML=a.innerHTML});return}const s=b.filter(a=>!a.deleted).filter(a=>{var n,r;return a.message.toLowerCase().includes(t.toLowerCase())||((n=a.senderName)==null?void 0:n.toLowerCase().includes(t.toLowerCase()))||((r=a.senderEmail)==null?void 0:r.toLowerCase().includes(t.toLowerCase()))}).map(a=>({...a,matchIndex:a.message.toLowerCase().indexOf(t.toLowerCase())}));Kt(s),s.length>0?(et(0),setTimeout(()=>{Za(s[0]._id)},100)):et(-1)},nn=t=>{const s=t.target.value;ks(s),rn(s)},ln=t=>{t.key==="Enter"?(t.preventDefault(),Xe.length>0&&et(s=>s<Xe.length-1?s+1:0)):t.key==="Escape"&&(Cs(!1),ks(""),Kt([]),et(-1),document.querySelectorAll(".search-text-highlight").forEach(s=>{s.outerHTML=s.innerHTML}))},Za=t=>{const s=ve.current[t];s&&(s.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{document.querySelectorAll(".search-highlight").forEach(n=>{n.classList.remove("search-highlight","search-pulse","search-glow")}),s.classList.add("search-highlight","search-pulse","search-glow");const a=document.createElement("div");a.className="search-ripple",s.style.position="relative",s.appendChild(a),setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},1e3),setTimeout(()=>{s.classList.remove("search-highlight","search-pulse","search-glow")},3e3)},300))},on=t=>{$r(t),Qt(!1);const a=new Date(t).toDateString(),n=b.find(r=>new Date(r.timestamp).toDateString()===a);if(n){const r=ve.current[n._id];r&&(r.classList.add("date-jump-preparing"),r.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),setTimeout(()=>{r.classList.remove("date-jump-preparing"),La(n._id),r.classList.add("date-highlight","date-jump-pulse");const o=document.createElement("div");o.className="date-jump-ripple",r.style.position="relative",r.appendChild(o),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},1e3),setTimeout(()=>{r.classList.remove("date-highlight","date-jump-pulse"),La(null)},4e3)},500))}else h.info("No messages found for the selected date",{position:"top-center",autoClose:3e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0})},dn=t=>{const s=new Date(t),a=s.getFullYear(),n=String(s.getMonth()+1).padStart(2,"0"),r=String(s.getDate()).padStart(2,"0");return`${a}-${n}-${r}`},cn=t=>{switch(t){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-red-100 text-red-700";case"cancelledBySeller":return"bg-red-100 text-red-700";case"cancelledByAdmin":return"bg-red-100 text-red-700";case"deletedByAdmin":return"bg-gray-100 text-gray-700";default:return"bg-gray-100 text-gray-700"}},mn=()=>{It(!0),Ot("")},Qa=async()=>{try{gt(!0);const{data:t}=await D.get(`${I}/api/bookings/${l._id}`,{withCredentials:!0});if(t.comments){const s=t.comments.map(r=>{const o=b.find(i=>i._id===r._id);return o&&o.starredBy?{...r,starredBy:o.starredBy}:r}),a=b.filter(r=>r._id.startsWith("temp-")),n=new Set(t.comments.map(r=>r._id));a.forEach(r=>{n.has(r._id)||s.push(r)}),C(s)}}catch(t){console.error("Error loading initial comments:",t),h.error("Failed to load messages")}finally{gt(!1)}},un=async()=>{try{gt(!0);const{data:t}=await D.get(`${I}/api/bookings/${l._id}`,{withCredentials:!0});if(t.comments){const s=t.comments.map(r=>{const o=b.find(i=>i._id===r._id);return o&&o.starredBy?{...r,starredBy:o.starredBy}:r}),a=b.filter(r=>r._id.startsWith("temp-")),n=new Set(t.comments.map(r=>r._id));a.forEach(r=>{n.has(r._id)||s.push(r)}),C(s),h.success("Messages refreshed successfully!",{autoClose:2e3,position:"top-center"})}}catch(t){console.error("Error fetching latest comments:",t),h.error("Failed to refresh messages")}finally{gt(!1)}},hn=async t=>{var s,a;t.preventDefault(),Wt(!0);try{const{data:n}=await D.post(`${I}/api/auth/verify-password`,{password:st},{withCredentials:!0,headers:{"Content-Type":"application/json"}});n.success&&(It(!1),xt(!0),setTimeout(()=>{Qa()},100))}catch(n){h.error(((a=(s=n.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to verify password. Please try again.")}Wt(!1)},Xa=t=>{at(t),Ge(!0)},xn=async()=>{var t,s,a;if(Ke){try{if(Array.isArray(Ke)){const n=Ke.map(o=>o._id),{data:r}=await D.delete(`${I}/api/bookings/${l._id}/comments/bulk-delete`,{withCredentials:!0,headers:{"Content-Type":"application/json"},data:{commentIds:n}});r!=null&&r.comments&&C(r.comments),h.success(`Deleted ${n.length} messages for everyone!`)}else{const n=!((t=Ke.readBy)!=null&&t.includes(m._id))&&Ke.senderEmail!==m.email,{data:r}=await D.delete(`${I}/api/bookings/${l._id}/comment/${Ke._id}`,{withCredentials:!0});C(r.comments),n&&x(o=>Math.max(0,o-1)),h.success("Message deleted successfully!")}}catch(n){h.error(((a=(s=n.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to delete message.")}Ge(!1),at(null)}};function gn(t){try{return JSON.parse(localStorage.getItem(`hiddenDeletedMsgs_${t}`))||[]}catch{return[]}}const fn=y.useCallback(t=>{R(s=>{if(!s.includes(t)){const a=[...s,t];return setTimeout(()=>{localStorage.setItem(`hiddenDeletedMsgs_${l._id}`,JSON.stringify(a))},0),a}return s})},[l._id]),bn=y.useCallback(t=>{R(s=>{const a=s.filter(n=>n!==t);return setTimeout(()=>{localStorage.setItem(`hiddenDeletedMsgs_${l._id}`,JSON.stringify(a))},0),a})},[l._id]);return e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${We?"bg-gray-50":""} ${Ka?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(l.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:l.time}),!Ka&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"}),We&&l.archivedAt&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Archived: ",new Date(l.archivedAt).toLocaleDateString("en-GB")]})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:l.listingId?e.jsx(kr,{to:`/admin/listing/${l.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:l.propertyName}):e.jsx("div",{className:"font-semibold",children:l.propertyName})})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx(Mn,{appointmentId:l._id,appointment:l})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var t;return le((t=l.buyerId)==null?void 0:t._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view buyer details",children:[e.jsx("div",{className:"font-semibold",children:((er=l.buyerId)==null?void 0:er.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:((tr=l.buyerId)==null?void 0:tr.email)||l.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((sr=l.buyerId)==null?void 0:sr.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var t;return le((t=l.sellerId)==null?void 0:t._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view seller details",children:[e.jsx("div",{className:"font-semibold",children:((ar=l.sellerId)==null?void 0:ar.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:(rr=l.sellerId)==null?void 0:rr.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((nr=l.sellerId)==null?void 0:nr.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:l.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:l.message||"No message provided"}),e.jsxs("td",{className:"border p-2 text-center",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${cn(l.status)}`,children:l.status==="deletedByAdmin"?"Deleted by Admin":l.status==="cancelledByBuyer"?"Cancelled by Buyer":l.status==="cancelledBySeller"?"Cancelled by Seller":l.status==="cancelledByAdmin"?"Cancelled by Admin":l.status.charAt(0).toUpperCase()+l.status.slice(1)}),l.status==="deletedByAdmin"&&l.adminComment&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:['"',l.adminComment,'"']}),(l.status==="cancelledByBuyer"||l.status==="cancelledBySeller")&&e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:l.status==="cancelledByBuyer"?`Buyer reinitiations: ${l.buyerReinitiationCount||0}/2`:`Seller reinitiations: ${l.sellerReinitiationCount||0}/2`})]}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:We?e.jsxs("button",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>He(l._id),title:"Unarchive Appointment",children:[e.jsx(Rt,{})," Unarchive"]}):e.jsxs(e.Fragment,{children:[l.status==="cancelledByAdmin"?e.jsxs("button",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>Ce(l._id),title:"Reinitiate Appointment (Admin)",children:[e.jsx(ms,{})," Reinitiate"]}):l.status!=="deletedByAdmin"?e.jsxs("button",{className:"bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>_(l._id),title:"Cancel Appointment (Admin)",children:[e.jsx(ms,{})," Cancel"]}):null,e.jsxs("button",{className:"bg-gradient-to-r from-orange-500 to-orange-600 text-white px-4 py-2 rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>Tt(l._id),title:"Archive Appointment",children:[e.jsx(Us,{})," Archive"]})]})})}),e.jsxs("td",{className:"border p-2 text-center relative",children:[e.jsxs("button",{className:"flex items-center justify-center bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-full p-3 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 mx-auto relative group",title:"Open Chat",onClick:mn,children:[e.jsx(Bs,{size:22,className:"group-hover:animate-pulse"}),e.jsx("div",{className:"absolute inset-0 bg-white rounded-full opacity-0 group-hover:opacity-20 transition-opacity duration-200"})]}),_t&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-xs relative flex flex-col items-center",children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-400 hover:text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors",onClick:()=>It(!1),title:"Close",children:e.jsx(ne,{className:"w-4 h-4"})}),e.jsxs("h3",{className:"text-lg font-bold mb-4 text-blue-700 flex items-center gap-2",children:[e.jsx(ms,{})," Admin Password Required"]}),e.jsxs("form",{onSubmit:hn,className:"w-full flex flex-col gap-3",children:[e.jsx("input",{type:"password",className:"border rounded px-3 py-2 w-full focus:ring-2 focus:ring-blue-200",placeholder:"Enter your password",value:st,onChange:t=>Ot(t.target.value),required:!0,autoFocus:!0}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full font-semibold",disabled:Ht,children:Ht?"Verifying...":"Unlock Chat"})]})]})}),E&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-3xl shadow-2xl w-full h-full max-w-6xl max-h-full p-0 relative animate-fadeIn flex flex-col border border-gray-200 transform transition-all duration-500 hover:shadow-3xl",children:[e.jsx("div",{className:"flex items-center gap-2 sm:gap-3 px-4 sm:px-6 py-3 sm:py-4 border-b-2 border-blue-700 bg-gradient-to-r from-blue-700 via-purple-700 to-blue-900 rounded-t-3xl relative shadow-2xl sticky top-[env(safe-area-inset-top,0px)] z-30",children:Zs?e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("label",{className:"flex items-center gap-2 text-white text-sm cursor-pointer hover:text-blue-200 transition-colors",children:[e.jsx("input",{type:"checkbox",checked:Ne.length===b.length&&b.length>0,onChange:()=>{Ne.length===b.length?ye([]):ye([...b])},className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"}),e.jsx("span",{className:"font-medium",children:"Select All Messages"})]}),e.jsxs("span",{className:"text-white text-sm font-medium",children:["(",Ne.length," message",Ne.length!==1?"s":""," selected)"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[Ne.length===1?e.jsx("div",{className:"flex items-center gap-2",children:(()=>{var s,a,n;const t=Ne[0];return t.senderEmail,m.email,e.jsx(e.Fragment,{children:!t.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Ya(t),Qe(!1),ye([])},title:"Reply","aria-label":"Reply",children:e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{oe(t.message),Qe(!1),ye([])},title:"Copy message","aria-label":"Copy message",children:e.jsx(Mt,{size:18})}),e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:async()=>{var o;const r=(o=t.starredBy)==null?void 0:o.includes(m._id);Ns(i=>({...i,starring:!0}));try{const{data:i}=await D.patch(`${I}/api/bookings/${l._id}/comment/${t._id}/star`,{starred:!r},{withCredentials:!0,headers:{"Content-Type":"application/json"}});C(d=>{const N=d.map(S=>S._id===t._id?{...S,starredBy:r?(S.starredBy||[]).filter($=>$!==m._id):[...S.starredBy||[],m._id]}:S);return Z(l._id,N),N}),h.success(r?"Message unstarred.":"Message starred.")}catch{h.error("Failed to update star status")}finally{Ns(i=>({...i,starring:!1}))}Qe(!1),ye([])},title:(s=t.starredBy)!=null&&s.includes(m._id)?"Unstar message":"Star message","aria-label":(a=t.starredBy)!=null&&a.includes(m._id)?"Unstar message":"Star message",disabled:js.starring,children:js.starring?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):(n=t.starredBy)!=null&&n.includes(m._id)?e.jsx(it,{size:18}):e.jsx(zs,{size:18})}),e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{at(t),Ge(!0),Qe(!1),ye([])},title:"Delete","aria-label":"Delete",children:e.jsx(Ve,{size:18})})]})})})()}):Ne.length>1?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:async()=>{var t,s,a;Ns(n=>({...n,starring:!0}));try{let n=0,r=0;const o=[];for(const i of Ne)try{const d=(t=i.starredBy)==null?void 0:t.includes(m._id),N=await D.patch(`${I}/api/bookings/${l._id}/comment/${i._id}/star`,{starred:!d},{withCredentials:!0,headers:{"Content-Type":"application/json"}});n++,C(S=>{const $=S.map(ee=>ee._id===i._id?{...ee,starredBy:d?(ee.starredBy||[]).filter(Oe=>Oe!==m._id):[...ee.starredBy||[],m._id]}:ee);return Z(l._id,$),$}),Te(S=>d?S.filter($=>$._id!==i._id):S.some($=>$._id===i._id)?S:[...S,{...i,starredBy:[...i.starredBy||[],m._id]}])}catch(d){console.error(`Failed to process message ${i._id}:`,d),r++,o.push(i)}n>0&&r===0?h.success(`Successfully updated star status for ${n} messages`):n>0&&r>0?h.warning(`Partially successful: ${n} messages updated, ${r} failed`):h.error("Failed to update any messages. Please try again."),r===0&&(Qe(!1),ye([]))}catch(n){console.error("Error in bulk starring operation:",n),n.response&&(console.error("Response data:",n.response.data),console.error("Response status:",n.response.status)),h.error(((a=(s=n.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to star messages. Please try again.")}finally{Ns(n=>({...n,starring:!1}))}},title:"Star all selected messages","aria-label":"Star all selected messages",disabled:js.starring,children:js.starring?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(it,{size:18})}),e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{const t=Ne.map(s=>s.message).join(`

`);oe(t),h.success("Copied all selected messages"),Qe(!1),ye([])},title:"Copy all selected messages","aria-label":"Copy all selected messages",children:e.jsx(Mt,{size:18})}),e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{at(Ne),Ge(!0),Qe(!1),ye([])},title:"Delete all selected messages","aria-label":"Delete all selected messages",children:e.jsx(Ve,{size:18})})]}):null,e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Qe(!1),ye([])},title:"Exit selection mode","aria-label":"Exit selection mode",children:e.jsx(ne,{className:"w-4 h-4"})})]})]}):Y&&k?e.jsxs("div",{className:"flex items-center justify-end w-full gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[k.deleted?e.jsx(e.Fragment,{children:e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:async()=>{var s;const t=(s=k.starredBy)==null?void 0:s.includes(m._id);vs(!0);try{const{data:a}=await D.patch(`${I}/api/bookings/${l._id}/comment/${k._id}/star`,{starred:!t},{withCredentials:!0,headers:{"Content-Type":"application/json"}});C(n=>{const r=n.map(o=>o._id===k._id?{...o,starredBy:t?(o.starredBy||[]).filter(i=>i!==m._id):[...o.starredBy||[],m._id]}:o);return Z(l._id,r),r}),Te(t?n=>n.filter(r=>r._id!==k._id):n=>[...n,k]),h.success(t?"Message unstarred":"Message starred")}catch{h.error("Failed to update star status")}finally{vs(!1)}A(null)},title:(lr=k.starredBy)!=null&&lr.includes(m._id)?"Unstar message":"Star message","aria-label":(or=k.starredBy)!=null&&or.includes(m._id)?"Unstar message":"Star message",disabled:ws,children:ws?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):(ir=k.starredBy)!=null&&ir.includes(m._id)?e.jsx(it,{size:18}):e.jsx(zs,{size:18})})}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Ya(k),A(null)},title:"Reply","aria-label":"Reply",children:e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{oe(k.message),A(null)},title:"Copy message","aria-label":"Copy message",children:e.jsx(Mt,{size:18})}),e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:async()=>{var s;const t=(s=k.starredBy)==null?void 0:s.includes(m._id);vs(!0);try{const{data:a}=await D.patch(`${I}/api/bookings/${l._id}/comment/${k._id}/star`,{starred:!t},{withCredentials:!0,headers:{"Content-Type":"application/json"}});C(n=>{const r=n.map(o=>o._id===k._id?{...o,starredBy:t?(o.starredBy||[]).filter(i=>i!==m._id):[...o.starredBy||[],m._id]}:o);return Z(l._id,r),r}),Te(t?n=>n.filter(r=>r._id!==k._id):n=>[...n,k]),h.success(t?"Message unstarred":"Message starred")}catch{h.error("Failed to update star status")}finally{vs(!1)}A(null)},title:(dr=k.starredBy)!=null&&dr.includes(m._id)?"Unstar message":"Star message","aria-label":(cr=k.starredBy)!=null&&cr.includes(m._id)?"Unstar message":"Star message",disabled:ws,children:ws?e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}):(mr=k.starredBy)!=null&&mr.includes(m._id)?e.jsx(it,{size:18}):e.jsx(zs,{size:18})})]}),!k.deleted&&e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{O(t=>!t),K||(ie(!1),W(null))},title:"More options","aria-label":"More options",children:e.jsx(pa,{size:14})}),K&&e.jsx("div",{className:"absolute top-full right-0 mt-2 bg-white rounded-lg shadow-lg border border-gray-200 z-20 min-w-[180px] chat-options-menu",children:k.senderEmail===m.email?e.jsxs(e.Fragment,{children:[k.imageUrl&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:()=>{Wa(k.imageUrl,k._id),O(!1),A(null)},children:[e.jsx(Lt,{className:"text-sm"}),"Download Image"]}),k.videoUrl&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:async()=>{try{const t=await fetch(k.videoUrl,{mode:"cors"});if(!t.ok)throw new Error(`HTTP ${t.status}`);const s=await t.blob(),a=window.URL.createObjectURL(s),n=document.createElement("a");n.href=a,n.download=`video-${k._id||Date.now()}.mp4`,document.body.appendChild(n),n.click(),n.remove(),setTimeout(()=>window.URL.revokeObjectURL(a),200),h.success("Video downloaded successfully")}catch(t){console.error("Video download failed:",t);const s=document.createElement("a");s.href=k.videoUrl,s.download=`video-${k._id||Date.now()}.mp4`,s.target="_blank",document.body.appendChild(s),s.click(),s.remove(),h.success("Video download started")}O(!1),A(null)},children:[e.jsx(Lt,{className:"text-sm"}),"Download Video"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",onClick:()=>{Ga(k),O(!1),A(null)},children:[e.jsx(ya,{className:"text-sm"}),"Info"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",onClick:()=>{an(k),O(!1),A(null)},disabled:J!==null,children:[e.jsx(wa,{className:"text-sm"}),"Edit"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",onClick:()=>{Xa(k),O(!1),A(null)},children:[e.jsx(Ve,{className:"text-sm"}),"Delete"]})]}):e.jsxs(e.Fragment,{children:[k.imageUrl&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:()=>{Wa(k.imageUrl,k._id),O(!1),A(null)},children:[e.jsx(Lt,{className:"text-sm"}),"Download Image"]}),k.videoUrl&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:async()=>{try{const t=await fetch(k.videoUrl,{mode:"cors"});if(!t.ok)throw new Error(`HTTP ${t.status}`);const s=await t.blob(),a=window.URL.createObjectURL(s),n=document.createElement("a");n.href=a,n.download=`video-${k._id||Date.now()}.mp4`,document.body.appendChild(n),n.click(),n.remove(),setTimeout(()=>window.URL.revokeObjectURL(a),200),h.success("Video downloaded successfully")}catch(t){console.error("Video download failed:",t);const s=document.createElement("a");s.href=k.videoUrl,s.download=`video-${k._id||Date.now()}.mp4`,s.target="_blank",document.body.appendChild(s),s.click(),s.remove(),h.success("Video download started")}O(!1),A(null)},children:[e.jsx(Lt,{className:"text-sm"}),"Download Video"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",onClick:()=>{Ga(k),O(!1),A(null)},children:[e.jsx(ya,{className:"text-sm"}),"Info"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",onClick:()=>{Xa(k),O(!1),A(null)},children:[e.jsx(Ve,{className:"text-sm"}),"Delete"]})]})})]})]}),e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>{A(null),O(!1)},title:"Close options","aria-label":"Close options",children:e.jsx(ne,{className:"w-4 h-4"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-full p-1.5 shadow-lg",children:e.jsx(Bs,{className:"text-blue-600 text-lg"})}),e.jsx("h3",{className:"text-lg font-bold text-white",children:"Live Chat"}),e.jsxs("div",{className:"flex items-center gap-3 ml-auto",children:[e.jsx("div",{className:"relative search-container",children:e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-all duration-300 transform hover:scale-110 shadow",onClick:()=>{Cs(!0),ie(!1),W(null)},title:"Search messages","aria-label":"Search messages",children:e.jsx(Na,{className:"text-sm"})})}),e.jsxs("div",{className:"relative flex items-center gap-2",children:[xs&&e.jsx("div",{className:"text-white bg-white/10 rounded-full p-2 shadow",children:e.jsx(Sr,{className:"text-sm animate-spin"})}),e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors shadow",onClick:()=>{Me(!At),At||(ie(!1),W(null))},title:"Chat options","aria-label":"Chat options",children:e.jsx(pa,{className:"text-sm"})}),At&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-white rounded-lg shadow-lg border border-gray-200 z-20 min-w-[180px] chat-options-menu",children:[e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",onClick:()=>{un(),Me(!1)},children:[e.jsx(wr,{className:"text-sm"}),"Refresh Messages"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-yellow-600 hover:bg-yellow-50 flex items-center gap-2",onClick:()=>{ys(!0),Me(!1),ie(!1),W(null)},children:[e.jsx(it,{className:"text-sm"}),"Starred Messages"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:()=>{Qe(!0),ye([]),Me(!1),ie(!1),W(null)},children:[e.jsx(Cn,{className:"text-sm"}),"Select Messages"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",onClick:()=>{U(!w),Me(!1),ie(!1),W(null)},children:[e.jsx(kn,{className:"text-sm"}),"Tips & Guidelines"]}),b.length>0&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-green-600 hover:bg-green-50 flex items-center gap-2",onClick:()=>{Me(!1),qs(l,b)},children:[e.jsx(Lt,{className:"text-sm"}),"Export Chat Transcript (PDF)"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",onClick:()=>{var t;le((t=l.buyerId)==null?void 0:t._id),Me(!1)},children:[e.jsx(Ca,{className:"text-sm"}),"View Buyer Details"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",onClick:()=>{var t;le((t=l.sellerId)==null?void 0:t._id),Me(!1)},children:[e.jsx(Ca,{className:"text-sm"}),"View Seller Details"]}),e.jsx("div",{className:"border-t border-gray-200 my-1"}),b.length>0&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",onClick:()=>{De(!0),Me(!1),ie(!1),W(null)},children:[e.jsx(Ve,{className:"text-sm"}),"Delete Entire Chat"]})]})]}),w&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 shadow-lg z-20 max-w-xs animate-fadeIn",children:[e.jsx("div",{className:"font-semibold mb-2",children:"âŒ¨ï¸ Keyboard Shortcuts:"}),e.jsx("div",{className:"mb-2",children:"â€¢ Press Ctrl + F to quickly focus and type your message"}),e.jsxs("div",{className:"border-t border-gray-600 pt-2 mt-2",children:[e.jsx("div",{className:"font-semibold mb-2",children:"ðŸ“Ž File Upload Guidelines:"}),e.jsx("div",{children:"â€¢ Photos: JPG, PNG, GIF, WebP (â‰¤ 5MB)"}),e.jsx("div",{children:"â€¢ Videos: MP4, WebM, MOV, MKV, OGG (â‰¤ 5MB)"}),e.jsx("div",{children:"â€¢ Documents: PDF, DOCX, XLSX, TXT and more (â‰¤ 5MB)"}),e.jsx("div",{children:"â€¢ Add captions to images"})]}),e.jsxs("div",{className:"border-t border-gray-600 pt-2 mt-2",children:[e.jsx("div",{className:"font-semibold mb-2",children:"ðŸ’¬ Chat Features:"}),e.jsx("div",{children:"â€¢ Real-time messaging with socket.io"}),e.jsx("div",{children:"â€¢ Message reactions and emoji support"}),e.jsx("div",{children:"â€¢ File sharing and image previews"}),e.jsx("div",{children:"â€¢ Chat locking for dispute resolution"})]}),e.jsxs("div",{className:"border-t border-gray-600 pt-2 mt-2",children:[e.jsx("div",{className:"font-semibold mb-2",children:"ðŸ”’ Security & Moderation:"}),e.jsx("div",{children:"â€¢ Report inappropriate content"}),e.jsx("div",{children:"â€¢ Report chat"}),e.jsx("div",{children:"â€¢ Content filtering and moderation"}),e.jsx("div",{children:"â€¢ User blocking capabilities"})]}),e.jsxs("div",{className:"border-t border-gray-600 pt-2 mt-2",children:[e.jsx("div",{className:"font-semibold mb-2",children:"ðŸ‘¨â€ðŸ’¼ Admin Controls:"}),e.jsx("div",{children:"â€¢ Full chat moderation access"}),e.jsx("div",{children:"â€¢ User management and blocking"}),e.jsx("div",{children:"â€¢ Content removal and warnings"}),e.jsx("div",{children:"â€¢ Dispute resolution tools"})]}),e.jsx("div",{className:"absolute -top-1 right-4 w-2 h-2 bg-gray-800 transform rotate-45"})]}),u>0&&!Re&&e.jsx("button",{className:"text-blue-500 hover:text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-full p-2 transition-colors shadow animate-bounce",onClick:Va,title:"Scroll to latest messages","aria-label":"Scroll to latest messages",children:e.jsx(Bs,{className:"text-sm"})}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>{xt(!1),ie(!1),W(null)},title:"Close","aria-label":"Close",children:e.jsx(ne,{className:"w-4 h-4"})})]})]})}),Qs&&e.jsx("div",{className:"enhanced-search-header bg-gradient-to-r from-blue-600 via-purple-600 to-blue-800 px-3 sm:px-4 py-3 border-b-2 border-blue-700 flex-shrink-0 animate-slideDown",children:e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 flex-nowrap",children:[e.jsxs("div",{className:"relative calendar-container",children:[e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-all duration-300 transform hover:scale-110 shadow",onClick:t=>{t.stopPropagation(),Qt(!Ss)},title:"Jump to date","aria-label":"Jump to date",children:e.jsx(Sn,{className:"text-sm"})}),Ss&&e.jsxs("div",{className:"absolute top-full left-0 mt-2 bg-white rounded-lg shadow-xl border border-gray-200 p-3 min-w-[250px] animate-fadeIn",style:{zIndex:9999},children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Jump to Date"}),e.jsx("button",{onClick:t=>{t.stopPropagation(),Qt(!1)},className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(ne,{size:14})})]}),e.jsx("input",{type:"date",value:Ar,onChange:t=>{t.stopPropagation(),on(t.target.value)},className:"w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all",max:dn(new Date)}),e.jsx("div",{className:"text-xs text-gray-500 mt-2",children:"Select a date to jump to the first message from that day"})]})]}),e.jsxs("div",{className:"flex-1 flex items-center gap-2 bg-white/20 rounded-full px-3 sm:px-4 py-2 backdrop-blur-sm min-w-0 overflow-hidden",children:[e.jsx(Na,{className:"text-white/70 text-sm"}),e.jsx("input",{type:"text",placeholder:"Search messages...",value:Xs,onChange:nn,onKeyDown:ln,className:"bg-transparent text-white placeholder-white/70 text-sm outline-none flex-1 min-w-0 w-full",autoFocus:!0}),Xe.length>0&&e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 flex-shrink-0",children:[e.jsxs("span",{className:"text-white/80 text-xs bg-white/10 px-2 py-1 rounded-full",children:[Zt+1,"/",Xe.length]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>et(t=>t>0?t-1:Xe.length-1),className:"text-white/80 hover:text-white p-1 rounded transition-colors text-xs",title:"Previous result",children:"â†‘"}),e.jsx("button",{onClick:()=>et(t=>t<Xe.length-1?t+1:0),className:"text-white/80 hover:text-white p-1 rounded transition-colors text-xs",title:"Next result",children:"â†“"})]})]})]}),e.jsx("button",{onClick:()=>{Cs(!1),ks(""),Kt([]),et(-1),Qt(!1),document.querySelectorAll(".search-text-highlight").forEach(t=>{t.outerHTML=t.innerHTML})},className:"flex-shrink-0 text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-all duration-300 transform hover:scale-110 shadow",title:"Close search","aria-label":"Close search",children:e.jsx(ne,{className:"text-sm"})})]})}),e.jsxs("div",{ref:we,className:`flex-1 overflow-y-auto space-y-2 px-4 pt-4 animate-fadeInChat relative bg-gradient-to-b from-transparent to-blue-50/30 ${kt?"bg-blue-50/50 border-2 border-dashed border-blue-300":""}`,style:{minHeight:"400px",maxHeight:"calc(100vh - 200px)"},onDragOver:t=>{t.preventDefault(),t.stopPropagation(),Ye(!0)},onDragEnter:t=>{t.preventDefault(),t.stopPropagation(),Ye(!0)},onDragLeave:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.contains(t.relatedTarget)||Ye(!1)},onDrop:t=>{t.preventDefault(),t.stopPropagation(),Ye(!1);const s=Array.from(t.dataTransfer.files),a=s.filter(n=>n.type.startsWith("image/"));a.length>0?qa(a):s.length>0&&h.error("Only image files are supported")},children:[e.jsx("div",{className:"px-4 py-3 bg-gradient-to-r from-blue-50 to-purple-50 border-l-4 border-blue-400 rounded-r-lg mb-4 transform transition-all duration-500 hover:scale-105 hover:shadow-lg hover:from-blue-100 hover:to-purple-100 hover:border-blue-500 hover:border-l-6 backdrop-blur-sm",children:e.jsxs("p",{className:"text-sm text-blue-700 font-medium text-center flex items-center justify-center gap-2",children:[e.jsx("span",{className:"animate-gentlePulse",children:"ðŸ”’"}),"Chats are encrypted and secure. View only for valid purposes like disputes or fraud checks. Unauthorized access or sharing is prohibited and will be logged."]})}),X&&b.length>0&&e.jsx("div",{className:`sticky top-0 left-0 right-0 z-30 pointer-events-none transition-all duration-300 ease-in-out ${$e?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"w-full flex justify-center py-2",children:e.jsx("div",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:X})})}),b.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx(Bs,{className:"text-gray-300 text-4xl mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"No messages yet"}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"Start a conversation to communicate with the parties"})]}):b.slice(Math.max(0,b.length-z)).map((t,s,a)=>{var S,$,ee,Oe,Et,re,ds,G,br,pr,yr;const n=b.length-a.length+s,r=t.senderEmail===m.email,o=J===t._id,i=new Date(t.timestamp),d=n>0?new Date(b[n-1].timestamp):null,N=d?i.toDateString()!==d.toDateString():!0;return e.jsxs(y.Fragment,{children:[N&&e.jsx("div",{className:"w-full flex justify-center my-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:ja(i)})}),u>0&&n===b.length-u&&e.jsxs("div",{className:"w-full flex items-center my-2",children:[e.jsx("div",{className:"flex-1 h-px bg-gray-300"}),e.jsx("span",{className:"mx-2 text-xs font-semibold text-red-600 bg-red-50 px-2 py-1 rounded-full border border-red-200",children:"New messages"}),e.jsx("div",{className:"flex-1 h-px bg-gray-300"})]}),e.jsxs("div",{className:`flex w-full ${r?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*n}s`},children:[Zs&&e.jsx("div",{className:`flex items-start ${r?"order-2 ml-2":"order-1 mr-2"}`,children:e.jsx("input",{type:"checkbox",checked:Ne.some(f=>f._id===t._id),onChange:f=>{f.target.checked?ye(v=>[...v,t]):ye(v=>v.filter(L=>L._id!==t._id))},className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"})}),e.jsxs("div",{ref:f=>ve.current[t._id]=f,"data-message-id":t._id,className:`relative rounded-2xl px-4 sm:px-5 py-3 text-sm shadow-xl max-w-[90%] sm:max-w-[80%] md:max-w-[70%] lg:max-w-[60%] xl:max-w-[50%] break-words overflow-visible transition-all duration-300 min-h-[60px] ${r?"bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-500 hover:to-purple-600 text-white shadow-blue-200 hover:shadow-blue-300 hover:shadow-2xl":"bg-white hover:bg-gray-100 text-gray-800 border border-gray-200 shadow-gray-200 hover:shadow-lg hover:border-gray-300 hover:shadow-xl"} ${Zs&&Ne.some(f=>f._id===t._id)?"ring-2 ring-blue-400":""}`,children:[t.replyTo&&e.jsx("div",{className:"border-l-4 border-purple-400 pl-3 mb-2 text-xs bg-gradient-to-r from-purple-50 to-blue-50 hover:from-purple-100 hover:to-blue-100 rounded-lg w-full max-w-full break-words cursor-pointer transition-all duration-200 hover:shadow-sm",onClick:()=>{ve.current[t.replyTo]&&(ve.current[t.replyTo].scrollIntoView({behavior:"smooth",block:"center"}),ve.current[t.replyTo].classList.add("reply-highlight"),setTimeout(()=>{var f;(f=ve.current[t.replyTo])==null||f.classList.remove("reply-highlight")},1600))},role:"button",tabIndex:0,"aria-label":"Go to replied message",children:e.jsxs("span",{className:"text-xs text-gray-700 font-medium truncate max-w-[150px] flex items-center gap-1",children:[e.jsx("span",{className:"text-purple-500",children:"â†©"}),(($=(S=b.find(f=>f._id===t.replyTo))==null?void 0:S.message)==null?void 0:$.substring(0,30))||"Original message",((Oe=(ee=b.find(f=>f._id===t.replyTo))==null?void 0:ee.message)==null?void 0:Oe.length)>30?"...":""]})}),e.jsx("div",{className:"font-semibold mb-2 flex items-center gap-2 justify-start text-left",children:e.jsx("span",{className:`truncate max-w-[120px] min-w-[60px] inline-block align-middle overflow-hidden text-ellipsis text-left ${r?"text-blue-100":"text-gray-700"}`,children:r?"You":(()=>{var L,q,H,vt;const f=t.senderEmail===((L=l.buyerId)==null?void 0:L.email),v=t.senderEmail===((q=l.sellerId)==null?void 0:q.email);return f?((H=l.buyerId)==null?void 0:H.username)||t.senderName||t.senderEmail:v?((vt=l.sellerId)==null?void 0:vt.username)||t.senderName||t.senderEmail:t.senderName||t.senderEmail})()})}),e.jsx("div",{className:`text-left ${r?"text-base font-medium":"text-sm"}`,children:t.deleted?(()=>{const f=p.includes(t._id);return m&&(m.role==="admin"||m.role==="rootadmin")?f?e.jsx("div",{className:"border border-gray-300 bg-gray-100 rounded p-2 mb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-600 text-xs",children:[e.jsx(Ft,{className:"inline-block"}),e.jsx("span",{children:"Deleted message hidden from view"})]}),e.jsx("button",{className:"text-xs text-blue-500 hover:text-blue-700 underline",onClick:()=>bn(t._id),title:"Show this deleted message content",children:"Show"})]})}):e.jsxs("div",{className:"border border-red-300 bg-red-50 rounded p-2 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-xs font-semibold mb-1",children:[e.jsx(Ft,{className:"inline-block"}),"Message deleted by ",t.deletedBy||"user"," (Admin view - preserved for records)"]}),(t.originalImageUrl||t.imageUrl)&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:t.originalImageUrl||t.imageUrl,alt:"Preserved image from deleted message",className:"max-w-full max-h-64 rounded-lg cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>{const v=(b||[]).filter(H=>!!(H.originalImageUrl||H.imageUrl)).map(H=>H.originalImageUrl||H.imageUrl),L=t.originalImageUrl||t.imageUrl,q=Math.max(0,v.indexOf(L));ea(v),Le(q),_s(!0)},onError:v=>{v.target.src="https://via.placeholder.com/300x200?text=Image+Not+Found",v.target.className="max-w-full max-h-64 rounded-lg opacity-50"}})}),k.audioUrl&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2",onClick:async()=>{try{const v=await fetch(k.audioUrl,{mode:"cors"});if(!v.ok)throw new Error(`HTTP ${v.status}`);const L=await v.blob(),q=window.URL.createObjectURL(L),H=document.createElement("a");H.href=q,H.download=k.audioName||`audio-${k._id||Date.now()}`,document.body.appendChild(H),H.click(),H.remove(),setTimeout(()=>window.URL.revokeObjectURL(q),200),h.success("Audio downloaded successfully")}catch{const L=document.createElement("a");L.href=k.audioUrl,L.download=k.audioName||`audio-${k._id||Date.now()}`,L.target="_blank",document.body.appendChild(L),L.click(),L.remove(),h.success("Audio download started")}O(!1),A(null)},children:[e.jsx(Lt,{className:"text-sm"}),"Download Audio"]}),e.jsx("div",{className:"text-gray-800 bg-white p-2 rounded border-l-4 border-red-400 relative group",children:(()=>{const v=t.originalMessage||t.message;return v?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"whitespace-pre-wrap break-words",children:v}),e.jsx("button",{className:"absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 text-gray-500 hover:text-gray-700 bg-white rounded p-1 shadow-sm",onClick:()=>oe(v),title:"Copy deleted message content","aria-label":"Copy deleted message content",children:e.jsx(Mt,{className:"text-xs"})})]}):e.jsx("span",{className:"text-gray-500 italic",children:"[Message content not preserved - this message was deleted before content preservation was implemented]"})})()}),e.jsx("button",{className:"mt-2 text-xs text-red-500 hover:text-red-700 underline",onClick:()=>fn(t._id),title:"Hide this deleted message from your admin view",children:"Hide from admin view"})]}):e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(Ft,{className:"inline-block text-lg"})," This message has been deleted."]})})():e.jsxs("div",{children:[o?e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-400 px-2 py-1 rounded",children:e.jsx("span",{className:"text-yellow-800 text-xs font-medium",children:"âœï¸ Editing this message below..."})}):e.jsxs(e.Fragment,{children:[(t.originalImageUrl||t.imageUrl)&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:t.originalImageUrl||t.imageUrl,alt:"Shared image",className:"max-w-full max-h-64 rounded-lg cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>{const f=(b||[]).filter(q=>!!(q.originalImageUrl||q.imageUrl)).map(q=>q.originalImageUrl||q.imageUrl),v=t.originalImageUrl||t.imageUrl,L=Math.max(0,f.indexOf(v));ea(f),Le(L),_s(!0)},onError:f=>{f.target.src="https://via.placeholder.com/300x200?text=Image+Not+Found",f.target.className="max-w-full max-h-64 rounded-lg opacity-50"}})}),t.videoUrl&&e.jsxs("div",{className:"mb-2",children:[e.jsx("video",{src:t.videoUrl,className:"max-w-full max-h-64 rounded-lg border cursor-pointer hover:opacity-90 transition-opacity",controls:!0,onClick:f=>{f.preventDefault(),f.stopPropagation(),f.target.requestFullscreen?f.target.requestFullscreen():f.target.webkitRequestFullscreen?f.target.webkitRequestFullscreen():f.target.msRequestFullscreen&&f.target.msRequestFullscreen()}}),e.jsx("div",{className:`mt-1 text-xs ${r?"text-blue-100":"text-gray-500"}`,children:e.jsx("button",{className:`${r?"text-white hover:text-blue-100":"text-blue-600 hover:underline"}`,onClick:f=>{f.stopPropagation();const v=document.createElement("a");v.href=t.videoUrl,v.download=`video-${t._id||Date.now()}`,v.target="_blank",document.body.appendChild(v),v.click(),v.remove(),h.success("Video download started")},children:"Download"})})]}),t.audioUrl&&e.jsxs("div",{className:"mb-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("audio",{src:t.audioUrl,className:"w-full",controls:!0,onClick:f=>f.stopPropagation()}),e.jsx("div",{className:"absolute top-2 right-2 flex gap-2",children:e.jsx("button",{className:"p-2 bg-white rounded-full shadow hover:bg-gray-100",onClick:f=>{f.stopPropagation();const v=document.createElement("a");v.href=t.audioUrl,v.download=t.audioName||`audio-${t._id||Date.now()}`,v.target="_blank",document.body.appendChild(v),v.click(),document.body.removeChild(v),h.success("Audio download started")},title:"Download audio",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"})})})})]}),t.message&&e.jsx("div",{className:"mt-2 text-sm text-gray-700 whitespace-pre-wrap break-words",children:t.message})]}),t.documentUrl&&e.jsx("div",{className:"mb-2",children:e.jsxs("button",{className:"flex items-center gap-2 px-3 py-2 rounded-lg border hover:bg-gray-50",onClick:async f=>{f.stopPropagation();try{const v=await fetch(t.documentUrl,{mode:"cors"});if(!v.ok)throw new Error(`HTTP ${v.status}`);const L=await v.blob(),q=window.URL.createObjectURL(L),H=document.createElement("a");H.href=q,H.download=t.documentName||`document-${t._id||Date.now()}`,document.body.appendChild(H),H.click(),H.remove(),setTimeout(()=>window.URL.revokeObjectURL(q),200),h.success("Document downloaded successfully")}catch(v){console.error("Download failed:",v);const L=document.createElement("a");L.href=t.documentUrl,L.download=t.documentName||`document-${t._id||Date.now()}`,L.target="_blank",document.body.appendChild(L),L.click(),L.remove(),h.success("Document download started")}},children:[e.jsx("span",{className:"text-2xl",children:"ðŸ“„"}),e.jsx("span",{className:`text-sm truncate max-w-[200px] ${r?"text-white":"text-blue-700"}`,children:t.documentName||"Document"})]})}),(()=>{if(t.previewDismissed)return null;const f=/(https?:\/\/[^\s]+|www\.[^\s]+\.[^\s]{2,}(?:\/[^\s]*)?|[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/gi,v=(t.message||"").match(f);return v&&v.length>0?e.jsx("div",{className:"mb-2 max-h-40 overflow-hidden",children:e.jsx(Nr,{url:v[0],className:"max-w-xs",showRemoveButton:!1,clickable:!0})}):null})(),e.jsx(jr,{text:(t.message||"").replace(/\n+$/,""),isSentMessage:r,className:"whitespace-pre-wrap break-words",searchQuery:Xs}),t.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300 whitespace-nowrap",children:"(Edited)"})]}),!t.deleted&&t.reactions&&t.reactions.length>0&&e.jsx("div",{className:"flex items-center gap-1 mt-2",children:(()=>{const f={};return t.reactions.forEach(v=>{f[v.emoji]||(f[v.emoji]=[]),f[v.emoji].push(v)}),Object.entries(f).map(([v,L])=>{const q=L.some(vt=>vt.userId===m._id),H=L.map(vt=>vt.userName).join(", ");return e.jsxs("button",{onClick:()=>be(t._id,v),className:`text-xs rounded-full px-2 py-1 flex items-center gap-1 transition-all duration-200 hover:scale-105 ${q?"bg-blue-100 border border-blue-300 hover:bg-blue-200":"bg-gray-100 hover:bg-gray-200"}`,title:`${H} reacted with ${v}${q?" (Click to remove)":" (Click to add)"}`,children:[e.jsx("span",{children:v}),e.jsx("span",{className:`${q?"text-blue-600":"text-gray-600"}`,children:L.length})]},v)})})()})]})}),e.jsxs("div",{className:"flex items-center gap-1 justify-end mt-2","data-message-actions":!0,children:[t.starredBy&&t.starredBy.includes(m._id)&&e.jsx(it,{className:`${r?"text-yellow-300":"text-yellow-500"} text-[10px]`}),e.jsx("span",{className:`${r?"text-blue-200":"text-gray-500"} text-[10px]`,children:new Date(t.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})}),e.jsx("button",{className:`${t.senderEmail===m.email?"text-blue-200 hover:text-white":"text-gray-500 hover:text-gray-700"} transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-white hover:bg-opacity-20 ml-1`,onClick:f=>{f.stopPropagation(),A(t._id),Ws(t._id)},title:"Message options","aria-label":"Message options",children:e.jsx(pa,{size:12})}),(()=>{if(!(!t.deleted&&qe&&Je===t._id))return!1;const v=document.querySelector(`[data-message-id="${t._id}"]`);if(v){const L=v.getBoundingClientRect(),q=we.current;if(q){const H=q.getBoundingClientRect();if(L.top-H.top<120&&H.bottom-L.bottom>=60+20)return!1}}return!0})()&&e.jsxs("div",{className:`absolute -top-8 ${r?"right-0":"left-0"} bg-red-500 rounded-full shadow-lg border-2 border-red-600 p-1 flex items-center gap-1 animate-reactions-bar z-[999999] reactions-bar transition-all duration-300`,style:{minWidth:"max-content"},children:[e.jsx("button",{onClick:()=>be(t._id,"ðŸ‘"),className:`w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform rounded-full ${(Et=t.reactions)!=null&&Et.some(f=>f.emoji==="ðŸ‘"&&f.userId===m._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100"}`,title:"Like",children:"ðŸ‘"}),e.jsx("button",{onClick:()=>be(t._id,"â¤ï¸"),className:`w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform rounded-full ${(re=t.reactions)!=null&&re.some(f=>f.emoji==="â¤ï¸"&&f.userId===m._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100"}`,title:"Love",children:"â¤ï¸"}),e.jsx("button",{onClick:()=>be(t._id,"ðŸ˜‚"),className:`w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform rounded-full ${(ds=t.reactions)!=null&&ds.some(f=>f.emoji==="ðŸ˜‚"&&f.userId===m._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100"}`,title:"Laugh",children:"ðŸ˜‚"}),e.jsx("button",{onClick:()=>be(t._id,"ðŸ˜®"),className:`w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform rounded-full ${(G=t.reactions)!=null&&G.some(f=>f.emoji==="ðŸ˜®"&&f.userId===m._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100"}`,title:"Wow",children:"ðŸ˜®"}),e.jsx("button",{onClick:()=>be(t._id,"ðŸ˜¢"),className:`w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform rounded-full ${(br=t.reactions)!=null&&br.some(f=>f.emoji==="ðŸ˜¢"&&f.userId===m._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100"}`,title:"Sad",children:"ðŸ˜¢"}),e.jsx("button",{onClick:()=>be(t._id,"ðŸ˜¡"),className:`w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform rounded-full ${(pr=t.reactions)!=null&&pr.some(f=>f.emoji==="ðŸ˜¡"&&f.userId===m._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100"}`,title:"Angry",children:"ðŸ˜¡"}),e.jsx("div",{className:"w-px h-6 bg-gray-300 mx-1"}),e.jsx("button",{onClick:Se,className:"w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform bg-gray-50 hover:bg-gray-100 rounded-full",title:"More emojis",children:"âž•"})]}),t.senderEmail===m.email&&!t.deleted&&e.jsx("span",{className:"ml-1 flex items-center gap-1",children:(yr=t.readBy)!=null&&yr.some(f=>f!==m._id)?e.jsx(va,{className:"text-green-400 text-xs transition-all duration-300 animate-fadeIn",title:"Read"}):t.status==="delivered"?e.jsx(va,{className:"text-blue-200 text-xs transition-all duration-300 animate-fadeIn",title:"Delivered"}):t.status==="sending"?e.jsx(va,{className:"text-blue-200 text-xs animate-pulse transition-all duration-300",title:"Sending..."}):e.jsx(vr,{className:"text-blue-200 text-xs transition-all duration-300 animate-fadeIn",title:"Sent"})})]})]})]})]},t._id||n)}),e.jsx("div",{ref:he})]}),(()=>{var i,d,N,S,$,ee;if(!(qe&&Je))return null;const s=document.querySelector(`[data-message-id="${Je}"]`);if(!s)return null;const a=s.getBoundingClientRect(),n=we.current;if(!n)return null;const r=n.getBoundingClientRect();if(a.top-r.top<120&&r.bottom-a.bottom>=60+20){const re=b.find(G=>G._id===Je);if(!re||re.deleted)return null;const ds=re.senderEmail===m.email;return e.jsxs("div",{className:"fixed bg-red-500 rounded-full shadow-lg border-2 border-red-600 p-1 flex items-center gap-1 animate-reactions-bar z-[999999] reactions-bar transition-all duration-300",style:{minWidth:"max-content",top:`${a.bottom+2}px`,left:ds?"auto":`${a.left}px`,right:ds?`${window.innerWidth-a.right}px`:"auto"},children:[e.jsx("button",{onClick:()=>be(re._id,"ðŸ‘"),className:`w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform rounded-full ${(i=re.reactions)!=null&&i.some(G=>G.emoji==="ðŸ‘"&&G.userId===m._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100"}`,title:"Like",children:"ðŸ‘"}),e.jsx("button",{onClick:()=>be(re._id,"â¤ï¸"),className:`w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform rounded-full ${(d=re.reactions)!=null&&d.some(G=>G.emoji==="â¤ï¸"&&G.userId===m._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100"}`,title:"Love",children:"â¤ï¸"}),e.jsx("button",{onClick:()=>be(re._id,"ðŸ˜‚"),className:`w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform rounded-full ${(N=re.reactions)!=null&&N.some(G=>G.emoji==="ðŸ˜‚"&&G.userId===m._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100"}`,title:"Laugh",children:"ðŸ˜‚"}),e.jsx("button",{onClick:()=>be(re._id,"ðŸ˜®"),className:`w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform rounded-full ${(S=re.reactions)!=null&&S.some(G=>G.emoji==="ðŸ˜®"&&G.userId===m._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100"}`,title:"Wow",children:"ðŸ˜®"}),e.jsx("button",{onClick:()=>be(re._id,"ðŸ˜¢"),className:`w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform rounded-full ${($=re.reactions)!=null&&$.some(G=>G.emoji==="ðŸ˜¢"&&G.userId===m._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100"}`,title:"Sad",children:"ðŸ˜¢"}),e.jsx("button",{onClick:()=>be(re._id,"ðŸ˜¡"),className:`w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform rounded-full ${(ee=re.reactions)!=null&&ee.some(G=>G.emoji==="ðŸ˜¡"&&G.userId===m._id)?"bg-blue-100 border-2 border-blue-400":"bg-gray-50 hover:bg-gray-100"}`,title:"Angry",children:"ðŸ˜¡"}),e.jsx("div",{className:"w-px h-6 bg-gray-300 mx-1"}),e.jsx("button",{onClick:Se,className:"w-8 h-8 flex items-center justify-center text-lg hover:scale-110 transition-transform bg-gray-50 hover:bg-gray-100 rounded-full",title:"More emojis",children:"âž•"})]})}return null})(),ct&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center z-[999999] animate-fadeIn",onMouseDown:t=>{t.target===t.currentTarget&&me(!1)},onClick:t=>{t.target===t.currentTarget&&me(!1)},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl border border-gray-200 p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-hidden quick-reactions-modal",onMouseDown:t=>{t.stopPropagation()},onClick:t=>{t.stopPropagation()},children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-800",children:"Quick Reactions"}),e.jsx("button",{onMouseDown:t=>{t.stopPropagation(),t.preventDefault()},onClick:t=>{t.stopPropagation(),me(!1)},className:"text-gray-500 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors",title:"Close",children:e.jsx(ne,{size:16})})]}),e.jsx("div",{className:"overflow-y-auto max-h-[60vh] scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",onMouseDown:t=>{t.stopPropagation()},onClick:t=>{t.stopPropagation()},children:e.jsx("div",{className:"grid grid-cols-10 gap-2",onMouseDown:t=>{t.stopPropagation()},onClick:t=>{t.stopPropagation()},children:["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜‡","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜Œ","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ˜—","ðŸ˜™","ðŸ˜š","ðŸ˜‹","ðŸ˜›","ðŸ˜","ðŸ˜œ","ðŸ¤ª","ðŸ¤¨","ðŸ§","ðŸ¤“","ðŸ˜Ž","ðŸ¤©","ðŸ¥³","ðŸ˜","ðŸ˜’","ðŸ˜ž","ðŸ˜”","ðŸ˜Ÿ","ðŸ˜•","ðŸ™","â˜¹ï¸","ðŸ˜£","ðŸ˜–","ðŸ˜«","ðŸ˜©","ðŸ¥º","ðŸ˜¢","ðŸ˜­","ðŸ˜¤","ðŸ˜ ","ðŸ˜¡","ðŸ¤¬","ðŸ¤¯","ðŸ˜³","ðŸ¥µ","ðŸ¥¶","ðŸ˜±","ðŸ˜¨","ðŸ˜°","ðŸ˜¥","ðŸ˜“","ðŸ¤—","ðŸ¤”","ðŸ¤­","ðŸ¤«","ðŸ¤¥","ðŸ˜¶","ðŸ˜","ðŸ˜‘","ðŸ˜¯","ðŸ˜¦","ðŸ˜§","ðŸ˜®","ðŸ˜²","ðŸ¥±","ðŸ˜´","ðŸ¤¤","ðŸ˜ª","ðŸ˜µ","ðŸ¤","ðŸ¥´","ðŸ¤¢","ðŸ¤®","ðŸ¤§","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤‘","ðŸ¤ ","ðŸ’€","ðŸ‘»","ðŸ‘½","ðŸ‘¾","ðŸ¤–","ðŸ˜ˆ","ðŸ‘¿","ðŸ‘¹","ðŸ‘º","ðŸ’ª","ðŸ¦¾","ðŸ¦¿","ðŸ¦µ","ðŸ¦¶","ðŸ‘‚","ðŸ¦»","ðŸ‘ƒ","ðŸ§ ","ðŸ«€","ðŸ«","ðŸ¦·","ðŸ¦´","ðŸ‘€","ðŸ‘ï¸","ðŸ‘…","ðŸ‘„","ðŸ’‹","ðŸ©¸","ðŸ«‚","ðŸ‘¶","ðŸ‘§","ðŸ§’","ðŸ‘¦","ðŸ‘©","ðŸ§‘","ðŸ‘¨","ðŸ‘µ","ðŸ§“","ðŸ‘´","ðŸ‘®â€â™€ï¸","ðŸ‘®","ðŸ‘®â€â™‚ï¸","ðŸ•µï¸â€â™€ï¸","ðŸ•µï¸","ðŸ•µï¸â€â™‚ï¸","ðŸ‘·â€â™€ï¸","ðŸ‘·","ðŸ‘·â€â™‚ï¸","ðŸ«…","ðŸ¤´","ðŸ‘¸","ðŸ‘³â€â™€ï¸","ðŸ‘³","ðŸ‘³â€â™‚ï¸","ðŸ‘²","ðŸ§•","ðŸ¤µâ€â™€ï¸","ðŸ¤µ","ðŸ¤µâ€â™‚ï¸","ðŸ‘°â€â™€ï¸","ðŸ‘°","ðŸ‘°â€â™‚ï¸","ðŸ¤°","ðŸ¤±","ðŸ‘¼","ðŸŽ…","ðŸ¤¶","ðŸ¦¸â€â™€ï¸","ðŸ¦¸","ðŸ¦¸â€â™‚ï¸","ðŸ¦¹â€â™€ï¸","ðŸ¦¹","ðŸ¦¹â€â™‚ï¸","ðŸ§™â€â™€ï¸","ðŸ§™","ðŸ§™â€â™‚ï¸","ðŸ§šâ€â™€ï¸","ðŸ§š","ðŸ§šâ€â™‚ï¸","ðŸ§›â€â™€ï¸","ðŸ§›","ðŸ§›â€â™‚ï¸","ðŸ§œâ€â™€ï¸","ðŸ§œ","ðŸ§œâ€â™‚ï¸","ðŸ§â€â™€ï¸","ðŸ§","ðŸ§â€â™‚ï¸","ðŸ§žâ€â™€ï¸","ðŸ§ž","ðŸ§žâ€â™‚ï¸","ðŸ§Ÿâ€â™€ï¸","ðŸ§Ÿ","ðŸ§Ÿâ€â™‚ï¸","ðŸ§Œ","ðŸ¶","ðŸ±","ðŸ­","ðŸ¹","ðŸ°","ðŸ¦Š","ðŸ»","ðŸ¼","ðŸ»â€â„ï¸","ðŸ¨","ðŸ¯","ðŸ¦","ðŸ®","ðŸ·","ðŸ¸","ðŸµ","ðŸ™ˆ","ðŸ™‰","ðŸ™Š","ðŸ’","ðŸ”","ðŸ§","ðŸ¦","ðŸ¤","ðŸ£","ðŸ¦†","ðŸ¦…","ðŸ¦‰","ðŸ¦‡","ðŸº","ðŸ—","ðŸ´","ðŸ¦„","ðŸ","ðŸ›","ðŸ¦‹","ðŸŒ","ðŸž","ðŸœ","ðŸ¦Ÿ","ðŸ¦—","ðŸ•·ï¸","ðŸ•¸ï¸","ðŸ¦‚","ðŸ¢","ðŸ","ðŸ¦Ž","ðŸ¦–","ðŸ¦•","ðŸ™","ðŸ¦‘","ðŸ¦","ðŸ¦ž","ðŸ¦€","ðŸ¡","ðŸ ","ðŸŸ","ðŸ¬","ðŸ³","ðŸ‹","ðŸ¦ˆ","ðŸŠ","ðŸ…","ðŸ†","ðŸ¦“","ðŸ¦","ðŸ¦§","ðŸ˜","ðŸ¦›","ðŸ¦","ðŸª","ðŸ«","ðŸ¦™","ðŸ¦’","ðŸƒ","ðŸ‚","ðŸ„","ðŸŽ","ðŸ–","ðŸ","ðŸ‘","ðŸ","ðŸ¦Œ","ðŸ•","ðŸ©","ðŸ¦®","ðŸ•â€ðŸ¦º","ðŸˆ","ðŸˆâ€â¬›","ðŸ“","ðŸ¦ƒ","ðŸ¦š","ðŸ¦œ","ðŸ¦¢","ðŸ¦©","ðŸ•Šï¸","ðŸŽ","ðŸ","ðŸŠ","ðŸ‹","ðŸŒ","ðŸ‰","ðŸ‡","ðŸ“","ðŸ«","ðŸˆ","ðŸ’","ðŸ‘","ðŸ¥­","ðŸ","ðŸ¥¥","ðŸ¥","ðŸ…","ðŸ†","ðŸ¥‘","ðŸ¥¦","ðŸ¥¬","ðŸ¥’","ðŸŒ¶ï¸","ðŸ«‘","ðŸŒ½","ðŸ¥•","ðŸ«’","ðŸ§„","ðŸ§…","ðŸ¥”","ðŸ ","ðŸ¥","ðŸ¥¯","ðŸž","ðŸ¥–","ðŸ¥¨","ðŸ§€","ðŸ¥š","ðŸ³","ðŸ§ˆ","ðŸ¥ž","ðŸ§‡","ðŸ¥“","ðŸ¥©","ðŸ—","ðŸ–","ðŸ¦´","ðŸŒ­","ðŸ”","ðŸŸ","ðŸ•","ðŸ¥ª","ðŸ¥™","ðŸ§†","ðŸŒ®","ðŸŒ¯","ðŸ«”","ðŸ¥—","ðŸ¥˜","ðŸ«•","ðŸ¥«","ðŸ","ðŸœ","ðŸ²","ðŸ›","ðŸ£","ðŸ±","ðŸ¥Ÿ","ðŸ¦ª","ðŸ¤","ðŸ™","ðŸš","ðŸ˜","ðŸ¥","ðŸ¥ ","ðŸ¥®","ðŸ¢","ðŸ¡","ðŸ§","ðŸ¨","ðŸ¦","ðŸ°","ðŸ§","ðŸ¥§","ðŸ®","ðŸ­","ðŸ¬","ðŸ«","ðŸ¿","ðŸª","ðŸŒ°","ðŸ¥œ","ðŸ¯","ðŸ¥›","ðŸ¼","ðŸ«–","âš½","ðŸ€","ðŸˆ","âš¾","ðŸ¥Ž","ðŸŽ¾","ðŸ","ðŸ‰","ðŸ¥","ðŸŽ±","ðŸª€","ðŸ“","ðŸ¸","ðŸ’","ðŸ‘","ðŸ¥","ðŸ","ðŸ¥…","â›³","ðŸª","ðŸ¹","ðŸŽ£","ðŸ¤¿","ðŸ¥Š","ðŸ¥‹","ðŸŽ½","ðŸ›¹","ðŸ›·ï¸","â›¸ï¸","ðŸ¥Œ","ðŸŽ¿","â›·ï¸","ðŸ‚","ðŸª‚","ðŸ‹ï¸â€â™€ï¸","ðŸ‹ï¸","ðŸ‹ï¸â€â™‚ï¸","ðŸ¤¼â€â™€ï¸","ðŸ¤¼","ðŸ¤¼â€â™‚ï¸","ðŸ¤¸â€â™€ï¸","ðŸ¤¸","ðŸ¤¸â€â™‚ï¸","â›¹ï¸â€â™€ï¸","â›¹ï¸","â›¹ï¸â€â™‚ï¸","ðŸ¤º","ðŸ¤¾â€â™€ï¸","ðŸ¤¾","ðŸ¤¾â€â™‚ï¸","ðŸŠâ€â™€ï¸","ðŸŠ","ðŸŠâ€â™‚ï¸","ðŸš£â€â™€ï¸","ðŸš£","ðŸš£â€â™‚ï¸","ðŸ„â€â™€ï¸","ðŸ„","ðŸ„â€â™‚ï¸","ðŸš´â€â™€ï¸","ðŸš´","ðŸš´â€â™‚ï¸","ðŸšµâ€â™€ï¸","ðŸšµ","ðŸšµâ€â™‚ï¸","ðŸ¤¹â€â™€ï¸","ðŸ¤¹","ðŸ¤¹â€â™‚ï¸","ðŸŽ­","ðŸ©°","ðŸŽ¨","ðŸŽ¬","ðŸŽ¤","ðŸŽ§","ðŸŽ¼","ðŸŽ¹","ðŸ¥","ðŸª˜","ðŸŽ·","ðŸŽº","ðŸŽ¸","ðŸª•","ðŸŽ»","ðŸŽ²","â™Ÿï¸","ðŸŽ¯","ðŸŽ³","ðŸŽ®","ðŸŽ°","ðŸ§©","ðŸŽ¨","ðŸ“±","ðŸš—","ðŸš•","ðŸš™","ðŸšŒ","ðŸšŽ","ðŸŽï¸","ðŸš“","ðŸš‘","ðŸš’","ðŸš","ðŸšš","ðŸš›","ðŸšœ","ðŸ›´","ðŸ›µ","ðŸï¸","ðŸš¨","ðŸš”","ðŸš","ðŸš˜","ðŸš–","ðŸš¡","ðŸš ","ðŸšŸ","ðŸšƒ","ðŸš‹","ðŸšž","ðŸš","ðŸš„","ðŸš…","ðŸšˆ","ðŸš‚","ðŸš†","ðŸš‡","ðŸšŠ","ðŸš‰","âœˆï¸","ðŸ›«","ðŸ›¬","ðŸ›©ï¸","ðŸ’º","ðŸ›°ï¸","ðŸš€","ðŸ›¸","ðŸš","ðŸ›¥ï¸","â›´ï¸","ðŸš¢","âš“","ðŸš¦","ðŸš¥","ðŸ","ðŸš","ðŸŽ¡","ðŸŽ¢","ðŸŽ ","ðŸ—ï¸","ðŸ˜ï¸","ðŸšï¸","ðŸ›ï¸","ðŸ™ï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","ðŸŽï¸","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ–¤","ðŸ¤","ðŸ¤Ž","ðŸ’”","â£ï¸","ðŸ’•","ðŸ’ž","ðŸ’“","ðŸ’—","ðŸ’–","ðŸ’˜","ðŸ’","ðŸ’Ÿ","â˜®ï¸","âœï¸","â˜ªï¸","ðŸ•‰ï¸","â˜¸ï¸","âœ¡ï¸","ðŸ”¯","ðŸ•Ž","â˜¯ï¸","â˜¦ï¸","ðŸ›","â›Ž","â™ˆ","â™‰","â™Š","â™‹","â™Œ","â™","â™Ž","â™","â™","â™‘","â™’","â™“","ðŸ†”","âš›ï¸","ðŸ‰‘","â˜¢ï¸","â˜£ï¸","ðŸ“´","ðŸ“³","ðŸˆ¶","ðŸˆš","ðŸˆ¸","ðŸˆº","ðŸˆ·ï¸","âœ´ï¸","ðŸ†š","ðŸ’®","ðŸ‰","ãŠ™ï¸","ãŠ—ï¸","ðŸˆ´","ðŸˆµ","ðŸˆ¹","ðŸˆ²","ðŸ…°ï¸","ðŸ…±ï¸","ðŸ†Ž","ðŸ†‘","ðŸ…¾ï¸","ðŸ†˜","âŒ","â­•","ðŸ›‘","â›”","ðŸ“›","ðŸš«","ðŸ’¯","ðŸ’¢","â™¨ï¸","ðŸ","ðŸš©","ðŸŽŒ","ðŸ´","ðŸ³ï¸","ðŸ³ï¸â€ðŸŒˆ","ðŸ´â€â˜ ï¸","ðŸ‡¦ðŸ‡«","ðŸ‡¦ðŸ‡½","ðŸ‡¦ðŸ‡±","ðŸ‡©ðŸ‡¿","ðŸ‡¦ðŸ‡¸","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©","ðŸ‡¦ðŸ‡©"].map((t,s)=>e.jsx("button",{onClick:a=>{a.stopPropagation(),a.preventDefault(),Je&&(be(Je,t),me(!1),ie(!1),W(null))},onMouseDown:a=>{a.stopPropagation(),a.preventDefault()},className:"w-10 h-10 flex items-center justify-center text-xl hover:scale-110 transition-all duration-200 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200 hover:border-gray-300 hover:shadow-md",title:`React with ${t}`,children:t},s))})})]})}),de&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsxs("span",{className:"text-xs text-gray-600 truncate max-w-[200px]",children:[(ur=de.message)==null?void 0:ur.substring(0,40),((hr=de.message)==null?void 0:hr.length)>40?"...":""]}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-1 transition-colors",onClick:()=>ht(null),title:"Cancel reply",children:e.jsx(ne,{className:"w-3 h-3"})})]})}),J&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-yellow-50 border-l-4 border-yellow-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-yellow-700 font-semibold mr-2",children:"âœï¸ Editing message:"}),e.jsx("span",{className:"text-xs text-yellow-600 truncate",children:Ae}),e.jsx("button",{className:"ml-auto text-yellow-400 hover:text-yellow-700 bg-yellow-100 hover:bg-yellow-200 rounded-full p-1 transition-colors",onClick:()=>{ge(null),ue(""),V(Ut),setTimeout(()=>{ut("")},100),_e(null),Ie(!1),setTimeout(()=>{if(g.current){const s=new Event("input",{bubbles:!0});g.current.dispatchEvent(s),g.current.style.height="48px";const a=g.current.scrollHeight,n=144;a<=n?(g.current.style.height=a+"px",g.current.style.overflowY="hidden"):(g.current.style.height=n+"px",g.current.style.overflowY="auto")}},100)},title:"Cancel edit",children:e.jsx(ne,{className:"w-3 h-3"})})]})}),e.jsxs("div",{className:"flex gap-2 mt-1 px-3 pb-2 flex-shrink-0 bg-gradient-to-b from-transparent to-white pt-2 items-end",children:[e.jsxs("div",{className:"flex-1 relative",children:[mt&&e.jsx("div",{className:"max-h-32 max-w-full overflow-y-auto mb-2 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:e.jsx(Nr,{url:mt,onRemove:()=>{_e(null),Ie(!0)},className:"w-full",showRemoveButton:!0,clickable:!1})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-2",children:[e.jsx("button",{type:"button",className:"px-2 py-1 text-xs rounded border hover:bg-gray-100",onClick:()=>{const t=g.current;if(!t)return;const s=t.selectionStart||0,a=t.selectionEnd||0,n=B||"",r=n.slice(s,a),o=`**${r||"bold"}**`,i=n.slice(0,s)+o+n.slice(a);V(i),setTimeout(()=>{try{t.focus(),t.setSelectionRange(s+2,s+2+(r||"bold").length)}catch{}},0)},children:"B"}),e.jsx("button",{type:"button",className:"px-2 py-1 text-xs rounded border hover:bg-gray-100 italic",onClick:()=>{const t=g.current;if(!t)return;const s=t.selectionStart||0,a=t.selectionEnd||0,n=B||"",r=n.slice(s,a),o=`*${r||"italic"}*`,i=n.slice(0,s)+o+n.slice(a);V(i),setTimeout(()=>{try{t.focus(),t.setSelectionRange(s+1,s+1+(r||"italic").length)}catch{}},0)},children:"I"}),e.jsx("button",{type:"button",className:"px-2 py-1 text-xs rounded border hover:bg-gray-100 underline",onClick:()=>{const t=g.current;if(!t)return;const s=t.selectionStart||0,a=t.selectionEnd||0,n=B||"",r=n.slice(s,a),o=`__${r||"underline"}__`,i=n.slice(0,s)+o+n.slice(a);V(i),setTimeout(()=>{try{t.focus(),t.setSelectionRange(s+2,s+2+(r||"underline").length)}catch{}},0)},children:"U"}),e.jsx("button",{type:"button",className:"px-2 py-1 text-xs rounded border hover:bg-gray-100",onClick:()=>{const t=g.current;if(!t)return;const s=t.selectionStart||0,a=t.selectionEnd||0,n=B||"",r=n.slice(s,a),o=`~~${r||"strike"}~~`,i=n.slice(0,s)+o+n.slice(a);V(i),setTimeout(()=>{try{t.focus(),t.setSelectionRange(s+2,s+2+(r||"strike").length)}catch{}},0)},children:"S"}),e.jsx("button",{type:"button",className:"px-2 py-1 text-xs rounded border hover:bg-gray-100",onClick:()=>{const t=g.current;if(!t)return;const s=B||"",a=t.selectionStart||0;V(s.slice(0,a)+"- "+s.slice(a))},children:"â€¢ List"}),e.jsx("button",{type:"button",className:"px-2 py-1 text-xs rounded border hover:bg-gray-100",onClick:()=>{const t=g.current;if(!t)return;const s=B||"",a=t.selectionStart||0,n=s.slice(0,a);s.slice(a);const r=n.split(`
`);let o=1;for(let i=r.length-1;i>=0;i--){const d=r[i].trim(),N=d.match(/^(\d+)\.\s/);if(N){o=parseInt(N[1])+1;break}else if(d&&!d.match(/^\s*$/))break}V(s.slice(0,a)+`${o}. `+s.slice(a))},children:"1. List"}),e.jsx("button",{type:"button",className:"px-2 py-1 text-xs rounded border hover:bg-gray-100",onClick:()=>{const t=g.current;if(!t)return;const s=B||"",a=t.selectionStart||0;V(s.slice(0,a)+"> "+s.slice(a))},children:"> Quote"}),e.jsx("button",{type:"button",className:"px-2 py-1 text-xs rounded border hover:bg-gray-100",title:"Tag Property",onClick:()=>{const t=g.current;if(!t)return;const s=t.selectionStart||0,a=B||"";V(a.slice(0,s)+"@"+a.slice(s))},children:"@Prop"}),e.jsx("button",{type:"button",className:"px-2 py-1 text-xs rounded border hover:bg-gray-100",title:"Insert appointment card",onClick:()=>{const t=g.current;if(!t)return;const s=t.selectionStart||0,a=B||"";V(a.slice(0,s)+"[Appointment: date â€¢ time â€¢ with]"+a.slice(s))},children:"Appt"}),e.jsx("button",{type:"button",className:"px-2 py-1 text-xs rounded border hover:bg-gray-100",title:"Insert service link",onClick:()=>{const t=g.current;if(!t)return;const s=t.selectionStart||0,a=B||"";V(a.slice(0,s)+"Book Movers: /user/movers"+a.slice(s))},children:"Service"})]}),B&&/@[^\s]*$/.test(B)&&e.jsx("div",{className:"absolute bottom-16 left-2 right-2 bg-white border rounded shadow-lg max-h-48 overflow-auto z-30",children:(()=>{var o;const t=(((o=B.match(/@([^\s]*)$/))==null?void 0:o[1])||"").toLowerCase(),n=[...(typeof appointments<"u"&&Array.isArray(appointments)&&appointments.length>0?appointments:[l].filter(Boolean)).map(i=>{var d,N;return{id:((d=i==null?void 0:i.listingId)==null?void 0:d._id)||(i==null?void 0:i.listingId),name:(i==null?void 0:i.propertyName)||((N=i==null?void 0:i.listingId)==null?void 0:N.name)||"Property"}}),...qt],r=Array.from(new Set(n.filter(i=>i.id&&i.name).map(i=>JSON.stringify(i)))).map(i=>JSON.parse(i)).filter(i=>i.name&&i.name.toLowerCase().includes(t));return r.length===0?e.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:"No matches"}):r.slice(0,8).map(i=>e.jsx("button",{type:"button",className:"w-full text-left px-3 py-2 text-sm hover:bg-gray-100",onClick:()=>{const d=g.current,N=B||"",S=N.match(/@([^\s]*)$/);if(!S)return;const $=N.lastIndexOf("@"),ee=`@[${i.name}](${i.id})`,Oe=N.slice(0,$)+ee+" "+N.slice($+S[0].length);V(Oe),setTimeout(()=>{try{d==null||d.focus(),d==null||d.setSelectionRange($+ee.length+1,$+ee.length+1)}catch{}},0)},children:i.name},i.id))})()}),e.jsx("textarea",{rows:1,className:"w-full pl-4 pr-20 py-3 border-2 border-gray-200 rounded-2xl text-sm focus:ring-2 focus:ring-blue-300 focus:border-blue-400 shadow-lg transition-all duration-300 bg-white resize-none whitespace-pre-wrap break-all hover:border-blue-300 hover:shadow-xl focus:shadow-2xl transform hover:scale-[1.01] overflow-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",style:{minHeight:"48px",maxHeight:"144px",lineHeight:"24px",wordBreak:"break-all",overflowWrap:"break-word"},placeholder:J?"Edit your message...":"Type a message...",value:B,onChange:t=>{const s=t.target.value;V(s);const a=/(https?:\/\/[^\s]+|www\.[^\s]+\.[^\s]{2,}(?:\/[^\s]*)?|[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*\.[a-zA-Z]{2,}(?:\/[^\s]*)?)/gi,n=s.match(a);if(n&&n.length>0?(_e(n[0]),Ie(!1)):(_e(null),Ie(!1)),J&&ue(s),(t.target.value||"").trim()===""){const d=t.target;d.style.height="48px",d.style.overflowY="hidden";return}const r=t.target;r.style.height="48px";const o=r.scrollHeight,i=144;o<=i?(r.style.height=o+"px",r.style.overflowY="hidden"):(r.style.height=i+"px",r.style.overflowY="auto")},onClick:()=>{Y&&(A(null),h.info("You can hit reply icon in header to reply"))},onScroll:t=>{t.stopPropagation()},onPaste:t=>{const a=Array.from(t.clipboardData.items).filter(n=>n.type.startsWith("image/"));if(a.length>0){t.preventDefault();const r=a[0].getAsFile();r&&qa([r])}},onKeyDown:t=>{const s=window.matchMedia("(min-width: 768px)").matches;if(t.key==="Enter"){if(t.isComposing||t.keyCode===229)return;(s&&!t.shiftKey||t.ctrlKey||t.metaKey)&&(t.preventDefault(),J?ba(J):fa())}},ref:g}),e.jsx("div",{className:"absolute right-12 bottom-2",children:e.jsx(cs,{onEmojiClick:t=>{const s=g==null?void 0:g.current,a=s?s.value:B;let n=a.length,r=a.length;try{s&&typeof s.selectionStart=="number"&&typeof s.selectionEnd=="number"&&(n=s.selectionStart,r=s.selectionEnd)}catch{}const o=a.slice(0,n)+t+a.slice(r);V(o),J&&ue(o),setTimeout(()=>{try{if(s){const i=n+t.length;s.focus(),s.setSelectionRange(i,i)}}catch{}},0)},className:"w-8 h-8",inputRef:g})}),e.jsxs("div",{className:"absolute right-3 bottom-3",children:[e.jsx("button",{ref:Pa,type:"button",onClick:()=>lt(t=>!t),disabled:Pe,className:`flex items-center justify-center w-8 h-8 rounded-full transition-all duration-300 ${Pe?"bg-gray-400 cursor-not-allowed":"bg-gray-100 hover:bg-gray-200 hover:shadow-md active:scale-95"}`,title:"Attach",children:Pe?e.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-gray-600 border-t-transparent rounded-full"}):e.jsx("svg",{className:"w-4 h-4 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"})})}),ra&&!Pe&&e.jsxs("div",{ref:Ba,className:"absolute bottom-10 right-0 bg-white border border-gray-200 shadow-xl rounded-lg w-48 py-2 z-20",children:[e.jsxs("label",{className:"flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer",children:[e.jsx("svg",{className:"w-4 h-4 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})}),"Photos",e.jsx("input",{type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:t=>{const s=t.target.files;s&&s.length>0&&Ha(s),t.target.value="",lt(!1)}})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left",onClick:async()=>{try{const t=await navigator.mediaDevices.getUserMedia({video:!0}),s=document.createElement("video");s.autoplay=!0,s.srcObject=t,await new Promise(r=>setTimeout(r,300));const a=document.createElement("canvas");a.width=1280,a.height=720,a.getContext("2d").drawImage(s,0,0,a.width,a.height),t.getTracks().forEach(r=>r.stop()),a.toBlob(r=>{if(!r)return;const o=new File([r],`camera-${Date.now()}.jpg`,{type:"image/jpeg"});Ha([o])},"image/jpeg",.92)}catch{h.error("Camera permission denied or not available")}finally{lt(!1)}},children:[e.jsx("svg",{className:"w-4 h-4 text-purple-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 7a2 2 0 012-2h2l1-2h6l1 2h2a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"})}),"Camera"]}),e.jsxs("label",{className:"flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer",children:[e.jsx("svg",{className:"w-4 h-4 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"})}),"Videos",e.jsx("input",{ref:Fr,type:"file",accept:"video/*",className:"hidden",onChange:t=>{const s=t.target.files&&t.target.files[0];s&&(s.size>5*1024*1024?h.error("Maximum video size is 5MB"):(As(s),$s(!0))),t.target.value="",lt(!1)}})]}),e.jsxs("label",{className:"flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer",children:[e.jsx("svg",{className:"w-4 h-4 text-green-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Documents",e.jsx("input",{ref:Rr,type:"file",className:"hidden",onChange:t=>{const s=t.target.files&&t.target.files[0];s&&(s.size>5*1024*1024?h.error("Maximum document size is 5MB"):(Ds(s),Es(!0))),t.target.value="",lt(!1)}})]}),e.jsxs("label",{className:"flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer",children:[e.jsxs("svg",{className:"w-4 h-4 text-indigo-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 1a3 3 0 00-3 3v8a3 3 0 106 0V4a3 3 0 00-3-3z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 10v2a7 7 0 11-14 0v-2"})]}),"Audio",e.jsx("input",{type:"file",accept:"audio/*",className:"hidden",onChange:t=>{const s=t.target.files&&t.target.files[0];s&&(s.size>5*1024*1024?h.error("Maximum audio size is 5MB"):(ns(s),ls(!0))),t.target.value="",lt(!1)}})]}),e.jsxs("button",{type:"button",className:"flex items-center gap-3 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer w-full text-left",onClick:()=>{lt(!1),Fs(!0)},children:[e.jsxs("svg",{className:"w-4 h-4 text-rose-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 1a3 3 0 00-3 3v8a3 3 0 106 0V4a3 3 0 00-3-3z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 10v2a7 7 0 11-14 0v-2"})]}),"Record Audio"]})]})]})]}),e.jsx("button",{onClick:t=>{t.preventDefault(),J?ba(J):fa()},disabled:J?hs===J:!B.trim(),className:"bg-gradient-to-r from-blue-600 to-purple-700 text-white w-12 h-12 rounded-full shadow-lg hover:from-blue-700 hover:to-purple-800 hover:shadow-xl transform hover:scale-110 transition-all duration-300 disabled:opacity-50 disabled:transform-none flex items-center justify-center hover:shadow-2xl active:scale-95 group",children:J?hs===J?e.jsx(wa,{className:"text-lg text-white animate-editSaving"}):e.jsx(wa,{className:"text-lg text-white group-hover:scale-110 transition-transform duration-200"}):e.jsx("div",{className:"relative",children:Ir?e.jsx(vr,{className:"text-lg text-white group-hover:scale-110 transition-all duration-300 send-icon animate-sent"}):e.jsx(_n,{className:`text-lg text-white group-hover:scale-110 transition-all duration-300 send-icon ${Ks?"animate-fly":""}`})})})]}),Fa&&e.jsx("div",{className:"px-3 pb-2",children:e.jsx("div",{className:"text-red-500 text-sm bg-red-50 p-2 rounded-lg border border-red-200",children:Fa})}),Mr&&M.length>0&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-4 shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("span",{className:"text-lg font-medium text-gray-700",children:["Image Preview (",M.length," image",M.length!==1?"s":"",")"]}),e.jsx("button",{onClick:()=>{rt([]),pt({}),Le(0),es(!1)},className:"text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors",children:e.jsx(ne,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"relative mb-4",children:[M.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>Le(t=>t>0?t-1:M.length-1),className:"absolute left-2 top-1/2 transform -translate-y-1/2 z-10 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-70 transition-all duration-200",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("button",{onClick:()=>Le(t=>t<M.length-1?t+1:0),className:"absolute right-2 top-1/2 transform -translate-y-1/2 z-10 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-70 transition-all duration-200",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]}),e.jsx("div",{className:"mb-3",children:e.jsx("img",{src:URL.createObjectURL(M[fe]),alt:`Preview ${fe+1}`,className:"w-full h-64 object-contain rounded-lg border"})}),e.jsxs("div",{className:"text-center text-sm text-gray-600 mb-3",children:[fe+1," of ",M.length]}),e.jsxs("div",{className:"flex gap-2 mb-3 overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 pb-2 min-w-0 max-w-full",style:{scrollbarWidth:"thin",scrollbarColor:"#d1d5db #f3f4f6"},children:[M.map((t,s)=>e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>Le(s),className:`flex-shrink-0 w-12 h-12 rounded-lg border-2 transition-all duration-200 ${s===fe?"border-blue-500 shadow-lg":"border-gray-300 hover:border-gray-400"}`,children:e.jsx("img",{src:URL.createObjectURL(t),alt:`Thumbnail ${s+1}`,className:"w-full h-full object-cover rounded-lg"})}),M.length>1&&e.jsx("button",{onClick:a=>{a.stopPropagation();const n=M.filter((o,i)=>i!==s),r={...Xt};delete r[t.name],n.length===0?(rt([]),pt({}),es(!1)):(rt(n),pt(r),fe>=n.length?Le(n.length-1):fe>s&&Le(fe-1))},className:"absolute -top-1 -right-1 bg-red-500 hover:bg-red-600 text-white rounded-full p-1 shadow-lg transition-all duration-200 hover:scale-110 z-10",title:"Remove this image","aria-label":"Remove this image",children:e.jsx(ne,{className:"w-2 h-2"})})]},s)),M.length<10&&e.jsx("div",{className:"relative",children:e.jsxs("label",{className:"flex-shrink-0 w-12 h-12 rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-400 hover:bg-blue-50 transition-all duration-200 cursor-pointer flex items-center justify-center group",children:[e.jsx("input",{type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:t=>{const s=t.target.files;if(s&&s.length>0){const a=10-M.length,n=Array.from(s).slice(0,a);if(n.length>0){const r=[...M,...n];rt(r),n.length<s.length&&h.info(`Added ${n.length} images. Maximum limit of 10 images reached.`)}t.target.value=""}}}),e.jsx("svg",{className:"w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})]})})]})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx("textarea",{placeholder:`Add a caption for ${(xr=M[fe])==null?void 0:xr.name}...`,value:Xt[(gr=M[fe])==null?void 0:gr.name]||"",onChange:t=>pt(s=>{var a;return{...s,[(a=M[fe])==null?void 0:a.name]:t.target.value}}),className:"w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:3,maxLength:500}),e.jsx("div",{className:"absolute right-2 top-2",children:e.jsx(cs,{onEmojiClick:t=>{var a;const s=Xt[(a=M[fe])==null?void 0:a.name]||"";pt(n=>{var r;return{...n,[(r=M[fe])==null?void 0:r.name]:s+t}})},className:"w-6 h-6"})}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-right",children:[(Xt[(fr=M[fe])==null?void 0:fr.name]||"").length,"/500"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"text-sm text-gray-600",children:Pe&&Ra>=0?e.jsxs("span",{children:["Uploading ",Ra+1," / ",M.length,` â€¢ ${Lr}%`]}):e.jsxs(e.Fragment,{children:[M.length," image",M.length!==1?"s":""," ready to send",$t.length>0&&e.jsxs("span",{className:"ml-2 text-red-600",children:["â€¢ ",$t.length," failed"]})]})}),e.jsx("div",{className:"flex items-center gap-2",children:Pe?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:ga,className:"bg-red-600 text-white py-2 px-3 rounded-lg hover:bg-red-700 text-sm font-medium transition-colors",children:"Cancel Upload"}),e.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-2 bg-blue-600 rounded-full transition-all",style:{width:`${nt}%`}})}),e.jsxs("span",{className:"text-sm text-gray-700 w-10 text-right",children:[nt,"%"]})]}):e.jsxs(e.Fragment,{children:[$t.length>0&&e.jsxs("button",{onClick:Gr,className:"bg-yellow-500 text-white py-2 px-3 rounded-lg hover:bg-yellow-600 text-sm font-medium transition-colors",children:["Retry Failed (",$t.length,")"]}),e.jsx("button",{onClick:Ja,className:"bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors",children:`Send ${M.length} Image${M.length!==1?"s":""}`})]})})]})]})}),e.jsx("style",{jsx:!0,children:`
                @keyframes fadeInChatBubble {
                  from { opacity: 0; transform: translateY(20px) scale(0.95); }
                  to { opacity: 1; transform: translateY(0) scale(1); }
                }
                .animate-fadeInChatBubble {
                  animation: fadeInChatBubble 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
                }
                @keyframes fadeInChat {
                  from { opacity: 0; transform: translateY(10px); }
                  to { opacity: 1; transform: translateY(0); }
                }
                .animate-fadeInChat {
                  animation: fadeInChat 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
                }
                @keyframes gentlePulse {
                  0%, 100% { opacity: 1; transform: scale(1); }
                  50% { opacity: 0.9; transform: scale(1.01); }
                }
                .animate-gentlePulse {
                  animation: gentlePulse 3s ease-in-out infinite;
                }
                @keyframes attentionGlow {
                  0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
                  50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
                }
                .animate-attentionGlow {
                  animation: attentionGlow 2s ease-in-out infinite;
                }
                @keyframes slideInFromTop {
                  from { opacity: 0; transform: translateY(-20px) scale(0.95); }
                  to { opacity: 1; transform: translateY(0) scale(1); }
                }
                                  .animate-slideInFromTop {
                    animation: slideInFromTop 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
                  }
                  @keyframes sendIconFly {
                    0% { 
                      transform: translate(0, 0) scale(1); 
                      opacity: 1;
                    }
                    20% { 
                      transform: translate(0, 0) scale(1.2); 
                      opacity: 1;
                    }
                    40% { 
                      transform: translate(15px, -20px) scale(1.3); 
                      opacity: 0.8;
                    }
                    60% { 
                      transform: translate(25px, -35px) scale(1.4); 
                      opacity: 0.6;
                    }
                    80% { 
                      transform: translate(15px, -20px) scale(1.2); 
                      opacity: 0.8;
                    }
                    100% { 
                      transform: translate(0, 0) scale(1); 
                      opacity: 1;
                    }
                  }
                  .send-icon.animate-fly {
                    animation: sendIconFly 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                  }
                  @keyframes sentSuccess {
                    0% { 
                      transform: scale(0.8); 
                      opacity: 0;
                    }
                    50% { 
                      transform: scale(1.2); 
                      opacity: 1;
                    }
                    100% { 
                      transform: scale(1); 
                      opacity: 1;
                    }
                  }
                  .send-icon.animate-sent {
                    animation: sentSuccess 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                  }
                  @keyframes editSaving {
                    0% { 
                      transform: scale(1) rotate(0deg) translate(0, 0); 
                      opacity: 1;
                    }
                    20% { 
                      transform: scale(1.15) rotate(-8deg) translate(-1px, -1px); 
                      opacity: 0.9;
                    }
                    40% { 
                      transform: scale(1.25) rotate(0deg) translate(0, -2px); 
                      opacity: 1;
                    }
                    60% { 
                      transform: scale(1.15) rotate(8deg) translate(1px, -1px); 
                      opacity: 0.9;
                    }
                    80% { 
                      transform: scale(1.1) rotate(-4deg) translate(-1px, 0); 
                      opacity: 0.95;
                    }
                    100% { 
                      transform: scale(1) rotate(0deg) translate(0, 0); 
                      opacity: 1;
                    }
                  }
                  .animate-editSaving {
                    animation: editSaving 1.2s ease-in-out infinite;
                  }
                  .search-highlight {
                    animation: searchHighlight 2s ease-in-out;
                  }
                  @keyframes searchHighlight {
                    0%, 100% { box-shadow: 0 0 0 rgba(59, 130, 246, 0); }
                    50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); }
                  }
                  .date-highlight {
                    animation: dateHighlight 3s ease-in-out;
                  }
                  @keyframes dateHighlight {
                    0%, 100% { box-shadow: 0 0 0 rgba(168, 85, 247, 0); }
                    50% { box-shadow: 0 0 25px rgba(168, 85, 247, 0.9); }
                  }
                `}),!Re&&!J&&!de&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsxs("button",{onClick:()=>{P(Math.max(j,b.length)),Va()},className:"bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-full p-3 shadow-xl transition-all duration-200 hover:scale-110 relative transform hover:shadow-2xl",title:u>0?`${u} new message${u>1?"s":""}`:"Jump to latest","aria-label":u>0?`${u} new messages, jump to latest`:"Jump to latest",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})}),u>0&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 border-2 border-white shadow-lg",children:u>99?"99+":u})]})}),ft&&e.jsx("div",{className:"absolute inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 w-full max-w-sm relative shadow-2xl",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors",onClick:()=>{De(!1),Gt("")},title:"Close","aria-label":"Close",children:e.jsx(ne,{className:"w-4 h-4"})}),e.jsxs("h3",{className:"text-lg font-bold mb-4 text-red-600 flex items-center gap-2",children:[e.jsx(Ve,{})," Delete Entire Chat"]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"This will permanently delete all messages for this appointment. Enter admin password to confirm."}),e.jsx("input",{type:"password",className:"border rounded px-3 py-2 w-full focus:ring-2 focus:ring-red-200 mb-4",placeholder:"Admin password",value:Yt,onChange:t=>Gt(t.target.value),onKeyDown:t=>{t.key==="Enter"&&Yt.trim()&&!Js&&(t.preventDefault(),(async()=>{var s,a;try{ps(!0);const{data:n}=await D.delete(`${I}/api/bookings/${l._id}/comments`,{withCredentials:!0,headers:{"Content-Type":"application/json"},data:{password:Yt}});C([]),h.success("Chat deleted successfully."),De(!1),Gt("")}catch(n){h.error(((a=(s=n.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to delete chat")}finally{ps(!1)}})())},autoFocus:!0}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{De(!1),Gt("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsx("button",{type:"button",disabled:Js||!Yt,onClick:async()=>{var t,s;try{ps(!0);const{data:a}=await D.delete(`${I}/api/bookings/${l._id}/comments`,{withCredentials:!0,headers:{"Content-Type":"application/json"},data:{password:Yt}});C([]),h.success("Chat deleted successfully."),De(!1),Gt("")}catch(a){h.error(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to delete chat")}finally{ps(!1)}},className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2 disabled:opacity-60",children:Js?"Deleting...":e.jsxs(e.Fragment,{children:[e.jsx(Ve,{size:12})," Delete Chat"]})})]})]})})]})}),Vt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Ve,{className:"text-red-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Delete Message"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to delete this message for everyone?"})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Ge(!1),at(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:xn,className:"px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(Ve,{size:14}),"Delete"]})]})]})})}),jt&&se===l._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Ft,{className:"text-red-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Cancel Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify mb-4",children:"Are you sure you want to cancel this appointment?"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for cancellation (required):"}),e.jsx("textarea",{value:Os,onChange:t=>us(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for cancelling this appointment..."})]})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{te(!1),ce(null),us("")},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Vs,className:"px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(Ft,{size:14}),"Cancel Appointment"]})]})]})})}),Nt&&se===l._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Rt,{className:"text-green-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Reinitiate Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to reinitiate this appointment? This will notify both buyer and seller."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{xe(!1),ce(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:ae,className:"px-4 py-2 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(Rt,{size:14}),"Reinitiate"]})]})]})})}),dt&&se===l._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Us,{className:"text-blue-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Archive Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to archive this appointment? It will be moved to the archived section."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Fe(!1),ce(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Hs,className:"px-4 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx(Us,{size:14}),"Archive"]})]})]})})}),ke&&se===l._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Rt,{className:"text-green-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Unarchive Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Q(!1),ce(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Pt,className:"px-4 py-2 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(Rt,{size:14}),"Unarchive"]})]})]})})}),Ys&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-yellow-50 to-amber-50",children:[e.jsxs("h3",{className:"text-xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(it,{className:"text-yellow-500"}),"Starred Messages"]}),e.jsx("button",{onClick:Ua,disabled:Gs,className:"p-2 text-yellow-600 hover:text-yellow-700 bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:"Refresh starred messages",children:Gs?e.jsx("div",{className:"w-4 h-4 border-2 border-yellow-600 border-t-transparent rounded-full animate-spin"}):e.jsx(wr,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:Gs?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-500"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading starred messages..."})]}):Ee.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(zs,{className:"mx-auto text-6xl text-gray-300 mb-4"}),e.jsx("h4",{className:"text-xl font-semibold text-gray-600 mb-2",children:"No Starred Messages"}),e.jsx("p",{className:"text-gray-500",children:"Star important messages to find them easily later."})]}):e.jsx("div",{className:"space-y-4",children:Ee.map((t,s)=>{const a=t.senderEmail===m.email,n=new Date(t.timestamp);return e.jsx("div",{className:`flex w-full ${a?"justify-end":"justify-start"} mb-4`,children:e.jsxs("div",{className:`relative max-w-[80%] ${a?"ml-12":"mr-12"}`,children:[e.jsxs("div",{className:`flex items-center gap-2 mb-1 ${a?"justify-end":"justify-start"}`,children:[e.jsx(it,{className:"text-yellow-500 text-xs"}),e.jsx("span",{className:`text-xs font-medium ${a?"text-blue-600":"text-green-600"}`,children:a?"You":(()=>{var r,o,i,d;return t.senderEmail===((r=l.buyerId)==null?void 0:r.email)?((o=l.buyerId)==null?void 0:o.username)||"Buyer":t.senderEmail===((i=l.sellerId)==null?void 0:i.email)?((d=l.sellerId)==null?void 0:d.username)||"Seller":t.senderName||"UrbanSetu"})()}),e.jsx("span",{className:"text-xs text-gray-500",children:n.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})}),e.jsx("button",{onClick:async()=>{Aa(t._id);try{const{data:r}=await D.patch(`${I}/api/bookings/${l._id}/comment/${t._id}/star`,{starred:!1},{withCredentials:!0,headers:{"Content-Type":"application/json"}});Te(o=>o.filter(i=>i._id!==t._id)),C(o=>{const i=o.map(d=>d._id===t._id?{...d,starredBy:(d.starredBy||[]).filter(N=>N!==m._id)}:d);return Z(l._id,i),i}),h.success("Message unstarred")}catch{h.error("Failed to unstar message")}finally{Aa(null)}},className:"text-red-500 hover:text-red-700 text-xs p-1 rounded-full hover:bg-red-50 transition-colors",title:"Remove from starred messages",disabled:Ia===t._id,children:Ia===t._id?e.jsx("div",{className:"w-3 h-3 border border-red-500 border-t-transparent rounded-full animate-spin"}):e.jsx(ne,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:`rounded-2xl px-4 py-3 text-sm shadow-lg break-words relative group cursor-pointer hover:shadow-xl transition-all duration-200 ${a?"bg-gradient-to-r from-blue-600 to-purple-700 text-white hover:from-blue-500 hover:to-purple-600":"bg-white text-gray-800 border border-gray-200 hover:bg-gray-50 hover:border-gray-300"}`,onClick:()=>{ys(!1);const r=document.querySelector(`[data-message-id="${t._id}"]`);r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),r.classList.add("starred-highlight"),setTimeout(()=>{r.classList.remove("starred-highlight")},1600))},children:[e.jsxs("div",{className:"whitespace-pre-wrap break-words",children:[(t.originalImageUrl||t.imageUrl)&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:t.originalImageUrl||t.imageUrl,alt:"Shared image",className:"max-w-full max-h-64 rounded-lg cursor-pointer hover:opacity-90 transition-opacity",onClick:r=>{r.stopPropagation();const o=(b||[]).filter(N=>!!(N.originalImageUrl||N.imageUrl)).map(N=>N.originalImageUrl||N.imageUrl),i=t.originalImageUrl||t.imageUrl,d=Math.max(0,o.indexOf(i));ea(o),Le(d),_s(!0)},onError:r=>{r.target.src="https://via.placeholder.com/300x200?text=Image+Not+Found",r.target.className="max-w-full max-h-64 rounded-lg opacity-50"}})}),t.videoUrl&&e.jsx("div",{className:"mb-2",children:e.jsx("video",{src:t.videoUrl,className:"max-w-full max-h-64 rounded-lg border cursor-pointer hover:opacity-90 transition-opacity",controls:!0,onClick:r=>{r.preventDefault(),r.stopPropagation(),r.target.requestFullscreen?r.target.requestFullscreen():r.target.webkitRequestFullscreen?r.target.webkitRequestFullscreen():r.target.msRequestFullscreen&&r.target.msRequestFullscreen()}})}),t.documentUrl&&e.jsx("div",{className:"mb-2",children:e.jsxs("button",{className:"flex items-center gap-2 px-3 py-2 rounded-lg border hover:bg-gray-50",onClick:r=>{r.stopPropagation();const o=document.createElement("a");o.href=t.documentUrl,o.download=t.documentName||`document-${t._id||Date.now()}`,o.target="_blank",document.body.appendChild(o),o.click(),o.remove()},children:[e.jsx("span",{className:"text-2xl",children:"ðŸ“„"}),e.jsx("span",{className:"text-sm text-blue-700 truncate max-w-[200px]",children:t.documentName||"Document"})]})}),t.deleted?e.jsxs("div",{className:"border border-red-300 bg-red-50 rounded p-2 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-xs font-semibold mb-1",children:[e.jsx(Ft,{className:"inline-block"}),"Message deleted by ",t.deletedBy||"user"," (Admin view - preserved for records)"]}),e.jsx("div",{className:"text-gray-800 bg-white p-2 rounded border-l-4 border-red-400 relative group",children:(()=>{const r=t.originalMessage||t.message;return r?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"whitespace-pre-wrap break-words",children:r}),e.jsx("button",{className:"absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 text-gray-500 hover:text-gray-700 bg-white rounded p-1 shadow-sm",onClick:o=>{o.stopPropagation(),oe(r)},title:"Copy deleted message content","aria-label":"Copy deleted message content",children:e.jsx(Mt,{className:"w-3 h-3"})})]}):e.jsx("span",{className:"text-gray-500 italic",children:"[Message content not preserved - this message was deleted before content preservation was implemented]"})})()})]}):e.jsx(jr,{text:(t.message||"").replace(/\n+$/,""),isSentMessage:a,className:"whitespace-pre-wrap break-words",searchQuery:Xs})]}),!t.deleted&&e.jsx("button",{onClick:r=>{r.stopPropagation(),oe(t.message)},className:`absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 p-1.5 rounded-full ${a?"bg-white/20 hover:bg-white/30 text-white":"bg-gray-100 hover:bg-gray-200 text-gray-600"}`,title:"Copy message",children:e.jsx(Mt,{className:"w-3 h-3"})}),t.edited&&e.jsx("div",{className:`flex justify-end mt-2 text-xs ${a?"text-blue-200":"text-gray-500"}`,children:e.jsx("span",{className:"italic",children:"(Edited)"})})]})]})},t._id)})})}),e.jsx("div",{className:"p-6 border-t border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:[Ee.length," starred message",Ee.length!==1?"s":""]}),e.jsxs("div",{className:"flex gap-2",children:[Ee.length>0&&e.jsx("button",{onClick:qr,disabled:$a,className:"px-2 sm:px-4 py-1.5 sm:py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:bg-red-400 disabled:cursor-not-allowed transition-colors font-medium flex items-center gap-1 sm:gap-2 text-xs sm:text-sm",children:$a?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Removing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ve,{className:"w-4 h-4"}),"Remove All"]})}),e.jsx("button",{onClick:()=>ys(!1),className:"px-2 sm:px-4 py-1.5 sm:py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors font-medium text-xs sm:text-sm",children:"Close"})]})]})})]})}),_r&&je&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(ya,{className:"text-blue-500"})," Message Info"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded p-3 text-sm text-gray-700",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Message:"}),e.jsxs("div",{className:"whitespace-pre-wrap break-words",children:[(je.message||"").slice(0,200),(je.message||"").length>200?"...":""]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Sent:"}),e.jsx("span",{className:"text-sm text-gray-800",children:new Date(je.timestamp).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})})]}),je.deliveredAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Delivered:"}),e.jsx("span",{className:"text-sm text-gray-800",children:new Date(je.deliveredAt).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})})]}),je.readAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Read:"}),e.jsx("span",{className:"text-sm text-gray-800",children:new Date(je.readAt).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})})]}),!je.deliveredAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Status:"}),e.jsx("span",{className:"text-sm text-gray-500",children:"Not delivered yet"})]}),je.deliveredAt&&!je.readAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Status:"}),e.jsx("span",{className:"text-sm text-blue-600",children:"Delivered"})]}),je.readAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Status:"}),e.jsx("span",{className:"text-sm text-green-600",children:"Read"})]})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{onClick:()=>{ka(!1),Sa(null)},className:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Close"})})]})}),e.jsx($n,{isOpen:Dr,onClose:()=>_s(!1),images:Er,initialIndex:fe,listingId:null,metadata:{addedFrom:"chat",chatType:"appointment"}}),Tr&&ze&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-4 shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-lg font-medium text-gray-700",children:"Video Preview"}),e.jsx("button",{onClick:()=>{As(null),$s(!1)},className:"text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors",children:e.jsx(ne,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-1 mb-4 min-h-0",children:e.jsx("video",{controls:!0,className:"w-full h-full max-h-[60vh] rounded-lg border",src:Br})}),e.jsxs("div",{className:"relative mb-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:sa,placeholder:`Add a caption for ${ze.name}...`,value:as,onChange:t=>Ms(t.target.value),className:"w-full p-3 pr-12 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:2,maxLength:500}),e.jsx("div",{className:"absolute right-2 top-2",children:e.jsx(cs,{onEmojiClick:t=>{const s=sa.current;if(s){const a=s.selectionStart,n=s.selectionEnd,r=as.slice(0,a)+t+as.slice(n);Ms(r),setTimeout(()=>{s.focus(),s.setSelectionRange(a+t.length,a+t.length)},0)}},inputRef:sa})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-right",children:[as.length,"/500"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600 truncate flex-1 mr-4",children:ze.name}),e.jsxs("div",{className:"flex gap-2 flex-shrink-0",children:[Pe?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:ga,className:"px-4 py-2 rounded-lg border border-red-300 text-red-600 hover:bg-red-50",children:"Cancel"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-2 bg-blue-600 rounded-full transition-all",style:{width:`${nt}%`}})}),e.jsxs("span",{className:"text-sm text-gray-700 w-10 text-right",children:[nt,"%"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{As(null),$s(!1),Ms("")},className:"px-4 py-2 rounded-lg border",children:"Cancel"}),e.jsx("button",{onClick:Zr,className:"px-4 py-2 rounded-lg bg-blue-600 text-white",children:"Send"})]}),zr&&Ue&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-4 shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-lg font-medium text-gray-700",children:"Audio Preview"}),e.jsx("button",{onClick:()=>{ns(null),ls(!1)},className:"text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors",children:e.jsx(ne,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"mb-4",children:e.jsx("audio",{controls:!0,className:"w-full",src:Ur})}),e.jsxs("div",{className:"relative mb-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:ia,placeholder:`Add a caption for ${Ue.name}...`,value:os,onChange:t=>la(t.target.value),className:"w-full p-3 pr-12 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:2,maxLength:500}),e.jsx("div",{className:"absolute right-2 top-2",children:e.jsx(cs,{onEmojiClick:t=>{const s=ia.current;if(s){const a=s.selectionStart,n=s.selectionEnd,r=os.slice(0,a)+t+os.slice(n);la(r),setTimeout(()=>{s.focus(),s.setSelectionRange(a+t.length,a+t.length)},0)}},inputRef:ia})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-right",children:[os.length,"/500"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600 truncate flex-1 mr-4",children:Ue.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{ns(null),ls(!1)},className:"py-2 px-4 rounded-lg text-sm font-medium border hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:en,className:`py-2 px-4 rounded-lg text-sm font-medium transition-colors ${Pe?"bg-gray-400 text-gray-200 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:"Send Audio"})]})]}),Pe&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full",style:{width:`${nt}%`}})}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-right",children:[nt,"%"]})]})]})})]})]})]})}),Pr&&ot&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-4 shadow-2xl max-w-md w-full",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-lg font-medium text-gray-700",children:"Document Preview"}),e.jsx("button",{onClick:()=>{Ds(null),Es(!1)},className:"text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors",children:e.jsx(ne,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"mb-4 flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded flex items-center justify-center text-gray-600",children:"ðŸ“„"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-medium truncate",children:ot.name}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:ot.type||"Document"})]})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:aa,placeholder:`Add a caption for ${ot.name}...`,value:rs,onChange:t=>Ls(t.target.value),className:"w-full p-3 pr-12 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:2,maxLength:500}),e.jsx("div",{className:"absolute right-2 top-2",children:e.jsx(cs,{onEmojiClick:t=>{const s=aa.current;if(s){const a=s.selectionStart,n=s.selectionEnd,r=rs.slice(0,a)+t+rs.slice(n);Ls(r),setTimeout(()=>{s.focus(),s.setSelectionRange(a+t.length,a+t.length)},0)}},inputRef:aa})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-right",children:[rs.length,"/500"]})]}),e.jsx("div",{className:"flex items-center justify-between",children:Pe?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:ga,className:"px-4 py-2 rounded-lg border border-red-300 text-red-600 hover:bg-red-50",children:"Cancel"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-24 h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-2 bg-blue-600 rounded-full transition-all",style:{width:`${nt}%`}})}),e.jsxs("span",{className:"text-sm text-gray-700 w-10 text-right",children:[nt,"%"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{Ds(null),Es(!1),Ls("")},className:"px-4 py-2 rounded-lg border",children:"Cancel"}),e.jsx("button",{onClick:tn,className:"px-4 py-2 rounded-lg bg-blue-600 text-white",children:"Send"})]})})]})}),Or&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-4 shadow-2xl max-w-md w-full",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("span",{className:"text-lg font-medium text-gray-700",children:"Record Audio"}),e.jsx("button",{onClick:()=>{is?za():Fs(!1)},className:"text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-colors",children:e.jsx(ne,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex flex-col items-center justify-center py-6",children:[e.jsx("div",{className:`w-24 h-24 rounded-full flex items-center justify-center mb-4 ${is?"bg-rose-100 animate-pulse":"bg-gray-100"}`,children:e.jsxs("svg",{className:`w-10 h-10 ${is?"text-rose-600":"text-gray-600"}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 1a3 3 0 00-3 3v8a3 3 0 106 0V4a3 3 0 00-3-3z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 10v2a7 7 0 11-14 0v-2"})]})}),e.jsx("div",{className:"text-sm text-gray-600 mb-4",children:is?`Recording... ${Math.floor(Vr/1e3)}s`:"Click Start to begin recording"}),e.jsx("div",{className:"flex items-center gap-3",children:is?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Wr,className:"px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700",children:"Stop"}),e.jsx("button",{onClick:za,className:"px-4 py-2 rounded-lg border",children:"Cancel"})]}):e.jsx("button",{onClick:Hr,className:"px-4 py-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700",children:"Start"})})]})]})})]})]})}export{On as default};
