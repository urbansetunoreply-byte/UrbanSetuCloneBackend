import{r as x,H as n,j as e,bb as Q,T as V,b0 as M,d as W,K as X,aN as Z}from"./index-WPqAAPOK.js";const re=({isOpen:g,onClose:P,appointment:s,onPaymentSuccess:z})=>{var F,C,T,A,E,$,O,L,U,J;const[I,c]=x.useState(!1),[a,j]=x.useState(null),[S,_]=x.useState(!1),[k,R]=x.useState(""),[Y,f]=x.useState(!1),[l,N]=x.useState(()=>(s==null?void 0:s.region)==="india"?"razorpay":"paypal");x.useEffect(()=>{if(g&&s){const t=(s==null?void 0:s.region)==="india"?"razorpay":"paypal";N(t),j(null),c(!0),setTimeout(()=>w(t),0)}return g?(document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%"):(document.body.style.overflow="",document.body.style.position="",document.body.style.width=""),()=>{document.body.style.overflow="",document.body.style.position="",document.body.style.width=""}},[g,s]);const w=async t=>{try{c(!0);const r=await fetch("https://urbansetu.onrender.com/api/payments/create-intent",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({appointmentId:s._id,paymentType:"advance",gateway:(t||l)==="razorpay"?"razorpay":"paypal"})}),i=await r.json();r.ok?j(i):n.error(i.message||"Failed to create payment intent")}catch(r){console.error("Error creating payment intent:",r),n.error("An error occurred while creating payment")}finally{c(!1)}},q=async()=>{var t,r,i,K;if(a)try{if(c(!0),l==="razorpay"){await new Promise((o,m)=>{if(window&&window.Razorpay)return o();const b=document.querySelector('script[src*="checkout.razorpay.com/v1/checkout.js"]');if(b){b.addEventListener("load",()=>o()),b.addEventListener("error",()=>m(new Error("Failed to load Razorpay SDK")));return}const p=document.createElement("script");p.src="https://checkout.razorpay.com/v1/checkout.js",p.async=!0,p.onload=()=>o(),p.onerror=()=>m(new Error("Failed to load Razorpay SDK")),document.body.appendChild(p)});const d=a.razorpay;if(!d){n.error("Razorpay not initialized");return}const u={key:d.keyId||"rzp_test_RFphKnf5uivCkc",amount:d.amount,currency:d.currency||"INR",name:"UrbanSetu",description:"Advance Booking Payment",order_id:d.orderId,prefill:{name:((t=s==null?void 0:s.buyerId)==null?void 0:t.username)||"",email:((r=s==null?void 0:s.buyerId)==null?void 0:r.email)||""},handler:async o=>{try{f(!0),await H(o)}catch{n.error("Verification failed")}finally{f(!1)}},modal:{ondismiss:()=>n.info("Payment cancelled. You can try again later.")}};new window.Razorpay(u).open();return}if(await new Promise((h,d)=>{if(window&&window.paypal)return h();const u=document.querySelector('script[src*="paypal.com/sdk/js"]');if(u){u.addEventListener("load",()=>h()),u.addEventListener("error",m=>d(new Error("Failed to load PayPal SDK")));return}const y="ATGAm-Q7s0hQAidh-pzq0TvGf1vJIYXseJxQyl1y0l-gMhvHegopwE_KPHo2k9CdlWQ5jkRH0lvZ37WY",o=document.createElement("script");o.src=`https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(y)}&currency=USD&intent=capture`,o.async=!0,o.onload=()=>h(),o.onerror=()=>d(new Error("Failed to load PayPal SDK")),document.body.appendChild(o)}),window&&window.paypal){const h=((i=a==null?void 0:a.paypal)==null?void 0:i.amount)||((K=a==null?void 0:a.payment)==null?void 0:K.amount),d=`paypal-button-container-${s._id}`,u=document.getElementById(d);u&&(u.innerHTML=""),window.paypal.Buttons({createOrder:async(y,o)=>{try{const m=await fetch("https://urbansetu.onrender.com/api/payments/paypal/create-order",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({amount:Number(h).toFixed(2),currency:"USD"})}),b=await m.text();let p;try{p=JSON.parse(b)}catch{throw new Error(b||"Invalid JSON from create-order")}if(!m.ok)throw new Error(p.message||"Failed to create PayPal order");return p.id}catch(m){throw n.error("Failed to initialize PayPal"),m}},onApprove:async(y,o)=>{try{f(!0);try{await o.order.capture()}catch{await fetch("https://urbansetu.onrender.com/api/payments/paypal/capture-order",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({orderId:y.orderID})})}await D({paypal_order_id:y.orderID})}catch{n.error("Payment capture failed")}finally{f(!1)}},onCancel:()=>{n.info("Payment cancelled. You can try again later.")},onError:y=>{var o;console.error("PayPal error",y),n.error("Payment failed or cancelled."),(o=a==null?void 0:a.payment)!=null&&o.paymentId&&v("PayPal payment failed")}}).render(`#${d}`)}else n.error("PayPal SDK not loaded.")}catch(B){console.error("Payment error:",B),n.error("Payment failed. Please try again.")}finally{c(!1)}},v=async t=>{try{const r=await fetch("https://urbansetu.onrender.com/api/payments/verify",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({paymentId:a.payment.paymentId,paymentStatus:"failed",clientIp:window&&window.__CLIENT_IP__||void 0,userAgent:navigator.userAgent})}),i=await r.json();(r.ok||r.status===400)&&(n.error(`Payment failed: ${t}`),c(!1),f(!1))}catch(r){console.error("Error marking payment as failed:",r),n.error("Payment failed"),c(!1),f(!1)}},D=async t=>{try{const r=await fetch("https://urbansetu.onrender.com/api/payments/verify",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({paymentId:a.payment.paymentId,paypalOrderId:t.paypal_order_id||t.paypalOrderId||t.orderID,clientIp:window&&window.__CLIENT_IP__||void 0,userAgent:navigator.userAgent})}),i=await r.json();r.ok?(_(!0),R(i.receiptUrl),n.success("Payment successful!"),z(i.payment)):(n.error(i.message||"Payment verification failed"),i.message&&i.message.toLowerCase().includes("signature")&&n.info("Dev mode: signature bypass is enabled. Please try again."))}catch(r){console.error("Verification error:",r),n.error("Payment verification failed")}finally{c(!1)}},H=async t=>{try{const r=await fetch("https://urbansetu.onrender.com/api/payments/razorpay/verify",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({paymentId:a.payment.paymentId,razorpay_payment_id:t.razorpay_payment_id,razorpay_order_id:t.razorpay_order_id,razorpay_signature:t.razorpay_signature,clientIp:window&&window.__CLIENT_IP__||void 0,userAgent:navigator.userAgent})}),i=await r.json();r.ok?(_(!0),R(i.receiptUrl),n.success("Payment successful!"),z(i.payment)):(n.error(i.message||"Payment verification failed"),r.status===400&&await v("Razorpay verification failed"))}catch(r){console.error("Verification error:",r),n.error("Payment verification failed"),await v("Razorpay verification error")}finally{c(!1)}},G=()=>{k&&window.open(k,"_blank")};return g?e.jsx("div",{className:"fixed inset-0 bg-gradient-to-br from-blue-900/40 to-purple-900/40 backdrop-blur-sm flex items-center justify-center z-50 p-4",style:{overscrollBehavior:"contain"},children:e.jsx("div",{className:"rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto bg-gradient-to-br from-white to-blue-50",children:S?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"p-6 text-center",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx(X,{className:"text-6xl text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Payment Successful!"}),e.jsx("p",{className:"text-gray-600",children:"Your advance payment has been processed successfully."})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-2",children:"Payment Details"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Amount Paid:"}),e.jsxs("span",{className:"font-medium",children:["$ ",Number(a.payment.amount).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Payment ID:"}),e.jsx("span",{className:"font-mono text-xs",children:a.payment.paymentId})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Receipt No:"}),e.jsx("span",{className:"font-mono text-xs",children:a.payment.receiptNumber})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:G,className:"w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center justify-center gap-2",children:[e.jsx(Z,{}),"Download Receipt"]}),e.jsx("button",{onClick:()=>{P(),window.location.href="/user/my-appointments"},className:"w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors",children:"View My Appointments"})]})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-6 border-b border-blue-100 bg-gradient-to-r from-blue-50 to-purple-50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-700 to-purple-700 flex items-center gap-2",children:[e.jsx(Q,{className:"text-blue-600"}),"Payment Required"]}),e.jsx("button",{onClick:()=>{S||n.info("Payment not completed. You can pay later from My Appointments."),P()},className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(V,{className:"text-xl"})})]}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Complete your advance payment to confirm the booking"})]}),e.jsx("div",{className:"p-6",children:Y?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(M,{className:"animate-spin text-4xl text-blue-600 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Processing Payment..."}),e.jsx("p",{className:"text-gray-600 text-center",children:"Please wait while we verify your payment. Do not close this window."})]}):I&&!a?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(M,{className:"animate-spin text-2xl text-blue-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Preparing payment..."})]}):a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:[e.jsx("h5",{className:"font-semibold text-gray-800 mb-2",children:"Select Region"}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"region",value:"india",checked:l==="razorpay",onChange:()=>{const t="razorpay";N(t),c(!0),j(null),setTimeout(()=>w(t),0)}}),e.jsx("span",{children:"India (₹100 via Razorpay)"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"region",value:"international",checked:l==="paypal",onChange:()=>{const t="paypal";N(t),c(!0),j(null),setTimeout(()=>w(t),0)}}),e.jsx("span",{children:"International ($5 via PayPal)"})]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-6 border border-blue-100",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-2",children:s.propertyName}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:s.propertyDescription}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Appointment Date:"}),e.jsx("span",{className:"text-sm font-medium",children:new Date(s.date).toLocaleDateString("en-GB")})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Time:"}),e.jsx("span",{className:"text-sm font-medium",children:s.time})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Payment Initiated:"}),e.jsx("span",{className:"text-sm font-medium",children:new Date().toLocaleString("en-GB")})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-6 border border-blue-100",children:[e.jsx("h4",{className:"font-semibold text-blue-800 mb-3",children:"Payment Summary"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Advance Payment (Flat)"}),e.jsx("span",{className:"font-medium",children:l==="razorpay"?`₹ ${Number(((F=a==null?void 0:a.payment)==null?void 0:F.currency)==="INR"?(C=a==null?void 0:a.payment)==null?void 0:C.amount:100).toFixed(2)}`:`$ ${Number(((T=a==null?void 0:a.payment)==null?void 0:T.currency)==="USD"?(A=a==null?void 0:a.payment)==null?void 0:A.amount:5).toFixed(2)}`})]}),e.jsxs("div",{className:"flex justify-between text-sm text-gray-500",children:[e.jsx("span",{children:"Note"}),e.jsx("span",{children:l==="razorpay"?"₹100 advance to confirm booking":"$5 advance to confirm booking"})]})]}),e.jsx("div",{className:"border-t border-blue-200 mt-3 pt-3",children:e.jsxs("div",{className:"flex justify-between font-semibold text-blue-800",children:[e.jsx("span",{children:"Total Amount"}),e.jsx("span",{children:l==="razorpay"?`₹ ${Number(((E=a==null?void 0:a.payment)==null?void 0:E.currency)==="INR"?($=a==null?void 0:a.payment)==null?void 0:$.amount:100).toFixed(2)}`:`$ ${Number(((O=a==null?void 0:a.payment)==null?void 0:O.currency)==="USD"?(L=a==null?void 0:a.payment)==null?void 0:L.amount:5).toFixed(2)}`})]})})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-6 border border-blue-100",children:[e.jsx("h5",{className:"font-semibold text-gray-800 mb-2",children:"Payment Platform"}),e.jsx("div",{className:"text-sm text-gray-700",children:l==="razorpay"?"Razorpay":"PayPal"}),e.jsxs("ul",{className:"list-disc pl-5 mt-3 text-sm text-gray-600 space-y-1",children:[l==="razorpay"?e.jsxs(e.Fragment,{children:[e.jsx("li",{children:'Click "Pay via Razorpay" and complete payment in the Razorpay popup.'}),e.jsx("li",{children:"On approval, we verify and confirm your booking automatically."})]}):e.jsxs(e.Fragment,{children:[e.jsx("li",{children:'Click "Load PayPal Button" and complete payment in the PayPal popup.'}),e.jsx("li",{children:"On approval, we verify and confirm your booking automatically."})]}),e.jsx("li",{children:"If you cancel or close PayPal, you can retry from My Appointments."})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-6 border border-blue-100",children:[e.jsx("h5",{className:"font-semibold text-gray-800 mb-2",children:"Payment Technical Details"}),e.jsxs("div",{className:"text-xs text-gray-600 space-y-1",children:[l==="razorpay"&&(a==null?void 0:a.razorpay)&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:["Order ID: ",e.jsx("span",{className:"font-mono",children:a.razorpay.orderId})]}),e.jsxs("div",{children:["Amount (paise): ",e.jsx("span",{className:"font-mono",children:a.razorpay.amount})]})]}),l==="paypal"&&e.jsxs("div",{children:["Amount: ",e.jsx("span",{className:"font-mono",children:((U=a==null?void 0:a.paypal)==null?void 0:U.amount)||((J=a==null?void 0:a.payment)==null?void 0:J.amount)})," USD"]})]})]}),e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(W,{className:"text-green-600 mt-1"}),e.jsxs("div",{children:[e.jsxs("h5",{className:"font-semibold text-green-800 mb-1",children:["Secure Payment via ",l==="razorpay"?"Razorpay":"PayPal"]}),e.jsx("p",{className:"text-sm text-green-700",children:"Your payment is processed securely. You can request a full refund if the appointment is cancelled."})]})]})}),e.jsxs("div",{className:"space-y-2",children:[l==="paypal"&&e.jsx("div",{id:`paypal-button-container-${s._id}`}),e.jsx("button",{onClick:q,className:"w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 shadow",children:I?"Loading…":l==="razorpay"?"Pay via Razorpay":"Load PayPal Button"})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray-600",children:"Failed to initialize payment. Please try again."}),e.jsx("button",{onClick:w,className:"mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors",children:"Retry"})]})})]})})}):null};export{re as P};
